<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>synchronized | 71ao's blog</title><meta name="keywords" content="java,thread,synchronized"><meta name="author" content="71ao"><meta name="copyright" content="71ao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言 synchronized 是 Java 关键字之一，常用于并发业务中，主要是对某对象上锁，以保证某段代码在多线程能安全运行，避免出现线程资源混乱。 随着 Java 的发展，synchronized 也不断被优化，不再像最初那样单一锁法，JDK1.6之后，synchronized 里面包含了三种级别锁：偏向锁、轻量锁、重量锁。每种锁的所带来的效率完全不一样，可以说是天差地别。因此有必要了解一下">
<meta property="og:type" content="article">
<meta property="og:title" content="synchronized">
<meta property="og:url" content="http://www.71ao.top/2020/05/20/synchronized/index.html">
<meta property="og:site_name" content="71ao&#39;s blog">
<meta property="og:description" content="前言 synchronized 是 Java 关键字之一，常用于并发业务中，主要是对某对象上锁，以保证某段代码在多线程能安全运行，避免出现线程资源混乱。 随着 Java 的发展，synchronized 也不断被优化，不再像最初那样单一锁法，JDK1.6之后，synchronized 里面包含了三种级别锁：偏向锁、轻量锁、重量锁。每种锁的所带来的效率完全不一样，可以说是天差地别。因此有必要了解一下">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/3c475ec84f03.jpg">
<meta property="article:published_time" content="2020-05-20T06:38:21.000Z">
<meta property="article:modified_time" content="2021-10-12T02:37:26.403Z">
<meta property="article:author" content="71ao">
<meta property="article:tag" content="java">
<meta property="article:tag" content="thread">
<meta property="article:tag" content="synchronized">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/3c475ec84f03.jpg"><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/43485833"><link rel="canonical" href="http://www.71ao.top/2020/05/20/synchronized/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'synchronized',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-12 10:37:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/43485833" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/3c475ec84f03.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">71ao's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">synchronized</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-20T06:38:21.000Z" title="发表于 2020-05-20 14:38:21">2020-05-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-10-12T02:37:26.403Z" title="更新于 2021-10-12 10:37:26">2021-10-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="synchronized"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="前言">前言</h3>
<p><strong>synchronized</strong> 是 <strong>Java</strong> 关键字之一，常用于并发业务中，主要是对某对象上锁，以保证某段代码在多线程能安全运行，避免出现线程资源混乱。</p>
<p>随着 Java 的发展，<strong>synchronized</strong> 也不断被优化，不再像最初那样单一锁法，<strong>JDK1.6</strong>之后，<strong>synchronized</strong> 里面包含了三种级别锁：<strong>偏向锁、轻量锁、重量锁</strong>。每种锁的所带来的效率完全不一样，可以说是天差地别。因此有必要了解一下<strong>synchronized</strong> 的原理。</p>
<h3 id="用法">用法</h3>
<p>简单几种用法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncExample</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyLock myLock = <span class="keyword">new</span> MyLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用法 1</span></span><br><span class="line"><span class="comment">     * 在方法上添加，锁住对象为 this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">one</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用法 2</span></span><br><span class="line"><span class="comment">     * 在方法内使用，锁住对象为 this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">second</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用法 3</span></span><br><span class="line"><span class="comment">     * 锁住某块代码，锁住自定义对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">third</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (myLock)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;third&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SyncExample syncExample = <span class="keyword">new</span> SyncExample();</span><br><span class="line">        syncExample.one();</span><br><span class="line">        syncExample.second();</span><br><span class="line">        syncExample.third();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要注意的是：如果是在方法上添加或锁住的 <strong>this</strong> <strong>或属性</strong>，那么锁住的依然是该属性或方法所属的实例化对象。</p>
<h3 id="对象头">对象头</h3>
<p>对象头是什么？为什么讲锁要去了解对象头呢？</p>
<h4 id="简介">简介</h4>
<p><strong>Java</strong> 对象头就是 <strong>Java</strong> 存储对象真正有效信息的的区域。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200520153255759.png" alt="image-20200520153255759"></p>
<p>上图为 <strong>Hotspot</strong> 的源码种对对象头的注释,整理一下得出下表</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525170634543.png" alt="image-20200525170634543"></p>
<p><strong>L locked</strong>（<strong>Lightweight Locked</strong>）,<strong>H Locked</strong>（<strong>Heavyweight Locked</strong>）</p>
<h4 id="Mark-Word">Mark_Word</h4>
<p><strong>Mark Word</strong> 用于存储对象自身的运行时数据，64位 <strong>JVM</strong> 为 <strong>64bits</strong>，<strong>8个字节</strong>：</p>
<ul>
<li><strong>thread</strong> ：偏向线程ID，<strong>54 bits</strong></li>
<li><strong>identity_hashcode</strong> ：哈希码（<strong>HashCode</strong>），<strong>31 bits</strong></li>
<li><strong>epoch</strong> ：偏向时间戳，<strong>2 bits</strong></li>
<li><strong>age</strong> ：GC分代年龄，<strong>4 bits</strong></li>
<li><strong>biased_lock</strong> ：偏向锁的标识位，<strong>1 bit</strong></li>
<li><strong>lock</strong> ： 线程持有的锁，<strong>2 bits</strong></li>
</ul>
<p>通过整理可以看出，<strong>Mark_Word</strong> 里面有三个 <strong>3bits</strong> 和锁紧密有关。这里可以解释为什么讲 <strong>synchronized</strong> 所产生的锁要理解对象头，<strong>因为 synchronized 关键字锁住的是对象，不是代码块，而体现就在对象头里面，所有很有必要了解一下对象头</strong>。</p>
<h4 id="对象的状态">对象的状态</h4>
<p>表格列出了<strong>5种</strong>对象状态，其实对象状态对象只有三种：</p>
<ul>
<li><strong>无锁状态</strong>（<strong>Normal</strong>）</li>
<li><strong>有锁状态</strong></li>
<li><strong>GC标记状态 （GC）</strong></li>
</ul>
<p>有锁状态又分为三种：</p>
<ul>
<li><strong>偏向锁（Biased）</strong></li>
<li><strong>轻量锁（Lightweight Locked）</strong></li>
<li><strong>重量锁（Heavyweight Locked）</strong></li>
</ul>
<p>总的来说一共有五种状态，但是 <strong>lock</strong> 只有 <strong>2bits</strong> 的二进制数，最多只能表示4种状态，所以这里多加了1bit <strong>biased_lock</strong>，表示偏向锁。</p>
<h3 id="分析JOL（Java-Object-Layout）">分析JOL（Java Object Layout）</h3>
<p><strong>Hotspot</strong>虚拟机中，对象在内存中的布局分为三块区域：<strong>对象头、实例数据和对齐填充</strong>。</p>
<h4 id="JOL工具包">JOL工具包</h4>
<p>如需要看到上述这些数据，需要借助一个工具包 <a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/code-tools/jol/"><strong>JOL（Java Object Layout）</strong></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JOL (Java Object Layout) is the tiny toolbox to analyze object layout schemes in JVMs. These tools are using Unsafe, JVMTI, and Serviceability Agent (SA) heavily to decoder the actual object layout, footprint, and references. This makes JOL much more accurate than other tools relying on heap dumps, specification assumptions, etc.</span><br></pre></td></tr></table></figure>
<p>一个借助 Java 多项技术，解析出 Java 对象在内存布局的工具包。</p>
<p>导入Maven包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jol/jol-core --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jol<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jol-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>打印一个对象信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.vm.VM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印当前 JVM 虚拟机信息</span></span><br><span class="line">        System.out.println(VM.current().details());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印实例化对象信息</span></span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Running 64-bit HotSpot VM.</span><br><span class="line"># Using compressed oop with 0-bit shift.</span><br><span class="line"># Using compressed klass with 3-bit shift.</span><br><span class="line"># Objects are 8 bytes aligned.</span><br><span class="line"># Field sizes by type: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span><br><span class="line"># Array element sizes: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span><br><span class="line"></span><br><span class="line">com.Playwi0.Third.One object internals:</span><br><span class="line">OFFSET SIZE   TYPE         DESCRIPTION                 VALUE</span><br><span class="line">  0   4   (object header)  01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">  4   4   (object header)  00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">  8   4   (object header)  43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)</span><br><span class="line">  12  4   (loss due to the next object alignment)</span><br><span class="line"></span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure>
<p>分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Field sizes by type: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span><br><span class="line"># 分别对应[Oop(Object Original Pointer), boolean, byte, char, short, int, float, long, double]的大小</span><br><span class="line"></span><br><span class="line"># Array element sizes: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes] </span><br><span class="line"># 数组中元素的大小，分别对应的是[Oop(Object Original Pointer), boolean, byte, char, short, int, float, long, double]</span><br></pre></td></tr></table></figure>
<p>这部分主要是用来优化 <strong>Field</strong> 的排序，节省内存空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">com.Playwi0.Third.One object internals:</span><br><span class="line">OFFSET SIZE   TYPE         DESCRIPTION                 VALUE</span><br><span class="line">  0   4   (object header)  01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">  4   4   (object header)  00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">  8   4   (object header)  43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)</span><br><span class="line">  12  4   (loss due to the next object alignment)</span><br><span class="line"></span><br><span class="line">Instance size: 16 bytes</span><br></pre></td></tr></table></figure>
<p>通过这部分，可以确确了解到一个空对象在内存中占 <strong>16 bytes</strong>，对象头为 <strong>12 bytes</strong>，还有 <strong>4 bytes</strong> 是对齐字节，因为 JVM 上规定对象都是<strong>以8 bytes的粒度来对齐的</strong>，所以对象头占了 12 bytes，需要补齐 4bytes，一共 16 bytes。</p>
<h4 id="实例数据">实例数据</h4>
<p>往对象里面添加数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class One &#123;</span><br><span class="line"></span><br><span class="line">    private int i = 1;</span><br><span class="line">    </span><br><span class="line">    private boolean flag = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522143734127.png" alt="image-20200522143734127"></p>
<p>可以看到下面有两行打印出对象的实例数据，按照前面所说，<strong>int</strong> 类型数据大小对应 <strong>4 bytes</strong>， <strong>boolean</strong> 类型为 <strong>1bytes</strong> ，多出 <strong>5 bytes</strong>，加上对象头 <strong>12 bytes</strong>，总共 <strong>17 bytes</strong>，因为对象都是<strong>以8 bytes的粒度来对齐的</strong>，所以补了 **7 bytes **对齐数据，全部加起来一共 <strong>24 bytes</strong>。</p>
<h4 id="对象头-2">对象头</h4>
<p>知道了<strong>实例数据</strong>和<strong>对齐字节</strong>的意义，那么继续探究对象头。对齐字节存在的意义是弥补实例数据所带来差额，而对象数据大小并不会改变，只有<strong>12 bytes</strong>。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522151453017.png" alt="image-20200522151453017"></p>
<p>在<strong>Hotspot术语表</strong>对<strong>Object header</strong>解释：由两个 <strong>words</strong> 组成。除去前面已经解释过一个： <strong>Mark_Word</strong>。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522151727209.png" alt="image-20200522151727209"></p>
<p>还有一个 <strong>Klass_Word</strong></p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522152048399.png" alt="image-20200522152048399"></p>
<p>该部分占 <strong>4 bytes</strong>（<strong>Mark_Word 占 8 bytes</strong>），并且该部分指向的是<strong>对象的元数据</strong>，就是JVM通过这个指针确定对象是哪个类的实例（猜测，依据是<strong>同一个类实例化出来的对象，该值一样</strong>）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class JOLExample &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        One one = new One();</span><br><span class="line">        One two = new One();</span><br><span class="line">        </span><br><span class="line">        // 打印实例化对象信息</span><br><span class="line">        System.out.println(&quot;Object one&quot;);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;Object two&quot;);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(two).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522152944863.png" alt="image-20200522152944863"></p>
<p>那么对象头的<strong>words</strong>结构是：</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522153330673.png" alt="image-20200522153330673"></p>
<p>验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印实例化对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before hashCode&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line">		a</span><br><span class="line">        <span class="comment">// 打印对象16进制的hashCode</span></span><br><span class="line">        System.out.println(Integer.toHexString(one.hashCode()));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;after hashCode&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522154421896.png" alt="image-20200522154421896"></p>
<p>根据上面的表格，这是一个正常（<strong>Normal，无锁状态</strong>）的对象，其 <strong>HashCode</strong> 占 <strong>31bits</strong>，<strong>unused</strong> 占 <strong>25bits</strong>，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">			unused							HashCode</span><br><span class="line">00000000 00000000 00000000 0[1100100 10100010 10010100 10100110 00000001]</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522160918624.png" alt="image-20200522160918624"></p>
<p>确实是<strong>HashCode</strong>值，但是为什么是反过来的？</p>
<p>这是因为<a href="%5Bhttps://baike.baidu.com/item/%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F/6750542?fr=aladdin%5D(https://baike.baidu.com/item/%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F/6750542?fr=aladdin)">大小端模式</a>。PC端一般是<strong>小端模式</strong>，也就是<strong>指数据的高字节，保存在内存的低地址中，而数据的低字节，保存在内存的高地址中，这样的存储模式有点儿类似于把数据当作字符串顺序处理：地址由小向大增加，而数据从高位往低位放</strong>。</p>
<p>接下只剩下 <strong>1byte</strong> ，也就是 <strong>8 bits</strong>，但它是<strong>和锁有直接关系的部分</strong>，也就是和 <strong>synchronized</strong> 关键字最紧密联系的部分，最直观感受到 <strong>synchronized</strong> 关键字锁住对象所带来的变化。根据表格，结构如下</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522162155451.png" alt="image-20200522162155451"></p>
<p><strong>8 bits</strong> 中后 <strong>3 bits</strong> 直接表示五种对象状态，接下来探讨基本都是围绕这 <strong>3 bits</strong></p>
<h3 id="锁的原理">锁的原理</h3>
<p>到这里，你对对像头已经有了基本的了解，接下来，就是慢慢揭开锁的面纱。</p>
<table>
<thead>
<tr>
<th style="text-align:center">对象状态</th>
<th style="text-align:center">1 bit</th>
<th style="text-align:center">4 bits</th>
<th style="text-align:center">1 bit</th>
<th style="text-align:center">2 bit</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">无锁态</td>
<td style="text-align:center">unused</td>
<td style="text-align:center">分带年龄</td>
<td style="text-align:center">0</td>
<td style="text-align:center">01</td>
</tr>
<tr>
<td style="text-align:center">偏向锁</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">1</td>
<td style="text-align:center">01</td>
</tr>
<tr>
<td style="text-align:center">轻量级锁</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">00</td>
</tr>
<tr>
<td style="text-align:center">重量级锁</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">GC 标记</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">11</td>
</tr>
</tbody>
</table>
<p>前面已经列出了对象的五种状态，由 <strong>3 bits</strong> 表示。上表是五种状态的具体表示。</p>
<h4 id="无锁态">无锁态</h4>
<p>前面已经打印过了，对象 <strong>one</strong> 并没有进行任何加锁操作，所以前面 <strong>8 bits</strong> 是 <strong>00000001</strong></p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522203006233.png" alt="image-20200522203006233"></p>
<h4 id="偏向锁">偏向锁</h4>
<p>什么是偏向锁？</p>
<p><strong>偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁，降低获取锁的代价。</strong></p>
<p>在大多数情况下，锁不仅不存在多线程竞争，而且总是由同一个线程获得，为了让线程获得锁的代价更低从而提高性能，所以引入了偏向锁的概念。</p>
<p>JDK1.6之后 偏向锁默认开启偏向锁是锁状态中最乐观的一种锁：从始至终只有一个线程请求同一把锁。</p>
<h5 id="举例">举例</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印锁前对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before lock&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给对象上锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (one)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对象已上锁信息</span></span><br><span class="line">            System.out.println(<span class="string">&quot;locking&quot;</span>);</span><br><span class="line">            System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 锁后对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after lock&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522204943506.png" alt="image-20200522204943506"></p>
<p>这里结果出乎，竟然不是偏向锁。难道前面所说的理论不对吗？</p>
<p>其实不是，<strong>这是因为偏向有延时</strong>，那为什么要有延时？</p>
<p><strong>JVM</strong> 启动时会进行一系列的复杂活动，比如装载配置，系统类初始化等等。在这个过程中会使用大量<strong>synchronized</strong> 关键字对对象加锁，且这些锁大多数都不是偏向锁。为了减少初始化时间，<strong>JVM 默认延时加载偏向锁</strong>。</p>
<p>这个延时的时间大概为4s左右，具体时间因机器而异。可以在运行时加入参数查看 <strong>JVM</strong> 默认参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522210112667.png" alt="image-20200522210112667"></p>
<p>当然也可以修改 <strong>JVM</strong> 参数，来取消延时加载偏向锁。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:BiasedLockingStartupDelay=0		//毫秒</span><br></pre></td></tr></table></figure>
<p>重新打印输出</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522210624336.png" alt="image-20200522210624336"></p>
<p>可以看到，偏向锁确实是偏向锁，但为什么加锁前后改变的是后面 <strong>3 bytes</strong>，还有，如果我设置了加载偏向锁的延时为 0，那么无锁状态呢？</p>
<p>回看之前对象头的表格，可以知道，偏向除了这个 <strong>8 bits</strong>，还有 <strong>56 bits</strong>，分别表示 <strong>JavaThreadID（54 bits）和 epoch（2 bits）</strong></p>
<p><img src="https://gitee.com/playwi0/MyImage/raw/master/NoteImage/image-20200522211807481.png" alt="image-20200522211807481"></p>
<p>也就是说，在加锁之前，虽然也是显示偏向锁的状态，但是并不是真正的上了偏向锁，这个状态叫<strong>可偏向状态（相当于无锁）</strong>，是准备上偏向锁的阶段，所以后面的 <strong>7 bytes</strong> 全部是空值。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522212539258.png" alt="image-20200522212539258"></p>
<p>在使用 <strong>synchronized</strong> 关键字给对象上锁时，会检查该对象是否处于一个<strong>可偏向状态</strong>，如果是可偏向状态，则通过<strong>CAS（旧的内存值：可偏向状态，预期值：可偏向状态，新值：线程ID）</strong> 将原本空值修改为 <strong>ThreadID和epoch</strong>，这时候才是真正给对象上了锁。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522213600039.png" alt="image-20200522213600039"></p>
<p>但是线程不会主动撤销偏向锁，偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会撤销锁。所以即使在同步代码块执行完成之后，对象还是偏向锁状态。而这样，如果下次还是该线程，那么直接会获得锁，不需要重新进入加锁过程，提高性能。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522213848366.png" alt="image-20200522213848366"></p>
<p>这里偏向锁的释放和撤销是两个概念：<strong>撤销是指在获取偏向锁的过程因为不满足条件导致要将锁对象改为非偏向锁状态；释放是指退出同步块时的过程。</strong></p>
<h4 id="轻量级锁">轻量级锁</h4>
<p>轻量级锁是指<strong>当锁是偏向锁或无锁（有延时）的时候，被另外的线程所访问，偏向锁或无锁（有延时）就会升级为轻量级锁</strong>。</p>
<h5 id="举例-2">举例</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Third;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印锁前对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 给对象上锁</span></span><br><span class="line">                <span class="keyword">synchronized</span> (one)&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 对象已上锁信息</span></span><br><span class="line">                        System.out.println(<span class="string">&quot;t1---locking&quot;</span>);</span><br><span class="line">                        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 给对象上锁</span></span><br><span class="line">                <span class="keyword">synchronized</span> (one)&#123;</span><br><span class="line">                    <span class="comment">// 对象已上锁信息</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;t2---locking&quot;</span>);</span><br><span class="line">                    System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//         锁后对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523182342410.png" alt="image-20200523182342410"></p>
<p><strong>分析：</strong></p>
<p>在<strong>加锁前（before）</strong>，因为已关闭延时，所以在加锁前是可偏向状态。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523203356138.png" alt="image-20200523203356138"></p>
<p>第一次是加锁，因为 <strong>t1</strong> 在 <strong>t2</strong> 启动之前用了 <strong>join</strong>，所以不存在多线程竞争，锁偏向 <strong>t1</strong> 线程。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523203831543.png" alt="image-20200523203831543"></p>
<p><strong>t2</strong> 启动要给对象加锁，可是对象已经是偏向锁了，又没达到重偏向条件（批量重偏向），并且持有偏向锁的线程已经死亡，所以膨胀为轻量级锁（有人说会重偏向t2，个人感觉不正确，后面会解释）。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523204742514.png" alt="image-20200523204742514"></p>
<p>最后所有子线程死亡，轻量级锁会主动释放，对象变为无锁状态。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523205053804.png" alt="image-20200523205053804"></p>
<h4 id="重量级锁">重量级锁</h4>
<p>重量级锁是<strong>当锁是无锁（有延时）、偏向锁或轻量级锁的时候，多个线程同时竞争锁，当前锁就会升级重量锁，没有获取锁的线程就会进入阻塞等待唤醒。</strong></p>
<h5 id="举例-3">举例</h5>
<h6 id="无锁到重量级锁">无锁到重量级锁</h6>
<p>开启轻量级锁的延时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">package com.Playwi0.Third;</span><br><span class="line"></span><br><span class="line">import org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line">public class JOLExample &#123;</span><br><span class="line"></span><br><span class="line">    private static final One one = new One();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 打印锁前对象信息</span><br><span class="line">        System.out.println(&quot;before\n&quot; + ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        Thread t1 = new Thread(&quot;t1&quot;) &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                // 给对象上锁</span><br><span class="line">                synchronized (one)&#123;</span><br><span class="line"></span><br><span class="line">                    // 对象已上锁信息</span><br><span class="line">                    System.out.println(&quot;t1---locking\n&quot; + 						  </span><br><span class="line">                    					ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t2 = new Thread(&quot;t2&quot;) &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                // 给对象上锁</span><br><span class="line">                synchronized (one)&#123;</span><br><span class="line">                    // 对象已上锁信息</span><br><span class="line">                    System.out.println(&quot;t2---locking\n&quot; + 						  </span><br><span class="line">                    					ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        </span><br><span class="line">        // 锁后对象信息</span><br><span class="line">        System.out.println(&quot;after\n&quot; + ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524144747712.png" alt="image-20200524144747712"></p>
<h6 id="偏向锁到重量级锁">偏向锁到重量级锁</h6>
<p>关闭偏向锁的延时，代码同上</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524145123180.png" alt="image-20200524145123180"></p>
<h6 id="轻量级锁到重量级锁">轻量级锁到重量级锁</h6>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524150120514.png" alt="image-20200524150120514"></p>
<p><strong>分析</strong>：</p>
<p>无论是哪种锁，多个线程同时竞争这把锁时，都会升级为重量锁，并且重量锁会主动释放</p>
<h3 id="锁的膨胀">锁的膨胀</h3>
<p><strong>流程图</strong></p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524155445490.png" alt="image-20200524155445490"></p>
<h4 id="无锁态的膨胀">无锁态的膨胀</h4>
<h5 id="无锁到偏向锁">无锁到偏向锁</h5>
<p>在关闭偏向锁延时时，无锁到可偏向状态只有在对象一开始未被加锁过的情况才会有。</p>
<p>可偏向状态下，<strong>epoch</strong> 字段是无效的(与锁对象对应的 <strong>klass_word</strong> 的 <strong>mark_prototype</strong> 的 <strong>epoch</strong> 值不匹配)，只有单个线程来拿锁，并且无竞争，<strong>JVM</strong> 会使用原子CAS指令（具体操不知），将可偏向状态偏向到当前线程ID。</p>
<h5 id="无锁到轻量锁">无锁到轻量锁</h5>
<p>如果不关闭偏向锁延时，<strong>JVM</strong> 默认一开始对象状态是无锁的，也不会有可偏向状态。</p>
<p>如果对象为无锁状态（001），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（<strong>Lock Record</strong>）的空间，用于存储锁对象目前的 <strong>Mark Word</strong> 的拷贝。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524164437982.png" alt="image-20200524164437982"></p>
<p>然后拷贝对象头中的 <strong>Mark Word</strong> 复制到锁记录中。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524165814016.png" alt="20200524165814016.png"></p>
<p>拷贝成功后，<strong>JVM</strong> 将使用 <strong>CAS</strong> 操作（具体未知）尝试将对象的 <strong>Mark Word</strong> 更新为指向 <strong>Lock Record</strong> 的指针，并将 <strong>Lock Record</strong> 里的<strong>owner</strong> 指针指向对象的 <strong>Mark Word</strong>。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524171050346.png" alt="image-20200524171050346"></p>
<p>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象 <strong>Mark Word</strong> 的锁标志位设置为**“000”**，表示此对象处于轻量级锁定状态。</p>
<p>如果更新操作失败了，虚拟机首先会检查对象的 <strong>Mark Word</strong> 是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行，否则说明多个线程竞争锁。</p>
<h5 id="无锁到重量级锁-2">无锁到重量级锁</h5>
<p>首先 <strong>JVM</strong> 会创建一个 <strong>Monitor</strong> （c++实现）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ObjectMonitor</span>() &#123;</span><br><span class="line">    _header       = <span class="literal">NULL</span>;<span class="comment">//mark_word 对象头</span></span><br><span class="line">    _count        = <span class="number">0</span>;</span><br><span class="line">    _waiters      = <span class="number">0</span>,<span class="comment">//等待线程数</span></span><br><span class="line">    _recursions   = <span class="number">0</span>;<span class="comment">//重入次数</span></span><br><span class="line">    _object       = <span class="literal">NULL</span>;<span class="comment">//监视器锁寄生的对象。锁不是平白出现的，而是寄托存储于对象中。</span></span><br><span class="line">    _owner        = <span class="literal">NULL</span>;<span class="comment">//指向获得ObjectMonitor对象的线程或基础锁</span></span><br><span class="line">    _WaitSet      = <span class="literal">NULL</span>;<span class="comment">//处于wait状态的线程，会被加入到waitSet；</span></span><br><span class="line">    _WaitSetLock  = <span class="number">0</span>;</span><br><span class="line">    _Responsible  = <span class="literal">NULL</span>;</span><br><span class="line">    _succ         = <span class="literal">NULL</span>;</span><br><span class="line">    _cxq          = <span class="literal">NULL</span>;</span><br><span class="line">    FreeNext      = <span class="literal">NULL</span>;</span><br><span class="line">    _EntryList    = <span class="literal">NULL</span>;<span class="comment">//处于等待锁block状态的线程，会被加入到entryList；</span></span><br><span class="line">    _SpinFreq     = <span class="number">0</span>;</span><br><span class="line">    _SpinClock    = <span class="number">0</span>;</span><br><span class="line">    OwnerIsThread = <span class="number">0</span>;</span><br><span class="line">    _previous_owner_tid = <span class="number">0</span>;<span class="comment">//监视器前一个拥有者线程的ID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Monitor</strong> 的 <strong>_header</strong> 字段指向锁对象的 <strong>Mark_Word</strong>，<strong>_object</strong> 指向锁对象。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524203211910.png" alt="image-20200524203211910"></p>
<p>用 <strong>CAS</strong> 指令把 ** <strong>Monitor</strong> 指针替换到对象头的 <strong>Mark_Word</strong></p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524203552524.png" alt="image-20200524203552524"></p>
<h4 id="偏向锁的膨胀">偏向锁的膨胀</h4>
<h5 id="偏向锁到轻量级锁">偏向锁到轻量级锁</h5>
<p>如果当前锁为偏向锁，当有其他线程再次需要锁该对象的时候，<strong>JVM</strong> 会等待一个全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，判断该线程的状态（<strong>JVM</strong> 维护了一个集合存放所有存活的线程，通过遍历该集合判断某个线程是否存活）。</p>
<p>如果该线程已经<strong>不存活</strong>或<strong>活着但不处于同步代码块中</strong>（<strong>synchronized</strong> 锁住部分代码），则撤销偏向锁，设置对象头为无锁状态，然后膨胀到轻量锁（<strong>逻辑与上面无锁一样</strong>）。</p>
<p>如果线程仍然<strong>活着且处于同步与块代码中</strong>，<strong>竞争升级</strong>，恢复到无锁状态，偏向锁最终变为重量级锁（这个过程是先到轻量级锁，再到重量级锁，还是直接膨胀为重量级锁，目前未找到答案，膨胀过程与上面无锁一样）。</p>
<h5 id="HashCode">HashCode</h5>
<p>如果当前锁对象已经 <strong>HashCode</strong>，则不存在<strong>可偏向或偏向锁状态</strong>。这是因为 <strong>Mark_Word</strong> 有冲突。</p>
<p><img src="https://gitee.com/playwi0/MyImage/raw/master/NoteImage/image-20200525102339044.png" alt="image-20200525102339044"></p>
<p>如果对象处于可偏向状态进行 <strong>HashCode</strong>，会变为无锁不可偏向状态，下次加锁为轻量锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before hashCode\n&quot;</span> + 	</span><br><span class="line">                           		ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;HashCode: &quot;</span> + fourth.hashCode());</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;after hashCode\n&quot;</span> + </span><br><span class="line">                           		ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">        </span><br><span class="line">         Thread t1 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;after hashCode\n&quot;</span> + </span><br><span class="line">                           		ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525111914047.png" alt="image-20200525111914047"></p>
<p>如果对象处于偏向锁状态且处于同步代码块的执行中 <strong>HashCode</strong>，则锁会膨胀为重量级锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before t1\n&quot;</span> + </span><br><span class="line">                           	ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---before\n&quot;</span> + 	</span><br><span class="line">                                       	ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                    </span><br><span class="line">                    System.out.println(<span class="string">&quot;HashCode: &quot;</span> + fourth.hashCode() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    </span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---after\n&quot;</span> + </span><br><span class="line">                                       	ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果<img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525111355073.png" alt="image-20200525111355073"></p>
<h5 id="重偏向（不存在）">重偏向（不存在）</h5>
<p>重偏向是指当前线程释放偏向锁，下一个线程来拿锁，偏向锁会重新偏向。但这种情况是不存在，重偏向只会在<strong>批量重偏向</strong>（下面讲）才会出现。那这个名词怎么提出来的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---locking\n&quot;</span> + </span><br><span class="line">                                       	ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t2---locking\n&quot;</span> + </span><br><span class="line">                                       	ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525113119281.png" alt="image-20200525113119281"></p>
<p>这一看确实还是偏向锁，重新偏向了 <strong>t2</strong> ，但再仔细一看。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525113516828.png" alt="image-20200525113516828"></p>
<p>**ThreadID（系统分配还是 JVM 分配未知）**一样，在这里可以做个推测。t1 死亡之后，再次分配（<strong>是JVM还是系统分配，目前不清楚</strong>）给 t2 的 ID 和 t1 的一样，因此偏向锁以为是同一个线程，继续执行，不会膨胀。</p>
<p><strong>举个反例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">				</span><br><span class="line">                <span class="comment">// 睡眠5秒，让 t2 执行时，t1 保持不死</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">		</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t2---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 睡眠一秒，让 t1 执行完同步代码块，再启动 t2</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样写主要时保证 <strong>t2</strong> 执行的时候，<strong>t1</strong> 还活着，这样他俩的线程 ID 就不会一样。</p>
<p>结果</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525114901404.png" alt="image-20200525114901404"></p>
<p>结果很明显，<strong>线程ID</strong>不一样，符合上面描述的锁膨胀的过程，并不存在重偏向。</p>
<h5 id="批量重偏向">批量重偏向</h5>
<p>当一个线程创建<strong>大量对象</strong>被用来作为锁对象，之后某个线程又使用这些对象作为锁对象，那么在这期间就会大量的上锁和撤销锁的操作，这样做大大降低效率，违背了优化的初衷。</p>
<p>为了解决这个问题，JVM 每次在撤销偏向锁的时候，以class为单位，为每个class维护一个偏向锁撤销计数器，每次撤销偏向锁，该计数器 +1，当这个值达到重偏向阈值（默认20）时，可以运行时加入一下命令查看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525143241957.png" alt="image-20200525143241957"></p>
<p>JVM就认为该 <strong>class</strong> 产生对象的偏向锁有问题，因此会进行批量重偏向。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RebiasThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayList&lt;Fourth&gt; fourths = <span class="keyword">new</span> ArrayList&lt;Fourth&gt;(<span class="number">70</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">t1</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Fourth fourth : fourths) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">18</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----19\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">19</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----20\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">20</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----21\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保持线程不死</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t1.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">t2</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Fourth fourth : fourths) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">18</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t2 locking----19\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">19</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t2 locking----20\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">20</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----21\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            fourths.add(<span class="keyword">new</span> Fourth());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        t1();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 让 t1 for循环执行完</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">        t2();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>结果</strong></p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525150356292.png" alt="image-20200525150356292"></p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525150459367.png" alt="image-20200525150459367"></p>
<p><strong>分析：</strong></p>
<p>t1 线程里的第19、20、21全部是偏向锁，符合预期。</p>
<p>t2 线程里第19个还是轻量锁，但第20，21已经开始批量重偏向，注意 t1 的第20、21锁对象的Thread ID和 t2 是不一样，证明他们已经重偏向了。</p>
<p>当到达开始批量重偏向阈值时，每个偏向锁对象的 <strong>Mark_Word</strong> 中的 <strong>epoch</strong> 字段（它的初始值是创建对象时<strong>class</strong> 中的 <strong>epoch</strong> 值），</p>
<p><img src="./NoteImg/image-20200525142559943.png" alt="image-20200525142559943"></p>
<p>每次发生批量重偏向时，就将该值+1，同时遍历JVM中所有线程的栈，找到该 class 产生的对象所有正处于加锁状态的偏向锁，将其 <strong>epoch</strong> 字段改为新值。下次获得锁时，发现当前对象的 <strong>epoch</strong> 值和 class 的 <strong>epoch</strong> 不相等，那就算当前已经偏向了其他线程，也不会执行撤销操作，而是直接通过CAS操作将其 <strong>Mark_Word</strong> 的 <strong>ThreadID</strong> 改成当前线程IID。</p>
<h5 id="批量撤销">批量撤销</h5>
<p>虽然有批量重偏向，但JVM不会一直重偏向下去，和前面批量重偏向机制一样，重偏向一次计数器+1，到达撤销阈值之后，</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525153132147.png" alt="image-20200525153132147"></p>
<p>JVM认为存在多线程竞争，会标记该class为不可偏向，开始批量撤销，膨胀。</p>
<h4 id="轻量级锁的膨胀">轻量级锁的膨胀</h4>
<h5 id="轻量级锁到重量级锁-2">轻量级锁到重量级锁</h5>
<p>膨胀到重量锁一般是因为<strong>多个线程同时竞争同一把锁</strong>，锁才会膨胀到重量级锁。</p>
<p>轻量级锁首先会释放锁，成为无锁状态，再膨胀为重量级锁，中间过程与上面的无锁到重量级锁类似。</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525155439945.png" alt="image-20200525155439945"></p>
<h3 id="性能对比">性能对比</h3>
<p>说那么多，是骡子是马，拿出来溜一溜就知道，<strong>show your code</strong></p>
<p>从0开始加到一个1个亿，看看三种不同级别锁，性能如何。（这里结果取决个人电脑，测个大概就行就行）</p>
<h4 id="偏向锁-2">偏向锁</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Compared</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000l</span>; i++) &#123;</span><br><span class="line">            fourth.add();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Time: &quot;</span> + String.format(<span class="string">&quot;%sms&quot;</span>, end - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        run();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关闭延时，结果</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525161754746.png" alt="image-20200525161754746"></p>
<h4 id="轻量级锁-2">轻量级锁</h4>
<p>代码同上，开启延时，结果</p>
<p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525161719004.png" alt="image-20200525161719004"></p>
<p>轻量锁与偏向锁性能差距可以达到 <strong>10倍</strong> 左右，说明优化还是很有必要</p>
<h3 id="总结">总结</h3>
<p><strong>synchronized</strong> 关键字可是 <strong>sun</strong> 公司的亲儿子，所做的优化不仅仅是上面说的这么简单，作者水平有限，无法处处拿出证明，只能扯扯理论，仅仅代表作者自己的观点，不足之处还请指出。</p>
<h3 id="参考资料">参考资料</h3>
<ul>
<li><a target="_blank" rel="noopener" href="http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.html"><strong>Hotspot术语表</strong></a></li>
<li><a href="%5Bhttp://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/94.html%5D(http://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/94.html)">死磕Synchronized底层实现–概论</a></li>
<li><a href="%5Bhttps://www.java520.cn/%e5%a4%9a%e7%ba%bf%e7%a8%8b/96.html%5D(https://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/96.html)">死磕Synchronized底层实现–偏向锁</a></li>
<li><a href="%5Bhttps://www.java520.cn/%e5%a4%9a%e7%ba%bf%e7%a8%8b/99.html%5D(https://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/99.html)">死磕Synchronized底层实现–轻量级锁</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/14440216/2427707">死磕Synchronized底层实现–重量级锁</a></li>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/11/15/java-lock.html">不可不说的Java“锁”事</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">71ao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.71ao.top/2020/05/20/synchronized/">http://www.71ao.top/2020/05/20/synchronized/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.71ao.top" target="_blank">71ao's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/thread/">thread</a><a class="post-meta__tags" href="/tags/synchronized/">synchronized</a></div><div class="post_share"><div class="social-share" data-image="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/3c475ec84f03.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/05/26/AQS/"><img class="prev-cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-22057-landscape.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">AQS(AbstractQueuedSynchronizer)</div></div></a></div><div class="next-post pull-right"><a href="/2020/05/18/JavaThread/"><img class="next-cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-137067-landscape.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Thread In Java</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/05/18/JavaThread/" title="Thread In Java"><img class="cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-137067-landscape.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-18</div><div class="title">Thread In Java</div></div></a></div><div><a href="/2020/05/17/pthread-create/" title="pthread_create"><img class="cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-84386-landscape.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-17</div><div class="title">pthread_create</div></div></a></div><div><a href="/2020/05/26/AQS/" title="AQS(AbstractQueuedSynchronizer)"><img class="cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-22057-landscape.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-26</div><div class="title">AQS(AbstractQueuedSynchronizer)</div></div></a></div><div><a href="/2020/07/15/SPI2/" title="Dubbo SPI（中）"><img class="cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-154610-landscape.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-15</div><div class="title">Dubbo SPI（中）</div></div></a></div><div><a href="/2020/07/16/SPI3/" title="Dubbo SPI（下）"><img class="cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-63246-landscape.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-16</div><div class="title">Dubbo SPI（下）</div></div></a></div><div><a href="/2020/07/14/SPI/" title="Dubbo SPI（上）"><img class="cover" src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/backiee-16999-landscape.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-14</div><div class="title">Dubbo SPI（上）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/43485833" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">71ao</div><div class="author-info__description">You are the apple of my eye</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/71aoo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/71aoo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:779244202@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4"><span class="toc-number">3.</span> <span class="toc-text">对象头</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mark-Word"><span class="toc-number">3.2.</span> <span class="toc-text">Mark_Word</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">3.3.</span> <span class="toc-text">对象的状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90JOL%EF%BC%88Java-Object-Layout%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">分析JOL（Java Object Layout）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JOL%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">4.1.</span> <span class="toc-text">JOL工具包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">4.2.</span> <span class="toc-text">实例数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4-2"><span class="toc-number">4.3.</span> <span class="toc-text">对象头</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">锁的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E6%80%81"><span class="toc-number">5.1.</span> <span class="toc-text">无锁态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-number">5.2.</span> <span class="toc-text">偏向锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">举例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">5.3.</span> <span class="toc-text">轻量级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">举例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">5.4.</span> <span class="toc-text">重量级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B-3"><span class="toc-number">5.4.1.</span> <span class="toc-text">举例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%88%B0%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">无锁到重量级锁</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81%E5%88%B0%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">偏向锁到重量级锁</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%88%B0%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">5.4.1.3.</span> <span class="toc-text">轻量级锁到重量级锁</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E8%86%A8%E8%83%80"><span class="toc-number">6.</span> <span class="toc-text">锁的膨胀</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E6%80%81%E7%9A%84%E8%86%A8%E8%83%80"><span class="toc-number">6.1.</span> <span class="toc-text">无锁态的膨胀</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%88%B0%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-number">6.1.1.</span> <span class="toc-text">无锁到偏向锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%88%B0%E8%BD%BB%E9%87%8F%E9%94%81"><span class="toc-number">6.1.2.</span> <span class="toc-text">无锁到轻量锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%88%B0%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81-2"><span class="toc-number">6.1.3.</span> <span class="toc-text">无锁到重量级锁</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81%E7%9A%84%E8%86%A8%E8%83%80"><span class="toc-number">6.2.</span> <span class="toc-text">偏向锁的膨胀</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81%E5%88%B0%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">6.2.1.</span> <span class="toc-text">偏向锁到轻量级锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HashCode"><span class="toc-number">6.2.2.</span> <span class="toc-text">HashCode</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%81%8F%E5%90%91%EF%BC%88%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%89"><span class="toc-number">6.2.3.</span> <span class="toc-text">重偏向（不存在）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E9%87%8D%E5%81%8F%E5%90%91"><span class="toc-number">6.2.4.</span> <span class="toc-text">批量重偏向</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%92%A4%E9%94%80"><span class="toc-number">6.2.5.</span> <span class="toc-text">批量撤销</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E7%9A%84%E8%86%A8%E8%83%80"><span class="toc-number">6.3.</span> <span class="toc-text">轻量级锁的膨胀</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%88%B0%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81-2"><span class="toc-number">6.3.1.</span> <span class="toc-text">轻量级锁到重量级锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="toc-number">7.</span> <span class="toc-text">性能对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81-2"><span class="toc-number">7.1.</span> <span class="toc-text">偏向锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81-2"><span class="toc-number">7.2.</span> <span class="toc-text">轻量级锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">9.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 71ao</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Apf54CiWnak4g05AYgmoRy2F-gzGzoHsz',
      appKey: 'UcJUCGn8QyuNVFCfO7jNA4Jw',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>