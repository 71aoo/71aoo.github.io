<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>论文笔记：TheArt,Science,and Engineering of Fuzzing: A Survey</title>
      <link href="/2022/04/09/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%EF%BC%9ATheArt-Science-andEngineeringofFuzzing-ASurvey/"/>
      <url>/2022/04/09/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%EF%BC%9ATheArt-Science-andEngineeringofFuzzing-ASurvey/</url>
      
        <content type="html"><![CDATA[<h1>论文笔记：The Art, Science, and Engineering of Fuzzing: A Survey</h1><blockquote><p>前言：刚接触fuzz，有些地方可能不是很了解。希望大佬们不吝赐教（轻喷），指出有误地方， 不胜感激。</p></blockquote><h1>论文目的</h1><p>Fuzzing社区越来越活跃，无论是学术界还是工业界，关于Fuzzing的项目，文章越来越多。虽然Fuzzing发展越来越好，但是有点像野蛮生长，很多术语不统一，这对Fuzzing的学习和传播非常不利。</p><p>因此，查阅相关文献，尝试统一该领域各种解释。包括对术语解释，对fuzzer的每个阶段进行建模，解释其设计和选择之间的权衡利弊。</p><h1>术语</h1><ul><li>PUT（Program Under Test）:被测试程序，或者待测试程序。</li><li>Fuzzing：从预期的输入域选取输入值（选取值并非随机）去执行<strong>PUT。</strong></li><li>Fuzz Testing：通过<strong>Fuzzing</strong>测试被测试程序是否违反安全策略。</li><li>Fuzzer：在<strong>PUT</strong>做<strong>Fuzzing Testing</strong>的程序。</li><li>Fuzzer Campaign：<strong>Fuzzer</strong>在具有特定安全策略的<strong>PUT</strong>上执行模糊测试的过程，目的在于找出<strong>PUT</strong>中的bug。</li><li>Bug Oracle：某个程序，或者是<strong>Fuzzer</strong>中的组件，用于确定<strong>PUT</strong>的某次执行是否违反安全策略。</li><li>Fuzz Configuration：能够控制Fuzz算法的输入参数集合。</li><li>Seed：测试种子，用于构造测试用例。</li><li>Seed Pool：种子集合。</li></ul><h1>分类</h1><p>将fuzzer分为三类：黑盒、灰盒和白盒。</p><h2 id="黑盒">黑盒</h2><p>黑盒测试表示窥探不到PUT的内部状态，只能根据其输入输出来判断其行为；因此也被称为I/O驱动或数据型驱动测试。</p><h2 id="白盒">白盒</h2><p>白盒测试通过PUT的内部结构和收集执行PUT时信息来生成测试用例。相较于黑盒，白盒能够系统地探索PUT的内部状态空间。</p><h2 id="灰盒">灰盒</h2><p>灰盒介于黑盒和白盒之间，有时候它们之间的区别很模糊。</p><p>灰盒是白盒一种变体，每次模糊测试只能从其中获取PUT的内部结构和执行PUT时的部分信息，依靠不完整和近似的信息来提高测试速度，以此来测试更多的输入。</p><h1>Fuzz Testing算法</h1><p>这是个通用算法，Fuzzer模型，覆盖目前大多数Fuzzing技术。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/Untitled.png" alt="Untitled"></p><h2 id="Input">Input</h2><ul><li>C：Fuzz Configuration。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>l</mi><mi>i</mi><mi>m</mi><mi>i</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{limit}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">imi</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>：测试超时时间。</li></ul><h2 id="Output">Output</h2><ul><li>B：有限的bug集。</li></ul><h2 id="Preprocess">Preprocess</h2><p>在<strong>Fuzz Campaign</strong>执行之前执行。由用户提供的<strong>Fuzz Configuration</strong>作为输入，处理后返回可修改（potentially-modified）的<strong>Fuzz Configuration</strong>，用于测试PUT。具体怎么实现，取决于Fuzz算法</p><h3 id="实现方式">实现方式</h3><ul><li>插桩：这种方式主要应用于灰盒和白盒的<strong>Fuzzer</strong>，主要用于获取执行反馈，虽然获取执行反馈的方法有很多，但插桩的方式往往能获取到最有价值的反馈。插桩分为两种，静态插桩和动态插桩。<ul><li>静态插桩：<ul><li>在编译时对源码或者中间代码执行</li><li>运行时间开销比动态插桩短</li><li>如果需要对<strong>PUT</strong>的依赖库进行插桩，则需要对依赖库分别进行插桩，在进行相同编译。</li></ul></li><li>动态插桩：<ul><li>对<strong>PUT</strong>依赖库进行动态插桩相对于静态插桩更简单，但需要更高开销。</li></ul></li></ul></li><li>内存Fuzzing：如果测试的程序很大，但有时只是需要测试其中的一部分功能时，可以先存储一份内存快照，在新的测试用例直接写入内存之前，恢复内存快照，这样能最小化重新启动程序所需开销。<ul><li>内存API Fuzzing：不需要重新恢复<strong>PUT</strong>的状态，可以重复执行测试。缺点<ul><li>发现bugs无法复现，因为没办法构造目标函数的调用上下文。</li><li>不能捕获多个函数</li><li>可靠性取决于入口函数，但入口函数的寻找非常困难。</li></ul></li></ul></li></ul><h3 id="作用">作用</h3><ul><li>通过显式控制线程调度，可以触发程序不同的不确定性行为。（比如条件竞争）</li><li>种子选择：<ul><li>基本原则：种子数量最小化，测试覆盖范围最大化。<ul><li>使用分支对数计数器，计算分支覆盖率。</li><li>基于指令、分支和唯一基本块（basic blocks）数量计算覆盖率。</li></ul></li></ul></li><li>种子修剪：更少的种子能减少内存的消耗和获得更大的吞吐量。（可以发生在当前的Preprocess，也可以发生在CONFUPDATE）<ul><li>保证覆盖率不变的前提下，不断去迭代修剪种子。</li><li>赋予数量小的种子更高的优先级，但会造成发现特殊<strong>bug</strong>数量比随机种子少。</li><li>保留使用静态分析检测调用之间关系，扩展Fuzzer减少种子数量。</li></ul></li><li>准备程序驱动：直接测试<strong>PUT</strong>比较困难时，可以先准备一个驱动程序。得手动准备，并且可能在整个测试过程中只会使用一次。</li></ul><h2 id="CONTINUE">CONTINUE</h2><p>由一组配置（fuzz configuration）作为输入，返回布尔值，表示是否应该进行下一迭代，如在白盒测试中，如果没有发现更多的路径，那么就可以终止迭代。</p><h2 id="SCHEDULING">SCHEDULING</h2><p>三个输入参数，分别是<strong>C</strong>（fuzz Configuration），<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>e</mi><mi>l</mi><mi>a</mi><mi>p</mi><mi>s</mi><mi>e</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{elapsed}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">se</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>上一次运行时间，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>l</mi><mi>i</mi><mi>m</mi><mi>i</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{limit}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">imi</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>运行超时时间；通过这三个参数计算返回下一次迭代所需要<strong>conf</strong>（fuzz Configuration），这取决于<strong>Fuzzer</strong>的类型。</p><h3 id="FCS（Fuzz-Configuration-Scheduling）问题">FCS（Fuzz Configuration Scheduling）问题</h3><p>SCHEDULING算法也会有探索-利用冲突（<strong>exploration vs. exploitation</strong>）问题，是利用现有价值的配置信息，找出可能导致最有利的结果的配置，比如尽量找到更多的bug，还是保证配置信息拥有最大化的覆盖率。（算法开销可以消耗在获取更精确的信息上，以此来影响下一步决策，也可以花费在往当前被认为获得更有利的结果的<strong>fuzzing</strong>配置上。）</p><ul><li>黑盒<strong>FCS</strong>算法：因为获取到信息的局限性，给定配置只能得到的fuzz结果（包括crashes，bug数量和时间开销），因此，算法更倾向于选择能够获取更高成功率（获取crashes，bug）的配置。<ul><li>均匀采样</li><li>**WCCP/UW（Weighted Coupon Collector’s Problem with Unknown Weights）：**假设每一个配置信息最终都有一定成功率（能导致好的结果），并且随着时间的推移进行学习，概率的衰减保持明确的上限。</li><li><strong>MAB（multi-armed bandit）：<strong>一般能科学地解决探索-利用问题。设计</strong>MAB</strong>算法能够精确利用未衰减的配置。</li><li>标准化配置成功率：其他条件相同的情况下，能够更快模糊测试的配置，能够收集更多的bug，或者更快降低下一次成功概率的上限。</li><li>BFF将fuzz迭代的顺序按固定迭代次数排序更改为按固定时间量排序。</li></ul></li><li>灰盒<strong>FCS</strong>算法：灰盒中，FCS算法可以获取更丰富的信息，比如配置测试之后的覆盖率。<ul><li>EA（evolutionary algorithm）：维护大量的配置，每个配置都值——fitness，从中选取合适的配置用于遗传转换，例如突变和重组产生下一代，之后，后代中的部分可能变为新的配置。但是使用这些配置的前提是更适合找到新的bug或者crashes。但是，是什么因素让这些配置更适合或者说怎样选择这些配置。<ul><li>选择运行最快和最小的配置</li><li>维护一个配置队列，循环选择</li><li>使用选定的配置运行固定的次数</li></ul></li><li>AFLFast对EA算法进行了三个方面的优化<ul><li>在执行控制流配置中，选择被选择更少哪个，如果前面选择有冲突，则选择对应执行路径执行次数最少的配置。</li><li>选择配置时不再是轮询选择，而是基于优先级选择配置。</li><li>选择配置运行固定次数变为可变次数，取决于Power Schedule。</li></ul></li><li>引入静态分析增强。</li></ul></li></ul><h2 id="INPUT-GENERATION">INPUT GENERATION</h2><p>输入参数为可变的<strong>conf</strong>（Fuzz Configuration），输出为<strong>tcs</strong>（test cases）。因为测试用例本身内容的好坏，直接决定了bug是否会被触发，因此，<strong>INPUT GENERATION</strong>自然而然地成<strong>Fuzzer</strong>设计中最有影响的一环。根据技术实现将他们分为<strong>Generation-based和Mutation-based。</strong></p><ul><li><strong>Generation-based fuzzer or Model-based fuzzer</strong>：测试用例的产生取决于指定描述<strong>PUT</strong>预期输入的模型。</li><li><strong>Mutation-based fuzzer or Model-less fuzzer</strong>：测试用例的产生来自给定输入种子的突变，因为种子只是举例输入，尽管数量很大，它也不能完整描述<strong>PUT</strong>预期输入空间，因此也被称为无模型（Model-less）</li></ul><h3 id="Model-based"><strong>Model-based</strong></h3><ul><li><strong>预定义模型（Predefined Model）</strong><ul><li>可以由用户设置。</li><li>以系统调用模版形式定义一个输入模型，模版指定系统调用期望的数量和类型作为输入参数。</li><li>fuzzer内置针对特定语言或语法的模型。</li><li>支持特定网络协议模型，如TLS和NFC。</li><li>解析一组给定的种子生成代码碎片，然后将代码碎片随机组合，并用它来变异种子生成测试用例。</li><li>基于上一条，只针对XML和正则表达式。</li></ul></li><li><strong>推断模型（Inferred Model）：<strong>不依赖预定义和用户输入，依赖自动化输入格式和逆向协议，但是应用较少，有点类似于插桩，模型推断可以发生在</strong>Preporcess</strong>和<strong>CONFUPDATE。</strong><ul><li>发生在<strong>Preporcess</strong>时：用PUT有用数据，预测合适的输入。<ul><li>给定一组种子和语法，使用数据驱动的方式推断一个概率的上下文敏感的语法（probabilitistic context-sensitive grammar），然后使用它来生成新的种子集合，侧重点在于生成语义有效的输入。</li><li>通过分析系统API日志学习内核API模型（<strong>kernel API model）</strong>，使用其生成可以调用API队列的C语言代码。</li><li>将 JavaScript 代码分解为“代码块（<strong>code bricks</strong>）”，并使用静态分析和动态分析计算装配约束（<strong>ssembly constraints</strong>），用以描述何时可以将不同的代码快组装或合并在一起，用于生成语义合法的测试用例。</li><li>使用神经网络机器学习算法从给定的测试文件集合学习模型。</li></ul></li><li>发生在<strong>CONFUPDATE</strong>时：在每次模糊测试迭代后更新模型。<ul><li>捕获程序产生的网络包推断网络协议模型，然后使用这个模型测试程序。</li><li>内部构建状态机，并映射与状态相关的消息令牌，然后用此信息生成覆盖状态机中更多的状态的测试用例。</li><li>通过观察I/O行为推断出Web服务的状态机，用这个模型扫描Web漏洞。</li><li>从I/O样例集合中合成上下文不敏感的语法，然后使用它来测试程序。</li><li>为添加到种子池的每个种子构建模型，然后用该模型从该种子生成新的输入。</li></ul></li></ul></li><li><strong>编码器模型（Encoder Model）</strong>：通常用于测试解析某种文件格式的编码器程序，解析文件格式的不同可以被视为一种隐式模型。<ul><li>使用隐式模型生成测试用例，程序切片会悄悄改变编码程序的行为，以至于产生轻微畸形的测试用例。</li></ul></li></ul><h3 id="Model-less（Mutation-based）"><strong>Model-less（Mutation-based）</strong></h3><p>随机测试生成满足指定路径条件的测试用例效率不高。</p><ul><li>位翻转（Bit-Flipping）<ul><li>翻转固定的位数。</li><li>随机翻转位数。</li><li>采用用户配置决定翻转位数。</li><li>对每个种子使用一组指数的突变率，并为突变率分配更多的迭代。</li><li>利用白盒程序分析来推断每个种子好的突变率。</li></ul></li><li>算数突变（Arithmetic Mutation）<ul><li>选择一个字节型列作为整数，对整数进行简单的运算，用计算结果代替选择的字队列，这样可以将突变的影响限制在一个很小的数字内。</li></ul></li><li>块突变（Block-based Mutation）：Block是种子的一个字节序列。<ul><li>在种子的随机位置插入随机生成的Block。</li><li>从种子中随机选择Block删除。</li><li>随机选择Block替换为随机值。</li><li>随机变换Block序列。</li><li>使用一个随机Block改变种子大小。</li><li>从一个种子中随机选取Block随机插入或替换掉另一个种子的Block。</li></ul></li><li>字典突变（Dictionary-based Mutation）<ul><li>使用一组预定义隐含重要语义权重的值进行突变。</li></ul></li></ul><h3 id="基于白盒">基于白盒</h3><p>有的Fuzzer利用白盒程序分析来查找有关 PUT 接收的输入的信息，将其用于黑盒或者灰盒测试。</p><ul><li>动态符号执行（Dynamic Symbolic Execution）<ul><li>动态符号执行是传统的符号执行的变体，在动态符号执行过程中，符号执行和实际的执行（concrete input）会同时进行，因此被称为concolic（concrete + symbolic）testing。</li><li>建立符号表达式。为执行过程中遇到的每一条分支指令建立一个路径公式，如果存在一个实际的输入，能够执行目标路径，那么就说该路径公式是可满足的。</li></ul></li><li>Guided Fuzzing：使用静态分析或者动态分析来增强Fuzzing的效果。<ul><li>使用开销较大的程序分析PUT，以此来获取有关于PUT的有用信息。</li><li>使用上一条分析获取的有用信息生成测试用例。</li><li>使用细粒度的污点分析来查找流入关键系统调用或API调用的输入字节（hot bytes）。<ul><li>在编译时期执行静态分析，探索式查找可能包含错误的循环，例如空指针引用，然后通过污点分析计算输入字节与循环之间的关系，最后只将关键字节变为符号，运行动态符号执行。</li><li>使用污点分析将每个路径约束和对应的字节联系起来，然后执行梯度下降式搜索算法，去引导突变朝解决约束的方向走。</li><li>通过插桩比较和查找所有操作对象与给定输入之间的对应关系，来检测PUT中如何使用输入。</li></ul></li></ul></li><li>PUT Mutation：如何绕过检验和验证。<ul><li>stitched dynamic symbolic execution：在存在校验的情况下生成测试用例。<ul><li>使用污点分析来校验和测试指令，并通过打补丁来绕过验证。当发现程序崩溃时，会使用正确的验证作为输入，以此来生成使未修改PUT崩溃的测试用例。</li></ul></li><li>在上面方法的基础上，通过灰盒测试，能够有效渗透所有类型的条件分支。<ul><li>首先使用一组NCC（Non-Critical Checks），它可以在不改变程序逻辑情况下进行分支转换。当<strong>fuzzing campaign</strong>发现新的路径停止时，选择一个NCC，对其进行转换，然后在修改过的PUT上重新进行<strong>fuzzing campaign</strong>；最后，当发现崩溃时，尝试使用符号执行在原始程序上复现。</li></ul></li></ul></li></ul><h2 id="INPUT-EVALUATION">INPUT EVALUATION</h2><p>这一步主要是决定如何处理执行结果。由conf（当前fuzz configuration）,tcs(test cases)， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">O_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>（fuzzer 内置参数）作为输入，输出执行信息（execinfos）和bug集合。</p><h3 id="Bug-Oracle（O-bug-）">Bug Oracle（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">O_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>）</h3><ul><li>将导致程序执行终止的致命性信号作为violation。<ul><li>对内存漏洞十分有效。</li></ul></li><li>使用<em><strong>sanitizer</strong></em>技术检测，有效检测不安全的，或预期之外的程序行为，以及中止程序。<ul><li><strong>内存类型安全（Memory and Type Safety）</strong>：分为空间性和时间性错误。空间性错误指在对象之外被间接引用指向它原本指向的对象之外的情况下。时间性错误通常发生在指针失效后被引用。<ul><li>在编译时对程序进行插桩，采用影子内存（shadow memory），允许每个内存地址在被解引用之前，快速地进行合法检查。</li><li>在分配对象之间创建大块不可访问内存——红色空间（redzones），如果这些红色空间被指针访问了，那就有可能造成崩溃。</li><li>在编译时插桩，将边界和时间信息与每个指针相关联，理论上可以检测所有的空间性和时间性错误。</li><li>在编译时插桩，检测***C++***类型转换错误。</li><li>在运行时检测原始程序中不可能的控制流转换，如找到非法篡改程序控制流的测试用例。</li></ul></li><li><strong>未定义行为（Undefined Behaviors）</strong><ul><li>在编译时插桩，使用影子内存（shadow memory）来表示每个可寻址位是否已经被初始化，用于检测<em><strong>C</strong></em>和***C++***中使用未初始化内存而引起的未定义行为。</li><li>编译时修改程序，可以检测错位指针、被零除、解引用空指针和整数溢出等未定义行为。</li><li>编译时修改程序，检测数据竞争（data races）</li></ul></li><li><strong>输入验证（Input Validation）</strong>：如XSS，SQL注入。<ul><li>使用真实的Web浏览器解析测试用例，提取DOM树，并将它与成功执行XSS攻击的手动指定模式进行比较。</li><li>通过使用数据库代理来拦截Web应用程序与数据库之间的通信，以此检测是否触发有害行为。</li></ul></li><li><strong>语义差异（Semantic Difference）</strong><ul><li>与行为相似（但不相同）的程序相比较，之间的差异可能就是错误。</li><li>在单个程序上使用多个不同的输入进行测试测试，将突变从PUT的输入映射到它的输出，可以用来识别信息泄漏。</li></ul></li></ul></li></ul><h3 id="执行优化（Execution-Optimizations）">执行优化（Execution Optimizations）</h3><p>每一次<strong>fuzz</strong>迭代都需要重新开启一个进程加载PUT，很浪费性能。现在的Fuzzer提供一个<strong>fork-server，<strong>每一次新的</strong>fuzz</strong>迭代可以对已经初始化的进程进行<strong>fork</strong>，降低迭代的开销。</p><h3 id="分流（Triage）">分流（Triage）</h3><p>分析和报告违反策略测试用例的过程，分为三个步骤：重复数据删除（Deduplication），优先级（prioritization）和测试用例最小化。</p><ul><li><strong>重复数据删除（Deduplication）</strong>：删除结果中触发相同错误测试用例的过程，理想情况下，每个测试用例都会触发一个独特的错误。可以减少硬盘空间的浪费和方便用户更简单理解结果。<ul><li>堆栈回溯哈希（Stack Backtrace Hashing）：在程序崩溃是记录堆栈回溯，并更具回溯内容分配堆哈希。<ul><li>只对函数名或函数地址进行哈希运算。</li><li>同时对函数名和偏移量或行进行哈希运算。</li><li>使用两个哈希：一个主要哈希，只对函数名进行哈希运算，将不同崩溃组合在一起。次要哈希，对函数名和行号，还可能包括不限数量的堆栈帧，进行哈希，更精确。</li></ul></li><li>基于覆盖的重复数据删除（Coverage-based Deduplication）<ul><li>记录PUT每条边的执行覆盖率，并粗略计算每条边命中次数。</li></ul></li><li>语义感知分析重复数据删除（Semantics-aware Deduplication）<ul><li>从每个崩溃中进行反向数据流分析，再从分析中恢复语义。</li></ul></li></ul></li><li><strong>优先级和可利用程度（Prioritization and Exploitability）</strong><ul><li>根据严重程度和独特性对有问题的测试用例进行分组和排名。</li><li>使用简单污点分析进行分级。</li></ul></li><li><strong>测试用例最小化（Test case minimization）</strong>：保证结果不变的前提下尽可能减小测试用例的大小。<ul><li>尝试最小化与原始种子文件不同的位数。</li><li>尝试通过在合适的情况下将字节设置为零和缩短测试用例的长度来简化测试用例。</li><li>尝试通过以指数递减的方式删除相邻行或字节块来最小化文件。</li></ul></li></ul><h2 id="CONFUPDATE（CONFIGURATION-UPDATING）">CONFUPDATE（CONFIGURATION UPDATING）</h2><p>由C（fuzz configuration），conf（当前fuzz configuration）， 执行迭代后的信息（execinfos）作为输入，返回更新后的C（fuzz configuration）。</p><p>不同于白灰盒，黑盒每一次迭代都不能够收集到任何允许它修改的信息，从而无法更新配置信息；而白灰盒可以通过迭代后得到的信息不断更新配置信息。因此，CONFUPDATE函数可以作为区分黑盒和白灰盒行为的重要角色。</p><h3 id="进化种子池更新（Evolutionary-Seed-Pool-Update）">进化种子池更新（Evolutionary Seed Pool Update）</h3><p>EA（Evolutionary Algorithm）维护一个种子池，里面会包含一些有希望的个体，随着<strong>fuzzing campaign</strong>的进行不断进化，可能导致新的种子被发现。</p><ul><li>使用节点或分支覆盖率作为计算点：如果测试用例发现新的分支或节点，则将它加入到种子池中。因此，种子池是代表所有可达路径多样化的工具，也可以代表PUT当前探索的情况。</li></ul><h3 id="维护minset（Maintaining-a-Minset）">维护minset（Maintaining a Minset）</h3><p>创建新的配置时，可能结果集会非常大。因此，最好是能够维护一个**minset，**如能使覆盖率最大化，而本身最小化的测试用例集。</p><ul><li>维护一个专门用于配置更新的minset，完全删除不在minset中的配置。</li><li>同上，但不删除配置，而是标记在minset中的配置优先级更高，被用于测试的机会更高，这样合理保持了队列循环速度和测试用例多样性之间的平衡。</li></ul><h1>参考文章</h1><ul><li><a href="https://2020.icse-conferences.org/details/icse-2020-Journal-First/82/The-Art-Science-and-Engineering-of-Fuzzing-A-Survey">The Art, Science, and Engineering of Fuzzing: A Survey (ICSE 2020 - Journal First) - ICSE 2020 (icse-conferences.org)</a></li><li><a href="https://blog.csdn.net/qq_40398985/article/details/103585735">https://blog.csdn.net/qq_40398985/article/details/103585735</a></li><li><a href="https://blog.csdn.net/sinat_38816924/article/details/114264772">https://blog.csdn.net/sinat_38816924/article/details/114264772</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 论文笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzz </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>论文笔记：Highly Precise Taint Analysis For Android Application</title>
      <link href="/2021/11/16/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%EF%BC%9AHighlyPreciseTaintAnalysisForAndroidApplication/"/>
      <url>/2021/11/16/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%EF%BC%9AHighlyPreciseTaintAnalysisForAndroidApplication/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p><a href="https://www.abartel.net/static/p/tr-2013-taintandroid.pdf">Highly Precise Taint Analysis for Android Applications</a>这篇论文从标题我们就可以知道，就是讲述如何对安卓应用做高精度的污点分析，其核心点主要在两个方面：</p><ul><li><p>如何对安卓生命周期函数，以及回调函数建模，以便更好的建立调用图。</p></li><li><p>基于IFDS框架做污点分析和<strong>按需别名分析（On-demand alias analysis）</strong>。</p></li></ul><p>因为个人对安卓一窍不通，所以，这边文章主要记录，它是<strong>如何利用IFDS框架做污点分析，以及按需别名分析</strong>。</p><h1>抽象分析语义</h1><p>该论文引用了这篇<a href="https://link.springer.com/chapter/10.1007/978-3-642-37057-1_15">Andromeda: Accurate and Scalable Security Analysis of Web Applications</a>论文的标准表示法来定义抽象分析语义。</p><p><strong>Formalization Domains</strong>如下</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211108151509831.png" alt="image-20211108151509831"></p><p><code>VarId</code>表示程序变量名，每一个变量名指向一个对象（<strong>object</strong>），但同一个对象可以拥有多个<code>VarId</code>；<code>FieldId</code>表示对象的属性，它存在<strong>heap</strong>中；<code>Loc</code>表示内存地址；<code>Val</code>表示某个值，即内存地址，当然，这个值有可能为空。因此<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>a</mi><mi>l</mi><mo>=</mo><mi>L</mi><mi>o</mi><mi>c</mi><mo>∪</mo><mo stretchy="false">{</mo><mi>n</mi><mi>u</mi><mi>l</mi><mi>l</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">Val = Loc \cup \{null\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">oc</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mclose">}</span></span></span></span>；<strong>Environment</strong>表示局部变量名与其值之间的映射集合；<code>Heap</code>用来表示<strong>heap</strong>中的元素与其值之间的映射集合；程序某点状态（<code>States</code>）也就所有变量和属性的状态。</p><p>用上面<strong>Formalization Domains</strong>来表达一条<code>Stmt</code>的语义，如下：</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211108154452406.png" alt="image-20211108154452406"></p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span>表示的<code>States</code>。**x = new Object()**表示变量名<code>x</code>指向对象<code>o</code>，对象本身没有像基本类型一样的值，它的内存地址和它的值其实同一个东西，值即所在内存地址，内存地址就是它的值。<strong>x = y</strong>，<code>y</code>赋值给<code>x</code>，即变量名<code>x</code>指向了变量名<code>y</code>所指向的值。</p><h1>方法定义</h1><p>为了更好的解释分析过程，作者定义了几个方法：</p><ul><li>arrayElem(x)：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>a</mi><mi>r</mi><mi>I</mi><mi>d</mi><mo>→</mo><mi>B</mi><mi>o</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">VarId \rightarrow Boolean</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">oo</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span></span></span></span>，如果变量<code>x</code>没有引用数组元素就返回<strong>True</strong>。</li><li>static(x)：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mi>I</mi><mi>d</mi><mo>→</mo><mi>B</mi><mi>o</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">FieldId \rightarrow Boolean</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">oo</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span></span></span></span>，如果变量<code>x</code>是静态变量，也就是全局变量，就返回<strong>True</strong>。</li><li>immut(x)：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>a</mi><mi>r</mi><mi>I</mi><mi>d</mi><mo>→</mo><mi>B</mi><mi>o</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">VarId \rightarrow Boolean</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">oo</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span></span></span></span>，如果变量<code>x</code>是原始类型变量（如int，String等）就返回<strong>True</strong>。</li><li>source(s)：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>m</mi><mi>t</mi><mo>→</mo><mi>ρ</mi><mo stretchy="false">(</mo><mi>V</mi><mi>a</mi><mi>r</mi><mi>I</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Stmt \rightarrow \rho(VarId)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;"></span><span class="mord mathnormal">St</span><span class="mord mathnormal">m</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ρ</span><span class="mopen">(</span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>，返回被<code>source</code>表达式污染的变量名集合，没有就返回空集。</li><li>native(s)：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>m</mi><mi>t</mi><mo>→</mo><mi>B</mi><mi>o</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">Stmt \rightarrow Boolean</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;"></span><span class="mord mathnormal">St</span><span class="mord mathnormal">m</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">oo</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span></span></span></span>，如果表达式<code>s</code>包含<strong>native</strong>方法调用就返回<strong>True</strong>。</li><li>nativeTaints(x)：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>m</mi><mi>t</mi><mo>→</mo><mi>ρ</mi><mo stretchy="false">(</mo><mi>V</mi><mi>a</mi><mi>r</mi><mi>I</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Stmt \rightarrow \rho(VarId)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;"></span><span class="mord mathnormal">St</span><span class="mord mathnormal">m</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ρ</span><span class="mopen">(</span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>，返回<strong>native</strong>方法调用后被污染值的集合。</li><li>nativeAlias(s)：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>m</mi><mi>t</mi><mo>→</mo><mi>ρ</mi><mo stretchy="false">(</mo><mi>V</mi><mi>a</mi><mi>r</mi><mi>I</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Stmt \rightarrow \rho(VarId)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;"></span><span class="mord mathnormal">St</span><span class="mord mathnormal">m</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ρ</span><span class="mopen">(</span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>​，返回可能被污染的值的别名集合。</li></ul><h1>access path</h1><p>下面介绍分析过程时，对对象的属性，也就是别名，用<strong>access path</strong>形式来表示，像这样<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>。</p><p>如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">x.f.g.h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathnormal">h</span></span></span></span>，<code>x</code>是属性<code>f</code>的基对象，<code>x.f</code>时属性<code>g</code>的基对象，以此类推，用<strong>access path</strong>表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">x.f^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.008548em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span>，即<strong>access path</strong>路径长度为3。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">x.f^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.008548em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span>不仅仅表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">x.f.g.h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathnormal">h</span></span></span></span>，它可以表任意以变量<code>x</code>为基对象，<strong>access path</strong>路径长度为3的别名。如果<strong>access path</strong>路径长度为0，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mn>0</mn></msup></mrow><annotation encoding="application/x-tex">x.f^0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.008548em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span>，表示<code>x</code>本身。</p><p>同时它还可以这样表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo>=</mo><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mo>+</mo><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">x.f^p = x.f^n + x.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mi>n</mi><mo>+</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">p = n + m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">m</span></span></span></span>。</p><h1>污点分析</h1><p>这里的污点分析是基于IFDS框架来实现的，而IFDS框架把数据流的传播分成四个流函数（Flow Function）:</p><ul><li>NormalFlowFunction</li><li>CallFlowFunction</li><li>ReturnFlowFunction</li><li>CallToReturnFlowFunction</li></ul><h2 id="NormalFlowFunction">NormalFlowFunction</h2><p>除去程序中调用语句和返回语句，<strong>NormalFlowFunction</strong>可以作用于其他所有的语句。</p><p>但是要注意一点，因为在最开始，作者定义了，<strong>只有方法调用才会产生新的source，如getSource()</strong>；因此，在这个函数里不会产生新的污染源（source），它只能<strong>传播、保存和去除</strong>现有的污染点。</p><p>为了保证结果是<strong>sound</strong>，这里对数组进行了不敏感处理，也就是说，只要数组中的某一个元素被污染，会被视为整个数组被污染。</p><p>对于一个表达式<code>s </code>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>∈</mo><mi>S</mi><mi>t</mi><mi>m</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">s \in Stmt</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;"></span><span class="mord mathnormal">St</span><span class="mord mathnormal">m</span><span class="mord mathnormal">t</span></span></span></span>，形式为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mo>=</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n = y.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>，则数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>T</mi><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mo>∪</mo><mo stretchy="false">{</mo><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mi mathvariant="normal">∀</mi><mi>p</mi><mo>:</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo>∈</mo><mi>T</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mi mathvariant="normal">/</mi><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><mspace width="1em"/><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mo>∗</mo></msup><mo mathvariant="normal">∉</mo><mi>T</mi><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mi>E</mi><mi>l</mi><mi>e</mi><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mspace width="1em"/><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>w</mi><mi>i</mi><mi>s</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T \stackrel{s}{\rightarrow} \left\{  \begin{array}{lr}    T \cup \{x.f^n.f^p\} {\quad} \forall{p} :y.f^m.f^p \in T \\    T /{x.f^n}{\quad}  y.f^m.f^* \notin T \land \lnot arrayElem(x.f^n) \\    T {\quad} otherwise  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.968262em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.49999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.49199em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292009999999999em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-4.30002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">{</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord">∀</span><span class="mord"><span class="mord mathnormal">p</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="mrel">∈</span></span><span class="mord vbox"><span class="thinbox"><span class="llap"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="inner"><span class="mord"><span class="mord">/</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span></span><span class="fix"></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">¬</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal" style="margin-right:0.01968em;">El</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">y.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>或<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">y.f^m.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span>存在污染集<strong>T</strong>中，则也要相应的把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>或<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span> 加入污染集；如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">y.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>或<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">y.f^m.f^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span>不存在污染集中，且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>没有引用任何的数组元素，则从污染集中去掉<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>，其他情况，污染集不变。</p><p>表达式<code>s</code>，形式为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mo>=</mo><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">x.f^n = new ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">...</span></span></span></span>，则数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>T</mi><mo><mover><mo><mo>→</mo></mo><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mo>=</mo><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mover></mo><mi>T</mi><mi mathvariant="normal">/</mi><mo stretchy="false">{</mo><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mo>∗</mo></msup><mo>∈</mo><mi>T</mi><mo>∣</mo><mi mathvariant="normal">¬</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mi>E</mi><mi>l</mi><mi>e</mi><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mo stretchy="false">)</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">T \stackrel{x.f^n = new ...}{\rightarrow} T/\{x.f^n.f^* \in T \mid \lnot arrayElem(x.f^n) \}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.230958em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.230958em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.613978em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mtight">.</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385428571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mtight">...</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">/</span><span class="mopen">{</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.738696em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">rr</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal" style="margin-right:0.01968em;">El</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)}</span></span></span></span></span></p><p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>或<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">x.f^n.f^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span>在污染集里面，或者<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>没有引用任何的数组元素，则从污染集中去除<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">x.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>或<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup><mi mathvariant="normal">.</mi><msup><mi>f</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">x.f^n.f^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span>。</p><p>表达式<code>s</code>还有一种特殊情况，形式为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mi>a</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">x = a + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">b</span></span></span></span>，数据流规则为：只要<code>a</code>或者<code>b</code>有一方被污染，则<code>x</code>就会被污染。</p><h2 id="CallFlowFunction">CallFlowFunction</h2><p><strong>CallFlowFunction</strong>处理调用点（caller）与被调用过程之间（callee）的数据流。</p><p>对于形式<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">c.m(a_0,...,a_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>调用，其数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mo>∪</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><msub><mi>p</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>∧</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>c</mi><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{callee} \stackrel{s}{\rightarrow} \cup \left\{  \begin{array}{lr}    \{this.f^m\} {\quad} c.f^m \in T_{caller} \\    \{p_{i}.f^p\}{\quad}  a_i.f^p \in T_{caller} \\    \{y.f^p\}{\quad} x.f^q \in T_{caller} \land static(y.f^q)  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1182619999999999em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="mord">∪</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.49999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.49199em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292009999999999em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-4.30002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">c.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>在<code>caller</code>的<code>context</code>就已经被污染，那么传入自己本身的方法中，需要改变相对的<code>context</code>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>→</mo><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">c \rightarrow this</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span></span></span></span> 。</p><p>如果实参<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">a_i.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span>在<code>caller</code>的<code>context</code>就已经被污染，那么需要将映射的形参加入到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{callee}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</p><p>最后一个是将在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{caller}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的全局变量，加入到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{callee}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</p><h2 id="ReturnFlowFunction">ReturnFlowFunction</h2><p><strong>ReturnFlowFunction</strong>处理被调用过程返回到调用点之间的数据了。</p><p>在这里，对原始类型变量有一步特殊的处理；如果原始类型变量在调用点之前未被污染，那么它也不会在被调用过程中被污染，也就是原始类型变量经过<code>callee</code>之后返回，返回到<code>caller</code>的<code>context</code>中，污染状态与调用之前保持一致。其他情况，按数据流规则映射回<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{caller}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p><p>对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b = c.m(a_0,...,a_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mo>∪</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><msub><mi>p</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub><mo>∧</mo><mi mathvariant="normal">¬</mi><mi>i</mi><mi>m</mi><mi>m</mi><mi>u</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><mi>x</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub><mo>∧</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>c</mi><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>b</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>v</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><mi>r</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>v</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{caller} \stackrel{s}{\rightarrow} \cup \left\{  \begin{array}{lr}    \{c.f^m\} {\quad} {\quad}this.f^m \in T_{callee} \\    \{a_{i}.f^p\}{\quad}{\quad} p_i.f^p \in T_{callee} \land \lnot immut(a_i) \\    \{y.f^q\}{\quad}{\quad} x.f^q \in T_{callee} \land static(y.f^q) \\    \{b.f^v\}{\quad}{\quad} r.f^v \in T_{callee}  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1182619999999999em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:4.80004em;vertical-align:-2.15002em;"></span><span class="mord">∪</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65002em;"><span style="top:-1.8999899999999998em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.8919899999999998em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.6160000000000001em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.6160000000000001em' style='width:0.889em' viewBox='0 0 889 616' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V616 H384z M384 0 H504 V616 H384z'/></svg></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292009999999999em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.6160000000000001em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.6160000000000001em' style='width:0.889em' viewBox='0 0 889 616' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V616 H384z M384 0 H504 V616 H384z'/></svg></span></span><span style="top:-4.90002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">¬</span><span class="mord mathnormal">imm</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal">b</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果<code>c</code>自身属性在<code>callee</code>中被污染，则传回<code>caller</code>时，需要改变相对<code>context</code>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>→</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">this \rightarrow c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">c</span></span></span></span>。</p><p>如果调用该过程时传入的数据，也就是形参，在<code>callee</code>中被污染，且不是原始类型，则需要映射回给实参。</p><p>如果<code>callee</code>中有全局属性被污染了，则也需要映射回给<code>caller</code>。</p><p>如果<code>callee</code>中返回值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>v</mi></msup></mrow><annotation encoding="application/x-tex">r.f^v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span></span></span></span>被污染了，则需要将在<code>caller</code>中接受返回值的变量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>v</mi></msup></mrow><annotation encoding="application/x-tex">b.f^v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">b</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span></span></span></span>，也加入到污染集<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{caller}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</p><h2 id="CallToReturnFlowFunction">CallToReturnFlowFunction</h2><p><strong>CallToReturnEdge</strong>是<strong>exploded supergraph</strong>一条特殊的边，其一大作用就是为了保证精度。</p><p><strong>CallToReturnFlowFunction</strong>需要判断是否会有新的<code>source</code>，和对<code>native</code>方法特殊处理。</p><p>对于表达式<code>s</code>，形式为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b = c.m(a_0,...,a_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>T</mi><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mo>∪</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mo>∪</mo><mi>n</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>T</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo><mspace width="1em"/><mi>n</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>∧</mo><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><mi>T</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mo>∪</mo><mo stretchy="false">{</mo><mi>x</mi><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mi>x</mi><mo>∈</mo><mi>s</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>c</mi><mi>e</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>w</mi><mi>i</mi><mi>s</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T \stackrel{s}{\rightarrow} \cup \left\{  \begin{array}{lr}    T \cup nativeTaint(s,T) {\quad} native(s) \land a_i.f^m \in T \\    T \cup \{x\}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad} x \in source(s) \\    T {\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad} otherwise  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.968262em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="mord">∪</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.49999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.49199em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292009999999999em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-4.30002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">na</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">ain</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">na</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">{</span><span class="mord mathnormal">x</span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">so</span><span class="mord mathnormal">u</span><span class="mord mathnormal">rce</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果<code>s</code>里包含<code>native</code>方法调用，且传入的实参<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">a_i.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>调用之前就被污染，则需要将<code>s</code>调用之后返回的值，或者传入的参数一起加入到现有污染集中。</p><p>如果<code>s</code>里包含<code>source</code>点，需要将被<code>source</code>污染变量名集合<code>x</code>加入到现有污染集。</p><p>其他情况，保持现有污染集不变。</p><h1>按需别名分析</h1><p>为什么叫按需别名分析？</p><p>一般情况下，别名分析是与污点分析一起执行，但是这样，非常的损耗性能，而且会处理许多没有意义的别名。</p><p>这里的别名分析也与前面污点分析有些区别，污点分析是基于IFDS框架的前向分析，就是顺着<strong>exploded supergraph</strong>，而别名分析却与污点分析刚好相反，它也是基于IFDS框架，但它是反向分析，从程序某一点开始，往回走。</p><p>还有一点，别名不会和污点分析一起执行，而是在出现有别名被污染的时候，才会促发别名分析，因此叫按需别名分析，下面一张图简单概括按需别名分析的分析流程。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211107150238056.png" alt="image-20211107150238056"></p><p>按需别名分析也是基于IFDS框架，那么它的核心还是离不开传播数据流的四个流函数：</p><ul><li>NormalFlowFunction</li><li>CallFlowFunction</li><li>ReturnFlowFunction</li><li>CallToReturnFlowFunction</li></ul><p>在污点分析时，如果找到新的被污染的别名，需要进行别名分析的时候，会使用被污染别名信息集合<strong>A</strong>来记录别名信息，当<strong>A</strong>被清空的时候，别名分析也就停止。</p><h2 id="NormalFlowFunction-2">NormalFlowFunction</h2><p>对于表达式<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mo>=</mo><mi>y</mi><mi mathvariant="normal">.</mi><mi>g</mi></mrow><annotation encoding="application/x-tex">x.f = y.g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>，数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mo>∪</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>A</mi><mi mathvariant="normal">/</mi><mo stretchy="false">{</mo><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo stretchy="false">}</mo><mo>∪</mo><mo stretchy="false">{</mo><mi>y</mi><mi mathvariant="normal">.</mi><mi>g</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mi mathvariant="normal">∀</mi><mi>p</mi><mo>:</mo><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo>∈</mo><mi>A</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>A</mi><mspace width="1em"/><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>w</mi><mi>i</mi><mi>s</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">A \stackrel{s}{\rightarrow} \cup \left\{  \begin{array}{lr}   A/\{x.f.f^p\} \cup \{y.g.f^p\} {\quad}\forall{p}: x.f.f^p \in A \\   A {\quad} otherwise  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.968262em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="mord">∪</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord">/</span><span class="mopen">{</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord">∀</span><span class="mord"><span class="mord mathnormal">p</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">x.f.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span>在被污染别名信息集合<strong>A</strong>里面，则需要从<strong>A</strong>里面去掉<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">x.f.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span>，之后加上<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi mathvariant="normal">.</mi><mi>g</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">y.g.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span>。</p><p>其他情况保持<strong>A</strong>集合不变。</p><p>同样的，需要对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mo>=</mo><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">x.f = new ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">...</span></span></span></span>情况进行特殊处理，数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo><mover><mo><mo>→</mo></mo><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mo>=</mo><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mover></mo><mi>A</mi><mi mathvariant="normal">/</mi><mo stretchy="false">{</mo><mi mathvariant="normal">∀</mi><mi>m</mi><mo>:</mo><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mo>∗</mo></msup><mo>∈</mo><mi>A</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">A \stackrel{x.f = new ...}{\rightarrow} A/\{\forall{m}:x.f.f^* \in A\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.200086em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.200086em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.613978em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mtight">.</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mtight">...</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord">/</span><span class="mopen">{</span><span class="mord">∀</span><span class="mord"><span class="mord mathnormal">m</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.933136em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.738696em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mclose">}</span></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mo>=</mo><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">x.f = new ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">...</span></span></span></span>是初始化操作，因此，需要将<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">x.f.f^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span>这一整条<code>access path</code>从<strong>A</strong>清除。这可能是按需别名分析停止条件之一。</p><h2 id="CallFlowFunction-2">CallFlowFunction</h2><p>因为是反向分析，所以在这里，<strong>CallFlowFunction</strong>处理的是调用点与被调用过程返回点之间的数据流。</p><p>对于表达式<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b = c.m(a_0,...,a_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>A</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mo>∪</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>r</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mi>b</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><msub><mi>A</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><msub><mi>A</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo>∈</mo><msub><mi>A</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>∧</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>c</mi><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">A_{callee} \stackrel{s}{\rightarrow} \cup \left\{  \begin{array}{lr}   \{r.f^m\}{\quad}  b.f^m \in A_{caller} \\    \{this.f^m\} {\quad} c.f^m \in A_{caller} \\    \{y.f^q\}{\quad} y.f^q \in A_{caller} \land static(y.f^q)  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1182619999999999em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="mord">∪</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.49999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.49199em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292009999999999em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-4.30002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">b</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">b.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">b</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>被污染，则<code>callee</code>中的返回值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">r.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>也会被污染。</p><p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">c.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>在<code>caller</code>中被污染，则在<code>callee</code>中需要改变相对的<code>context</code>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>→</mo><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">c \rightarrow this</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span></span></span></span></p><p>如果全局属性<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup></mrow><annotation encoding="application/x-tex">y.f^q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span></span></span></span>在<code>caller</code>中被污染，则也需要传入到<code>callee</code>中。</p><h2 id="ReturnFlowFunction-2">ReturnFlowFunction</h2><p>在反向分析中，<strong>ReturnFlowFunction</strong>处理的是被调用过程的起始点与调用点之前的数据流，需要将形参映射回实参。</p><p>对于表达式<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">c.m(a_0,...,a_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，其数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>A</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msub><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mo>∪</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><msub><mi>A</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><msub><mi>p</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup><mo>∈</mo><msub><mi>A</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">{</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo>∈</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>e</mi></mrow></msub><mo>∧</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>c</mi><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">A_{caller} \stackrel{s}{\rightarrow} \cup \left\{  \begin{array}{lr}    \{c.f^m\} {\quad} {\quad}this.f^m \in A_{callee} \\    \{a_{i}.f^p\}{\quad}{\quad} p_i.f^p \in A_{callee} \\    \{y.f^q\}{\quad}{\quad} y.f^q \in T_{callee} \land static(y.f^q) \\  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1182619999999999em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="mord">∪</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.49999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.49199em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292009999999999em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-4.30002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">ee</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果<strong>c</strong>本身属性<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">this.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>被污染，则映射回<code>caller</code>需要改变相对的<code>context</code>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>→</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">this \rightarrow c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal">c</span></span></span></span></p><p>如果形参<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">p_i.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span>在<code>callee</code>中被污染，则需要映射回<code>caller</code>的实参<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">a_i.f^p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span></span>。</p><p>如果全局属性<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>q</mi></msup></mrow><annotation encoding="application/x-tex">y.f^q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span></span></span></span></span></span></span>在<code>callee</code>中被污染，则也需要传入到<code>caller</code>中。</p><h2 id="CallToReturnFlowFunction-2">CallToReturnFlowFunction</h2><p><strong>CallToReturnFlowFunction</strong>需要对<code>native</code>方法进去处理。</p><p>对于表达式<code>s</code>，形式为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b = c.m(a_0,...,a_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，数据流规则如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo><mover><mo><mo>→</mo></mo><mi>s</mi></mover></mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.1600em" columnalign="left right" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>A</mi><mo>∪</mo><mi>n</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>A</mi><mi>l</mi><mi>i</mi><mi>a</mi><mi>s</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mspace width="1em"/><mspace width="1em"/><mi>n</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>∧</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><mi>A</mi><mo>∨</mo><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><mi>A</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>A</mi><mi mathvariant="normal">/</mi><mo stretchy="false">{</mo><mi>b</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo stretchy="false">}</mo><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mi>b</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup><mo>∈</mo><mi>A</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>A</mi><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mspace width="1em"/><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>w</mi><mi>i</mi><mi>s</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">A \stackrel{s}{\rightarrow}  \left\{  \begin{array}{lr}    A \cup nativeAlias(s){\quad}{\quad} native(s) \land (a_i.f^m \in A \vee c.f^m \in A) \\    A/\{b.f^m\} {\quad}{\quad} {\quad}{\quad}{\quad}{\quad}b.f^m \in A\\    A {\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}{\quad}otherwise\\  \end{array}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.968262em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.968262em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">→</span></span></span><span style="top:-3.5668699999999998em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.49999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.49199em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292009999999999em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.889em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.889em' height='0.016em' style='width:0.889em' viewBox='0 0 889 16' preserveAspectRatio='xMinYMin'><path d='M384 0 H504 V16 H384z M384 0 H504 V16 H384z'/></svg></span></span><span style="top:-4.30002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">na</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">ia</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">na</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord">/</span><span class="mopen">{</span><span class="mord mathnormal">b</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">b</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord"><span class="mspace" style="margin-right:1em;"></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>如果实参<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">a_i.f^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>被污染或者<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">c.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>被污染，且<code>s</code>中包含<code>native</code>方法调用，则需要把所有相关的<code>access path</code>加入到<strong>A</strong>。</p><p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi mathvariant="normal">.</mi><msup><mi>f</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">b.f^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">b</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>被污染，则需要从<strong>A</strong>中去除，因为<code>b</code>在这里接受返回值，有可能被重新赋值，因此需要去除。</p><p>其他情况，<strong>A</strong>保持不变。</p><h1>参考文章</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/79802252">FlowDroid: 精确的上下文，流，字段, 对象敏感和生存周期感知的污染分析</a></li><li><a href="https://www.abartel.net/static/p/tr-2013-taintandroid.pdf">Highly Precise Taint Analysis for Android Applications</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 论文笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IFDS </tag>
            
            <tag> 污点分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>论文笔记：Practical Extensions to the IFDS Algorithm</title>
      <link href="/2021/10/28/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%EF%BC%9APracticalExtensionstotheIFDSAlgorithm/"/>
      <url>/2021/10/28/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%EF%BC%9APracticalExtensionstotheIFDSAlgorithm/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p><strong>IFDS</strong>是全称<strong>Interprocedural，Finite，Distributive，Subset Problem</strong>的首字母缩写，代表了一类比较典型的静态分析问题。</p><ul><li><p><strong>Inter-procedural</strong> ：过程间，考虑整个程序之间的函数调用关系。与<strong>Intraprocedural</strong>有较大区别，它只考虑过程内的部语句，不考虑过程间调用。</p></li><li><p><strong>Finite</strong>：指问题的<strong>Domains</strong>是有限的，即<strong>Dataflow Fact</strong>是有限的。</p></li><li><p><strong>Distributive</strong>：数据流转换函数必须在交汇操作上是可分配的，即必须满足<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>a</mi><mo>∪</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>∪</mo><mi>f</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(a\cup b)=f(a) \cup f(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></p></li><li><p><strong>Subset</strong>：子集，分析的<strong>Dataflow Fact</strong>限制为问题<strong>Domains</strong>的子集<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>i</mi></msub><mo>⊆</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">d_i \subseteq D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⊆</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></p></li></ul><p>在1995年1月，美国威斯康星大学的<a href="http://pages.cs.wisc.edu/~reps/">Thomas Reps</a>、<a href="https://en.wikipedia.org/wiki/Susan_B._Horwitz">Susan Horwitz</a>和<a href="https://www.cs.tau.ac.il/~msagiv/">Mooly Sagiv</a>三位大牛发表论文<a href="https://dl.acm.org/doi/10.1145/199448.199462">Precise interprocedural dataflow analysis via graph reachability</a>，将这类问题（IFDS）转换为一种特殊的图可达性问题，能够在多项式时间复杂度内被精确求解。</p><p>既然是基于图可达性来解决问题，那么第一步就是要建图。该图基于<strong>Inter-procedural Control Flow Graph</strong>构建<strong>Supergraph G*</strong>，然后再基于<strong>G*<strong>和四个</strong>Flow Function</strong>构建<strong>Exploded Supergraph G#</strong>。</p><p>最后根据<strong>Tabulation algorithm</strong>，计算可达性。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211024165912123.png" alt="image-20211024165912123"></p><h1>算法缺陷</h1><p><a href="https://www.semanticscholar.org/paper/Practical-Extensions-to-the-IFDS-Algorithm-Naeem-Lhot%C3%A1k/49548aa54bdc8a6f0a13b58d032987305bdb61f7">Practical Extensions to the IFDS Algorithm</a>论文中指出上述计算可达性算法<strong>Tabulation algorithm</strong>在实际使用过程中出现的四个问题：</p><ul><li><p>现实中，很多分析中计算的<strong>Domains</strong>是有限的，也就是说很多分析不太可能分析所有的<strong>Dataflow Fact</strong>，大多数分析只会计算其中的一小部分；而<strong>Tabulation algorithm</strong>中的<strong>Tabulate</strong>方法传入的是<strong>Exploded Supergraph G#</strong>，即该算法要计算所有的<strong>Dataflow Fact</strong>的可达性，包括可达的和不可达的<strong>Dataflow Fact</strong>；现实的分析中，Domains往往是很大很大，有可能大部分都用不到，也不可达，计算这无用的部分会消耗大量的性能。<strong>因此 ，改进后算法，保证只计算事实上可达Dataflow Fact。</strong></p></li><li><p><strong>Tabulation algorithm</strong>中<strong>ReturnFlowFunction</strong>返回的信息有限；对于许多分析来说，将<strong>Dataflow Fact</strong>从被调用方映射回调用方需要提供在调用过程之前有关的状态信息。<strong>因此 ，改进后算法，要为ReturnFlowFunction提供这些信息</strong>。</p></li><li><p><strong>Tabulation algorithm</strong>在<strong>SSA</strong>形式上的程序的分析精度要小于不是<strong>SSA</strong>形式的程序。<strong>因此 ，改进后算法，要保持两者的精度一样</strong>。</p></li><li><p><strong>Tabulation algorithm</strong>没有很好的利用<strong>Domains</strong>集合的结构。<strong>因此，该进后的算法，会利用它的结构来减少分析的时间</strong>。</p></li></ul><h1>算法扩展</h1><p>在<strong>Tabulation algorithm</strong>基础上进行优化和扩展，下图，扩展部分已全部用下滑线标出来。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211024223836661.png" alt="image-20211024223836661"></p><h2 id="动态构图">动态构图</h2><p><strong>exploded supergraph G#<strong>中</strong>Node</strong>数量是<code>|Inst|*（|D| + 1）</code>:</p><ul><li><code>|Inst|</code>指程序中指令的数量</li><li><code>|D|</code>是分析问题中<strong>Domains</strong>的数量</li></ul><p>在很多分析中，虽然<code>|D|</code>是数量有限的，但是也是很庞大的。所以花大量时间和空间去构建和存储一个<strong>exploded supergraph G#</strong>，有点不太实际；同时，在实际运算中，只有很小一部分的<strong>supergraph</strong>会被遍历到，其他部分就造成了时间和空间上的浪费。因此，改进后的算法，<strong>Extended IFDS Algorithm</strong>只会去计算真正需要和真正可达那部分。</p><p>在<strong>Extended IFDS Algorithm</strong>中，<code>Tabulate</code>函数的参数再是整个<strong>exploded supergraph G#</strong>，而是四个函数：</p><ul><li><strong>flow(n)</strong>：计算所有过程内分析的边，对应<strong>exploded supergraph</strong>中的<strong>NormalFlowFunction</strong>。该函数还有一个参数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span>，这与<strong>SSA</strong>的精度有关。</li><li><strong>passArgs(n)</strong>：当传入的<code>Node</code>是调用点，计算<strong>call-to-start</strong>（call-to-callee）的边，对应<strong>exploded supergraph</strong>中的<strong>CallFlowFunction</strong>。</li><li><strong>returnVal(n)</strong>：当传入的<code>Node</code>是分析过程内的返回点，计算<strong>exit-to-return-site</strong>的边，对应<strong>exploded supergraph</strong>中的<strong>ReturnFlowFunction</strong>。</li><li><strong>CallFlow(n)</strong>：当传入的<code>Node</code>是调用点，计算<strong>call-to-return-site</strong>的边，对应<strong>exploded supergraph</strong>中的<strong>CallToReturnFlow Function</strong>。</li></ul><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211025105451762.png" alt="image-20211025105451762"></p><p>注意：这个四个扩展函数传入的<code>Node</code>都是<strong>Supergraph</strong>中的<code>Node</code>，同时他们计算的边都是从当前<code>Node</code>指向下一个<code>Node</code>的边。</p><p>四个函数分别替代掉<strong>Tabulation algorithm</strong>中四处需要查询<strong>exploded supergraph</strong>的边的位置，分别是：</p><ul><li><strong>Tabulation algorithm</strong>第<strong>14行</strong>中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>n</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><msub><mi>S</mi><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>d</mi><mi>P</mi><mi>r</mi><mi>o</mi><mi>c</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>3</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;n,d_2&gt; \rightarrow &lt;S_{calledProc(n)},d_3&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.04964em;vertical-align:-0.3551999999999999em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">roc</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>查询<strong>call-to-start</strong>（call-to-callee）的边，在<strong>Extended IFDS Algorithm</strong>使用passArgs(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>n</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;n,d_2&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>)代替。</li><li><strong>Tabulation algorithm</strong>第<strong>17行</strong>中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>n</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi>S</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>d</mi><mn>3</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;n,d_2&gt; \rightarrow &lt;returnSite(n),d_3&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>查询<strong>call-to-return-site</strong>的边，在<strong>Extended IFDS Algorithm</strong>使用CallFlow(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>n</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;n,d_2&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>)代替。</li><li><strong>Tabulation algorithm</strong>第<strong>23行</strong>中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>e</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi>S</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>d</mi><mn>5</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;e_p,d_2&gt; \rightarrow &lt;returnSite(n),d_5&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>查询<strong>exit-to-return-site</strong>的边，在<strong>Extended IFDS Algorithm</strong>使用returnVal(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>e</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo separator="true">,</mo><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>4</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;e_p,d_2&gt;,&lt;c,d_4&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>)代替。</li><li><strong>Tabulation algorithm</strong>第<strong>34行</strong>中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>n</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><mi>m</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>3</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;n,d_2&gt; \rightarrow &lt;m,d_3&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>查询过程内的边，在<strong>Extended IFDS Algorithm</strong>使用Flow(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>n</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo separator="true">,</mo><mi>π</mi></mrow><annotation encoding="application/x-tex">&lt;n,d_2&gt;,\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span>)代替。</li></ul><h2 id="Incoming集合作用">Incoming集合作用</h2><p>在<strong>Tabulation algorithm</strong>中的第23行，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>4</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><msub><mi>S</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>1</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;c,d_4&gt; \rightarrow &lt;S_p,d_1&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>需要在<strong>exploded supergraph</strong>中查询当前方法的<strong>call-to-start</strong>（call-to-callee）边，也就是谁调用了此方法，即该过程<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>节点的前驱。</p><p><strong>Extended IFDS Algorithm</strong>中的<code>Tabulate</code>函数并不是传入整个<strong>exploded supergraph</strong>，而是四个函数；如果要获取某个节点前驱节点，就要进行反向运算，这非常难，也很耗时；同时，在<strong>exploded supergraph</strong>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>节点的前驱节点不是所有都可达，也没有很好办法去判断哪些可达，哪些不可达；如果在这里直接进行反向运算，直接与最初改进想法相违背。因此，<strong>Extended IFDS Algorithm</strong>加入了一个<strong>Incoming</strong>集合，来记录<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mi>p</mi></msub><mo separator="true">,</mo><mi>d</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_p,d&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>节点的前驱。</p><p>在<strong>Extended IFDS Algorithm</strong>第15.1行，每一次到计算<strong>call-to-start</strong>（call-to-callee）边的时候，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mi>n</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo stretchy="false">[</mo><mo>&lt;</mo><msub><mi>S</mi><mrow><mi>C</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>d</mi><mi>P</mi><mi>r</mi><mi>o</mi><mi>c</mi><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>d</mi><mn>3</mn></msub></mrow></msub><mo>&gt;</mo><mo stretchy="false">]</mo><mo>∪</mo><mo>=</mo><mo>&lt;</mo><mi>n</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">Incoming[&lt;S_{CalledProc(c),d_3}&gt;] \cup= &lt;n,d_2&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">co</span><span class="mord mathnormal">min</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">[</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.03853em;vertical-align:-0.3551999999999999em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">roc</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">]</span><span class="mord">∪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>会记录当前被调用过程的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>节点的前驱节点，也就是当前被调用过程的调用点，下次需要时直接可以在<strong>Incoming</strong>集合中查找；同时，也保证了能被<strong>Incoming集合</strong>记录的前驱节点，也是一定可达的。</p><h2 id="EndSummary集合作用">EndSummary集合作用</h2><p>为了更好的理解<strong>EndSummary</strong>集合的作用，这里按流程走一下<strong>Extended IFDS Algorithm</strong>中第21,，22， 23行。</p><p>假设当前的<strong>edge</strong>是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>1</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><msub><mi>e</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_p,d_1&gt; \rightarrow &lt;e_p,d_2&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>，这里的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>∈</mo><msub><mi>e</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">n \in e_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，所以会执行第21行。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211025162737822.png" alt="image-20211025162737822"></p><p>从<strong>Incoming</strong>集合中找出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>1</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_p,d_1&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>的前驱，也就是第22行的操作。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211025163934260.png" alt="image-20211025163934260"></p><p>执行第23行，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>5</mn></msub></mrow><annotation encoding="application/x-tex">d_5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211025164226729.png" alt="image-20211025164226729"></p><p>那么问题来了，随着算法的执行，<strong>Incoming</strong>集合中记录<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>1</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_p,d_1&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>的前驱节点可能会越来多，那么每增加一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>1</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_p,d_1&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>的前驱节点，这里就要重新计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>1</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_p,d_1&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>的所有前驱节点，显然，这里的设计有点不合理。</p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211025165254059.png" alt="image-20211025165254059"  /><p>因此，<strong>Extended IFDS Algorithm</strong>引入了<strong>EndSummary</strong>集合来解决此问题。</p><p><strong>Extended IFDS Algorithm</strong>在第21.1行使用<strong>EndSummary</strong>集合将每一个过程内的<strong>start</strong>节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>和它的<strong>exit</strong>节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">e_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>相互映射起来，之后每一次算法执行到该过程的<strong>start</strong>节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>时，在第15.1行到15.6行就直接快进到原本需要在第22，23行的操作，还避免了大量的重复计算。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211025172230511.png" alt="image-20211025172230511"></p><h2 id="Return-Flow-Functions">Return Flow Functions</h2><p>在<strong>Tabulation algorithm</strong>中，<strong>ReturnFlowFunctions</strong>是对<strong>exploded supergraph</strong>中某个过程内的<strong>exit</strong>节点到它的调用点的边的抽象，也就是说，这条边的作用域取决于被调用的方法内部过程，而与它调用点的作用域无光。</p><p>简单说就是，调用某个方法时的结果，和执行这个方法之后的结果，两者没有什么关系。但是，在很多分析过程中，都是需要将两者信息相互映射。</p><p>举个<strong>Type Analysis</strong>例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ensureCircle</span><span class="params">(Shape y)</span></span>&#123;</span><br><span class="line">Shape z = y;<span class="comment">// 3</span></span><br><span class="line">(Circle) z;<span class="comment">// 4 Circle 为 Shape 的子类</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Shape x = ...;<span class="comment">// 1</span></span><br><span class="line">ensureCircle(x);<span class="comment">// 2</span></span><br></pre></td></tr></table></figure><p>某个<code>Shape x</code>传入到<code>ensureCircle（Shape y）</code>的参数<code>Shape y</code>，<code>Shape y</code>赋值给了<code>Shape z</code>，最后<code>Shape z</code>被强制转为了<code>Circle z</code>；那么最终的结果就是三个属性<strong>x、y、z</strong>最后的类型都是<strong>Circle</strong>。但是在<strong>Tabulation algorithm</strong>中，没有办法将调用点时的<code>Shape x</code>与<strong>ensureCircle</strong>过程内部的执行结果<code>Circle z</code>映射起来，它们是相互独立的。</p><p>在<strong>Extended IFDS Algorithm</strong>第<strong>23</strong>行表示，对<strong>ReturnFlowFunctions</strong>函数进行了改进，即<strong>returnVal</strong>可以传入两个参数：</p><ul><li>一个是过程内部的<strong>exit</strong>节点。</li><li>另一个是该过程的调用点<strong>c</strong>节点。</li></ul><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi>V</mi><mi>a</mi><mi>l</mi><mo stretchy="false">(</mo><mo>&lt;</mo><msub><mi>e</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo separator="true">,</mo><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>4</mn></msub><mo>&gt;</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">returnVal(&lt;e_p,d_2&gt;,&lt;c,d_4&gt;)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">nVa</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">)</span></span></span></span>表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">d_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>不仅在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">e_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>可达，因为从程序的起始指令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">d_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>开始也是可达的，而<strong>Incoming</strong>集合中记录了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>s</mi><mi>P</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>1</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;s_P,d_1&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>的可达前驱节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>4</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;c,d_4&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>，所以，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">d_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>从<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>4</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;c,d_4&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>到过程内的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">e_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>指令也是可达的。这样就可以将调用点的信息与过程内的信息相互映射起来。</p><p>对应到上面的例子，从<strong>ensureCircle</strong>过程内，我们可以得出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mrow><mi>e</mi><mi>n</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>y</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><msub><mi>S</mi><mrow><mi>e</mi><mi>n</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>z</mi><mo separator="true">,</mo><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo>&gt;</mo><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_{ensureCircle},&lt;y,Shape&gt;&gt; \rightarrow &lt;S_{ensureCircle},&lt;z,Circle&gt;&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">rc</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">rc</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">i</span><span class="mord mathnormal">rc</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;</span></span></span></span>，因为在<strong>Incoming</strong>集合中记录了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>S</mi><mrow><mi>e</mi><mi>n</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>y</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;S_{ensureCircle},&lt;y,Shape&gt;&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">rc</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;</span></span></span></span>的前驱节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;c,&lt;x,Shape&gt;&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;</span></span></span></span>，因此<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><msub><mi>S</mi><mrow><mi>e</mi><mi>n</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>y</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><msub><mi>S</mi><mrow><mi>e</mi><mi>n</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>z</mi><mo separator="true">,</mo><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo>&gt;</mo><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;c,&lt;x,Shape&gt;&gt; \rightarrow &lt;S_{ensureCircle},&lt;y,Shape&gt;&gt; \rightarrow &lt;S_{ensureCircle},&lt;z,Circle&gt;&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">rc</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">rc</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">i</span><span class="mord mathnormal">rc</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;</span></span></span></span>，可以知道<code>x</code>指向<strong>Circle</strong>类型。</p><p>这种扩展，不仅仅可以用于<strong>Tabulation algorithm</strong>中，还可以用于所有基于<strong>exploded supergraph</strong>实现的算法。</p><p>在<strong>Tabulation algorithm</strong>中第23行，如果某个过程内的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">d_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>在<strong>exit</strong>节点和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>5</mn></msub></mrow><annotation encoding="application/x-tex">d_5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>在它的调用节点的返回节点之间有一条边，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>e</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi>S</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>d</mi><mn>5</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;e_p,d_2&gt; \rightarrow &lt;returnSite(c),d_5&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>存在，就会在第25行新建一条这个过程的调用节点和调用返回节点的边<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>4</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi>S</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>d</mi><mn>5</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;c,d_4&gt; \rightarrow &lt;returnSite(c),d_5&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>，称之为<strong>call-to-return-flow</strong>，并将之插入<strong>SummaryEdge</strong>。</p><p><strong>Extended IFDS Algorithm</strong>的扩展给予了分析设计者更多的灵活性；将一条<strong>call-to-return-flow-edge</strong>加入<strong>SummaryEdge</strong>集合的同时，也要额外考虑到它的调用点，也就是说一条<strong>exit-to-return-flow-edge</strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>e</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo><mo>→</mo><mo>&lt;</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi>S</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>d</mi><mn>5</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;e_p,d_2&gt; \rightarrow &lt;returnSite(c),d_5&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;→&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>存不存在，取决于是否使用那条从过程调用点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>c</mi><mo separator="true">,</mo><msub><mi>d</mi><mn>4</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;c,d_4&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>到过程内的exit节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><msub><mi>e</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mn>2</mn></msub><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;e_p,d_2&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>可达的路径。</p><h2 id="SSA指令程序精度">SSA指令程序精度</h2><p>个人对<strong>SSA指令</strong>不是很熟，因此这部分理解起来有写困难。因此只能先留一个坑，等学会<strong>SSA指令</strong>，再回来更。</p><h2 id="Domains结构扩展">Domains结构扩展</h2><p>有些时候，某个问题的<strong>Domains</strong>，它的各个元素之间，可能存在一种包含关系。</p><p>例如在<strong>Return Flow Functions</strong>举的<strong>ensureCircle</strong>例子，因为<strong>Circle</strong>是<strong>Shape</strong>的子类，所以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;x,Circle&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">i</span><span class="mord mathnormal">rc</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>包含了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;x,Shape&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>，意味着<code>x</code>指向<strong>Circle</strong>，同时它是<strong>Shape</strong>的子类；但是，在<strong>Tabulation algorithm</strong>，如果要在程序某一点计算结果集（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;x,Circle&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">i</span><span class="mord mathnormal">rc</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;x,Shape&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>），因为没有提供额外关于它们之间关系的信息，因此<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;x,Circle&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">i</span><span class="mord mathnormal">rc</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;x,Shape&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>会被视为独立、等价的，没有任何关系，要么<code>x</code>指向<strong>Circle</strong>，要么指向<strong>Shape</strong>。</p><p>所以，我们可以为任何分析定义一种偏序关系<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>≤</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a \le b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">b</span></span></span></span>，即<code>a</code>包含<code>b</code>（例如，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>C</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo>&gt;</mo><mo>≤</mo><mo>&lt;</mo><mi>x</mi><mo separator="true">,</mo><mi>S</mi><mi>h</mi><mi>a</mi><mi>p</mi><mi>e</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;x,Circle&gt; \le &lt;x,Shape&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">i</span><span class="mord mathnormal">rc</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;≤&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>），同时默认，所有分析的<strong>Dataflow Functions</strong>在偏序关系上是单调的，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>≤</mo><mi>b</mi><mo>⇒</mo><mi>f</mi><mi>l</mi><mi>o</mi><mi>w</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>≤</mo><mi>f</mi><mi>l</mi><mi>o</mi><mi>w</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a \le b \Rightarrow flow(a) \le flow(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span>。</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>D</mi><mn>2</mn></msub><mo>⟺</mo><mi mathvariant="normal">∀</mi><msub><mi>d</mi><mn>1</mn></msub><mo>∈</mo><msub><mi>D</mi><mn>1</mn></msub><mi mathvariant="normal">∃</mi><msub><mi>d</mi><mn>2</mn></msub><mo>∈</mo><msub><mi>D</mi><mn>2</mn></msub><mi>s</mi><mi mathvariant="normal">.</mi><mi>t</mi><mi mathvariant="normal">.</mi><msub><mi>d</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>d</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">D_1 \le D_2 \Longleftrightarrow \forall d_1 \in D_1 \exists d_2 \in D_2  s.t.  d_1 \le d_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟺</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord">∀</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∃</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord mathnormal">t</span><span class="mord">.</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>除以上关系之外，还有一种等价关系<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">D_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>～<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">D_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，即每个集合中的每个元素都包含在另一个集合中的某个元素中。</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mn>1</mn></msub><mo>∼</mo><msub><mi>D</mi><mn>2</mn></msub><mo>⟺</mo><msub><mi>D</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>D</mi><mn>2</mn></msub><mo>∧</mo><msub><mi>D</mi><mn>2</mn></msub><mo>≤</mo><msub><mi>D</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">D_1 \sim D_2 \Longleftrightarrow D_1 \le D_2 \land  D_2 \le D_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟺</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>在<strong>Extended IFDS Algorithm</strong>中，利用这种包含关系，去找到更小的结果集；同时，它不仅仅可以减少最终结果集，还可以减少中间结果集；不要小看这一优化，一次次减少不必要结果集的计算，最终都会体现到整个分析的效率上。</p><p>即使增加了这一优化，<strong>Extended IFDS Algorithm</strong>精度也会保持和<strong>Tabulation algorithm</strong>的一样；在<strong>Tabulation algorithm</strong>中独立计算某个程序点的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>e</mi><mi>x</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">D_{ext}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>o</mi><mi>r</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">D_{ori}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，在<strong>Extended IFDS Algorithm</strong>则表示它们是等价的，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>e</mi><mi>x</mi><mi>t</mi></mrow></msub><mo>∼</mo><msub><mi>D</mi><mrow><mi>o</mi><mi>r</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">D_{ext} \sim D_{ori}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</p><p><img src="https://playwin.oss-cn-shanghai.aliyuncs.com/picgo/image-20211028171428250.png" alt="image-20211028171428250"></p><p><strong>Extended IFDS Algorithm</strong>通过改造<strong>Propagate</strong>函数来实现这种关系，在第9行，限制了加入<strong>PathEdge</strong>集合的边，即加入的边不包含任何一条已存在的边。在第9.1行，可以删除<strong>PathEdge</strong>和<strong>WorkList</strong>中所有冗余的新边。</p><p>同时，还需要对<strong>WorkList</strong>集合中的元素进行排序，相当于定义一个优先级，保证被包含的元素要在包含元素之前处理；如果不这样，当<strong>WorkList</strong>集合构建完成之后，才发现元素之间存在包含关系，那会存在大量不必要的元素。</p><h1>后话</h1><p>写了比较久，可能有些地方理解不是很到位，欢迎大佬们不吝赐教。</p><h1>参考</h1><ul><li><a href="https://dl.acm.org/doi/10.1145/199448.199462">Precise interprocedural dataflow analysis via graph reachability </a></li><li><a href="https://blog.csdn.net/qq_37206105/article/details/119428468?spm=1001.2014.3001.5501">IFDS开山之作：Precise Interprocedual Dataflow Analysis via Graph Reachability</a></li><li><a href="https://blog.csdn.net/qq_37206105/article/details/120442229?spm=1001.2014.3001.5501">IFDS论文算法精解：应用于污点分析的例子</a></li><li><a href="https://blog.csdn.net/majestyhao/article/details/43834855">用求解图内节点是否可达的算法来解决IFDS问题</a></li><li><a href="https://www.semanticscholar.org/paper/Practical-Extensions-to-the-IFDS-Algorithm-Naeem-Lhot%C3%A1k/49548aa54bdc8a6f0a13b58d032987305bdb61f7">Practical Extensions to the IFDS Algorithm</a></li><li><a href="https://www.jianshu.com/p/2bd21a34eb8b">【课程笔记】南大软件分析课程11——CFL可达性&amp;IFDS（课时15）</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 论文笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 静态分析 </tag>
            
            <tag> IFDS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>个人对安全白盒的理解</title>
      <link href="/2021/10/19/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%AE%89%E5%85%A8%E7%99%BD%E7%9B%92%E7%9A%84%E7%90%86%E8%A7%A3/"/>
      <url>/2021/10/19/%E4%B8%AA%E4%BA%BA%E5%AF%B9%E5%AE%89%E5%85%A8%E7%99%BD%E7%9B%92%E7%9A%84%E7%90%86%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p>白盒是一个很庞大的概念，几乎每一个行业，都有自己的白盒实现方式。</p><p>之前实习，一直在做安全白盒相关工作。也算是初步认识白盒在安全中大概是什么样子，这篇文章算是对前段时间的一个总结。</p><p>因此，以下讨论的白盒，默认限定在网络安全的范围之内。</p><h1>什么白盒</h1><p>什么是白盒，简单总结就一句话：“利用有限的信息，得出有用的结果”。</p><p>虽然总结只有短短一句话，十四个字，但是蕴含了两个核心点，也就是白盒的两个核心点：<strong>信息</strong>和得出有用结果的<strong>检测能力</strong>。</p><h2 id="信息">信息</h2><p>信息是有限的，无论是在哪一方面。</p><p>白盒能获得的信息无非是系统的源码、各种配置和运行环境等；其中最重要的信息是系统的源码，完整的系统源码，实际运用中，往往也只有系统的源码；但它也是有限的，即使系统的功能在不断的增加，但是系统的代码还是有限的。</p><p>完整的系统源码对白盒来说，已经是最完整的信息了。</p><h2 id="能力">能力</h2><p>白盒的能力，也就是得出有用结果的<strong>检测能力</strong>，它是白盒的核心中的核心。</p><p>如果说信息是白盒的前提，那么<strong>检测能力</strong>，就是白盒的<strong>根本</strong>。</p><p>信息给的再多，再完整，没有相应检测能力的白盒，它也是形同虚设；即使信息相对缺少，白盒检测能力在，那么白盒的灵魂就在。</p><h1>白盒实现</h1><p>白盒信息的来源于外界，不属于白盒本身；一般是在拥有足够的信息前提下，想利用白盒能力来做业务。</p><p>那么也就是说，白盒的实现，其实就是白盒检测能力的实现。</p><p>白盒检测能力可以分为<strong>人工检测能力</strong>和<strong>自动化检测能力</strong>。</p><h2 id="人工检测能力">人工检测能力</h2><p>人工检测能力的实现，就是依靠人的能力对信息的检测，强弱完全取决于安全人员能力的强弱。</p><p>基于人力检测能力实现的白盒，缺点是很明显的：</p><ul><li>结果的正报率、误报率以及漏报率完全取决于人；</li><li>人的能力是有限的，意味信息量越大，检测的时常也会相应的成倍增长；</li><li>同时人力成本是非常高昂的，检测范围的增加，往往意味着人力资源的增加。</li></ul><p>这种实现方式，是白盒初期的实现方式，往往用来缓解初期业务增长的压力。</p><p>对于大公司来说，不会采取这种方式，也不会抛弃这种方式，而是以少量人工检测能力作为辅助，去建设自动化检测能力。</p><h2 id="自动化检测能力">自动化检测能力</h2><p>当今白盒的实现都是<strong>以自动化检测的能力为核心</strong>。</p><p>自动化检测能力对于大公司的白盒来说太重要了。大公司的应用数以万计，每天需要检测的应用就非常的多，单纯的依靠人工检测，是无法满足大公司庞大的需求；因此白盒检测能力自动化就变得尤为重要。</p><p>实现自动化检测能力的方式有很多，目前主流的形式是扫描器。（当然，有条件，你甚至可以做一个机器人，代替人来做代码审计，以达到自动化的目的。）</p><p>扫描器的实现原理也是多种多样的，例如：</p><ul><li>基于正则</li><li>状态机</li><li>污点分析</li></ul><p>最后，在自动化的基础上，还是要回归到增强检测能力的目标上来。</p>]]></content>
      
      
      <categories>
          
          <category> 安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 白盒 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>单机数据库事务（与隔离性）原理</title>
      <link href="/2021/02/09/%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%EF%BC%88%E4%B8%8E%E9%9A%94%E7%A6%BB%E6%80%A7%EF%BC%89%E5%8E%9F%E7%90%86/"/>
      <url>/2021/02/09/%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%EF%BC%88%E4%B8%8E%E9%9A%94%E7%A6%BB%E6%80%A7%EF%BC%89%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1>数据库事务</h1><h2 id="什么是数据库事务">什么是数据库事务</h2><p>数据库事务，即一系列作为一个逻辑单元来执行的操作集合。在数据库中的体现就是，一系列读存动作被当作一个执行单元，例如：查看某行记录，查询并修改某行记录。</p><h2 id="开启事务">开启事务</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;<span class="comment">-- 开启事务</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> xxx;<span class="comment">-- 执行一条或多条语句</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ROLLBACK</span>;<span class="comment">-- 可选，如出错，回滚到到事务的开头。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;<span class="comment">-- 提交事务，一个事务正确执行。</span></span><br></pre></td></tr></table></figure><p>一个事务大概是三步，开启，执行，结束，如果中间有操作错误，想回滚，就<code>ROLLBACK</code>，不过这样的方式，该事务会直接回到事务开头，不管你中间执行多少条语句。</p><p>看完你可能会感觉我怎么一点也没使用到过数据库事务。其实，平常大量的操作都在隐性使用数据事务；比如你执行一条<code>SELECT</code>语句，也是在执行一条事务，虽然你并没有这开启和提交操作，但这些数据库都隐性帮你做了。</p><h1>四大特性</h1><p>说到数据库事务，不得不提到它的四大特性：**原子性，一致性，隔离性，持久性。**下面举个例子来一一介绍这四大特性。</p><p>假设股东·Liu 给打工·Chen每月发200元工资，即股东·Liu 给打工·Chen 转账 200 元。那么整个事务过程如下：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207153626735.png" alt="image-20210207153626735"></p><p>简化一下，只得到数据库数据的状态：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207153857577.png" alt="image-20210207153857577"></p><p>一开始先查看，股东·Liu账户有200元，打工·Chen 0元，减掉股东·Liu 账户200元，此时两者账户都是0元，最后打工·Chen加上200元，此时账户股东·Liu 0元，打工·Chen 200元，这就是数据在这一事务过程的变化。</p><h2 id="原子性（Atomicity）">原子性（Atomicity）</h2><p>原子性，即一个事务所有操作要么同时成功，要么同时失败。</p><p>如上例子，所以步骤都成功，事务才成功。要是中间某一步失败了，执行出错了，那么整个事务就失败了，整个事务就要回滚。</p><p>那么他是如何保证原子性？</p><p>数据库会在执行过程中，记录每一步执行之前的数据状态，形成一个<code>Undo</code>日志。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207154650048.png" alt="image-20210207154650048"></p><p>当在某一步出错时，会根据<code>Undo</code>日志回滚之前的数据。</p><p>但是，如果在中途有人给转股东转了100W，另一个事务修改了股东·Liu的数据状态，数据库状态变成了如下：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207155115362.png" alt="image-20210207155115362"></p><p>而这个事务执行记录最后一步是股东·Liu 0 元，最后执行完，股东·Liu 变成了0元，平白不见了100W，银行赚了100W，谁来担股东·Liu的损失，程序员吗？</p><p>回过头来看，在原子性的定义中，并没有关注到这种状态。所以又定义了另一种特性，一致性。</p><h2 id="一致性（Consistency）">一致性（Consistency）</h2><p>一致性主要保证两个内容，事务过程中的数据保持一致和事务必须完成后数据才可见。</p><p>也就说，一个事务执行过程中不允许其他任何事务打扰。那么如何保证事务的一致性？一种非常常见的解决方式，给事务加锁。在事务执行过程中，给需要操作的数据加锁。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207160444817.png" alt="image-20210207160444817"></p><p>这样其他事务能操作的数据只能是在这个事务执行之前或之后。</p><p>我们知道，加锁是一个极其复杂的操作，同时会大大降低系统的并发度。大多数时候，系统只需要查看某条数据的状态，而少数时候修改一条数据的状态。这会造成一系列问题，究竟什么时候给数据上锁能保持系统性能高可用，同时读取数据和写入数据时是否都需要加锁，读锁是否可以升级为写锁。</p><p>这些复杂的问题，又衍生出了事务的另一大特性，隔离性。</p><h2 id="隔离性-Isolation">隔离性(Isolation)</h2><p>隔离性，由上述为了保证一致性而加锁的问题引出（这里的一致性为强一致性，即一个事务执行完，另一个事务才能执行，但是这样的效率太低了，基本在高并发的互联网中不可用。），其实就是以性能为理由，对强一致性的破坏。</p><p>隔离性，因为加锁的复杂度，分为了四个等级：<strong>序列化读（Serializable），可重复读（Repeatable Read ），读已提交（Read Committed），读未提交（Read Uncommitted）</strong>。</p><p>下面一一解释它们之间的关系。</p><h3 id="序列化读（Serializable）">序列化读（Serializable）</h3><p>序列化读，即对事务操作的每一个数据都加锁，加锁的数据不允许其他事务操作，也就是强一致性。会出现如下情况，读和写事务序列化。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207163024473.png" alt="image-20210207163024473"></p><p>这保证不同事务之间完全隔离，但是并发太低，在现在的互联网，基本不可用。</p><p>为了提高性能，将锁分为了读锁，和写锁，即对应了事务中的查看数据和修改数据的操作。但同样存在一个问题，读锁是否可以被写锁升级？于是，又出现了下面的隔离级别。</p><h3 id="可重复读（Repeatable-Read-）">可重复读（Repeatable Read ）</h3><p>可重复读，使用读写锁机制，但是读锁不能被写锁升级。</p><p>这样的读写锁机制，读锁是共享锁，写锁是排他锁，两者之间相互独立。不同事务之间，可以同时读取相同的数据，但不可以同时修改相同的数据，修改数据时，需要释放读锁，再加上写锁。那么读写事务之间的执行顺序如下：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207163952361.png" alt="image-20210207163952361"></p><p>读读并行，并发提高了一点，但是，带来了一些的数据问题。</p><p>虚读：某一个事务读取到另一个事务已修改的数据，导致前后读取不一致。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207165806013.png" alt="image-20210207165806013"></p><h3 id="读已提交（Read-Committed）">读已提交（Read Committed）</h3><p>读已提交，使用读写锁机制，但是读锁能被写锁升级。</p><p>同样的，读锁是共享锁，写锁是排他锁，区别于可重复读隔离级别，一行数据被加了读锁时，在有写的操作，读锁不需要释放，直接可以升级为写锁。因此，读写事务之间的执行顺序再次发生改变：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207170208028.png" alt="image-20210207170208028"></p><p>读读并行，读写并行，并发进一步提高，同样的，它也会存在一些数据问题：不可重复读和虚读。</p><p>不可重复读：同一个事务内，多次读取同一数据，结果不一样。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207171831301.png" alt="image-20210207171831301"></p><h3 id="读未提交（Read-Uncommitted）">读未提交（Read Uncommitted）</h3><p>读未提交，不再使用读写锁机制，只在一种情况加锁，就是有写操作时才会加锁。</p><p>写锁是排它锁，不同事务之间，读取相同数据不存在屏障，需要修改数据时，需给数据加上写锁，也就是说，只有在修改数据时，才会排斥。那么，读写事务之间的执行顺序又一次发生改变：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207172649179.png" alt="image-20210207172649179"></p><p>读读并行，读写并行，写读并行，并发也会再一次提高，但数据的问题又再一次加重：不可重复读、虚读和脏读。</p><p>脏读：某一事务读取到了另一个事务未提交的数据。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210207173255819.png" alt="image-20210207173255819"></p><h3 id="快照隔离级别（Snapshot-Isolation）">快照隔离级别（Snapshot Isolation）</h3><p>不是说隔离性只有四个级别吗？这个快照隔离级别又是什么东西？</p><p>计算机中锁的概念的提出离现在已过去非常之久。虽然它是个很好的解决方法，但是计算机加锁和释放锁也是很耗费性能的，其他线程等待锁的释放，就会浪费大量的资源，而且并发性能依旧没能很好满足现在互联网的高速发展。</p><p>所以之前的大佬们都在寻求更加高效的解决办法，终于有大佬提出了新的隔离级别，快照隔离级别，即我们常说的<strong>多版本并发控制（MVCC，Multi-Version Concurrency Control）</strong>，它的核心思想是<strong>无锁编程，Copy on write</strong>。</p><p>快照隔离级别的实现主要依靠的是<strong>版本链和ReadView</strong>。</p><h4 id="版本链">版本链</h4><p>对于使用InnoDB存储引擎的表来说，它的聚簇索引记录中都包含两个必要的隐藏列：</p><ul><li><p>trx_id：每次对某条记录进行改动时，都会把对应的事务id赋值给trx_id隐藏列。</p></li><li><p>roll_pointer：每次对某条记录进行改动时，这个隐藏列会存一个指针，可以通过这个指针找到该记</p><p>录修改前的信息</p></li></ul><p>整个结构如下图：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210208115943602.png" alt="image-20210208115943602"></p><h4 id="ReadView">ReadView</h4><p>ReadView主要包含四个比较重要的内容：</p><ul><li><p>m_ids：表示在生成ReadView时当前系统中活跃的读写事务的事务id列表。</p></li><li><p>min_trx_id：表示在生成ReadView时当前系统中活跃的读写事务中最小的事务id，也就是m_ids中的最小</p><p>值。</p></li><li><p>max_trx_id：表示生成ReadView时系统中应该分配给下一个事务的id值。</p></li><li><p>creator_trx_id：表示生成该ReadView的事务的事务id。</p></li></ul><p>特别要注意的是：max_trx_id并不是表示m_ids中的最大值。假设id分别为1，2，3的三个事务，之后id为3的事务提交了。因为事务id是递增分配的，那么一个新的读事务在生成ReadView时，m_ids就包括1和2，min_trx_id的值就是1，max_trx_id的值就是4。</p><h4 id="运行机制">运行机制</h4><p>1、某条记录首次被事务访问时，会创建一个ReadView。</p><ul><li>可重复读隔离级别，在第一次读取数据时生成一个ReadView。</li><li>读已提交隔离级别：每次读取数据前都生成一个ReadView。</li></ul><p>2、事务去访问某条记录时，根据ReadView，来判断记录的某个版本是否可见：</p><ul><li><p>如果被访问版本的trx_id属性值与ReadView中的creator_trx_id值相同，意味着当前事务在访问它自</p><p>己修改过的记录，所以该版本可以被当前事务访问。</p></li><li><p>如果被访问版本的trx_id属性值小于ReadView中的min_trx_id值，表明生成该版本的事务在当前事</p><p>务生成ReadView前已经提交，所以该版本可以被当前事务访问。</p></li><li><p>如果被访问版本的trx_id属性值大于ReadView中的max_trx_id值，表明生成该版本的事务在当前事务生成ReadView后才开启，所以该版本不可以被当前事务访问。</p></li><li><p>如果被访问版本的trx_id属性值在ReadView的min_trx_id和max_trx_id之间，那就需要判断一下</p><p>trx_id属性值是不是在m_ids列表中，如果在，说明创建ReadView时生成该版本的事务还是活跃</p><p>的，该版本不可以被访问；如果不在，说明创建ReadView时生成该版本的事务已经被提交，该版</p><p>本可以被访问</p></li></ul><p>可以看到，快照隔离级别的出现，减少了锁的使用，并行度能达到或超过读未提交的，而且隔离级别很高，大大提高数据库的效率。但是在这之前，数据库隔离性都是在有锁的情况下，对其进行分类，定义标准。因此，只能把快照隔离级别映射回到四个隔离级别。直到现在，很多数据库隔离性的实现都是基于快照隔离级别原理。</p><h1>持久性(Durability)</h1><p>持久性，即事务完成以后，该事务所对数据库所作的更改便持久的保存在数据库之中，并且不会被回滚。</p><p>简单点说，就是如何保证数据永久保存到计算机。而现在计算存储数据的地方无非是两个地方：内存和硬盘，但要保证数据完整永久的存储，并不是一件简单的事情，这涉及到了操作系统和硬件之间的讨论，这里就不展开了。</p><h1>总结</h1><ul><li>数据库事务是一系列作为一个逻辑单元来执行的操作集合。</li><li>数据库事务的四大特性：原子性，一致性，隔离性，持久性。</li><li>四大隔离级别：序列化读，可重复读，读已提交，读未提交。</li><li>快照隔离级别被映射回了四大隔离级别之中。</li></ul>]]></content>
      
      
      <categories>
          
          <category> MYSQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> 事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL查询优化器原理</title>
      <link href="/2021/02/05/MySQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%99%A8%E5%8E%9F%E7%90%86/"/>
      <url>/2021/02/05/MySQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%99%A8%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1>MySQL查询优化器</h1><p>再次祭出MySQL的底层架构图</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210126144655131.png" alt="image-20210126144655131"></p><p>在存储引擎之上，还有许多模块，比如：Connection Pool（连接池）、Parser（解析器）、Optimizer（优化器）等。而本次重点来看一下Optimizer（优化器）。</p><h1>优化日志</h1><p>MySQL会记录优化器日志，如果想查看详细过程，得开启优化器日志。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> optimizer_trace<span class="operator">=</span>&quot;enabled=on&quot;;<span class="comment">-- 开启</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> optimizer_trace<span class="operator">=</span>&quot;enabled=off&quot;;<span class="comment">-- 关闭</span></span><br></pre></td></tr></table></figure><p>开启优化器日志之后，每执行一条SQL语句，MySQL都会记录该语句的优化记录。使用步骤如下。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees limit <span class="number">1</span>,<span class="number">100</span>;<span class="comment">--执行SQL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.OPTIMIZER_TRACE;<span class="comment">-- 查看日志信息</span></span><br></pre></td></tr></table></figure><p>结果如下</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210131155850887.png" alt="image-20210131155850887"></p><p>TRACE列就是优化日志，内容如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;join_preparation&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;expanded_query&quot;</span>: <span class="string">&quot;/* select#1 */ select `employees`.`emp_no` AS `emp_no`,`employees`.`birth_date` AS `birth_date`,`employees`.`first_name` AS `first_name`,`employees`.`last_name` AS `last_name`,`employees`.`gender` AS `gender`,`employees`.`hire_date` AS `hire_date` from `employees` limit 1,100&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;join_optimization&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;table_dependencies&quot;</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`employees`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;row_may_be_null&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                                <span class="attr">&quot;map_bit&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">&quot;depends_on_map_bits&quot;</span>: [</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;rows_estimation&quot;</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`employees`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;table_scan&quot;</span>: &#123;</span><br><span class="line">                                    <span class="attr">&quot;rows&quot;</span>: <span class="number">299335</span>,</span><br><span class="line">                                    <span class="attr">&quot;cost&quot;</span>: <span class="number">232.25</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;considered_execution_plans&quot;</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;plan_prefix&quot;</span>: [</span><br><span class="line">                                ],</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`employees`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;best_access_path&quot;</span>: &#123;</span><br><span class="line">                                    <span class="attr">&quot;considered_access_paths&quot;</span>: [</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;rows_to_scan&quot;</span>: <span class="number">299335</span>,</span><br><span class="line">                                            <span class="attr">&quot;access_type&quot;</span>: <span class="string">&quot;scan&quot;</span>,</span><br><span class="line">                                            <span class="attr">&quot;resulting_rows&quot;</span>: <span class="number">299335</span>,</span><br><span class="line">                                            <span class="attr">&quot;cost&quot;</span>: <span class="number">30166</span>,</span><br><span class="line">                                            <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">&quot;condition_filtering_pct&quot;</span>: <span class="number">100</span>,</span><br><span class="line">                                <span class="attr">&quot;rows_for_plan&quot;</span>: <span class="number">299335</span>,</span><br><span class="line">                                <span class="attr">&quot;cost_for_plan&quot;</span>: <span class="number">30166</span>,</span><br><span class="line">                                <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;attaching_conditions_to_tables&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;original_condition&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">                            <span class="attr">&quot;attached_conditions_computation&quot;</span>: [</span><br><span class="line">                            ],</span><br><span class="line">                            <span class="attr">&quot;attached_conditions_summary&quot;</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`employees`&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;attached&quot;</span>: <span class="literal">null</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;refine_plan&quot;</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`employees`&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;join_execution&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>观查日志，一条SQL语句的执行可以分为三个阶段：</p><ul><li>join_preparation（准备阶段）：解析SQL语句</li><li>join_optimization（优化阶段）：根据SQL句义优化</li><li>join_execution（执行阶段）：执行语句</li></ul><h1>查询优化器</h1><p>查询优化器分为两类：<strong>基于规则的优化器(Rule-Based Optimizer，RBO) 和基于代价的优化器(Cost-Based Optimizer，CBO)</strong></p><h2 id="基于规则的优化器-Rule-Based-Optimizer，RBO">基于规则的优化器(Rule-Based Optimizer，RBO)</h2><p>没有人能保证自己写的SQL语句就一定是最优的。为了保证数据库的查询高效，无论用户的SQL语句怎样，或者说无论读取的表中数据是怎么样的，要保证最后生成的执行计划都是一样的，也就是查询数据该怎样查保证最快。</p><p>为了解决这一问题，RBO中有一套严格顺序的优化规则。在执行SQL语句前，会根据优化规则对关系表达式进行转换，转换之后，原关系表达式可能会变成另外一个关系表达式，或者原有表达式可能会被裁剪掉；最后生成最终执行计划。</p><h3 id="等值传递（equality-propagation）">等值传递（equality_propagation）</h3><p>一条SQL语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> salaries, employees <span class="keyword">where</span> salaries.salary <span class="operator">=</span> salaries.emp_no <span class="keyword">and</span> salaries.emp_no <span class="operator">=</span> employees.emp_no  <span class="keyword">and</span> employees.emp_no <span class="operator">=</span> <span class="number">10001</span>;</span><br></pre></td></tr></table></figure><p>查看优化日志：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;join_optimization&quot;</span>: &#123;</span><br><span class="line">         <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">         <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">           &#123;</span><br><span class="line">             <span class="attr">&quot;condition_processing&quot;</span>: &#123;</span><br><span class="line">               <span class="attr">&quot;condition&quot;</span>: <span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;((`salaries`.`salary` = `salaries`.`emp_no`) and (`salaries`.`emp_no` = `employees`.`emp_no`) and (`employees`.`emp_no` = 10001))&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                 &#123;</span><br><span class="line">                   <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(multiple equal(10001, `salaries`.`salary`, `salaries`.`emp_no`, `employees`.`emp_no`))&quot;</span></span><br><span class="line">                 &#125;,</span><br><span class="line">                 &#123;</span><br><span class="line">                   <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;constant_propagation&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(multiple equal(10001, `salaries`.`salary`, `salaries`.`emp_no`, `employees`.`emp_no`))&quot;</span></span><br><span class="line">                 &#125;,</span><br><span class="line">                 &#123;</span><br><span class="line">                   <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;multiple equal(10001, `salaries`.`salary`, `salaries`.`emp_no`, `employees`.`emp_no`)&quot;</span></span><br><span class="line">                 &#125;</span><br><span class="line">               ]</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;,</span><br><span class="line">       ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据日志，可以看到，SQL语句的条件发生了改变</p><p><code>(multiple equal(10001, </code>salaries<code>.</code>salary<code>, </code>salaries<code>.</code>emp_no<code>, </code>employees<code>.</code>emp_no<code>))</code></p><p>如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> salaries, employees <span class="keyword">where</span> salaries.salary <span class="operator">=</span> <span class="number">10001</span> <span class="keyword">and</span> salaries.emp_no <span class="operator">=</span> <span class="number">10001</span>  <span class="keyword">and</span> employees.emp_no <span class="operator">=</span> <span class="number">10001</span>;</span><br></pre></td></tr></table></figure><h3 id="常量传递（constant-propagation）">常量传递（constant_propagation）</h3><p>一条SQL语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> salaries <span class="keyword">where</span> emp_no <span class="operator">=</span> <span class="number">10001</span> <span class="keyword">and</span> salary <span class="operator">&gt;</span> emp_no;</span><br></pre></td></tr></table></figure><p>查看优化日志：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;join_optimization&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;condition_processing&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;condition&quot;</span>: <span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;((`salaries`.`emp_no` = 10001) and (`salaries`.`salary` &gt; `salaries`.`emp_no`))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;((`salaries`.`salary` &gt; 10001) and multiple equal(10001, `salaries`.`emp_no`))&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;constant_propagation&quot;</span>, --- 常量传递</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;((`salaries`.`salary` &gt; 10001) and multiple equal(10001, `salaries`.`emp_no`))&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;((`salaries`.`salary` &gt; 10001) and multiple equal(10001, `salaries`.`emp_no`))&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">     ],</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>根据日志，可以看到，SQL语句的条件发生了改变</p><p><code>((</code>salaries<code>.</code>salary<code>&gt; 10001) and multiple equal(10001,</code>salaries<code>.</code>emp_no<code>))</code></p><p>如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> salaries <span class="keyword">where</span> emp_no <span class="operator">=</span> <span class="number">10001</span> <span class="keyword">and</span> salary <span class="operator">&gt;</span> <span class="number">10001</span>;</span><br></pre></td></tr></table></figure><h3 id="移除无用条件（trivial-condition-removal）">移除无用条件（trivial_condition_removal）</h3><p>一条SQL语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> salaries <span class="keyword">where</span> emp_no <span class="operator">=</span> <span class="number">10001</span> <span class="keyword">and</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>查看优化日志：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;join_optimization&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;condition_processing&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;condition&quot;</span>: <span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;((`salaries`.`emp_no` = 10001) and (1 = 1))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;((1 = 1) and multiple equal(10001, `salaries`.`emp_no`))&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;constant_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;((1 = 1) and multiple equal(10001, `salaries`.`emp_no`))&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;multiple equal(10001, `salaries`.`emp_no`)&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据日志，可以看到，SQL语句的条件发生了改变</p><p><code>multiple equal(10001, </code>salaries<code>.</code>emp_no<code>)</code></p><p>如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> salaries <span class="keyword">where</span> emp_no <span class="operator">=</span> <span class="number">10001</span></span><br></pre></td></tr></table></figure><h2 id="基于代价的优化器-Cost-Based-Optimizer，CBO">基于代价的优化器(Cost-Based Optimizer，CBO)</h2><p>经过了RBO的转换，得到的执行计划并不是最后的和最优的。比如优化后语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> salaries <span class="keyword">where</span> emp_no <span class="operator">=</span> <span class="number">10001</span> <span class="keyword">and</span> salary <span class="operator">&gt;</span> <span class="number">10001</span>;</span><br></pre></td></tr></table></figure><p>可以有这三种查询计划：</p><ul><li>先把<code>salaries</code>表数据取出来，再根据条件筛选。</li><li>假设<code>emp_no</code>或<code>salary</code>存在索引，先根据索引找出数据，再根据其他条件筛选数据。</li><li>假设<code>emp_no</code>和<code>salary</code>均存在索引，那先根据哪个索引查找数据呢？</li></ul><p>也许你会说，有索引当然用索引啊，但是像第三种这种情况，又该如何选用适合的索引。而这就是CBO所解决的问题。CBO会根据**统计信息和代价模型(Cost Model)**计算每个执行计划的Cost（代价或成本），从中挑选Cost最小的执行计划。</p><p>Cost主要可以分为<strong>I/O成本</strong>，即存储引擎把数据从硬盘读入内存的损耗时间，和<strong>CPU成本</strong>，即CPU读取以及检测记录是否满足对应的搜索条件、对结果集进行排序等这些操作损耗的时间。</p><h3 id="优化步骤">优化步骤</h3><p>如下语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> emp_no <span class="operator">&gt;</span> <span class="number">10001</span> <span class="keyword">and</span> emp_no <span class="operator">&lt;</span> <span class="number">20000</span> <span class="keyword">and</span> hire_date <span class="operator">=</span> <span class="string">&#x27;1985-11-21&#x27;</span>;</span><br></pre></td></tr></table></figure><p>表中索引如下：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210201100344853.png" alt="image-20210201100344853"></p><p>计划选择：</p><ul><li>全表扫描</li><li>主键索引（emp_no）</li><li>二级索引（hire_date）</li></ul><p>这里存在三种执行计划，究竟选择哪种，需要经过CBO计算。</p><h4 id="I-O成本">I/O成本</h4><p>I/O成本，即存储引擎把数据从硬盘读入内存的损耗时间。</p><p>MySQL中的存储引擎把所有数据进行分页管理，也就是存储引擎每次从硬盘至少需要读取一页数据，大小为16KB，CBO把这一过程成本常量化，每从硬盘加载一页数据到内存，成本为1，进行估算。</p><p>如全表扫描：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;employees&#x27;</span></span><br></pre></td></tr></table></figure><p>每个表维护了一系列统计信息，使用该语句查看表的统计信息，如下：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210201114044402.png" alt="image-20210201114044402"></p><p><strong>Data_length</strong>即为表中数据大小，因此，我们可以算出I/O成本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I/O Cost = 15220736 ÷ 16 ÷ 1024 × 1 = 929</span><br></pre></td></tr></table></figure><p>得到I/O成本为929</p><h4 id="CPU成本">CPU成本</h4><p>CPU成本，即CPU读取以及检测记录是否满足对应的搜索条件、对结果集进行排序等这些操作损耗的时间。</p><p>把数据按页加载到内存后，需要经过CPU的计算，也就是每一行数据每一行数据的比对，找出结果集。对这一过程的成本，CBO标记为0.2，也就是说，CPU计算一行数据，成本为0.2。</p><p>根据上图，Rows即为行数，因此，计算CPU成本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPU Cost = 299246 × 0.2 = 59849.2</span><br></pre></td></tr></table></figure><p>得到CPU成本为59849.2</p><h4 id="COST">COST</h4><p>总的成本为I/O成本+CPU成本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cost = I/O Cost + CPU Cost = 929 + 59849.2 = 60778.2‬</span><br></pre></td></tr></table></figure><p>与优化日志的对比。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;rows_estimation&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`employees`&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;range_analysis&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;table_scan&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;rows&quot;</span>: <span class="number">299733</span>,</span><br><span class="line">                    <span class="attr">&quot;cost&quot;</span>: <span class="number">60878</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">//....</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>可以看到&quot;cost&quot;: 60878</code>，结果还是符合预期的</p><p>但是有的版本和计算结果不一样，相差甚大，目前没有找到答案，暂时不讨论。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># WIN MySQL5<span class="number">.7</span><span class="number">.32</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;rows_estimation&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`employees`&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;range_analysis&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;table_scan&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;rows&quot;</span>: <span class="number">299733</span>,</span><br><span class="line">                    <span class="attr">&quot;cost&quot;</span>: <span class="number">325976</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">//....</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样的，主键索引和二级索引使用的都是同样的方法，估算出最终的成本，取出最小的，作为最终的执行计划。</p><h1>总结</h1><ul><li>MySQL有自己的查询优化器，分为两类：基于规则的优化器和基于代价的优化器。</li><li>在开启日志的情况下，每执行一条SQL语句，都会记录优化日志。</li><li>在查询时，MySQL有隐性计划，全表扫描。究竟是选择全部扫描还是选择索引，是基于代价的优化器估算扫描的代价决定。</li></ul><h1>参考文章</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/40478975">SQL优化器原理——查询优化器综述</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> MYSQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>字节后端研发实习面试记录（已挂）</title>
      <link href="/2021/02/04/%E5%AD%97%E8%8A%82%E5%90%8E%E7%AB%AF%E7%A0%94%E5%8F%91%E5%AE%9E%E4%B9%A0%E9%9D%A2%E8%AF%95%E8%AE%B0%E5%BD%95%EF%BC%88%E5%B7%B2%E6%8C%82%EF%BC%89/"/>
      <url>/2021/02/04/%E5%AD%97%E8%8A%82%E5%90%8E%E7%AB%AF%E7%A0%94%E5%8F%91%E5%AE%9E%E4%B9%A0%E9%9D%A2%E8%AF%95%E8%AE%B0%E5%BD%95%EF%BC%88%E5%B7%B2%E6%8C%82%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p>前两天接到字节后端研发职位面试邀请，一面就挂了（真的太太太菜了），记录下来，以此为戒。</p><h1>面试</h1><p>面试提问相对简单。</p><h1>1、算法题</h1><p>随机的算法题，想进好一点厂子，刷算法是必不可少的了，我重来没刷过。</p><h1>2、网络——三次握手，四次挥手</h1><p>虽然知道，但没认真深究过。</p><h2 id="2-1-四次挥手的第二第三次是否可以合并">2.1 四次挥手的第二第三次是否可以合并</h2><p>没仔细研究过，答得有点随意</p><h1>3、数据库</h1><p>数据主要与索引有关。</p><h2 id="3-1-索引结构">3.1 索引结构</h2><p>这个不会可以转行了。</p><h2 id="3-2-为什么选择B-树">3.2 为什么选择B+树</h2><p>答得断断续续，没答到太多重点。</p><h2 id="3-4-隔离级别">3.4 隔离级别</h2><p>瞬间失忆，慢吞吞回忆才想起来。</p><h1>4、有什么想问的</h1><p>不问，好过随便提问。</p><h1>总结</h1><p>这半年来有点浮躁了，去奇安信实习（主要写前端），下班基本没怎么学习新的知识，也不回看以前写过的文章。白白浪费了大半年，Java代码也打得很少。做算法题时，出现很多低级语法错误，虽然都改回来了，但有什么用，还是做不出来。</p><p>上面这些都是最简单，最基础了。最致命的是，都学过，还写过文章，都没回答好。</p><p>不说了，以此为戒，脚踏实地，失败是成功之母，认真复盘，备战下次。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试 </tag>
            
            <tag> 后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>InnoBD底层原理</title>
      <link href="/2021/01/27/InnoBD%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"/>
      <url>/2021/01/27/InnoBD%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1>Mysql中的InnoDB</h1><p>下面是一张<strong>MySQL</strong>数据库的架构图</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210126144655131.png" alt="image-20210126144655131"></p><p>从图中可以看到，Mysql数据库的底层实现分为很多层次。而我们所关心的<code>InnoDB</code>则在<strong>可插拔存储引擎（Pluggable storage Engines）<strong>层，也就是Mysql数据库的</strong>存储引擎</strong>。</p><p>除了<code>InnoDB</code>之外，MySQL数据库还有很多的存储引擎，每个引擎的特性都有一定的差别。像<code>Memory</code>，则是把数据存储在内存中，而不是硬盘。</p><p>从图中我们也可以看出存储引擎在MySQL数据库中的重要性——承上启下。在存储引擎之上，有<strong>连接池（Connection Pool）</strong>，**SQL解析器（Parser）<strong>等。这些都是组成Mysql数据库的重要模块。数据经过这些模块的处理，再通过存储引擎，存储到</strong>文件系统（File System）**中和记录相应的日志。</p><p>而我们的要学习的是在互联网中非常常用存储引擎——<strong>InnoDB</strong>。</p><h1>InnoDB存储方式</h1><p>首先要明确一点，计算机想要处理数据，要先把数据从硬盘中读取到内存。</p><p>如果让你设计存储方式，你会怎么做？</p><p>一条一条的读，一条一条的存？那I效率也太低了。</p><p>如果你学过有关操作系统的知识，应该知道系统是把数据<strong>以分页的方式</strong>存储到硬盘中。</p><p><strong>InnoDB</strong>也不例外，采取类似的方式：<strong>将数据划分为若干个页，以页作为磁盘和内存之间交互的基本单位</strong>。<strong>InnoDB</strong>页的大小一般为<strong>16KB</strong>，<code>使用以下命令查看页大小</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> STATUS <span class="keyword">like</span> <span class="string">&#x27;Innodb_page_size&#x27;</span></span><br></pre></td></tr></table></figure><p>也就是说，每次引擎从硬盘中读取数据时，至少为16KB，同时每一次最少把16KB数据存储到硬盘。</p><h1>InnoDB数据页的结构</h1><p>页是<strong>InnoDB</strong>管理存储空间的基本单位，下图是InnoDB数据页的结构</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210127165513680.png" alt="img"></p><ul><li>File Header（文件头部）：记录页的一些头信息，共38字节</li><li>Page Header（页面头部）：记录数据页的状态信息，共56字节</li><li>Infifimum + Supremum Records（最小记录和最大记录）：虚拟的行记录，Infimun表示比任何主键值都小的值，Supremum表示比任何可能的值都大的值。</li><li>User Records（用户记录）：实际存储的行记录内容。也就是用户存储数据的地方</li><li>Free Space（空闲空间）：页中尚未使用的空间。记录该页的可用空间，主要与<code>User Records</code>有关，<code>User Records</code>越大，<code>Free Space</code>越小，当<code>Free Space</code>被分配完，也就代表改页已满，需要重新申请新的页。</li><li>Page Directory（页面目录）：存放了记录的相对位置。</li><li>File Trailer（文件尾部）：校验页是否完整，共8字节。通过该外置判断该页是否为完整的一页。</li></ul><h1>InnoDB行格式</h1><p><strong>InnoDB</strong>对整个数据库的数据是以页的方式管理，但对用户的数据，是<strong>以行的方式</strong>存储到页中。</p><p><strong>InnoDB</strong>有多种行格式，分别是<strong>Compact、Redundant、Dynamic和Compressed</strong>。可以在创建时指定表的行格式。</p><p><strong>Compact</strong>是应用较广泛的行格式。结构 如下图</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210126164917321.png" alt="image-20210126164917321"></p><p>每一行不仅要记录数据，还要记录这行数据的一些额外信息。</p><ul><li>变长字段长度列表：MySQL是支持一些变长的数据类型，比如VARCHAR(n)，VARBINARY(n)等，但是这些数据类型是用户自定义长度的，具体存储多少字节MySQL是不知道的，所以需要把真实存储数据的大小，就是占用字节数也存起来，把这记录放在行的开头部位，形成一个列表。</li><li>NULL值列表：NULL值在MySQL中一个特殊的值，MySQL会统一管理，存一个标记为在NULL值列表中。<ul><li>二进制位的值为1时，代表该列的值为NULL。</li><li>二进制位的值为0时，代表该列的值不为NULL。</li></ul></li><li>记录头信息：用于描述记录的记录头信息。</li><li>RowID：行ID,唯一标识一条记录。如果表中没有定义主键，则会选择一个有<code>Unique</code>约束属性作为主键，如果连<code>Unique</code>都没有的话，则会选择RowID作为主键</li><li>TransactionID：事务ID</li><li>RollPointer：回滚指针</li></ul><h1>索引的产生</h1><p>1、使用<code>InnoDB</code>创建一张表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> demo_innodb(</span><br><span class="line">   a <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">   b <span class="type">int</span>,</span><br><span class="line">   c <span class="type">int</span>,</span><br><span class="line">   d <span class="type">int</span></span><br><span class="line"> )ENGINE <span class="operator">=</span> InnoDB; <span class="operator">/</span><span class="operator">/</span> 指定使用存储引擎</span><br></pre></td></tr></table></figure><p>2、插入一些数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> demo_myisam <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> demo_myisam <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">4</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> demo_myisam <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> demo_myisam <span class="keyword">VALUES</span>(<span class="number">7</span>,<span class="number">9</span>,<span class="number">3</span>,<span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> demo_myisam <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="number">4</span>,<span class="number">54</span>,<span class="number">43</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> demo_myisam <span class="keyword">VALUES</span>(<span class="number">8</span>,<span class="number">7</span>,<span class="number">3</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>3、结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210127145807063.png" alt="image-20210127145807063"></p><p>似乎挺正常，换一种引擎<code>MyISAM</code>进行同样的操作，得到以下结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210127150927649.png" alt="image-20210127150927649"></p><p>仔细对比，发现使用<code>InnoDB</code>引擎创建的表，<code>a</code>列数据是从小到大排好序的，而使用<code>MyISAM</code>引擎的数据是按数据的插入顺序排序的。也就是说<code>InnoDB</code>引擎在插入数据时会根据主键大小排好序。</p><p>如图</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210127152923356.png" alt="image-20210127152923356"></p><p>按照<code>InnoDB</code>数据存储结构，单个数据以行结构存储，将这些数据进行分页管理。假设每页存储4条数据（实际存储16kB数据），那么再继续插入，结果如下</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210127153716451.png" alt="image-20210127153716451"></p><p>第一页存满，会新开一页，页中的额外信息会存储下一页的指针，形成链式结构。</p><p>但是，MySQL数据库在查找数据的时候，不可能任何情况下都把整个表的数据一页一页的都加载一遍，一行一行数据的去比对，这样效率太慢了。</p><p>为了提高效率，可以把主键提取出来。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210127155425851.png" alt="image-20210127155425851"></p><p>但是这样按主键查找会提高效率吗？很显然，一个个查找，并不会提高查询的效率。</p><p>为了更进一步提高查询效率。在主键为有序集基础上，可以使用<strong>二分法</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20210127160031717.png" alt="image-20210127160031717"></p><p>把每页中行数据主键最小值（最大值也可以）提取出来，再携带上页号（指针），并指向该页，形成树形结构。</p><p>当查找主键值<code>1=&lt; x =&lt; 7</code>的数据，则在左节点，<code>x &gt;= 7</code>则在右节点，大大提高查询效率。</p><p>而这种的树形结构，就是<strong>B+树</strong>（具体B+树解析，这篇文章：<a href="https://www.playwi0.com/2020/07/29/%E7%82%B9%E8%A7%A3MySql%E9%80%89%E6%8B%A9%E4%BA%86B-%E6%A0%91/">点解MySql选择了B+树</a>）。</p><h1>索引区别</h1><p>MySQL数据库中的 B+ 树索引可以分为<strong>聚集索引（clustered index）和辅助索引（secondary index）</strong></p><h2 id="聚集索引">聚集索引</h2><p>像上面描述的，B+树的叶子节点携带所有的行信息，普通节点为索引，可以称为聚集索引。</p><h2 id="辅助索引">辅助索引</h2><p>在MySQL数据库中，除去主键索引，还可以建立额外的<strong>联合索引</strong>，或者说<strong>二级索引</strong>，这些都可以统称为<strong>辅助索引</strong>，同样的，它们也是B+树结构。</p><p>试想一下，如果每建立一个辅助索引，都需要像聚集索引一样，叶子节点携带数据，那么岂不是会照成大堆数据重复，从而消耗大量空间。所以为了节省空间，辅助索引的叶子节点，保存的是该行数据的主键，也就是另一份索引。所以，通过辅助索引查找数据，会进行一次回表操作，也就是会根据主键再查一次。</p><h1>总结</h1><ul><li><p>InnoDB存储引擎会把所有数据进行分页管理，有自己的页结构。</p></li><li><p>对于用户数据，按行结构存储</p></li><li><p>InnoDB存储引擎会自动为主键（如果没有它会自动帮我们添加）建立聚簇索引，聚簇索引的叶子节点包</p></li></ul><p>含完整的用户记录。</p><ul><li><p>每个索引都对应一棵B+树。用户记录都存储在B+树的叶子节点，所有目录记录都存储在非叶子节点。</p></li><li><p>辅助索引的叶子节点保存的是辅助索引和主键，经过辅助索引查找到的结果会进行一次回表。</p></li><li><p>通过索引查找记录是从B+树的根节点开始，一层一层向下搜索。由于每个页面都按照索引列的值建立了</p><p>页目录，所以在这些页面中的查找非常快。</p></li></ul><h1>参考文章</h1><ul><li><a href="https://mp.weixin.qq.com/s?__biz=MzI2MDQzMTU2MA==&amp;mid=2247483860&amp;idx=1&amp;sn=b9c8f5e69bedfe0c8dff149a0579f9dc&amp;chksm=ea688a73dd1f036591cd5033b96f9bbbcf7c20040592aa6abffd5a2cadceea80910cd64bfa19&amp;token=1896344902&amp;lang=zh_CN#rd">深入理解InnoDB – 存储篇</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> MYSQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> InnoDB </tag>
            
            <tag> 索引 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis缓存问题</title>
      <link href="/2020/08/07/Redis%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/"/>
      <url>/2020/08/07/Redis%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200805151644572.png" alt="image-20200805151644572"></p><p>正常情况下，一个请求会根据业务需求到缓存（<strong>Redis</strong>）中取数据，如果缓存中有缓存到数据，则直接返回；如果缓存中没有，则需要在数据库查询出数据，再存到缓存中，最后返回。</p><p>理论上应该是实这样的，但是在实际业务出现许多意料之外的情况。</p><p>比如：<strong>缓存穿透，缓存击穿，缓存雪崩</strong>，这是<strong>Redis</strong>常见的三个问题。但是我每次都把它们之间的概念搞混，这次做个记录。</p><h1>缓存穿透</h1><h2 id="什么是缓存穿透">什么是缓存穿透</h2><p>正常的情况，数据在数据库中有，同时缓存中也会存在一份。</p><p>但是某些查询请求，查询的数据缓存中没有，同时数据库也没有；如果是这种请求是大量的，甚至是恶意的，就白白的消耗系统的性能，还有可能造成系统瘫痪。</p><p>上述这种现象被称之为：<strong>缓存穿透</strong>。</p><h2 id="解决办法">解决办法</h2><p><strong>缓存穿透</strong>产生的主要原因是：<strong>用户查询了不存在的数据，对于业务系统来说，这些都是垃圾请求</strong>。</p><h3 id="缓存空对象">缓存空对象</h3><p>既然数据库中不存在该数据，不想查询数据库，那么可以在缓存中缓存一个空对象来解决该问题。</p><p><strong>空对象：NullValueResultDO.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NullValueResultDO</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6550539547145486005L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>伪代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line">     UserDAO userDAO;</span><br><span class="line">     RedisCache RedisCache;</span><br><span class="line"> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> UserDO <span class="title">getUser</span><span class="params">(String userNick)</span> </span>&#123;</span><br><span class="line">          Object object = RedisCache.get(userNick);</span><br><span class="line">          <span class="keyword">if</span>(object != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span>(object <span class="keyword">instanceof</span> NullValueResultDO) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> (UserDO)object;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               User user = userDAO.getUser(userNick);</span><br><span class="line">               <span class="keyword">if</span>(user != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    RedisCache.put(userNick,user);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    RedisCache.put(userNick, <span class="keyword">new</span> NullValueResultDO());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> user;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="布隆过滤器">布隆过滤器</h3><p>缓存一个空对象也是要空间的，大量的空对象会造成空间浪费，典型的空间换时间做法。</p><p>那么有没有更好的解决办法？</p><p>如果可以<strong>拦截</strong>这些垃圾查询请求，那么问题就能迎刃而解；而判断是否为垃圾查询请求的依据是数据库是否存在改数据。</p><p>正好，<strong>布隆过滤器</strong>可以做到这一点。</p><p><strong>布隆过滤器</strong>类似于哈希表，不过它采用了三个（或三个以上）不同哈希函数对同一个数据进行哈希，同时表中并不记录真实数据，而是一个用来作布尔判断的值。</p><p>比如一个数据10，通过三个哈希计算，会落到表中三个不同位置。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200805170743258.png" alt="image-20200805170743258"></p><p>添加多个数据，那么如何判断某个数据是否存在呢？</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200805171606293.png" alt="image-20200805171606293"></p><p>例如查找数据0，也需要经过三个哈希计算，也会落到表中三个不同位置</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200805171949475.png" alt="image-20200805171949475"></p><p>如果这三个位置，其中有一个为空，也就是没有数据哈希落到这个位置上，说明查找的这个数据是不存在的。</p><p>那么三个位置都不为空，能说明数据一定存在吗？</p><p>答案是不能。学过哈希表都是知道，哈希在有限的空间下是会存在哈希冲突的，也就是说刚好查找的数据在表内也被占用了，这时候只能判断这个数据是可能存在的，并不能100%确认数存在。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200805172232621.png" alt="image-20200805172232621"></p><p>因此<strong>布隆过滤器</strong>是有一定误判率，但是属于可接受范围之内。</p><p>根据上面所描述的，可以预先将数据库索引加载到<strong>布隆过滤器</strong>，这样，在业务系统查询数据之前，可以先用布隆过滤器过滤一遍，再查询数据库或缓存。</p><p><strong>伪代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line">     UserDAO userDAO;</span><br><span class="line">     RedisCache RedisCache;</span><br><span class="line"> </span><br><span class="line">     <span class="function"><span class="keyword">public</span> UserDO <span class="title">getUser</span><span class="params">(String userNick)</span> </span>&#123;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//先走布隆过滤器</span></span><br><span class="line">          <span class="keyword">if</span>(!bloomFilter.isExist(String.valueOf(id)))&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> R().setMsg(<span class="string">&quot;查询无果&quot;</span>).setData(<span class="keyword">new</span> NullValueResultDO()).setCode(<span class="number">600</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          Object object = RedisCache.get(userNick);</span><br><span class="line">          <span class="keyword">if</span>(object != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span>(object <span class="keyword">instanceof</span> NullValueResultDO) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> (UserDO)object;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               User user = userDAO.getUser(userNick);</span><br><span class="line">               <span class="keyword">if</span>(user != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    RedisCache.put(userNick,user);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    RedisCache.put(userNick, <span class="keyword">new</span> NullValueResultDO());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> user;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先过一遍<strong>布隆过滤器</strong>，可以再查询缓存，有就直接返回，没有再查询数据库。</p><h1>缓存击穿</h1><h2 id="什么是缓存击穿">什么是缓存击穿</h2><p>在业务系统中加入缓存，是希望业务存取数据能更加高效。如果数据在缓存中没有，在数据库中有（一般是缓存时间到期），那么在高并发环境下，大量的查询请求同时读取缓存没有得到数据，又同时去查询数据库，会瞬间给数据库造成巨大压力，小则系统反应缓慢，大则直接宕机。</p><p>上述这种现象称之为：<strong>缓存击穿</strong>。</p><h2 id="解决办法-2">解决办法</h2><p><strong>缓存击穿</strong>其实要解决的是重建缓存的问题。查询请求只有在缓存查不到的情况下才会去数据库查找，因为高并发的关系，缓存还没重建完成，就已去查询数据，或者大量线程去重建缓存，而重建缓存的过程只需要一个线程就可以，因此，我们需要加锁。</p><p><strong>伪代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">    String value = redis.get(key);</span><br><span class="line">    <span class="keyword">if</span>(value == <span class="keyword">null</span>)&#123;</span><br><span class="line">        String mutexKey = <span class="string">&quot;mutex:key:&quot;</span>+key; <span class="comment">//设置互斥锁的key</span></span><br><span class="line">        <span class="keyword">if</span>(redis.set(mutexKey,<span class="string">&quot;1&quot;</span>,<span class="string">&quot;ex 180&quot;</span>,<span class="string">&quot;nx&quot;</span>))&#123; <span class="comment">//给这个key上一把锁，ex表示只有一个线程能执行，过期时间为180秒</span></span><br><span class="line">          value = db.get(key);</span><br><span class="line">          redis.set(key,value);</span><br><span class="line">          redis.delete(mutexKety);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="comment">// 其他的线程休息100毫秒后重试</span></span><br><span class="line">          Thread.sleep(<span class="number">100</span>);</span><br><span class="line">          getKey(key);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>拿到锁的线程去查询数据库，然后重建缓存；未得到锁的线程，先等待缓存重建完成，再去取值。</p><h1>双穿合璧</h1><p>上述<strong>缓存穿透</strong>和<strong>缓存击穿</strong>的解决办法都是针对单个问题，如果两个问题同时出现怎么解决？</p><h2 id="解决办法-3">解决办法</h2><p>其实也就是将前面两个问题解决办法进行合并，就可以很好的解决。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span>  R <span class="title">synchronizedSelectOrderById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//先走布隆过滤器</span></span><br><span class="line">    <span class="keyword">if</span>(!bloomFilter.isExist(String.valueOf(id)))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> R().setMsg(<span class="string">&quot;查询无果&quot;</span>).setData(<span class="keyword">new</span> NullValueResultDO()).setCode(<span class="number">600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询缓存</span></span><br><span class="line">    Object redisObj = RedisCache.get(String.valueOf(id));</span><br><span class="line">    <span class="comment">//命中缓存</span></span><br><span class="line">    <span class="keyword">if</span>(redisObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//正常返回数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> R().setCode(<span class="number">200</span>).setData(redisObj).setMsg(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        redisLock.lock(String.valueOf(id));</span><br><span class="line">        <span class="comment">//查询缓存</span></span><br><span class="line">        redisObj = RedisCache.get(String.valueOf(id));</span><br><span class="line">        <span class="comment">//命中缓存</span></span><br><span class="line">        <span class="keyword">if</span>(redisObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//正常返回数据</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> R().setCode(<span class="number">200</span>).setData(redisObj).setMsg(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Order order = orderMapper.selectOrderById(id); <span class="comment">//查数据库</span></span><br><span class="line">        <span class="keyword">if</span> (order != <span class="keyword">null</span>) &#123;</span><br><span class="line">            RedisCache.set(String.valueOf(id), order,<span class="number">5</span>,TimeUnit.SECONDS);  <span class="comment">//加入缓存</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> R().setCode(<span class="number">200</span>).setData(order).setMsg(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        redisLock.unlock(String.valueOf(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> R().setCode(<span class="number">500</span>).setData(<span class="keyword">new</span> NullValueResultDO()).setMsg(<span class="string">&quot;查询无果&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>缓存雪崩</h1><h2 id="什么是缓存雪崩">什么是缓存雪崩</h2><p><strong>缓存雪崩</strong>一看名字就知道事态非常严重，机器崩了。</p><p>而造成这一问题的原因主要有两个：</p><ul><li>缓存机器宕机</li><li>大量缓存数据在同一时间过期，同时失效，请求全部到了数据库，压力过大导致数据库宕机。</li></ul><h2 id="解决办法-4">解决办法</h2><p>想这种<strong>机器宕机</strong>的问题，已经很难在代码层面控制，只做到预防，尽量减少。</p><p>1、不同的<strong>key</strong>，设置不同的过期时间，让缓存失效的时间尽量均匀。（数据量大时，难以控制）</p><p>2、二级缓存，A为原始缓存，B为拷贝缓存，A失效时，可以访问B。A的失效时间设置为短期，B为长期。（占用空间）</p><p>3、缓存失效后，利用线程锁，重建缓存，其他线程等待。（影响系统响应速度）</p><p>。。。。。</p><p>以上方法还是很难解决机器宕机，如果某台机器真的宕机，可能整个系统都要停止运行。目前比较好的办法是<strong>搭建集群</strong>。</p><h1>总结</h1><p>上述三个问题是缓存中比较常见的，总的来说就是，缓存与数据库一致性问题，而这些都只是这里面的一部分。</p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>点解MySql选择了B+树</title>
      <link href="/2020/07/29/%E7%82%B9%E8%A7%A3MySql%E9%80%89%E6%8B%A9%E4%BA%86B-%E6%A0%91/"/>
      <url>/2020/07/29/%E7%82%B9%E8%A7%A3MySql%E9%80%89%E6%8B%A9%E4%BA%86B-%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h1>概述</h1><p><strong>B+树</strong>是一种数据结构，常用于数据库和系统的文件系统中，作为数据元素索引。</p><p>为什么<strong>B+树</strong>会进入程序员视野，除去它作为一种数据结构，而最大的原因是 <strong>MySql</strong> 数据库选择它作为元素索引。其实 <strong>MySql</strong> 和<strong>B+树</strong>没有直接关系，而真正与<strong>B+树</strong>有关系的是 <strong>MySQL</strong> 的默认存储引擎 <strong>InnoDB</strong>（旧版本为 <strong>MyISAM</strong> ）。</p><p>那为什么要选择<strong>B+树</strong>作为元素索引结构。</p><p>PS：<strong>点解</strong>粤语音译，<strong>为什么</strong>的意思。</p><h1>为什么选择B+树</h1><p>现在，我们把一切有关数据库的东西都忘掉，从零开始，让你自己来开发一个数据库，你会怎样存储数据，或者说选什么数据结构来存储数据。</p><h2 id="线性结构">线性结构</h2><p>线性结构常用的：<strong>数组，链表，哈希表</strong>等，以这三种为例我们一一分析。</p><h3 id="数组">数组</h3><p>如果选用<strong>数组</strong>作为数据的存储结构，那么最基本的就是下标。下标怎么解决？</p><p>不是有主键吗，选择主键作为下标不就行，咋一看确实没啥问题。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200727103703371.png" alt="image-20200727103703371"></p><p>但是，随着存储数据量的增加，数据库存储的数据量也不断增大，那么数组也在不断的增大，频繁的改变数组的长度是个很消耗性能的过-程。如果想减少修改次数，那么一开始就要定好长度。这就变的非常难，因为没有人知道，他们数据量是多少，即使预测一个范围值也是不可靠的，有可能会造成结构很稀疏，浪费系统空间，也有可能超出范围，消耗系统性能。</p><p>其次，如果要删除一个数据，这个位置可以清空，但是，这个位置或许会永远为空，这就更加浪费空间了。</p><h3 id="链表">链表</h3><p>根据数组结构的缺陷，链表的优势就体现出来了。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200727110507709.png" alt="image-20200727110507709"></p><p>链表可以随时增加数据，不会预支系统空间，长度动态改变，很不错。</p><p>但是，查找的时候怎么办，运气好第一个就是，运气不好，最后一个是。如果数据量庞大，那么查找的时间也是巨大的。</p><p>那么怎么解决查找的问题呢？<strong>哈希表</strong> ？。</p><h3 id="哈希表">哈希表</h3><p>哈希表能解决上面链表的查找问题，但是它不能解决，链表所带来的问题。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200728095226030.png" alt="image-20200728095226030"></p><p>数据库的存储的数据量会越来越大，哈希碰撞的次数也会越来越多，里面的链表也会越来越长，又回到前面链表的问题。</p><p>哈希表长度的改变需要重新哈希，这也是非常消耗性能和空间的。</p><p>同时。线性表会带一个非常大的问题，数据存储介质的选择。如果是内存，那么数据量的增大，消耗的内存空间也必然增大，这简直就是一个无底洞。如果是硬盘，那么系统的<strong>IO</strong>的时间大大增加，性能大大降低，这是很致命的。还有对于范围查询和排序<strong>哈希表</strong>也无法很好地支持，最终导致全表扫描。</p><h2 id="树形结构">树形结构</h2><p>线性结构无法保证数据库的性能，查找问题很难解决。</p><p>那是否可以用树形结构？</p><h3 id="二叉树">二叉树</h3><p>树形结构里面比较经典的就是二叉树。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/528223e7db6c2662ec52572a18106c3b.jpg" alt="img"></p><p>如上图，假设以（index，row）的方式存储，一个节点就对应一行数据。</p><p>如果以<strong>id</strong>为据查找，利用二叉树天然的优势，自带二分查找算法被动，可以非常快的找到数据，性能上具有一定优势。</p><p>以<strong>id</strong>为据，我们可以称这个<strong>id</strong>为这个表的<strong>索引</strong>。当然你也可以用其他的字段作为索引，<strong>Mysql</strong> 数据库是支持的。</p><p>难到二叉树真的就那么好吗？</p><p><strong>二叉树</strong>最大的缺点就是会变成一条线。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200728111045973.png" alt="image-20200728111045973"></p><p>如果是极端情况下，二叉树变成了如上情况，那么它的被动技能<strong>二分查找法</strong>也会随之消失，成为一个伪装成树的链表，而且特性也会跟链表一样。</p><h3 id="平衡二叉树">平衡二叉树</h3><p>为了解决上述问题：需要一直保证树的平衡，就是两边树的高度一致或者相差不大。</p><p>为此，大佬又搞出了平衡二叉树，也就是 <strong>AVL树</strong>。</p><p>在往树插入数据的时候，<strong>AVL树</strong>会根据目前情况自己调整左右子树，保证整个树左右的层级差距不太大。</p><p>具体可以到<a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualizations</a>这个网站试一下</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200728113215991.png" alt="image-20200728113215991"></p><p>如果按照上面所描述的一样存储数据，那么查找数据问题可以大大解决，性能非常的不错。但是，<strong>IO</strong>的问题并没有很好的解决。还是数据存到内存还是硬盘的问题。如果查找速度要非常的快，那么所有的数据必须存储到内存中，而且还需要解决一系列持久化的问题。</p><h3 id="B树">B树</h3><p>如果把<strong>IO</strong>问题考虑进来，那么原来的平衡二叉树在工程师们的心中也就不那么“平衡”。不过这错不在平衡二叉树，错在我们没有这么大的内存。</p><p>问题已经有了，那如何解决呢？</p><p>这。。。难道你心里没点<strong>B树</strong>，对就是这个<strong>B树</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200728120434061.png" alt="image-20200728120434061"></p><p>增大节点存储数据量，同时增加节点数（<strong>3阶B树</strong>）。这样整个树的高度也会降低，同时每向下读取一个叉，读取到的数据会增加很多，<strong>IO</strong>次数也相应的减少。</p><p>那么它是如何存储数据的呢？</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/9df6c3706b62a58781db30a140aece33.jpg" alt="img"></p><p>如上图，一个M阶B树，此时的M=3。规定，每个节点可以保存**[M/2-1,M-1]<strong>个元素，每个节点可以拥有</strong>[M/2,M]<strong>孩子，所有的叶子节点位于同一层。每个节点</strong>保存索引<strong>的同时，还可以</strong>保存数据**，且每节点的索引是<strong>不重复</strong>的。</p><p>去<a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">Data Structure Visualizations</a>插入数据试试？</p><p>虽然<strong>B树</strong>的性能不错，但是，还是不能避免一个问题：频繁的<strong>IO</strong>。众所周知，操作系统有页的概念，每次系统从磁盘中读取数据是以页为单位的（具体大小，因操作系统而异），在B树中，每个节点都是有存储数据的，每查找一个节点，都意味着大量的<strong>IO</strong>操作。所以对于这种以硬盘为介质存储数据的数据库<strong>Mysql</strong>，频繁的<strong>IO</strong>会极大地影响性能，从前面开始，直到这里依旧未能很好地解决<strong>IO</strong>问题。</p><h3 id="B-树">B+树</h3><p>其实，按照存储结构来说，<strong>B树</strong>已经很优秀了，它只是不适合像<strong>Mysql</strong>这样以硬盘为介质存储数据的数据库。</p><p>为了降低因频繁的<strong>IO</strong>所造成的性能损耗，大佬又在<strong>B树</strong>的基础上成功改造出<strong>B+树</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729111337482.png" alt="image-20200729111337482"></p><p>如上图，差别很明显，一眼就可以看出**B+**树主要是解决数据存储问题。</p><p>可以看到数据存储全部放到了叶子节点，因此，中间节点有了更多空间来存储索引。节点中存储索引值有很多种，有的是子树索引中的最小值，有的则是最大值，还有最大值**+1**…这根据实际需求。每个索引都有对应记录数据链表地址，或子树地址。</p><p>这样的设计可以很大程度上减少<strong>IO</strong>次数，并且保持着较高的查找效率。</p><h1>总结</h1><p>真正最大程度上影响计算的是<strong>IO</strong>，而不是算法。</p><p>小到应用，大到编程语言，都有性能之差，很大程度上是因为<strong>IO</strong>的问题。</p><h1>参考文章</h1><ul><li><a href="https://blog.csdn.net/qq_35644234/article/details/66969238">https://blog.csdn.net/qq_35644234/article/details/66969238</a></li><li><a href="https://zhuanlan.zhihu.com/p/141462157">https://zhuanlan.zhihu.com/p/141462157</a></li><li><a href="https://draveness.me/whys-the-design-mysql-b-plus-tree/">https://draveness.me/whys-the-design-mysql-b-plus-tree/</a></li><li><a href="https://database.51cto.com/art/201911/605365.htm">https://database.51cto.com/art/201911/605365.htm</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> MYSQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> 索引 </tag>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dubbo服务导出</title>
      <link href="/2020/07/25/Dubbo%E6%9C%8D%E5%8A%A1%E5%AF%BC%E5%87%BA/"/>
      <url>/2020/07/25/Dubbo%E6%9C%8D%E5%8A%A1%E5%AF%BC%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p>文章偏长，主要分析 <strong>Dubbo</strong> 是如何导出服务。废话不多说，直接开始</p><h1>开始</h1><p>基于 <strong>Spring</strong> 启动 <strong>Dubbo</strong> 服务，如何走到这里，先不管，下次有空单独写篇文章。</p><h2 id="onApplicationEvent">onApplicationEvent</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 是否有延迟导出 &amp;&amp; 是否已导出 &amp;&amp; 是不是已被取消导出</span></span><br><span class="line">    <span class="keyword">if</span> (isDelay() &amp;&amp; !isExported() &amp;&amp; !isUnexported()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;The service ready on spring started. service: &quot;</span> + getInterface());</span><br><span class="line">        &#125;</span><br><span class="line">        export();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里面的<code>if</code>有三个判断<code>isDelay() &amp;&amp; !isExported() &amp;&amp; !isUnexported()</code>，其中<code>isDelay()</code>方法稍微注意一下。</p><h2 id="isDelay">isDelay</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDelay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// serviceBean 初始化时默认值，这里默认为 Null</span></span><br><span class="line">    Integer delay = getDelay();</span><br><span class="line">    <span class="comment">// 从配置信息里的 Provider 里面获取</span></span><br><span class="line">    ProviderConfig provider = getProvider();</span><br><span class="line">    <span class="keyword">if</span> (delay == <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">        delay = provider.getDelay();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> supportedApplicationListener &amp;&amp; (delay == <span class="keyword">null</span> || delay == -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ProviderConfig provider = getProvider();</code>这行代码是获取配置信息。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">delay</span>=<span class="string">&quot;2&quot;</span> <span class="attr">export</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>如果有在XML配置文件配置这行代码，则<code>getProvider();</code>才会返回一个 <strong>ProviderConfig</strong> 类；如果没有配置，这里是返回空，因为该类还没初始化。</p><p><strong>supportedApplicationListener</strong> 这个变量是判断当前的 <strong>Spring</strong> 容器是否支持  <strong>ApplicationListener</strong> 接口；默认为<code>false</code>，如果支持，<strong>Spring</strong> 容器通过 <strong>ServiceBean</strong> 类的 <strong>setApplicationContext</strong> 方法会自动设置该变量为<code>true</code>。这里 <strong>ServiceBean</strong> 类是实现了 <strong>ApplicationListener</strong> 接口的，所有为 <strong>true</strong></p><p>注意的是，这里 <strong>isDelay</strong> 方法返回 <strong>true</strong> 表示不用延迟加载，<strong>false</strong> 则需要延迟加载。</p><h1>配置检查</h1><p>这一阶段，<strong>Duboo</strong> 会对程序员的配置合法性检查，未配置的使用默认，或这报错。</p><h2 id="export">export</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">export</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置信息配置了 &lt;dubbo:provider/&gt; 标签才会不为空</span></span><br><span class="line">    <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (export == <span class="keyword">null</span>) &#123;</span><br><span class="line">            export = provider.getExport();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (delay == <span class="keyword">null</span>) &#123;</span><br><span class="line">            delay = provider.getDelay();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否要导出服务</span></span><br><span class="line">    <span class="keyword">if</span> (export != <span class="keyword">null</span> &amp;&amp; !export) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 延迟导出 delay &gt; 0</span></span><br><span class="line">    <span class="keyword">if</span> (delay != <span class="keyword">null</span> &amp;&amp; delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建一个延时任务</span></span><br><span class="line">        delayExportExecutor.schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                doExport();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">        doExport();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在测试阶段，有些服务还未开通，只是本地测试，所以你可以配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">export</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>这样就不会导出服务，上面代码中间的<code> if (export != null &amp;&amp; !export)</code>就是判断这个配置信息，如果没配置是为空的。</p><p>最后，延不延时加载，都是调用<code>doExport()</code>.</p><h2 id="doExport">doExport</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doExport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (unexported) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Already unexported!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (exported) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这个变量设置为 true，表示开始导出服务</span></span><br><span class="line">    exported = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// interfaceName 是从 &lt;dubbo:service interface=&quot;&quot;/&gt; 配置中获取</span></span><br><span class="line">    <span class="keyword">if</span> (interfaceName == <span class="keyword">null</span> || interfaceName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;&lt;dubbo:service interface=\&quot;\&quot; /&gt; interface not allow null!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检测 provider 是否为空，为空则新建一个，并通过系统变量为其初始化</span></span><br><span class="line">    <span class="comment">// 如果你没有配置 &lt;dubbo:provider/&gt; 这个标签，前面的 provider 变量都是为空的</span></span><br><span class="line">    <span class="comment">// 如果为空，这里会新实例化一个，然后添加初始化变量。</span></span><br><span class="line">    checkDefault();</span><br><span class="line">    <span class="comment">// 属性赋值</span></span><br><span class="line">    <span class="comment">// 这里全部是都是取出配置信息配置的，没配置则当前都是为空</span></span><br><span class="line">    <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// &lt;dubbo:application /&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">            application = provider.getApplication();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;dubbo:module name=&quot;xx&quot;/&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">module</span> = provider.getModule();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;dubbo:registry/&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">            registries = provider.getRegistries();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;dubbo:monitor/&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            monitor = provider.getMonitor();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;dubbo:protocol/&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (protocols == <span class="keyword">null</span>) &#123;</span><br><span class="line">            protocols = provider.getProtocols();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 和前面一样</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">            registries = <span class="keyword">module</span>.getRegistries();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            monitor = <span class="keyword">module</span>.getMonitor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (application != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">            registries = application.getRegistries();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            monitor = application.getMonitor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检测 ref 是否为泛化服务类型</span></span><br><span class="line">    <span class="comment">// ref 是前面检测出接口的实现类</span></span><br><span class="line">    <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> GenericService) &#123;</span><br><span class="line">        <span class="comment">// 设置 interfaceClass 为 GenericService.class</span></span><br><span class="line">        interfaceClass = GenericService.class;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(generic)) &#123;</span><br><span class="line">            <span class="comment">// 设置 generic = &quot;true&quot;</span></span><br><span class="line">            generic = Boolean.TRUE.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 根据接口名，加载 class，并把 class 赋值到 interfaceClass</span></span><br><span class="line">            interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread()</span><br><span class="line">                    .getContextClassLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对 interfaceClass，以及 &lt;dubbo:method&gt; 标签中的必要字段进行检查</span></span><br><span class="line">        <span class="comment">// 如果你配置有 &lt;dubbo:method&gt; 标签，则 methods 变量包含就是 &lt;dubbo:method&gt; 集合</span></span><br><span class="line">        <span class="comment">// 检测的是你配置的方法，这个接口中是否真的有</span></span><br><span class="line">        checkInterfaceAndMethods(interfaceClass, methods);</span><br><span class="line">        <span class="comment">// 检测 ref 是否真的实现该接口</span></span><br><span class="line">        checkRef();</span><br><span class="line">        <span class="comment">// 走到这一步应该不是泛化服务类型</span></span><br><span class="line">        generic = Boolean.FALSE.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// local 与下面的 stub 在功能应该是一致的，用于配置本地存根</span></span><br><span class="line">    <span class="keyword">if</span> (local != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(local)) &#123;</span><br><span class="line">            local = interfaceName + <span class="string">&quot;Local&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; localClass;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            localClass = ClassHelper.forNameWithThreadContextClassLoader(local);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;The local implementation class &quot;</span> + localClass.getName() + <span class="string">&quot; not implement interface &quot;</span> + interfaceName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stub != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(stub)) &#123;</span><br><span class="line">            stub = interfaceName + <span class="string">&quot;Stub&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; stubClass;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stubClass = ClassHelper.forNameWithThreadContextClassLoader(stub);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(stubClass)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;The stub implementation class &quot;</span> + stubClass.getName() + <span class="string">&quot; not implement interface &quot;</span> + interfaceName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这下面几步会检测导出服务所需对象是否为空，为空就新创建，有其他问题就抛出异常</span></span><br><span class="line">    checkApplication();</span><br><span class="line">    checkRegistry();</span><br><span class="line">    checkProtocol();</span><br><span class="line">    appendProperties(<span class="keyword">this</span>);</span><br><span class="line">    checkStub(interfaceClass);</span><br><span class="line">    checkMock(interfaceClass);</span><br><span class="line">    <span class="keyword">if</span> (path == <span class="keyword">null</span> || path.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        path = interfaceName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 导出服务</span></span><br><span class="line">    doExportUrls();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ProviderModel 表示服务提供者模型，此对象中存储了与服务提供者相关的信息。</span></span><br><span class="line">    <span class="comment">// 比如服务的配置信息，服务实例等。每个被导出的服务对应一个 ProviderModel。</span></span><br><span class="line">    <span class="comment">// ApplicationModel 持有所有的 ProviderModel。</span></span><br><span class="line">    <span class="comment">// 其实就是把这个服务的基本信息包装成一个 model</span></span><br><span class="line">    ProviderModel providerModel = <span class="keyword">new</span> ProviderModel(getUniqueServiceName(), <span class="keyword">this</span>, ref);</span><br><span class="line">    ApplicationModel.initProviderModel(getUniqueServiceName(), providerModel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的代码比较长，总的来说就是做配置检查。如果在 <strong>xml</strong> 并没有配置某些标签，这里会新建一个默认的。其实对象都是一样的，如果你配置了，变的是属性而已。</p><h1>生成 URL 载体</h1><p>这一步对 <strong>Dubbo</strong> 来说，很重要，<strong>URL</strong> 是 <strong>Dubbo</strong> 各个模块之间交流的载体。这一步会生成注册中心 <strong>URL</strong> 和服务 <strong>URL</strong>。</p><h2 id="doExportUrls">doExportUrls</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExportUrls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;URL&gt; registryURLs = loadRegistries(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">for</span> (ProtocolConfig protocolConfig : protocols) &#123;</span><br><span class="line">        doExportUrlsFor1Protocol(protocolConfig, registryURLs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你在<strong>XML</strong>中配置有多个注册中心或者多种协议</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.7:1234&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;redis://224.5.6.7:1234&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.8:1234&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><strong>loadRegistries</strong> 方法会全部解析出来。</p><h2 id="注册中心-URL">注册中心 URL</h2><h3 id="loadRegistries">loadRegistries</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;URL&gt; <span class="title">loadRegistries</span><span class="params">(<span class="keyword">boolean</span> provider)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检测是否配置到注册中心 &lt;dubbo:registry/&gt;</span></span><br><span class="line">    checkRegistry();</span><br><span class="line">    List&lt;URL&gt; registryList = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">    <span class="keyword">if</span> (registries != <span class="keyword">null</span> &amp;&amp; !registries.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 遍历注册中心，包括不同协议的</span></span><br><span class="line">        <span class="keyword">for</span> (RegistryConfig config : registries) &#123;</span><br><span class="line">            <span class="comment">// 获取 address</span></span><br><span class="line">            String address = config.getAddress();</span><br><span class="line">            <span class="comment">// 没有 address 则默认设置为 0.0.0.0</span></span><br><span class="line">            <span class="keyword">if</span> (address == <span class="keyword">null</span> || address.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                address = Constants.ANYHOST_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 从系统属性中加载注册中心地址</span></span><br><span class="line">            String sysaddress = System.getProperty(<span class="string">&quot;dubbo.registry.address&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (sysaddress != <span class="keyword">null</span> &amp;&amp; sysaddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                address = sysaddress;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 检测 address 是否合法</span></span><br><span class="line">            <span class="keyword">if</span> (address.length() &gt; <span class="number">0</span> &amp;&amp; !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) &#123;</span><br><span class="line">                Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">                <span class="comment">// 添加 application 属性到 Map中</span></span><br><span class="line">                <span class="comment">// application 的 name 和 qosPort</span></span><br><span class="line">                appendParameters(map, application);</span><br><span class="line">                <span class="comment">// 添加 RegistryConfig 字段信息到 map 中</span></span><br><span class="line">                appendParameters(map, config);</span><br><span class="line">                <span class="comment">// 添加 path、pid，protocol，timestamp 等信息到 map 中</span></span><br><span class="line">                map.put(<span class="string">&quot;path&quot;</span>, RegistryService.class.getName());</span><br><span class="line">                map.put(<span class="string">&quot;dubbo&quot;</span>, Version.getProtocolVersion());</span><br><span class="line">                map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">                <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!map.containsKey(<span class="string">&quot;protocol&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 默认协议为dubbo</span></span><br><span class="line">                    <span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension(<span class="string">&quot;remote&quot;</span>)) &#123;</span><br><span class="line">                        map.put(<span class="string">&quot;protocol&quot;</span>, <span class="string">&quot;remote&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        map.put(<span class="string">&quot;protocol&quot;</span>, <span class="string">&quot;dubbo&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将当前Map解析为 URL</span></span><br><span class="line">                <span class="comment">// 解析得到 URL 列表，address 可能包含多个注册中心 ip，</span></span><br><span class="line">                <span class="comment">// &lt;dubbo:registry address=&quot;multicast://224.5.6.8:1234,multicast://224.5.6.8:1234,&quot;/&gt;</span></span><br><span class="line">                <span class="comment">// 因此解析得到的是一个 URL 列表</span></span><br><span class="line">                List&lt;URL&gt; urls = UrlUtils.parseURLs(address, map);</span><br><span class="line">                <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">                    <span class="comment">// 将 URL 协议头设置为 registry</span></span><br><span class="line">                    url = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());</span><br><span class="line">                    url = url.setProtocol(Constants.REGISTRY_PROTOCOL);</span><br><span class="line">                    <span class="comment">// 通过判断条件，决定是否添加 url 到 registryList 中</span></span><br><span class="line">                    <span class="comment">// (服务提供者 &amp;&amp; register = true 或 null) </span></span><br><span class="line">                    <span class="comment">//   || (非服务提供者 &amp;&amp; subscribe = true 或 null)</span></span><br><span class="line">                    <span class="keyword">if</span> ((provider &amp;&amp; url.getParameter(Constants.REGISTER_KEY, <span class="keyword">true</span>))</span><br><span class="line">                            || (!provider &amp;&amp; url.getParameter(Constants.SUBSCRIBE_KEY, <span class="keyword">true</span>))) &#123;</span><br><span class="line">                        registryList.add(url);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> registryList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码有点小长，主要是对配置的注册中心解析成 URL，都改为 <strong>registry</strong> 协议，添加到 <strong>registryList</strong> 中。</p><h2 id="服务-URL">服务 URL</h2><h3 id="doExportUrlsFor1Protocol">doExportUrlsFor1Protocol</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExportUrlsFor1Protocol</span><span class="params">(ProtocolConfig protocolConfig, List&lt;URL&gt; registryURLs)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// &lt;dubbo:protocol name=&quot;dubbo&quot; /&gt;</span></span><br><span class="line">    <span class="comment">// 对应配置信息的 name 参数</span></span><br><span class="line">    String name = protocolConfig.getName();</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        name = <span class="string">&quot;dubbo&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 添加 side、版本、时间戳以及进程号等信息到新建的 map 中</span></span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    map.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE);</span><br><span class="line">    map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());</span><br><span class="line">    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">    <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过反射将对象的字段信息添加到 map 中</span></span><br><span class="line">    appendParameters(map, application);</span><br><span class="line">    appendParameters(map, <span class="keyword">module</span>);</span><br><span class="line">    appendParameters(map, provider, Constants.DEFAULT_KEY);</span><br><span class="line">    appendParameters(map, protocolConfig);</span><br><span class="line">    appendParameters(map, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 解析 &lt;dubbo:method /&gt; </span></span><br><span class="line">    <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line"><span class="comment">// 单独分析      </span></span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 检测 generic 是否为 &quot;true&quot;，并根据检测结果向 map 中添加不同的信息</span></span><br><span class="line">    <span class="keyword">if</span> (ProtocolUtils.isGeneric(generic)) &#123;</span><br><span class="line">        map.put(Constants.GENERIC_KEY, generic);</span><br><span class="line">        map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 从 META-INFO 文件下配置获取</span></span><br><span class="line">        String revision = Version.getVersion(interfaceClass, version);</span><br><span class="line">        <span class="keyword">if</span> (revision != <span class="keyword">null</span> &amp;&amp; revision.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;revision&quot;</span>, revision);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// 为接口生成包裹类 Wrapper，Wrapper 中包含了接口的详细信息，比如接口方法名数组，字段信息等</span></span><br><span class="line">        <span class="comment">// SPI 部分有详细介绍</span></span><br><span class="line">        String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();</span><br><span class="line">        <span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 没有方法记录一下</span></span><br><span class="line">            logger.warn(<span class="string">&quot;NO method found in service interface &quot;</span> + interfaceClass.getName());</span><br><span class="line">            map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 有方法将方法名以逗号分隔组成字符串：m1，m2,m3</span></span><br><span class="line">            map.put(Constants.METHODS_KEY, StringUtils.join(<span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(methods)), <span class="string">&quot;,&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 配置token，如果值是true就随机生成，否则就使用默认的</span></span><br><span class="line">    <span class="keyword">if</span> (!ConfigUtils.isEmpty(token)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ConfigUtils.isDefault(token)) &#123;</span><br><span class="line">            map.put(Constants.TOKEN_KEY, UUID.randomUUID().toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            map.put(Constants.TOKEN_KEY, token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// 判断协议名是否为 injvm</span></span><br><span class="line">    <span class="keyword">if</span> (Constants.LOCAL_PROTOCOL.equals(protocolConfig.getName())) &#123;</span><br><span class="line">        protocolConfig.setRegister(<span class="keyword">false</span>);</span><br><span class="line">        map.put(<span class="string">&quot;notify&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取上下文路径</span></span><br><span class="line">    String contextPath = protocolConfig.getContextpath();</span><br><span class="line">    <span class="keyword">if</span> ((contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span>) &amp;&amp; provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">        contextPath = provider.getContextpath();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 获取 host 和 port</span></span><br><span class="line">    <span class="comment">// 默认获取本机 IP</span></span><br><span class="line">    String host = <span class="keyword">this</span>.findConfigedHosts(protocolConfig, registryURLs, map);</span><br><span class="line">    Integer port = <span class="keyword">this</span>.findConfigedPorts(protocolConfig, name, map);</span><br><span class="line">    <span class="comment">// 把host，port，map 解析成一个URL</span></span><br><span class="line">    URL url = <span class="keyword">new</span> URL(name, host, port, (contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : contextPath + <span class="string">&quot;/&quot;</span>) + path, map);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 导出服务</span></span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将一个服务接口解析出一个<strong>URL</strong>载体，中间还有一部分</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (MethodConfig method : methods) &#123;</span><br><span class="line">        <span class="comment">// 添加 MethodConfig 对象的字段信息到 map 中，键 = 方法名.属性名。</span></span><br><span class="line">        appendParameters(map, method, method.getName());</span><br><span class="line">        String retryKey = method.getName() + <span class="string">&quot;.retry&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(retryKey)) &#123;</span><br><span class="line">            String retryValue = map.remove(retryKey);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;false&quot;</span>.equals(retryValue)) &#123;</span><br><span class="line">                map.put(method.getName() + <span class="string">&quot;.retries&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取方法中所有参数</span></span><br><span class="line">        List&lt;ArgumentConfig&gt; arguments = method.getArguments();</span><br><span class="line">        <span class="keyword">if</span> (arguments != <span class="keyword">null</span> &amp;&amp; !arguments.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 遍历每个参数</span></span><br><span class="line">            <span class="keyword">for</span> (ArgumentConfig argument : arguments) &#123;</span><br><span class="line">                <span class="comment">// 验证参数合法</span></span><br><span class="line">                <span class="keyword">if</span> (argument.getType() != <span class="keyword">null</span> &amp;&amp; argument.getType().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 获得接口中所有方法</span></span><br><span class="line">                    Method[] methods = interfaceClass.getMethods();</span><br><span class="line">                    <span class="comment">// visit all methods</span></span><br><span class="line">                    <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; methods.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">                            <span class="comment">// 找出接口中xml配置过的方法</span></span><br><span class="line">                            String methodName = methods[i].getName();</span><br><span class="line">                            <span class="keyword">if</span> (methodName.equals(method.getName())) &#123;</span><br><span class="line">                                <span class="comment">// 获取该方法所有参数类型</span></span><br><span class="line">                                Class&lt;?&gt;[] argtypes = methods[i].getParameterTypes();</span><br><span class="line">                                <span class="comment">// 上面参数在方法中的位置</span></span><br><span class="line">                                <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) &#123;</span><br><span class="line">                                    <span class="comment">// 判断类型是否一致，不一致则抛出异常</span></span><br><span class="line">                                    <span class="keyword">if</span> (argtypes[argument.getIndex()].getName().equals(argument.getType())) &#123;</span><br><span class="line">                                   </span><br><span class="line">                                        appendParameters(map, argument, method.getName() + <span class="string">&quot;.&quot;</span> + argument.getIndex());</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;argument config error : the index attribute and type attribute not match :index :&quot;</span> + argument.getIndex() + <span class="string">&quot;, type:&quot;</span> + argument.getType());</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// 如果没配置位置，则遍历方法中参数类型，找到对应的，没找到就报错</span></span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; argtypes.length; j++) &#123;</span><br><span class="line">                                        Class&lt;?&gt; argclazz = argtypes[j];</span><br><span class="line">                                        <span class="keyword">if</span> (argclazz.getName().equals(argument.getType())) &#123;</span><br><span class="line">                                            appendParameters(map, argument, method.getName() + <span class="string">&quot;.&quot;</span> + j);</span><br><span class="line">                                            <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span> &amp;&amp; argument.getIndex() != j) &#123;</span><br><span class="line">                                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;argument config error : the index attribute and type attribute not match :index :&quot;</span> + argument.getIndex() + <span class="string">&quot;, type:&quot;</span> + argument.getType());</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 用户未配置 type 属性，但配置了 index 属性，且 index != -1</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) &#123;</span><br><span class="line">                    appendParameters(map, argument, method.getName() + <span class="string">&quot;.&quot;</span> + argument.getIndex());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;argument config must set index or type attribute.eg: &lt;dubbo:argument index=&#x27;0&#x27; .../&gt; or &lt;dubbo:argument type=xxx .../&gt;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// end of methods for</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里面套了很多 <code>for</code> 和 <code>if</code>循环，下面屡一下</p><p>在<code>&lt;dubbo:method /&gt;</code>中拿到信息，然后取出这个方法中所有参数，注意不是配置信息。在接口中找到对应的方法，再一一找到对应的参数位置，再把配置的参数放到Map中。</p><p>这部分与前面分析部分就是 <strong>dubbo</strong> 如何把一个服务解析成 <strong>URL</strong>，还有一部分就是导出服务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExportUrlsFor1Protocol</span><span class="params">(ProtocolConfig protocolConfig, List&lt;URL&gt; registryURLs)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 前面分析部分 </span></span><br><span class="line">   ....</span><br><span class="line">   <span class="comment">// 加载 ConfiguratorFactory，并判断是否有协议</span></span><br><span class="line">    <span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)</span><br><span class="line">            .hasExtension(url.getProtocol())) &#123;</span><br><span class="line">        url = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)</span><br><span class="line">                .getExtension(url.getProtocol()).getConfigurator(url).configure(url);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 获取服务作用域</span></span><br><span class="line">    String scope = url.getParameter(Constants.SCOPE_KEY);</span><br><span class="line">    <span class="comment">// 不是 none 就导出服务</span></span><br><span class="line">    <span class="keyword">if</span> (!Constants.SCOPE_NONE.toString().equalsIgnoreCase(scope)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有配置 remote 则在本地导出</span></span><br><span class="line">        <span class="keyword">if</span> (!Constants.SCOPE_REMOTE.toString().equalsIgnoreCase(scope)) &#123;</span><br><span class="line">            exportLocal(url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有配置为 local 则在本地导出</span></span><br><span class="line">        <span class="keyword">if</span> (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Export dubbo service &quot;</span> + interfaceClass.getName() + <span class="string">&quot; to url &quot;</span> + url);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (registryURLs != <span class="keyword">null</span> &amp;&amp; !registryURLs.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">// 遍历注册中心 URL</span></span><br><span class="line">                <span class="keyword">for</span> (URL registryURL : registryURLs) &#123;</span><br><span class="line">                    <span class="comment">// 服务 url 添加 dynamic 参数</span></span><br><span class="line">                    url = url.addParameterIfAbsent(Constants.DYNAMIC_KEY, registryURL.getParameter(Constants.DYNAMIC_KEY));</span><br><span class="line">                    <span class="comment">// 加载监视器链接</span></span><br><span class="line">                    URL monitorUrl = loadMonitor(registryURL);</span><br><span class="line">                    <span class="keyword">if</span> (monitorUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 将监视器链接作为参数添加到 url 中</span></span><br><span class="line">                        url = url.addParameterAndEncoded(Constants.MONITOR_KEY, monitorUrl.toFullString());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                        logger.info(<span class="string">&quot;Register dubbo service &quot;</span> + interfaceClass.getName() + <span class="string">&quot; url &quot;</span> + url + <span class="string">&quot; to registry &quot;</span> + registryURL);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// For providers, this is used to enable custom proxy to generate invoker</span></span><br><span class="line">                    String proxy = url.getParameter(Constants.PROXY_KEY);</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotEmpty(proxy)) &#123;</span><br><span class="line">                        registryURL = registryURL.addParameter(Constants.PROXY_KEY, proxy);</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">// 为服务提供类(ref)生成 Invoker</span></span><br><span class="line">                    Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));</span><br><span class="line">                    <span class="comment">// DelegateProviderMetaDataInvoker 用于持有 Invoker 和 ServiceConfig</span></span><br><span class="line">                    <span class="comment">// 包装 invoker 对象和 ServiceConfig,方便拿取</span></span><br><span class="line">                    DelegateProviderMetaDataInvoker wrapperInvoker = <span class="keyword">new</span> DelegateProviderMetaDataInvoker(invoker, <span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 导出服务，并生成 Exporter</span></span><br><span class="line">                    Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br><span class="line">                    exporters.add(exporter);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 不存在注册中心，仅导出服务</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);</span><br><span class="line">                DelegateProviderMetaDataInvoker wrapperInvoker = <span class="keyword">new</span> DelegateProviderMetaDataInvoker(invoker, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br><span class="line">                exporters.add(exporter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.urls.add(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意这个<code>scope</code>变量，不配置是为<code>null</code>，也就是远程和本地都导出，或者配置<code>none</code>,<code>remote</code>,<code>local</code>三个之一。</p><p>在导出服务前都要做的一步就是创建一个 <strong>Invoker</strong>，注意这行代码<code>registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString())</code>，前面有分析过解析注册中心 <strong>URL</strong>，这里就是把注册中心的<strong>URL</strong>和服务的<strong>URL</strong>拼接在一起。</p><h2 id="getInvoker">getInvoker</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">(T proxy, Class&lt;T&gt; type, URL url)</span> </span>&#123;</span><br><span class="line"><span class="comment">// proxy = ref,type = interfaceclass</span></span><br><span class="line">    <span class="comment">// 如果类实例名有 $ 符号说明已经代理过，这里回传入type = interfaceclass</span></span><br><span class="line">    <span class="keyword">final</span> Wrapper wrapper = Wrapper.getWrapper(proxy.getClass().getName().indexOf(<span class="string">&#x27;$&#x27;</span>) &lt; <span class="number">0</span> ? proxy.getClass() : type);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AbstractProxyInvoker&lt;T&gt;(proxy, type, url) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Object <span class="title">doInvoke</span><span class="params">(T proxy, String methodName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  Class&lt;?&gt;[] parameterTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  Object[] arguments)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先创建一个 <strong>Wrapper</strong> 类（这个类和之前文章的 <strong>Wrapper</strong> 类不太一样），再使用 <strong>AbstractProxyInvoker</strong> 类的 <strong>doInvoke</strong> 方法调用。这里的 <strong>Wrapper</strong> 使用了 <strong>invokeMethod</strong> 方法，直接使用工具 <a href="https://github.com/alibaba/arthas"><strong>arthas</strong></a> 来看一下生成类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.common.bytecode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.ClassGenerator;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.NoSuchMethodException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.NoSuchPropertyException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.Wrapper;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Wrapper0</span></span></span><br><span class="line"><span class="class"><span class="keyword">extends</span> <span class="title">Wrapper</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">ClassGenerator</span>.<span class="title">DC</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] pns;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map pts;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] mns;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] dmns;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class[] mts0;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">getPropertyType</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Class)pts.get(string);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invokeMethod</span><span class="params">(Object object, String string, Class[] arrclass, Object[] arrobject)</span> <span class="keyword">throws</span> InvocationTargetException </span>&#123;</span><br><span class="line">        DemoService demoService;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            demoService = (DemoService)object;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;sayHello&quot;</span>.equals(string) &amp;&amp; arrclass.length == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> demoService.sayHello((String)arrobject[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvocationTargetException(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(<span class="keyword">new</span> StringBuffer().append(<span class="string">&quot;Not found method \&quot;&quot;</span>).append(string).append(<span class="string">&quot;\&quot; in class com.alibaba.dubbo.demo.DemoService.&quot;</span>).toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getPropertyNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> pns;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPropertyValue</span><span class="params">(Object object, String string)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DemoService demoService = (DemoService)object;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchPropertyException(<span class="keyword">new</span> StringBuffer().append(<span class="string">&quot;Not found property \&quot;&quot;</span>).append(string).append(<span class="string">&quot;\&quot; filed or setter method in class com.alibaba.dubbo.demo.DemoService.&quot;</span>).toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(Object object, String string, Object object2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DemoService demoService = (DemoService)object;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchPropertyException(<span class="keyword">new</span> StringBuffer().append(<span class="string">&quot;Not found property \&quot;&quot;</span>).append(string).append(<span class="string">&quot;\&quot; filed or setter method in class com.alibaba.dubbo.demo.DemoService.&quot;</span>).toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getDeclaredMethodNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> dmns;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getMethodNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> mns;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasProperty</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pts.containsKey(string);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心就是 <strong>invokeMethod</strong> 方法，逻辑不难。</p><h1>服务导出</h1><p>生成服务和注册中心对应的 <strong>URL</strong> 之后，就会进入导出服务阶段，导出服务分本地导出和远程导出。</p><h2 id="本地导出">本地导出</h2><p>导出到本地不存在注册中心。</p><h3 id="exportLocal">exportLocal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exportLocal</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 URL 的协议头等于 injvm，说明已经导出到本地了，无需再次导出</span></span><br><span class="line">    <span class="keyword">if</span> (!Constants.LOCAL_PROTOCOL.equalsIgnoreCase(url.getProtocol())) &#123;</span><br><span class="line">        URL local = URL.valueOf(url.toFullString())</span><br><span class="line">                .setProtocol(Constants.LOCAL_PROTOCOL) <span class="comment">// 设置协议头为 injvm</span></span><br><span class="line">                .setHost(LOCALHOST)</span><br><span class="line">                .setPort(<span class="number">0</span>);</span><br><span class="line">        StaticContext.getContext(Constants.SERVICE_IMPL_CLASS).put(url.getServiceKey(), getServiceClass(ref));</span><br><span class="line">        <span class="comment">// 创建 Invoker，并导出服务，这里的 protocol 是 Adative 代理类。会根据 URL 调用 InjvmProtocol 的 export 方法</span></span><br><span class="line">        Exporter&lt;?&gt; exporter = protocol.export(</span><br><span class="line">                proxyFactory.getInvoker(ref, (Class) interfaceClass, local));</span><br><span class="line">        exporters.add(exporter);</span><br><span class="line">        logger.info(<span class="string">&quot;Export dubbo service &quot;</span> + interfaceClass.getName() + <span class="string">&quot; to local registry&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改协议头，创建 <strong>Invoker</strong> 对象，导出。<code>protocol.export</code> 的 <strong>protocol</strong> 是 <strong>javassist</strong> 生成的 <strong>Adative</strong> 代理类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();</span><br></pre></td></tr></table></figure><p>使用阿里巴巴的 <a href="https://github.com/alibaba/arthas"><strong>arthas</strong></a> 看看代理类是怎么样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.rpc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.rpc.Exporter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.rpc.Invoker;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.rpc.Protocol;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.rpc.RpcException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Protocol</span>$<span class="title">Adaptive</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;method public abstract void com.alibaba.dubbo.rpc.Protocol.destroy() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;method public abstract int com.alibaba.dubbo.rpc.Protocol.getDefaultPort() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Invoker <span class="title">refer</span><span class="params">(Class class_, URL uRL)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        String string;</span><br><span class="line">        <span class="keyword">if</span> (uRL == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        URL uRL2 = uRL;</span><br><span class="line">        String string2 = string = uRL2.getProtocol() == <span class="keyword">null</span> ? <span class="string">&quot;dubbo&quot;</span> : uRL2.getProtocol();</span><br><span class="line">        <span class="keyword">if</span> (string == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="keyword">new</span> StringBuffer().append(<span class="string">&quot;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&quot;</span>).append(uRL2.toString()).append(<span class="string">&quot;) use keys([protocol])&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Protocol protocol = (Protocol)ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(string);</span><br><span class="line">        <span class="keyword">return</span> protocol.refer(class_, uRL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exporter <span class="title">export</span><span class="params">(Invoker invoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        String string;</span><br><span class="line">        <span class="keyword">if</span> (invoker == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;com.alibaba.dubbo.rpc.Invoker argument == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (invoker.getUrl() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;com.alibaba.dubbo.rpc.Invoker argument getUrl() == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取 URL</span></span><br><span class="line">        URL uRL = invoker.getUrl();</span><br><span class="line">        String string2 = string = uRL.getProtocol() == <span class="keyword">null</span> ? <span class="string">&quot;dubbo&quot;</span> : uRL.getProtocol();</span><br><span class="line">        <span class="keyword">if</span> (string == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="keyword">new</span> StringBuffer().append(<span class="string">&quot;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&quot;</span>).append(uRL.toString()).append(<span class="string">&quot;) use keys([protocol])&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取对应的协议扩展类</span></span><br><span class="line">        Protocol protocol = (Protocol)ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(string);</span><br><span class="line">        <span class="comment">// 调用该类的 export 方法</span></span><br><span class="line">        <span class="keyword">return</span> protocol.export(invoker);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和在 <strong>SPI</strong> 里面分析的差别不大，都是根据 <strong>URL</strong> 动态加载对应的扩展类。</p><h3 id="export（InJvmProtoco）">export（InJvmProtoco）</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200723141620388.png" alt="image-20200723141620388"></p><p>不同的协议对应不同的对象，这里使用 <strong>InJvmProtocol</strong> 对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> InjvmExporter&lt;T&gt;(invoker, invoker.getUrl().getServiceKey(), exporterMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里只是创建了一个 <strong>InjvmExporter</strong> 对象，有其他的逻辑。重点不是这个，重点远程导出过程。</p><h2 id="远程导出">远程导出</h2><p>远程导出，如果不存在注册中心，只是导出服务。而存在注册中心， 只是多了一步注册服务到注册中心逻辑，导出服务没差别。</p><h3 id="export（RegistryProtocol）">export（RegistryProtocol）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    <span class="comment">// 导出服务</span></span><br><span class="line">    <span class="keyword">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = doLocalExport(originInvoker);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取注册中心 URL</span></span><br><span class="line">    <span class="comment">// 最开始解析 URL 时，把协议改成了 registry，现在改跟注册中心一样的。</span></span><br><span class="line">    <span class="comment">// 以 zookeeper 注册中心为例，得到的示例 URL 如下：</span></span><br><span class="line">    <span class="comment">// zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?....</span></span><br><span class="line">    URL registryUrl = getRegistryUrl(originInvoker);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 URL 加载 Registry 实现类，比如 ZookeeperRegistry</span></span><br><span class="line">    <span class="keyword">final</span> Registry registry = getRegistry(originInvoker);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 服务的 provider</span></span><br><span class="line">    <span class="keyword">final</span> URL registeredProviderUrl = getRegisteredProviderUrl(originInvoker);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获取 register 参数</span></span><br><span class="line">    <span class="keyword">boolean</span> register = registeredProviderUrl.getParameter(<span class="string">&quot;register&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 向服务提供者与消费者注册表中注册服务提供者</span></span><br><span class="line">    ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registeredProviderUrl);</span><br><span class="line"> <span class="comment">// 根据 register 的值决定是否注册服务</span></span><br><span class="line">    <span class="keyword">if</span> (register) &#123;</span><br><span class="line">        <span class="comment">// 向注册中心注册服务</span></span><br><span class="line">        register(registryUrl, registeredProviderUrl);</span><br><span class="line">        ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 获取订阅 URL，比如：</span></span><br><span class="line">    <span class="keyword">final</span> URL overrideSubscribeUrl = getSubscribedOverrideUrl(registeredProviderUrl);</span><br><span class="line">    <span class="comment">// 创建监听器</span></span><br><span class="line">    <span class="keyword">final</span> OverrideListener overrideSubscribeListener = <span class="keyword">new</span> OverrideListener(overrideSubscribeUrl, originInvoker);</span><br><span class="line">    <span class="comment">// 向注册中心进行订阅 override 数据</span></span><br><span class="line">    overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);</span><br><span class="line">    <span class="comment">// 创建并返回 DestroyableExporter</span></span><br><span class="line">    registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);</span><br><span class="line">    <span class="comment">//Ensure that a new exporter instance is returned every time export</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DestroyableExporter&lt;T&gt;(exporter, originInvoker, overrideSubscribeUrl, registeredProviderUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里使用的是 <strong>RegistryProtocol</strong>，因为 URL 的协议是 <strong>registry</strong> 。先导出服务，然后注册到注册中心。</p><h3 id="doLocalExport">doLocalExport</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">ExporterChangeableWrapper&lt;T&gt; <span class="title">doLocalExport</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 provider url</span></span><br><span class="line">    String key = getCacheKey(originInvoker);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存检查</span></span><br><span class="line">    ExporterChangeableWrapper&lt;T&gt; exporter = (ExporterChangeableWrapper&lt;T&gt;) bounds.get(key);</span><br><span class="line">    <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (bounds) &#123;</span><br><span class="line">            exporter = (ExporterChangeableWrapper&lt;T&gt;) bounds.get(key);</span><br><span class="line">            <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建 Invoker 为委托类对象</span></span><br><span class="line">                <span class="keyword">final</span> Invoker&lt;?&gt; invokerDelegete = <span class="keyword">new</span> InvokerDelegete&lt;T&gt;(originInvoker, getProviderUrl(originInvoker));</span><br><span class="line">                <span class="comment">// 调用 protocol 的 export 方法导出服务</span></span><br><span class="line">                exporter = <span class="keyword">new</span> ExporterChangeableWrapper&lt;T&gt;((Exporter&lt;T&gt;) protocol.export(invokerDelegete), originInvoker);</span><br><span class="line">                bounds.put(key, exporter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> exporter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意这里的 <strong>URL</strong> 一直在变，前面是 <strong>registry</strong> 协议的 <strong>URL</strong> 和 <strong>dubbo</strong> 协议的拼接，这里<code>getCacheKey(originInvoker);</code>就是取出 <strong>dubbo</strong> 协议的 <strong>URL</strong>，最后<code>protocol.export(invokerDelegete)</code>导出服务。</p><h3 id="export（dubbo）">export（dubbo）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 url</span></span><br><span class="line">    URL url = invoker.getUrl();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取服务标识，理解成服务坐标也行。由服务组名，服务名，服务版本号以及端口组成。</span></span><br><span class="line">    <span class="comment">// demoGroup/com.alibaba.dubbo.demo.DemoService:1.0.1:20880</span></span><br><span class="line">    String key = serviceKey(url);</span><br><span class="line">    <span class="comment">// 创建 DubboExporter</span></span><br><span class="line">    DubboExporter&lt;T&gt; exporter = <span class="keyword">new</span> DubboExporter&lt;T&gt;(invoker, key, exporterMap);</span><br><span class="line">    <span class="comment">// 缓存</span></span><br><span class="line">    exporterMap.put(key, exporter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//服务本地存根</span></span><br><span class="line">    Boolean isStubSupportEvent = url.getParameter(Constants.STUB_EVENT_KEY, Constants.DEFAULT_STUB_EVENT);</span><br><span class="line">    Boolean isCallbackservice = url.getParameter(Constants.IS_CALLBACK_SERVICE, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (isStubSupportEvent &amp;&amp; !isCallbackservice) &#123;</span><br><span class="line">        String stubServiceMethods = url.getParameter(Constants.STUB_EVENT_METHODS_KEY);</span><br><span class="line">        <span class="keyword">if</span> (stubServiceMethods == <span class="keyword">null</span> || stubServiceMethods.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="keyword">new</span> IllegalStateException(<span class="string">&quot;consumer [&quot;</span> + url.getParameter(Constants.INTERFACE_KEY) +</span><br><span class="line">                        <span class="string">&quot;], has set stubproxy support event ,but no stub methods founded.&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stubServiceMethodsMap.put(url.getServiceKey(), stubServiceMethods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">// 启动服务器</span></span><br><span class="line">    openServer(url);</span><br><span class="line">    <span class="comment">// 优化序列化</span></span><br><span class="line">    optimizeSerialization(url);</span><br><span class="line">    <span class="keyword">return</span> exporter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重点关注的是<code>openServer(url);</code>，如何创建一个服务。</p><h3 id="openServer">openServer</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private void openServer(URL url) &#123;</span><br><span class="line">    // 获取 host:port</span><br><span class="line">    String key = url.getAddress();</span><br><span class="line">    //client can export a service which&#x27;s only for server to invoke</span><br><span class="line">    boolean isServer = url.getParameter(Constants.IS_SERVER_KEY, true);</span><br><span class="line">    if (isServer) &#123;</span><br><span class="line">     // 访问缓存</span><br><span class="line">        ExchangeServer server = serverMap.get(key);</span><br><span class="line">        if (server == null) &#123;</span><br><span class="line">        // 创建服务器实例</span><br><span class="line">            serverMap.put(key, createServer(url));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 服务器已创建，则根据 url 中的配置重置服务器</span><br><span class="line">            server.reset(url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 <strong>URL</strong> 是 <strong>dubbo</strong> 协议的，也就是 <strong>provider</strong> 的。之后检查缓存，没有就创建服务，有就根据 <strong>URL</strong> 重置服务，重点看创建。</p><h3 id="createServer">createServer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ExchangeServer <span class="title">createServer</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// send readonly event when server closes, it&#x27;s enabled by default</span></span><br><span class="line">    url = url.addParameterIfAbsent(Constants.CHANNEL_READONLYEVENT_SENT_KEY, Boolean.TRUE.toString());</span><br><span class="line">    <span class="comment">// 心跳检测，多久检测一次服务是否存活</span></span><br><span class="line">    url = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));</span><br><span class="line">    <span class="comment">// 服务中间，默认为 netty</span></span><br><span class="line">    String str = url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_SERVER);</span><br><span class="line"><span class="comment">// 通过 SPI 检测是否存在 server 参数所代表的 Transporter 拓展，不存在则抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span> &amp;&amp; !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">&quot;Unsupported server type: &quot;</span> + str + <span class="string">&quot;, url: &quot;</span> + url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加编码解码器参数</span></span><br><span class="line">    url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);</span><br><span class="line">    ExchangeServer server;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 ExchangeServer，开启服务</span></span><br><span class="line">        server = Exchangers.bind(url, requestHandler);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">&quot;Fail to start server(url: &quot;</span> + url + <span class="string">&quot;) &quot;</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    str = url.getParameter(Constants.CLIENT_KEY);</span><br><span class="line">    <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Set&lt;String&gt; supportedTypes = ExtensionLoader.getExtensionLoader(Transporter.class).getSupportedExtensions();</span><br><span class="line">        <span class="keyword">if</span> (!supportedTypes.contains(str)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">&quot;Unsupported client type: &quot;</span> + str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> server;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>除去比较重要的 <strong>Transporter</strong> 拓展，最重要的是<code>Exchangers.bind(url, requestHandler);</code>服务 <strong>bind</strong> 到服务器上。</p><h3 id="bind">bind</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExchangeServer <span class="title">bind</span><span class="params">(URL url, ExchangeHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;handler == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    url = url.addParameterIfAbsent(Constants.CODEC_KEY, <span class="string">&quot;exchange&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取 Exchanger，默认为 HeaderExchanger。</span></span><br><span class="line">    <span class="comment">// 紧接着调用 HeaderExchanger 的 bind 方法创建 ExchangeServer 实例</span></span><br><span class="line">    <span class="keyword">return</span> getExchanger(url).bind(url, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续调用的 <strong>HeaderExchanger</strong> 的 <strong>bind</strong> 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ExchangeServer <span class="title">bind</span><span class="params">(URL url, ExchangeHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HeaderExchangeServer(Transporters.bind(url, <span class="keyword">new</span> DecodeHandler(<span class="keyword">new</span> HeaderExchangeHandler(handler))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里创建两个对象：<strong>HeaderExchangeHandle</strong> 和 <strong>DecodeHandler</strong>。并调用 <strong>Transporters</strong> 类的 <strong>bind</strong> 静态方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Server <span class="title">bind</span><span class="params">(URL url, ChannelHandler... handlers)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handlers == <span class="keyword">null</span> || handlers.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;handlers == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ChannelHandler handler;</span><br><span class="line">    <span class="keyword">if</span> (handlers.length == <span class="number">1</span>) &#123;</span><br><span class="line">        handler = handlers[<span class="number">0</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果 handlers 元素数量大于1，则创建 ChannelHandler 分发器</span></span><br><span class="line">        handler = <span class="keyword">new</span> ChannelHandlerDispatcher(handlers);</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// 获取自适应 Transporter 实例，并调用实例方法</span></span><br><span class="line">    <span class="keyword">return</span> getTransporter().bind(url, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getTransporter().bind(url, handler);</code>这行代码使用的是 <strong>dubbo SPI</strong> 获得 <strong>Transporter</strong> 接口的 <strong>Adaptive</strong> 类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transporter <span class="title">getTransporter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ExtensionLoader.getExtensionLoader(Transporter.class).getAdaptiveExtension();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再根据 <strong>URL</strong> 获取对应的 <strong>Transporter</strong> 扩展类，<strong>Transporter.class</strong> 接口默认有四个扩展类。有两个是关于 <strong>Netty</strong> 版本的。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200723155547234.png" alt="image-20200723155547234"></p><p>根据 <strong>URL</strong> 这里默认调用 <strong>com.alibaba.dubbo.remoting.transport.netty.NettyTransporter</strong>，其实不管调用哪个，这里的 <strong>bind</strong> 方法都是启动 <strong>Netty</strong> 服务器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Server <span class="title">bind</span><span class="params">(URL url, ChannelHandler listener)</span> <span class="keyword">throws</span> RemotingException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NettyServer(url, listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>注册服务</h1><p>注册服务对于 <strong>Dubbo</strong> 来说不是必须的，因为 <strong>Dubbo</strong> 提供了服务直连方式，这样可以直接绕过注册中心。但是实践证明，没有注册中心，不方便治理各个服务。因此，虽然注册中心不是必须的，但确是必要的。</p><h2 id="export（RegistryProtocol）-2">export（RegistryProtocol）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">    <span class="comment">// 导出服务</span></span><br><span class="line">    <span class="keyword">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = doLocalExport(originInvoker);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取注册中心 URL</span></span><br><span class="line">    <span class="comment">// 最开始解析 URL 时，把协议改成了 registry，现在改跟注册中心一样的。</span></span><br><span class="line">    <span class="comment">// 以 zookeeper 注册中心为例，得到的示例 URL 如下：</span></span><br><span class="line">    <span class="comment">// zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?....</span></span><br><span class="line">    URL registryUrl = getRegistryUrl(originInvoker);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 URL 加载 Registry 实现类，比如 ZookeeperRegistry</span></span><br><span class="line">    <span class="keyword">final</span> Registry registry = getRegistry(originInvoker);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 服务的 provider</span></span><br><span class="line">    <span class="keyword">final</span> URL registeredProviderUrl = getRegisteredProviderUrl(originInvoker);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获取 register 参数</span></span><br><span class="line">    <span class="keyword">boolean</span> register = registeredProviderUrl.getParameter(<span class="string">&quot;register&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 向服务提供者与消费者注册表中注册服务提供者</span></span><br><span class="line">    ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registeredProviderUrl);</span><br><span class="line"> <span class="comment">// 根据 register 的值决定是否注册服务</span></span><br><span class="line">    <span class="keyword">if</span> (register) &#123;</span><br><span class="line">        <span class="comment">// 向注册中心注册服务</span></span><br><span class="line">        register(registryUrl, registeredProviderUrl);</span><br><span class="line">        ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 获取订阅 URL，比如：</span></span><br><span class="line">    <span class="keyword">final</span> URL overrideSubscribeUrl = getSubscribedOverrideUrl(registeredProviderUrl);</span><br><span class="line">    <span class="comment">// 创建监听器</span></span><br><span class="line">    <span class="keyword">final</span> OverrideListener overrideSubscribeListener = <span class="keyword">new</span> OverrideListener(overrideSubscribeUrl, originInvoker);</span><br><span class="line">    <span class="comment">// 向注册中心进行订阅 override 数据</span></span><br><span class="line">    overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);</span><br><span class="line">    <span class="comment">// 创建并返回 DestroyableExporter</span></span><br><span class="line">    registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);</span><br><span class="line">    <span class="comment">//Ensure that a new exporter instance is returned every time export</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DestroyableExporter&lt;T&gt;(exporter, originInvoker, overrideSubscribeUrl, registeredProviderUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>导出服务已经分析过了，在这之后，是注册服务。值得一提的是，只有在远程导出的时候，才会有注册服务到注册中心这部分逻辑。</p><h2 id="getRegistryUrl">getRegistryUrl</h2><p><code> URL registryUrl = getRegistryUrl(originInvoker);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> URL <span class="title">getRegistryUrl</span><span class="params">(Invoker&lt;?&gt; originInvoker)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得 URL</span></span><br><span class="line">    URL registryUrl = originInvoker.getUrl();</span><br><span class="line">    <span class="comment">// 如果协议是 registry</span></span><br><span class="line">    <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(registryUrl.getProtocol())) &#123;</span><br><span class="line">        <span class="comment">// 获取配置的协议，如果没配置默认就是 dubbo</span></span><br><span class="line">        String protocol = registryUrl.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_DIRECTORY);</span><br><span class="line">        <span class="comment">// 替换并移除 registry</span></span><br><span class="line">        registryUrl = registryUrl.setProtocol(protocol).removeParameter(Constants.REGISTRY_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> registryUrl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一开始解析注册中心 <strong>URL</strong> 的时候，协议被替换成了 <strong>registry</strong>，应该表示服务没有注册到注册中心，这里取出了真正配置的协议，如果没配置就是 <strong>dubbo</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.7:1234&quot;</span>/&gt;</span> # multicast</span><br></pre></td></tr></table></figure><p>这里代码走完之后，协议就要么是配置的协议，要么是默认协议。</p><h2 id="getRegistry">getRegistry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Registry <span class="title">getRegistry</span><span class="params">(<span class="keyword">final</span> Invoker&lt;?&gt; originInvoker)</span> </span>&#123;</span><br><span class="line">    URL registryUrl = getRegistryUrl(originInvoker);</span><br><span class="line">    <span class="keyword">return</span> registryFactory.getRegistry(registryUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getRegistryUrl(originInvoker);</code>与上面一样。跟进<code>registryFactory.getRegistry(registryUrl);</code></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200725164241249.png" alt="image-20200725164241249"></p><p><strong>registryFactory</strong> 有四个，以 <strong>zookeeper</strong> 为例，这里会调用 <strong>AbstractRegistryFactory</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Registry <span class="title">getRegistry</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注册中心类名</span></span><br><span class="line">    url = url.setPath(RegistryService.class.getName())</span><br><span class="line">        <span class="comment">// URL 添加一个 interface 参数</span></span><br><span class="line">            .addParameter(Constants.INTERFACE_KEY, RegistryService.class.getName())</span><br><span class="line">        <span class="comment">// 移除 export 参数，和 refer 参数</span></span><br><span class="line">            .removeParameters(Constants.EXPORT_KEY, Constants.REFER_KEY);</span><br><span class="line">    <span class="comment">// key 是 协议://ip:port/com.alibaba.dubbo.registry.RegistryService</span></span><br><span class="line">    String key = url.toServiceStringWithoutResolving();</span><br><span class="line">    <span class="comment">// AOS 锁，确保一个 URL 对应一个 服务</span></span><br><span class="line">    LOCK.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 检查缓存，有就已经注册过了</span></span><br><span class="line">        Registry registry = REGISTRIES.get(key);</span><br><span class="line">        <span class="keyword">if</span> (registry != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> registry;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有就新建</span></span><br><span class="line">        registry = createRegistry(url);</span><br><span class="line">        <span class="keyword">if</span> (registry == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Can not create registry &quot;</span> + url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 缓存</span></span><br><span class="line">        REGISTRIES.put(key, registry);</span><br><span class="line">        <span class="keyword">return</span> registry;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 释放锁</span></span><br><span class="line">        LOCK.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据 <strong>URL</strong> 获取对应的注册中心，去掉了服务部分参数。使用锁的目的，就是确保注册中心的 <strong>URL</strong> 只对应一个服务。<code>createRegistry(url);</code>创建注册中心分析一下。</p><h2 id="createRegistry">createRegistry</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200725165737020.png" alt="image-20200725165737020"></p><p>这选择 <strong>Zookeeper</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Registry <span class="title">createRegistry</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ZookeeperRegistry(url, zookeeperTransporter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZookeeperRegistry</span><span class="params">(URL url, ZookeeperTransporter zookeeperTransporter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(url);</span><br><span class="line">        <span class="keyword">if</span> (url.isAnyHost()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;registry address == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    、  <span class="comment">// 获取组名，默认为 dubbo</span></span><br><span class="line">        String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);</span><br><span class="line">        <span class="keyword">if</span> (!group.startsWith(Constants.PATH_SEPARATOR)) &#123;</span><br><span class="line">            <span class="comment">// group = &quot;/&quot; + group</span></span><br><span class="line">            group = Constants.PATH_SEPARATOR + group;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.root = group;</span><br><span class="line">    <span class="comment">// 创建 Zookeeper 客户端，默认为 CuratorZookeeperTransporter</span></span><br><span class="line">        zkClient = zookeeperTransporter.connect(url);</span><br><span class="line">   <span class="comment">// 添加状态监听器</span></span><br><span class="line">        zkClient.addStateListener(<span class="keyword">new</span> StateListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (state == RECONNECTED) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        recover();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        logger.error(e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>zkClient = zookeeperTransporter.connect(url);</code>这里面使用了 <strong>Curator</strong> 框架创建实例，具体不分析了，有兴趣可自行查看。</p><p>回到<code>export（RegistryProtocol）</code>，之后是获得服务的 <strong>URL</strong>。</p><h2 id="getRegisteredProviderUrl">getRegisteredProviderUrl</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">getRegisteredProviderUrl</span><span class="params">(<span class="keyword">final</span> Invoker&lt;?&gt; originInvoker)</span> </span>&#123;</span><br><span class="line">    URL providerUrl = getProviderUrl(originInvoker);</span><br><span class="line">    <span class="comment">//The address you see at the registry</span></span><br><span class="line">    <span class="keyword">return</span> providerUrl.removeParameters(getFilteredKeys(providerUrl))</span><br><span class="line">            .removeParameter(Constants.MONITOR_KEY)</span><br><span class="line">            .removeParameter(Constants.BIND_IP_KEY)</span><br><span class="line">            .removeParameter(Constants.BIND_PORT_KEY)</span><br><span class="line">            .removeParameter(QOS_ENABLE)</span><br><span class="line">            .removeParameter(QOS_PORT)</span><br><span class="line">            .removeParameter(ACCEPT_FOREIGN_IP)</span><br><span class="line">            .removeParameter(VALIDATION_KEY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里会移除一些不必要的参数。</p><h2 id="其他">其他</h2><p>后面这行代码<code>boolean register = registeredProviderUrl.getParameter(&quot;register&quot;, true);</code>是判定有木有注册。</p><p><code>ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registeredProviderUrl);</code>这行对服务的一些包装，添加一下包装类，前面做过的类似。</p><p><code>register(registryUrl, registeredProviderUrl);</code>这里注册 <strong>URL</strong> 到注册中心。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200725172127812.png" alt="image-20200725172127812"></p><p>再后面就不说了，不是很重要。</p><h1>总结</h1><p>没啥总结的，能看到这里你也 NB。</p>]]></content>
      
      
      <categories>
          
          <category> Dubbo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dubbo </tag>
            
            <tag> 服务导出 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dubbo SPI（下）</title>
      <link href="/2020/07/16/SPI3/"/>
      <url>/2020/07/16/SPI3/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p><strong>Dubbo SPI</strong> 提供的 <strong>Wrapper</strong> 形式，虽然增强了扩展性，但并不是很灵活。</p><p>有些扩展类并不需要在一开始启动时就被加载到缓存中，而是希望能够在运行时，根据参数进行调用。听起来很矛盾，没有被加载如何进行调用。</p><p><strong>Dubbo SPI</strong> 也考虑到了这一点，为了解决的这个问题，<strong>Dubbo SPI</strong> 衍生出了<strong>自适应拓展机制</strong>。</p><h1>实例</h1><p><strong>自适应拓展机制</strong>，听起来有点迷糊，下面举个栗子，看看这套机制怎样使用。</p><p>假设土豪有很多辆车，要看土豪某辆车，只需要跟土豪说车名，土豪就会带你去看那辆车。</p><h2 id="接口">接口</h2><p><strong>People.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.adaptive.people;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.SPI;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">People</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getCar</span><span class="params">(URL url)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Car.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.adaptive.Car;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.Adaptive;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.SPI;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive(&quot;car&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getName</span><span class="params">(URL url)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你要跟土豪说看哪辆车，所以需要参数传递，这里用 <strong>URL</strong> 作为参数。那为什么车也要加呢，还有注解，继续往下看。</p><h2 id="扩展">扩展</h2><p>两辆车，一辆奔驰，一辆宝马</p><p><strong>BM.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.adaptive.Car.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.adaptive.Car.Car;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BM</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getName</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BM&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Benz.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.adaptive.Car.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.adaptive.Car.Car;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Benz</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getName</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Benz&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>土豪就是你</p><p><strong>You.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.adaptive.people.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.adaptive.Car.Car;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.adaptive.people.People;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">You</span> <span class="keyword">implements</span> <span class="title">People</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCar</span><span class="params">(Car car)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.car = car;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCar</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">        car.getName(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么传入一个 <strong>Car</strong>，你可能觉得和包装类差不多，传入指定 <strong>Car</strong> 不就能做到。但是这样做，一个 <strong>You</strong> 只对应一辆车，而且<code>getCar(URL url)</code>参数时 <strong>URL</strong>。继续往下。</p><h2 id="配置">配置</h2><p>对应接口对应的扩展类。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716095730834.png" alt="image-20200716095730834"></p><h2 id="结果">结果</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> MyTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.adaptive.people.People;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExtensionLoader&lt;People&gt; extensionLoader = ExtensionLoader.getExtensionLoader(People.class);</span><br><span class="line">        People you = extensionLoader.getExtension(<span class="string">&quot;you&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;car&quot;</span>,<span class="string">&quot;benz&quot;</span>);</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;dubbo&quot;</span>, <span class="string">&quot;localhost&quot;</span>, <span class="number">1</span>, map);</span><br><span class="line">        </span><br><span class="line">        you.getCar(url);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用 <strong>Map</strong> 来包装参数，<strong>key</strong> 是什么，就是上面接口中<code>@Adaptive(&quot;car&quot;)</code>的值，<strong>value</strong> 就是配置文件中对应的 <strong>key</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716100221276.png" alt="image-20200716100221276"></p><p>如果需要调用 <strong>BM</strong>，只需要修改参数为 <strong>BM</strong> 就可以</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716100441458.png" alt="image-20200716100441458"></p><h1>原理</h1><p><strong>自适应拓展机制</strong>确实做到我们想象中的样子，根据参数值调用对应的扩展类实例。这激起了我心中求知欲，它怎么做到的呢。</p><h2 id="getAdaptiveExtension">getAdaptiveExtension</h2><p>前面在 <strong>getExtensionLoader</strong> 方法中，会根据接口类型，初始化一个对应的 <strong>Loader</strong></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716101443435.png" alt="image-20200716101443435"></p><p><strong>ExtensionLoader</strong> 初始化时还会初始化一个 <strong>ExtensionFactory</strong> 的 <strong>Loader</strong>，这里 <strong>ExtensionFactory</strong> 本身就是一个 <strong>objectFactory</strong>，所以并不需要一个初始化一个 <strong>objectFactory</strong>，换句话说就是，其他接口需要一个对象工厂，而这个对象工厂就是它。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716101537586.png" alt="image-20200716101537586"></p><p>在这里还调用了一步<code>getAdaptiveExtension()</code>方法，看名字，肯定和前面注解有联系，跟下去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 缓存</span></span><br><span class="line">    Object instance = cachedAdaptiveInstance.get();</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (createAdaptiveInstanceError != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Failed to create adaptive instance: &quot;</span> +</span><br><span class="line">                    createAdaptiveInstanceError.toString(),</span><br><span class="line">                    createAdaptiveInstanceError);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 双重检查</span></span><br><span class="line">        <span class="keyword">synchronized</span> (cachedAdaptiveInstance) &#123;</span><br><span class="line">            instance = cachedAdaptiveInstance.get();</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 创建代理类</span></span><br><span class="line">                    instance = createAdaptiveExtension();</span><br><span class="line">                    cachedAdaptiveInstance.set(instance);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    createAdaptiveInstanceError = t;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Failed to create adaptive instance: &quot;</span> + t.toString(), t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>缓存检查，没有创建。</p><h2 id="createAdaptiveExtension">createAdaptiveExtension</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> injectExtension((T) getAdaptiveExtensionClass().newInstance());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Can&#x27;t create adaptive extension &quot;</span> + type + <span class="string">&quot;, cause: &quot;</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先管依赖注入<code>injectExtension</code>，这里生成了一个类并实例化<code>getAdaptiveExtensionClass().newInstance()</code></p><h2 id="getAdaptiveExtensionClass">getAdaptiveExtensionClass</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">    <span class="comment">// 扩展资源加载</span></span><br><span class="line">    getExtensionClasses();</span><br><span class="line">    <span class="comment">// 如果扩展类上有 @Adaptive 注解，则用这个类来充当代理类</span></span><br><span class="line">    <span class="keyword">if</span> (cachedAdaptiveClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cachedAdaptiveClass;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 没有就是用默认的</span></span><br><span class="line">    <span class="keyword">return</span> cachedAdaptiveClass = createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getExtensionClasses();</code>应该不陌生了，加载并解析配置文件已经缓存。这里的 <strong>cachedAdaptiveClass</strong> 属性很熟悉，没错，在 <strong>loadClass</strong> 方法时，有解析该属性。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716102647723.png" alt="image-20200716102647723"></p><p>不过条件是在类上有 @<strong>Adaptive</strong> 注解，很明显我们配置的类上是没有该注解，那个接口只是在方法上有，不是类上。而且目前为止我们并不知道这个是干什么的。不过在最后调用了<code>createAdaptiveExtensionClass();</code>,继续跟进</p><h2 id="createAdaptiveExtensionClass">createAdaptiveExtensionClass</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; createAdaptiveExtensionClass() &#123;</span><br><span class="line">    <span class="comment">// 默认代理代理生成器</span></span><br><span class="line">    String code = <span class="keyword">new</span> AdaptiveClassCodeGenerator(type, cachedDefaultName).generate();</span><br><span class="line">    ClassLoader classLoader = findClassLoader();</span><br><span class="line">    org.apache.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(org.apache.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br><span class="line">    <span class="keyword">return</span> compiler.compile(code, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>String code = new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate();</code>根据这行代码，隐隐约约能猜到生成了一个类，返回的是代码，下面是编译。</p><h2 id="generate">generate</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 是否要生成代理类</span></span><br><span class="line">    <span class="comment">// 接口类的方法上没有 @Adaptive</span></span><br><span class="line">    <span class="comment">// no need to generate adaptive class since there&#x27;s no adaptive method found.</span></span><br><span class="line">    <span class="keyword">if</span> (!hasAdaptiveMethod()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No adaptive method exist on extension &quot;</span> + type.getName() + <span class="string">&quot;, refuse to create the adaptive class!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    StringBuilder code = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="comment">// 类所在的包名，package</span></span><br><span class="line">    code.append(generatePackageInfo());</span><br><span class="line">    <span class="comment">// 引用类，Import</span></span><br><span class="line">    code.append(generateImports());</span><br><span class="line">    <span class="comment">// 什么一个类，实现该接口</span></span><br><span class="line">    code.append(generateClassDeclaration());</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    Method[] methods = type.getMethods();</span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        code.append(generateMethod(method));</span><br><span class="line">    &#125;</span><br><span class="line">    code.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(code.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> code.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>走到这里，心中也隐隐应该有答案了，<strong>Dubbo</strong> 会生成一个代理类，前提是要指定生成代理类的代理的方法，就是在接口的方法上加上<code>@Adaptive</code>注解。</p><h2 id="代理类">代理类</h2><p>这个代理类是运行时产生的，但是我们可以借助一个工具，由阿里巴巴开发的 <a href="https://github.com/alibaba/arthas"><strong>arthas</strong></a> ，Java诊断工具，可以用来反编译 <strong>JVM</strong> 运行时的类。</p><h3 id="连接上虚拟机">连接上虚拟机</h3><p>为了连接上对应 <strong>JVM</strong>，我们需要让这个程序阻塞，要不然程序结束，也连接不上。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716104739027.png" alt="image-20200716104739027"></p><p>下载对应的 <strong>jar</strong> 包，运行就行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure><p>就可以看到程序对应的虚拟机。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716105005664.png" alt="image-20200716105005664"></p><p>打上对应的数字，连接上去。成功如下。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716105120985.png" alt="image-20200716105120985"></p><h3 id="反编译">反编译</h3><p>用命令查找对应的类</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc *Car*  #sc 正则表达式</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716105247519.png" alt="image-20200716105247519"></p><p>有一个加<code>$Adaptive</code>的类，可能是代理类。反编译它。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jad com.Playwi0.SPI.adaptive.Car.Car$Adaptive</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716105520666.png" alt="image-20200716105520666"></p><p><strong>Car$Adaptive.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Decompiled with CFR.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Could not load the following classes:</span></span><br><span class="line"><span class="comment"> *  com.Playwi0.SPI.adaptive.Car.Car</span></span><br><span class="line"><span class="comment"> *  org.apache.dubbo.common.URL</span></span><br><span class="line"><span class="comment"> *  org.apache.dubbo.common.extension.ExtensionLoader</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.adaptive.Car;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.adaptive.Car.Car;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span>$<span class="title">Adaptive</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getName</span><span class="params">(URL uRL)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (uRL == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        URL uRL2 = uRL;</span><br><span class="line">        String string = uRL2.getParameter(<span class="string">&quot;car&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (string == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="keyword">new</span> StringBuffer().append(<span class="string">&quot;Failed to get extension (com.Playwi0.SPI.adaptive.Car.Car) name from url (&quot;</span>).append(uRL2.toString()).append(<span class="string">&quot;) use keys([car])&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        Car car = (Car)ExtensionLoader.getExtensionLoader(Car.class).getExtension(string);</span><br><span class="line">        car.getName(uRL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现了 <strong>Car</strong> 接口，从传入的 <strong>URL</strong> 中获取参数，最后逻辑与前面一样，获取对应的扩展类，并调用方法。</p><h1>总结</h1><p>如果你还是有点乱，我们来理清一下逻辑。</p><p>1、在 <strong>You.java</strong> 有个 <strong>set注入</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200716110032176.png" alt="image-20200716110032176"></p><p>2、<code>extensionLoader.getExtension(&quot;you&quot;);</code>实例扩展类，在<code>injectExtension(instance);</code>依赖注入时，会根据set方法参数类型，创建对应的 <strong>Loader</strong> ，<code> ExtensionLoader.getExtensionLoader(Car.class);</code>里面调用 <strong>getAdaptiveExtension</strong> 方法。</p><p>3、检查接口中的方法是否有<code>@Adaptive</code>注解，开始生成对应的代理类，没有加<code>@Adaptive</code>注解的方法在代理类是不能调用的。</p><p>4、生成代理类被set注入到 <strong>You</strong> 中，在调用 <strong>getCar</strong> 方法时，里面调用的是代理类 <strong>Car$Adaptive</strong>，代理类会根据 <strong>URL</strong> 参数，加载对应的扩展类，最后调用对应的方法。</p><p>到这里，你应该明白，<strong>Dubbo</strong> 不同服务之间的调用，是以 <strong>Dubbo SPI</strong> 为基础，在此基础上面再延伸。这回你知道为什么在使用 <strong>Dubbo</strong> 开发要提供 <strong>api</strong>。</p><h1>参考文章</h1><ul><li><a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/adaptive-extension.html">http://dubbo.apache.org/zh-cn/docs/source_code_guide/adaptive-extension.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Dubbo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> SPI </tag>
            
            <tag> dubbo </tag>
            
            <tag> 自适应拓展机制 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dubbo SPI（中）</title>
      <link href="/2020/07/15/SPI2/"/>
      <url>/2020/07/15/SPI2/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p>上一篇文章：<a href="https://www.playwi0.com/2020/07/14/SPI/">SPI</a> ，分析了 <strong>Java SPI</strong> 和 <strong>Dubbo SPI</strong> 之间的区别，和细讲 <strong>Dubbo SPI</strong> 实例化扩展类的过程。但是，<strong>Dubbo SPI</strong> 扩展不只这些。</p><p>不要忘记了，<strong>Dubbo SPI</strong> 也是有 <strong>IOC</strong> 特性的，利用这一特性，还可以实现更加灵活的扩展。</p><h1>Wrapper</h1><p><strong>Dubbo SPI</strong> 不仅支持原生扩展类，还可以对扩展类进行包装，这也是增强了灵活性的一点。</p><h2 id="实例">实例</h2><h3 id="接口">接口</h3><p><strong>Car.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.car;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.SPI;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="扩展">扩展</h3><p><strong>Benz.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.car.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.car.Car;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Benz</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Benz&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CarWrapper.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.car.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.car.Car;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarWrapper</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CarWrapper</span><span class="params">(Car car)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.car = car;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;wrapper before&quot;</span>);</span><br><span class="line">        car.getName();</span><br><span class="line">        System.out.println(<span class="string">&quot;wrapper after&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CarWrapper</strong> 也是一个扩展类，但是他的作用和其它的扩展类不同，它是一个包装类。</p><h3 id="配置">配置</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200715150642518.png" alt="image-20200715150642518"></p><h3 id="结果">结果</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200715150731473.png" alt="image-20200715150731473"></p><h2 id="原理">原理</h2><p>上一篇有提到过 <strong>Wrapper</strong>，在 <strong>createExtension</strong> 方法中.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从配置信息中取出所有的扩展类</span></span><br><span class="line">    <span class="comment">// 再根据 name 参数，取出对应的类</span></span><br><span class="line">    Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       .....</span><br><span class="line">       </span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br><span class="line">        <span class="comment">// 如果缓存集合不为空</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(wrapperClasses)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">                <span class="comment">// 包装扩展实例对象的 wrapper 对象依赖注入</span></span><br><span class="line">                instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        .....</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Extension instance (name: &quot;</span> + name + <span class="string">&quot;, class: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;) couldn&#x27;t be instantiated: &quot;</span> + t.getMessage(), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可是这个 <strong>cachedWrapperClasses</strong> 是怎么来的呢，它究竟是不是上面的 <strong>Wrapper</strong>？</p><p>注意最开始一行代码<code>Class&lt;?&gt; clazz = getExtensionClasses().get(name);</code>，从配置文件中扫描所有扩展类，取出当前指定类，那么是怎么扫描的呢。</p><h3 id="getExtensionClasses">getExtensionClasses</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">    <span class="comment">// 配置扩展类 Map 缓存</span></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">    <span class="comment">// 双重检查</span></span><br><span class="line">    <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">            classes = cachedClasses.get();</span><br><span class="line">            <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果为空，加载所有扩展类，key value</span></span><br><span class="line">                classes = loadExtensionClasses();</span><br><span class="line">                cachedClasses.set(classes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>缓存检查，没有就重新加载<code>loadExtensionClasses();</code>，有就直接返回。</p><h3 id="loadExtensionClasses">loadExtensionClasses</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">    cacheDefaultExtensionName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载出对应的类全部放到 extensionClasses，最后存在缓存中</span></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (LoadingStrategy strategy : strategies) &#123;</span><br><span class="line">        loadDirectory(extensionClasses, strategy.directory(), type.getName(), strategy.preferExtensionClassLoader(), strategy.overridden(), strategy.excludedPackages());</span><br><span class="line">        loadDirectory(extensionClasses, strategy.directory(), type.getName().replace(<span class="string">&quot;org.apache&quot;</span>, <span class="string">&quot;com.alibaba&quot;</span>), strategy.preferExtensionClassLoader(), strategy.overridden(), strategy.excludedPackages());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> extensionClasses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里遍历了一个 <strong>LoadingStrategy</strong> 类型集合</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200715152216574.png" alt="image-20200715152216574"></p><p>根据名字，这里 <strong>Dubbo</strong> 使用策略模式，加载配置时的策略。这四个类约定了不同策略的配置文件的加载路径</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200715152757580.png" alt="image-20200715152757580"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DubboExternalLoadingStrategy --&gt; META-INF/dubbo/external/</span><br><span class="line">DubboInternalLoadingStrategy --&gt; META-INF/dubbo/internal/</span><br><span class="line">DubboLoadingStrategy        --&gt; META-INF/dubbo/</span><br><span class="line">ServicesLoadingStrategy      --&gt; META-INF/services/</span><br></pre></td></tr></table></figure><p>这回知道为什么配置文件要写在这几个目录下了。</p><p>不过加载这里是调用了 <strong>loadDirectory</strong> 方法</p><h3 id="loadDirectory">loadDirectory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDirectory</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir, String type,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">boolean</span> extensionLoaderClassLoaderFirst, <span class="keyword">boolean</span> overridden, String... excludedPackages)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String fileName = dir + type;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;java.net.URL&gt; urls = <span class="keyword">null</span>;</span><br><span class="line">        ClassLoader classLoader = findClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try to load from ExtensionLoader&#x27;s ClassLoader first</span></span><br><span class="line">        <span class="comment">// 加载扩展的loader</span></span><br><span class="line">        <span class="comment">// 默认为 false</span></span><br><span class="line">        <span class="keyword">if</span> (extensionLoaderClassLoaderFirst) &#123;</span><br><span class="line">            ClassLoader extensionLoaderClassLoader = ExtensionLoader.class.getClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (ClassLoader.getSystemClassLoader() != extensionLoaderClassLoader) &#123;</span><br><span class="line">                urls = extensionLoaderClassLoader.getResources(fileName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (urls == <span class="keyword">null</span> || !urls.hasMoreElements()) &#123;</span><br><span class="line">            <span class="comment">// 如果 loader 不为空则用该 loader 加载配置文件</span></span><br><span class="line">            <span class="comment">// 否则用 SystemClassLoader</span></span><br><span class="line">            <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                urls = classLoader.getResources(fileName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                urls = ClassLoader.getSystemResources(fileName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (urls != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                java.net.URL resourceURL = urls.nextElement();</span><br><span class="line">                loadResource(extensionClasses, classLoader, resourceURL, overridden, excludedPackages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Exception occurred when loading extension class (interface: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;, description file: &quot;</span> + fileName + <span class="string">&quot;).&quot;</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果扩展类有扩展类加载器 <strong>Loader</strong>，则使用扩展 <strong>Loader</strong>，没有则使用默认的系统默认的 <strong>SystemClassLoader</strong>，配置文件会被包装成一个 <strong>URL</strong> 类，最后调用 <strong>loadResource</strong> 方法加载。</p><h3 id="loadResource">loadResource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadResource</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader,</span></span></span><br><span class="line"><span class="params"><span class="function">                          java.net.URL resourceURL, <span class="keyword">boolean</span> overridden, String... excludedPackages)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(resourceURL.openStream(), StandardCharsets.UTF_8))) &#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="comment">// 一行行读</span></span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 去掉注释</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> ci = line.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    line = line.substring(<span class="number">0</span>, ci);</span><br><span class="line">                &#125;</span><br><span class="line">                line = line.trim();</span><br><span class="line">                <span class="comment">// 去掉注释是否有内容，可能这行用来注释</span></span><br><span class="line">                <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 以‘=’号为分隔</span></span><br><span class="line">                        String name = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">int</span> i = line.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// name 是 key</span></span><br><span class="line">                            name = line.substring(<span class="number">0</span>, i).trim();</span><br><span class="line">                            <span class="comment">// line 是 value</span></span><br><span class="line">                            line = line.substring(i + <span class="number">1</span>).trim();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 配置的扩展类所在的包名不能 和 excludedPackages 重复</span></span><br><span class="line">                        <span class="comment">// excludedPackages 为 strategy 设置,默认为空</span></span><br><span class="line">                        <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span> &amp;&amp; !isExcluded(line, excludedPackages)) &#123;</span><br><span class="line">                            <span class="comment">// Class.forName(line, true, classLoader) 加载扫描的类</span></span><br><span class="line">                            loadClass(extensionClasses, resourceURL, Class.forName(line, <span class="keyword">true</span>, classLoader), name, overridden);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        IllegalStateException e = <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Failed to load extension class (interface: &quot;</span> + type + <span class="string">&quot;, class line: &quot;</span> + line + <span class="string">&quot;) in &quot;</span> + resourceURL + <span class="string">&quot;, cause: &quot;</span> + t.getMessage(), t);</span><br><span class="line">                        exceptions.put(line, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Exception occurred when loading extension class (interface: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;, class file: &quot;</span> + resourceURL + <span class="string">&quot;) in &quot;</span> + resourceURL, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>读取和解析配置文件（<strong>name</strong> 和 <strong>class</strong>），并通过反射加载类<code>Class.forName(line, true, classLoader)</code>，最后调用 <strong>loadClass</strong> 方法进行其他操作。</p><h3 id="loadClass">loadClass</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadClass</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, java.net.URL resourceURL, Class&lt;?&gt; clazz, String name,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="keyword">boolean</span> overridden)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="comment">// 加载到的类需是该 type 的子类</span></span><br><span class="line">    <span class="keyword">if</span> (!type.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Error occurred when loading extension class (interface: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;, class line: &quot;</span> + clazz.getName() + <span class="string">&quot;), class &quot;</span></span><br><span class="line">                + clazz.getName() + <span class="string">&quot; is not subtype of interface.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 类上是否有 @Adaptive 注解</span></span><br><span class="line">    <span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">        cacheAdaptiveClass(clazz, overridden);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 是否为 Wrapper 类</span></span><br><span class="line">    <span class="comment">// 判断是否为该类的一个原则就是：该类是否有type类型的参数的构造方法</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isWrapperClass(clazz)) &#123;</span><br><span class="line">        cacheWrapperClass(clazz);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获得该类的无参构造方法</span></span><br><span class="line">        clazz.getConstructor();</span><br><span class="line">        <span class="comment">// key</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(name)) &#123;</span><br><span class="line">            name = findAnnotationName(clazz);</span><br><span class="line">            <span class="keyword">if</span> (name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No such extension name for the class &quot;</span> + clazz.getName() + <span class="string">&quot; in the config &quot;</span> + resourceURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 切割name</span></span><br><span class="line">        String[] names = NAME_SEPARATOR.split(name);</span><br><span class="line">        <span class="keyword">if</span> (ArrayUtils.isNotEmpty(names)) &#123;</span><br><span class="line">            <span class="comment">// 如果类上有 @Activate 注解，加入 cachedActivates 缓存</span></span><br><span class="line">            <span class="comment">// 保存的是第一个名字</span></span><br><span class="line">            cacheActivateClass(clazz, names[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">// 将 name 和 class 放的 cachedNames 集合中，每个名字对应一个从 class</span></span><br><span class="line">            <span class="comment">// 同也放到 extensionClasses，每个名字对应一个从 class</span></span><br><span class="line">            <span class="keyword">for</span> (String n : names) &#123;</span><br><span class="line">                cacheName(clazz, n);</span><br><span class="line">                saveInExtensionClass(extensionClasses, clazz, n, overridden);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码有点长，简单分析一下</p><p>1、<code>if (!type.isAssignableFrom(clazz))</code>一个扩展接口对应一个 <strong>Loader</strong>，只加在自己的扩展类。</p><p>2、<code>if (clazz.isAnnotationPresent(Adaptive.class))</code>，这个先留着。</p><p>3、<code>if (isWrapperClass(clazz))</code>，如何鉴定是否为一个 <strong>WrapperClass</strong>，答案在这里。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isWrapperClass</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        clazz.getConstructor(type);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很简单，没有想想那么复杂，如果某个扩展类实现了扩展接口，并且以构造方法注入某个扩展类，则视为一个包装类，并加入到缓存<code>cacheWrapperClass(clazz);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheWrapperClass</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cachedWrapperClasses == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    cachedWrapperClasses.add(clazz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、如果是一个普通的扩展类，则通过反射调用无参构造方法实例化，并以 <strong>key，value</strong> 保存到缓存中。</p><p>5、这里基本完成配置信息的缓存，点<code>if</code>判断之后的方法都能看到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cachedAdaptiveClass// 与自适应机制有关</span><br><span class="line">cachedWrapperClasses// 包装类缓存</span><br><span class="line">cachedActivates// @Activate 注解类缓存</span><br><span class="line">cachedNames// 类对应名称，value key方式。</span><br><span class="line">extensionClasses// key value,每个名字对应一个class，一个class可以有多个name</span><br></pre></td></tr></table></figure><h1>总结</h1><p><strong>Duboo SPI</strong> 在包装类这块并没有做得很完善，一个包装类并不能指定包装哪个类，某个扩展类也不能指定被哪个类包装。很粗暴，在 <strong>createExtension</strong> 方法中直接是不断嵌套进去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (CollectionUtils.isNotEmpty(wrapperClasses)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">        <span class="comment">// 包装扩展实例对象的 wrapper 对象依赖注入</span></span><br><span class="line">        instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过这也并不是 <strong>Duboo SPI</strong> 的核心机制。</p>]]></content>
      
      
      <categories>
          
          <category> Dubbo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> SPI </tag>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dubbo SPI（上）</title>
      <link href="/2020/07/14/SPI/"/>
      <url>/2020/07/14/SPI/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p><strong>SPI全称为：Service Provider Interface</strong>，是<strong>JDK</strong>内置的一种<strong>服务发现机制</strong>。</p><p>它是<strong>Java</strong>提供的一套用来被第三方实现或者扩展的<strong>API</strong>，可以用来启用框架扩展和替换组件，主要是被框架的开发人员使用，比如<strong>java.sql.Driver</strong>接口。</p><p>本质上来说，它也是典型基于面向接口编程思想设计的，这种设计思想想来大家应该也不陌生，在初学<strong>Java</strong>编程老师应该多次强调过。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/1568077097364725.jpg" alt=""></p><h1>SPI实践</h1><h2 id="接口">接口</h2><p>根据<strong>Java</strong>中<strong>SPI</strong>的标注，需要提供一个接口</p><p><strong>SPITest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.spi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SPITest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Test</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="扩展">扩展</h2><p>根据该接口的实现类，也就是扩展</p><p><strong>MySPITest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.spi.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.spi.SPITest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySPITest</span> <span class="keyword">implements</span> <span class="title">SPITest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;my test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>HerSPITest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.spi.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.spi.SPITest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HerSPITest</span> <span class="keyword">implements</span> <span class="title">SPITest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Her Test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="配置">配置</h2><p>在 <strong>resource</strong> 目录下，新建 <strong>META-INF/services</strong> 目录，再新建一个名为 <strong>com.Playwi0.spi.SPITest</strong> 的文件（文件名是你接口名称加上在当前项目的包名），内容写上该接口的所有扩展类。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.Playwi0.spi.impl.HerSPITest</span><br><span class="line">com.Playwi0.spi.impl.MySPITest</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200714152346578.png" alt="image-20200714152346578"></p><h2 id="调用">调用</h2><p>上面全部配置好后，接下来就是要去调用前面所提供的的服务。</p><h3 id="ServiceLoader">ServiceLoader</h3><p><strong>Java</strong> 在 <strong>util</strong> 包里面提供了一个类 <strong>ServiceLoader</strong> 来实现调用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">S</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">&quot;META-INF/services/&quot;</span>;</span><br><span class="line">    </span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用其静态方法 <strong>load</strong>，传入接口类，会自动解析并返回配置中所有实现该接口的扩展类；最后遍历执行方法就可以了（<strong>ServiceLoader</strong> 实现 <strong>Iterable</strong> 接口）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.Playwi0.spi.SPITest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ServiceLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ServiceLoader&lt;SPITest&gt; load = ServiceLoader.load(SPITest.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SPITest s : load)&#123;</span><br><span class="line">            s.Test();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结果">结果</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200714153204583.png" alt="image-20200714153204583"></p><h2 id="总结">总结</h2><p><strong>Java SPI</strong> 确实具有非常强的扩展性，调用服务模块和服务模块之间进行了解耦，在实际业务中可以根据需要随意添加扩展类，但还是存在以下几处不足：</p><ul><li>不能按需加载，<strong>ServiceLoader</strong> 默认加载了所有扩展类。这里面可能大量是当前不需要的。</li><li>即使加载所有扩展类都是我们需要的，获取的某个扩展类时比较麻烦，需要遍历。</li><li><strong>ServiceLoader</strong> 类实例在多线程下是不安全的。</li></ul><h1>Dubbo SPI</h1><p>虽然 <strong>Java SPI</strong> 具有很强的扩展性，但却有几处硬伤，不够灵活。针对这几个缺点，<strong>Dubbo SPI</strong> 在此基础上进行了增强，不仅增强其扩展性，同时还让其变得更加灵活。</p><h2 id="实践">实践</h2><p><strong>Dubbo SPI</strong> 和前面的大同小异，因为 <strong>Dubbo SPI</strong> 更加的灵活，在配置时需要多添加点东西</p><h3 id="Maven">Maven</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.dubbo/dubbo --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果你是在源码中调试，那么你只需要在你的 <strong>Module</strong> 导入 <strong>Dubbo-common</strong> 就可以</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="接口-2">接口</h3><p><strong>DubboSPITest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.SPI;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DubboSPITest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：<strong>Dubbo</strong> 约定接口需要加上<code>@SPI</code>注解，表示它是一个可扩展接口，否则会报错</p><h3 id="扩展-2">扩展</h3><p>和前面差异不大。</p><p><strong>HerDubboSPI.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.DubboSPITest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HerDubboSPI</span> <span class="keyword">implements</span> <span class="title">DubboSPITest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;her test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>MyDubboSPI.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.SPI.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.DubboSPITest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDubboSPI</span> <span class="keyword">implements</span> <span class="title">DubboSPITest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;my test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置-2">配置</h3><p>在 <strong>resource</strong> 目录下，新建 <strong>META-INF/dubbo/</strong> 目录，再新建一个名为 <strong>com.Playwi0.spi.DubboSPITest</strong> 的文件，内容写上该接口的所有扩展类。这里 <strong>Dubbo</strong> 为了更加灵活的获取扩展类，支持以 <strong>key=value</strong> 方式配置。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">my=com.Playwi0.SPI.impl.MyDubboSPI</span><br><span class="line">her=com.Playwi0.SPI.impl.HerDubboSPI</span><br></pre></td></tr></table></figure><h3 id="调用-2">调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.Playwi0.SPI.DubboSPITest;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"> ExtensionLoader&lt;DubboSPITest&gt; loader = ExtensionLoader.getExtensionLoader(DubboSPITest.class);</span><br><span class="line">        DubboSPITest my = (DubboSPITest) loader.getExtension(<span class="string">&quot;my&quot;</span>);</span><br><span class="line">        my.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <strong>ExtensionLoader</strong>  类的 <strong>getExtensionLoader</strong> 静态方法加载接口的所有扩展类，再根据配置的 <strong>key</strong> 加载对应的扩展类，最后执行方法</p><h3 id="结果-2">结果</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200714162226067.png" alt="image-20200714162226067"></p><h2 id="原理">原理</h2><p>知道了怎么使用，来看看 Dubbo 是怎么实现的。</p><h3 id="getExtensionLoader">getExtensionLoader</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ExtensionLoader&lt;T&gt; <span class="title">getExtensionLoader</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 传入必须是接口并且有 SPI 注解</span></span><br><span class="line">    <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Extension type == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!type.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Extension type (&quot;</span> + type + <span class="string">&quot;) is not an interface!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否有 @SPI 注解</span></span><br><span class="line">    <span class="keyword">if</span> (!withExtensionAnnotation(type)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Extension type (&quot;</span> + type +</span><br><span class="line">                <span class="string">&quot;) is not an extension, because it is NOT annotated with @&quot;</span> + SPI.class.getSimpleName() + <span class="string">&quot;!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从缓存中获取 Loder</span></span><br><span class="line">    ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">    <span class="comment">// 没有就重新创建一个，并且放到缓存中，</span></span><br><span class="line">    <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 新建一个 Loader 放到缓存中</span></span><br><span class="line">        EXTENSION_LOADERS.putIfAbsent(type, <span class="keyword">new</span> ExtensionLoader&lt;T&gt;(type));</span><br><span class="line">        loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对合法的可扩展接口，初始化一个 <strong>ExtensionLoader</strong> 放到缓存中</p><h3 id="getExtension">getExtension</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 不为空</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(name)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Extension name == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果为 true，则返回默认的对象</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getDefaultExtension();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从缓存取出目标对象包装类 holder。</span></span><br><span class="line">    <span class="comment">// 如果没有就创建一个空的包装类 holder。</span></span><br><span class="line">    <span class="keyword">final</span> Holder&lt;Object&gt; holder = getOrCreateHolder(name);</span><br><span class="line">    <span class="comment">// holder 中取出对象</span></span><br><span class="line">    Object instance = holder.get();</span><br><span class="line">    <span class="comment">// 双重检查</span></span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (holder) &#123;</span><br><span class="line">            instance = holder.get();</span><br><span class="line">            <span class="comment">// 如果该对象没有创建，也就是不在缓存里，则重新创建</span></span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建对象实例</span></span><br><span class="line">                instance = createExtension(name);</span><br><span class="line">                holder.set(instance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从缓存取出指定扩展实例对象，没有就新建一个。不过扩展实例对象并不是直接放到缓存集合中，而是把它包装成一个 <strong>Holder</strong> 对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getOrCreateHolder">getOrCreateHolder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Holder&lt;Object&gt; <span class="title">getOrCreateHolder</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 缓存取出 holder 对象</span></span><br><span class="line">    Holder&lt;Object&gt; holder = cachedInstances.get(name);</span><br><span class="line">    <span class="comment">// 没有就新建一个 holder 对象，里面没有扩展实例</span></span><br><span class="line">    <span class="comment">// 放到缓存中</span></span><br><span class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cachedInstances.putIfAbsent(name, <span class="keyword">new</span> Holder&lt;&gt;());</span><br><span class="line">        holder = cachedInstances.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> holder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="createExtension">createExtension</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从配置信息中取出所有的扩展类</span></span><br><span class="line">    <span class="comment">// 再根据 name 参数，取出对应的类</span></span><br><span class="line">    Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line">    <span class="comment">// 不存在抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> findException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 根据类信息，从缓存中扩展类实例</span></span><br><span class="line">        T instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        <span class="comment">// 如果类没有被实例化过</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 通过反射实例化扩展类</span></span><br><span class="line">            <span class="comment">// 存入到扩展类实例缓存中</span></span><br><span class="line">            <span class="comment">// 再重新取出来</span></span><br><span class="line">            EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span><br><span class="line">            instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注入依赖</span></span><br><span class="line">        <span class="comment">// 扩展实例对象注入</span></span><br><span class="line">        injectExtension(instance);</span><br><span class="line">        <span class="comment">// wrapper 缓存对象</span></span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br><span class="line">        <span class="comment">// 如果缓存集合不为空</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(wrapperClasses)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">                <span class="comment">// 包装扩展实例对象的 wrapper 对象依赖注入</span></span><br><span class="line">                instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行生命周期方法 initialize</span></span><br><span class="line">        initExtension(instance);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Extension instance (name: &quot;</span> + name + <span class="string">&quot;, class: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;) couldn&#x27;t be instantiated: &quot;</span> + t.getMessage(), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>缓存没有就反射实例化指定扩展类，并进行依赖注入 <strong>injectExtension</strong>，最后执行生命周期方法 <strong>nitExtension</strong>。这里有 <strong>wrapperClasses</strong>，留着后面讲。</p><h3 id="injectExtension">injectExtension</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">injectExtension</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (objectFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 遍历该扩展实例中所有的方法</span></span><br><span class="line">        <span class="keyword">for</span> (Method method : instance.getClass().getMethods()) &#123;</span><br><span class="line">            <span class="comment">// 不是 set 方法不要</span></span><br><span class="line">            <span class="keyword">if</span> (!isSetter(method)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 标记有 @DisableInject 注解也不用</span></span><br><span class="line">            <span class="keyword">if</span> (method.getAnnotation(DisableInject.class) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获得set方法参数</span></span><br><span class="line">            Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">// 判断参数的类型</span></span><br><span class="line">            <span class="comment">// 八种基本类型（boolean, byte, char, short, int, long, float, 和double）</span></span><br><span class="line">            <span class="comment">// String, Character,</span></span><br><span class="line">            <span class="comment">// 类继承Number，Date</span></span><br><span class="line">            <span class="comment">// 以上返回都是true</span></span><br><span class="line">            <span class="comment">// 如果是数组，则取出数组类型，如果也是上面这些，返回true</span></span><br><span class="line">            <span class="comment">// 基本类型的注入这里不考虑</span></span><br><span class="line">            <span class="keyword">if</span> (ReflectUtils.isPrimitives(pt)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获得参数名</span></span><br><span class="line">                <span class="comment">// 这里的算法是截取 set 后面字符串</span></span><br><span class="line">                String property = getSetterProperty(method);</span><br><span class="line">                <span class="comment">// 根据名字从 Factory 获取实例</span></span><br><span class="line">                Object object = objectFactory.getExtension(pt, property);</span><br><span class="line">                <span class="comment">// 反射注入</span></span><br><span class="line">                <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    method.invoke(instance, object);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Failed to inject via method &quot;</span> + method.getName()</span><br><span class="line">                        + <span class="string">&quot; of interface &quot;</span> + type.getName() + <span class="string">&quot;: &quot;</span> + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Dubbo</strong> 只支持 <strong>set</strong> 注入，利用反射来完成。</p><h2 id="总结-2">总结</h2><p>前面分析了 <strong>Dubbo SPI</strong> 是如何实例化扩展类，并完成相应的依赖注入。这几处逻辑也并没有特别复杂的点。但这不是 <strong>Dubbo SPI</strong> 核心点。</p><p><strong>Dubbo SPI</strong> 扩展点是自适应机制，这里面有些复杂，下篇分析。</p><h1>参考文章</h1><ul><li><a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/dubbo-spi.html">http://dubbo.apache.org/zh-cn/docs/source_code_guide/dubbo-spi.html</a></li><li><a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/adaptive-extension.html">http://dubbo.apache.org/zh-cn/docs/source_code_guide/adaptive-extension.html</a></li><li><a href="https://crossoverjie.top/2020/02/24/wheel/cicada8-spi/">https://crossoverjie.top/2020/02/24/wheel/cicada8-spi/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Dubbo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> SPI </tag>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AQS(AbstractQueuedSynchronizer)</title>
      <link href="/2020/05/26/AQS/"/>
      <url>/2020/05/26/AQS/</url>
      
        <content type="html"><![CDATA[<h2 id="Java层面如何实现一个锁">Java层面如何实现一个锁</h2><p>如何只使用 <strong>Java</strong> 去实现一个锁？</p><h3 id="方式一">方式一</h3><p>使用一个 <strong>state</strong> 属性来表示当前锁状态（<strong>0</strong>没有线程持有锁，<strong>1</strong>有线程持有锁），没有或得锁的线程一直在<strong>自旋</strong>（死循环，不断尝试获得锁，直到成功）。</p><p>伪代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表示锁的状态，保证线程之间的可见性</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> state = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直到获取锁成功       </span></span><br><span class="line">        <span class="keyword">while</span> (!compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上锁逻辑</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否是持有锁的线程</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 修改状态</span></span><br><span class="line">        state = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndSetState</span><span class="params">(<span class="keyword">int</span> expect,<span class="keyword">int</span> update)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CAS 操作修改 state，成功返回 true，失败返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样是可以实现一个锁，但是，如果一个线程获取不到锁，它也会一直在运行（获取锁），消耗CPU资源，造成浪费。</p><p>解决思路：<strong>让获取不到锁的线程让出CPU资源。</strong></p><h3 id="方式二">方式二</h3><p><strong>自旋 + yield</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class Lock &#123;</span><br><span class="line"></span><br><span class="line">    // 表示锁的状态，保证线程之间的可见性</span><br><span class="line">    volatile int state = 0;</span><br><span class="line"></span><br><span class="line">    public void lock()&#123;</span><br><span class="line"></span><br><span class="line">        while (compareAndSetState(0, 1))&#123;</span><br><span class="line"></span><br><span class="line">// 让出CPU资源</span><br><span class="line">yield()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 上锁逻辑</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void unLock()&#123;</span><br><span class="line"></span><br><span class="line">        state = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean compareAndSetState(int expect,int update)&#123;</span><br><span class="line"></span><br><span class="line">        //CAS 操作修改 state，成功返回 true，失败返回 false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现一个 <strong>yield</strong> 方法，让获取不到锁的线程让出CPU，但是，线程数少还好，如果是上百上千个线程，不断让出CPU，然后又不断竞争，这样还是会在消耗CPU资源。</p><p><strong>如果让没有获得锁的线程睡一段时间，再醒来竞争呢？</strong></p><h3 id="方式三">方式三</h3><p><strong>sleep + 自旋</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表示锁的状态，保证线程之间的可见性</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> state = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让出CPU资源,并沉睡</span></span><br><span class="line">sleep(n)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上锁逻辑</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        state = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndSetState</span><span class="params">(<span class="keyword">int</span> expect,<span class="keyword">int</span> update)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CAS 操作修改 state，成功返回 true，失败返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sleep 是可以 sleep，但是sleep多久呢，这个恐怕没有人知道，时间长了，效率低，时间短了，消耗资源。这种方式还是差了点意思。</p><p><strong>是否可以让未获得锁的线程进入等待，等待持有锁的线程执行完，它们再来竞争锁</strong></p><h3 id="方式四">方式四</h3><p><strong>park + 自旋</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表示锁的状态，保证线程之间的可见性</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> state = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待队列，未获的锁的线程进入等待队列</span></span><br><span class="line">    Queue parkQueue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 进入等待队列逻辑</span></span><br><span class="line">park();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上锁逻辑</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//修改锁状态</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// 唤醒等待队列线程</span></span><br><span class="line">        t = parkQueue;</span><br><span class="line">        </span><br><span class="line">        unPark(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">compareAndSetState</span><span class="params">(<span class="keyword">int</span> expect,<span class="keyword">int</span> update)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CAS 操作修改 state，成功返回 true，失败返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 未获得锁，加入等待队列</span></span><br><span class="line">        parkQueue.add(Thread.currentThread());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放CPU资源</span></span><br><span class="line">        releaseCPU();</span><br><span class="line">          </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unPark</span><span class="params">(Queue parkQueue)</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 唤醒等待队列</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>让未获取锁的线程进入等待队列并释放CPU，直到持有锁的线程释放锁，再唤醒等待队列里的线程。</p><p>在 <strong>java.util.concurrent.locks</strong> 包下的 <strong>AbstractQueuedSynchronizer</strong> 抽象类就使用这种方式实现的。下面将研究其具体实现逻辑。</p><h2 id="AbstractQueuedSynchronizer">AbstractQueuedSynchronizer</h2><h3 id="简介">简介</h3><p><strong>AQS</strong> 是 <strong>java.util.concurrent.locks</strong> 包一个抽象类，它实现了对<strong>同步状态的管理</strong>，以及对<strong>阻塞线程进行排队</strong>，<strong>等待通知</strong>等等一些底层的实现处理，同时它还包括的以下几个核心：<strong>同步队列，独占式锁的获取和释放，共享锁的获取和释放以及可中断锁，超时等待锁获取这些特性的实现</strong>。</p><h3 id="加锁">加锁</h3><p>看看AQS如何获得锁，和如何处理未获得锁的线程。</p><h4 id="acquire-int-arg">acquire(int arg)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>if</strong> 判断，通过 <strong>tryAcquire</strong> 方法去尝试获得锁（名字取得讲究，尝试获取），猜测获得锁失败，<strong>tryAcquire</strong> 返回 <strong>false</strong>，那么 <strong>!tryAcquire</strong> 就为 <strong>true</strong>，进入 <strong>addWaiter</strong> 方法，把当前线程包装为一个 <strong>Node</strong> 节点，<strong>acquireQueued</strong> 再把包装好的 <strong>Node</strong> 加入队列；如果 <strong>tryAcquire</strong> 返回 <strong>true</strong>，则获取锁成功。</p><p>具体查看源码便知。</p><h4 id="tryAcquire-int-acquires">tryAcquire(int acquires)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AQS</strong> 里面没有具体实现 <strong>tryAcquire</strong> 方法，因为 <strong>AQS</strong> 是一个抽象类，可以理解为一个抽象锁，具体哪种锁，加锁的方式是不一样的，交由子类重写，针对锁的不同，实现具体加锁逻辑。</p><h4 id="addWaiter-Node-mode">addWaiter(Node mode)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 初始值为空</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;    </span><br></pre></td></tr></table></figure><p>该方法时获取锁失败后，把线程包装成一个 <strong>Node</strong> 节点的方法，<strong>acquire</strong> 方法中传入的是 <strong>Node.EXCLUSIVE</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">    <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">    <span class="keyword">this</span>.thread = thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入 <strong>addWaiter</strong> 方法，先新建个 <strong>Node</strong> 包装当前线程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Node pred = tail;</span><br><span class="line">if (pred != null) &#123;</span><br><span class="line">    node.prev = pred;</span><br><span class="line">    if (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">        pred.next = node;</span><br><span class="line">        return node;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 队列头部</span><br><span class="line">private transient volatile Node tail;</span><br><span class="line"></span><br><span class="line">// 队列尾部</span><br><span class="line">private transient volatile Node head;</span><br></pre></td></tr></table></figure><p><strong>AQS</strong> 记录着队列头节点（<strong>head</strong>）和尾节点（<strong>tail</strong>）。拿到队列的尾节点，如果尾部不为空，那么说明该线程前面还有等待线程，用 <strong>CAS</strong> 进行尾插法操作，插入新的节点，如果为空，说明队列刚初始化，直接把包装节点传入 <strong>enq</strong> 方法，同时这里 <strong>CAS</strong> 尾插不成功也会进入 <strong>enq</strong>  方法。最后都是返回新建 <strong>Node</strong>。</p><h4 id="enq-final-Node-node">enq(final Node node)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到 <strong>for (;;)</strong> ，很明显这里是个自旋，主要有两步操作。</p><p>第一次自旋，尾部为空，说明队列没有初始化，新建了一个空节点，设置头部和尾部，再循环一次，这时候尾部已经不为空，再用 <strong>CAS</strong> 尾插法把新建节点设置为尾节点，不断重试知道成功。</p><p>如果是 <strong>addWaiter</strong> 方法中尾插失败，则 <strong>enq</strong> 方法自旋尾插入，知道成功返回尾部。</p><h4 id="队列结构">队列结构</h4><p>看完 <strong>addWaiter</strong> 和 <strong>enq</strong> 方法，基本可以了解队列的结果，<strong>就是个链表</strong>。</p><p><strong>初始化</strong></p><p>先创建一个包装当前线程的 <strong>Node</strong></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200527170424368.png" alt="image-20200527170424368"></p><p>再初始化一个空的节点，指向 <strong>head</strong> 属性，然后与新建节点进行链接，</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200527171441726.png" alt="image-20200527171441726"></p><p><strong>队列存在</strong></p><p>新建节点直尾接插入该队列</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200527172013275.png" alt="image-20200527172013275"></p><h4 id="acquireQueued-final-Node-node-int-arg">acquireQueued(final Node node, int arg)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在进入 <strong>acquireQueued</strong> 之前，调用 <strong>addWaiter</strong> 包装线程，并插入队列，再将包装好的 <strong>Node</strong> 传入到 <strong>acquireQueued</strong> 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure><p>两个标记，作用未知</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">    Node p = prev;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用 <strong>node</strong> 内部方法，获得前驱节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">    setHead(node);</span><br><span class="line">    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">    failed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> interrupted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前面介绍了同步队列的结构，第一个节点是空的（可能用来表示持有锁的线程）。这里 p 表示当前节点（线程）的前驱，如果他的前驱是队列的头部，说明当前节点在队列的第二位（前面是持有锁的线程），有资格尝试获得锁。按理说进入到 <strong>acquireQueued</strong>  是因为线程第一次尝试获得锁（tryAcquire）失败，包装成 node 节点去排队，为什么再这里还有再次尝试获得锁？可能是在插入队列的时候，锁已经释放了，这里再次尝试获得锁，避免当前线程进入排队。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHead</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    head = node;</span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line">    node.prev = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果获得锁成功，把当前节点设置尾头节点，代替原来头节点的位置。改变标记，返回当前节点是否被打断标记。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">    parkAndCheckInterrupt())</span><br><span class="line">    interrupted = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure><p>如果当前节点的前驱节点不是头节点，说明前面还有线程 node 在排队，应该进入阻塞逻辑。</p><p>一般进入 <strong>acquireQueued</strong> 方法的节点，绝大部分都是要进行阻塞处理，由两个方法实现 <strong>shouldParkAfterFailedAcquire</strong> 和 <strong>parkAndCheckInterrupt</strong></p><h4 id="shouldParkAfterFailedAcquire-Node-pred-Node-node">shouldParkAfterFailedAcquire(Node pred, Node node)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ws = pred.waitStatus;</span><br></pre></td></tr></table></figure><p>获取前驱节点状态（排队还是已获得锁）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (ws == Node.SIGNAL)</span><br><span class="line">return true;</span><br></pre></td></tr></table></figure><p>如果当前节点和前驱节点状态一样（阻塞），返回 <strong>true</strong>，表示当前线程可以安心休息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line">    &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">    pred.next = node;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>如果不和前驱节点的状态一样，说明前驱节点有可能已经放弃竞争，等死的节点，<strong>do while</strong> 循环，直到获取到一个正常的节点（pred.waitStatus &lt;= 0，小于 0 阻塞，等于 0 在竞争）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果前驱节点正常，把前驱节点设置为阻塞状态，这里有可能失败，前驱节点有可能刚好正在竞争锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure><p>除了前驱节点处于等待状态，否则都会返回失败，再进入 <strong>acquireQueued</strong>  的 <strong>for (;;)</strong> 自旋获得锁或者，再次进入排队。</p><h4 id="parkAndCheckInterrupt">parkAndCheckInterrupt()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前面源码可以看到，<strong>shouldParkAfterFailedAcquire</strong> 方法主要是改变节点为阻塞状态，直到成功或者节点成功抢占锁。那么 <strong>parkAndCheckInterrupt</strong> 方法在 <strong>shouldParkAfterFailedAcquire</strong> 之后执行，很明显节点状态已经设置好，走到这里说明线程要进入排队了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">(Object blocker)</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    setBlocker(t, blocker);</span><br><span class="line">    UNSAFE.park(<span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">    setBlocker(t, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先调用 <strong>LockSupport</strong> 类中的 <strong>park</strong> 方法让线程进入阻塞状态（内部逻辑是有 <strong>native</strong> 方法实现）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Thread.interrupted();</span><br></pre></td></tr></table></figure><p>返回线程是否被打断标。</p><h4 id="总结">总结</h4><p>前面所有分析，否是加锁部分逻辑。</p><ul><li>第一次拿锁，加锁（<strong>tryAcquire</strong>）成功则不需要进入排队，</li><li>第一次拿锁失败，队列未初始化，则初始化队列（头节点为空的链表），然后包装成节点插入队列，这时应该在队列第二位，有资格再一次竞争锁，再次失败则进入排队，成功直接获得锁。</li><li>第一次拿锁失败，队列已初始化，包装成节点进入队列排队，前驱节点是阻塞状态，则自己安心阻塞，如果前面线程已放弃竞争，则自己位置前进以为，不断重复这个过程，直到找到正常节点，改变状态。</li></ul><h3 id="释放锁">释放锁</h3><p>有加锁肯定就有释放锁，当然释放锁不可能是简单改变锁的状态，还要负责唤醒正在等待的线程</p><h4 id="release-int-arg">release(int arg)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用 <strong>tryRelease</strong> 方式尝试释放锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Node h = head;</span><br></pre></td></tr></table></figure><p>如果成功，则获取队列头部</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">    unparkSuccessor(h);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure><p>如果队列不为空，且正在阻塞状态，则调用  <strong>unparkSuccessor</strong> 唤醒队列。最终返回 <strong>true</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure><p>释放锁失败，返回 <strong>false</strong></p><h4 id="tryRelease-int-arg">tryRelease(int arg)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样的，<strong>tryRelease</strong>方法的具体实现交给具体锁。</p><h4 id="unparkSuccessor-Node-node">unparkSuccessor(Node node)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前面传进来是头部，一般是处于阻塞状态（加锁时 <strong>shouldParkAfterFailedAcquire</strong> 方法设置的）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line"><span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">    compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>先拿到节点状态，如果时阻塞状态，则改变为正常状态 0。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Node s = node.next;</span><br></pre></td></tr></table></figure><p>头部为空节点，拿到下一个节点（真正在排队节点）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    s = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">        <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">            s = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果下一个节点是空节点或着已经放弃竞争，则从队列尾部开始查找有效节点（<strong>waitStatus &lt;= 0</strong>），如果找到正常节点或者下一个是阻塞节点,，则进入唤醒逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">    LockSupport.unpark(s.thread);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unpark</span><span class="params">(Thread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (thread != <span class="keyword">null</span>)</span><br><span class="line">        UNSAFE.unpark(thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是防止从尾部开始查找节点已经为空或者说来就是一个空队列。</p><h4 id="总结-2">总结</h4><p>解锁逻辑相对加锁逻辑比较简单，主要就是改变锁的状态，和唤醒队列。</p><h3 id="AQS总结">AQS总结</h3><p>结合前面加锁和解锁分析，可以解决几个疑问。</p><p>为什么头节点为空？</p><p>从 <strong>shouldParkAfterFailedAcquire</strong> 方法和 <strong>unparkSuccessor</strong>，可以推测，某个节点的前驱节点是表示这个节点的状态，所以在加锁的时候要保证前驱节点的状态，解锁的也要改变前驱节点状态，如果前驱节点状态都错误，可能后面都错误，所以从尾部开始查找，查看有没有正常节点。</p><p>当然 <strong>AQS</strong> 不仅仅只有这几个方法，还有共享锁加解锁逻辑等。有兴趣可以继续阅读</p><h2 id="公平锁（FairSync）">公平锁（FairSync）</h2><p><strong>FairSync</strong> 是 <strong>AQS</strong> 子类之一（间接），<strong>AQS</strong> 是抽象锁，那么 <strong>FairSync</strong> 就是具体锁，公平锁的一种。</p><p><strong>AQS</strong> 留下了两个主要的抽象方法：<strong>tryAcquire</strong> 和 <strong>tryRelease</strong> ，查看这个两个方法的具体实现，来看锁的具体实现原理。</p><h3 id="加锁-2">加锁</h3><p>公平锁加锁</p><h4 id="tryAcquire-int-acquires-2">tryAcquire(int acquires)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">            compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先获取当前线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Thread current = Thread.currentThread();</span><br></pre></td></tr></table></figure><p>再获得当前锁的状态，是否被其他线程上锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> c = getState();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Method</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  属性，0 表示未有线程持有锁，1 表示已被线程持有锁</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br></pre></td></tr></table></figure><p>如果当前线程是第一个到这来拿取锁的，那么 <strong>c = 0</strong>，则进入下面逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">        compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">        setExclusiveOwnerThread(current);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>hasQueuedPredecessors</strong> 方法判断是否有前驱节点，也就是是否需要排队，需要返回 <strong>true</strong> ，不需要返回 <strong>false</strong> ，第一次上锁队列都是没初始化，如果不需要排队就 <strong>CAS</strong> 操作更改锁的状态为上锁状态。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setExclusiveOwnerThread(current);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setExclusiveOwnerThread</span><span class="params">(Thread thread)</span> </span>&#123;</span><br><span class="line">    exclusiveOwnerThread = thread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Thread exclusiveOwnerThread;</span><br></pre></td></tr></table></figure><p>上锁完后要记录当前持有锁的线程，因为要为下面重入作铺垫。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">    <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">    <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果锁已经被某个线程持有，那么 <strong>c = 1</strong>，还有一种可能可以拿到锁，那就是锁的重入，就是当前线程在锁的同步块里面加锁，又是同一把锁，那么这种情况可以拿到锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">current == getExclusiveOwnerThread()</span><br></pre></td></tr></table></figure><p>比对持有锁的线程和当前线程是否是同一个线程，是就是重入锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nt nextc = c + acquires;</span><br><span class="line">f (nextc &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">setState(nextc);</span><br></pre></td></tr></table></figure><p>记录加锁次数，解锁次数等于加锁次数才算解锁成功。这里返回 <strong>true</strong></p><h4 id="hasQueuedPredecessors">hasQueuedPredecessors()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Node t = tail; <span class="comment">// Read fields in reverse initialization order</span></span><br><span class="line">    Node h = head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法不简单，公平锁的核心所在。看看如何保证公平。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h != t</span><br></pre></td></tr></table></figure><p>如果是相等的，有两种情况：</p><ul><li><strong>head</strong> 和 <strong>tail</strong> 都为空，说名明队列没有初始化，说明当前线程是第一个来拿锁的，则可以直接拿到锁。</li><li><strong>head</strong> 和 <strong>tail</strong> 都指向同一个节点，这种情况只有一种可能，根据队列结构可以判断，是空的头节点；这种情况说明队列虽然初始化，但是是空的队列，没有人在排队。可以直接拿到锁。</li></ul><p>如果不相等，说明队列已经初始化，并且有可能有节点在排队。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread())</span><br></pre></td></tr></table></figure><p>队列已初始化，头节点为空，真正在排队是第二个节点。这时有两种情况：</p><ul><li>第二个节点是空节点，这种情况基本不可能出现。</li><li>第二个节点是不是空节点，继续判断第二个节点里面的线程是否为当前线程，如果是，说明你是排在最前面哪一个，可以去拿锁；如果不是，说明队列有线程排在当前线程前面，当前线程需要去排队。</li></ul><h3 id="解锁">解锁</h3><p>公平锁的解锁逻辑</p><h4 id="tryRelease-int-releases">tryRelease(int releases)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> c = getState() - releases;</span><br></pre></td></tr></table></figure><p>先做好解锁标记</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br></pre></td></tr></table></figure><p>如果持有锁的线程不是当前线程，那么说明没有拿到锁就解锁，捣乱。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">    free = <span class="keyword">true</span>;</span><br><span class="line">    setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">setState(c);</span><br><span class="line"><span class="keyword">return</span> free;</span><br></pre></td></tr></table></figure><p>如果 <strong>c = 0</strong>，说明当前线程全部释放锁（包括重入锁），则可以把锁设置为无锁状态，如果 <strong>c != 0</strong>，说明只是释放了一个重入锁，锁并没有完全释放 ，还是返回 <strong>false</strong>，不会去唤醒队列。</p><h3 id="总结-3">总结</h3><p>经过分析，公平锁的原则就是，谁先来拿锁，谁就排在前面，谁就优先，先到先得。即使有线程来的是刚好没有线程持有锁（可能线程刚好释放），也要先判断队列是否有线程排队，有则当前线程要靠后，这就是公平锁。</p><h2 id="非公平锁（NonfairSync）">非公平锁（NonfairSync）</h2><p><strong>NonfairSync</strong> 也是 <strong>AQS</strong> 的子类之一，是一种非公平锁，同样的，主要查看它的 <strong>tryAcquire</strong> 和 <strong>tryRelease</strong> 方法。</p><h3 id="加锁-3">加锁</h3><p>非公平锁加锁逻辑</p><h4 id="tryAcquire-int-acquires-3">tryAcquire(int acquires)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryAcquire(int acquires) &#123;</span><br><span class="line">    return nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里非公平锁自定义了一个方法 <strong>nonfairTryAcquire</strong></p><h4 id="nonfairTryAcquire-int-acquires">nonfairTryAcquire(int acquires)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整体看，这里代码和公平锁的代码相差不大</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">        setExclusiveOwnerThread(current);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这一步少了一个 <strong>hasQueuedPredecessors</strong>  方法，改方法主要是在线程拿锁前，判断同步队列里面是否还有等待线程，而这里去掉，说明无论同步队列有没有等待线程，都可以去抢占锁。也就是说，线程来拿锁，无论先来还是后到，只有拿不到锁才回去排队。</p><h3 id="解锁-2">解锁</h3><p>非公平锁释放锁逻辑</p><h4 id="tryRelease-int-releases-2">tryRelease(int releases)</h4><p>非公平锁释放锁和公平锁释放共用一个方法，两个锁释放锁都是这个方法具体看前面。</p><h3 id="总结-4">总结</h3><p>结合公平锁来看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 公平锁</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 非公平锁</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>公平锁有先来后到原则，而非公平锁拿到就是你的，拿不到就去排队。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> thread </tag>
            
            <tag> AQS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>synchronized</title>
      <link href="/2020/05/20/synchronized/"/>
      <url>/2020/05/20/synchronized/</url>
      
        <content type="html"><![CDATA[<h3 id="前言">前言</h3><p><strong>synchronized</strong> 是 <strong>Java</strong> 关键字之一，常用于并发业务中，主要是对某对象上锁，以保证某段代码在多线程能安全运行，避免出现线程资源混乱。</p><p>随着 Java 的发展，<strong>synchronized</strong> 也不断被优化，不再像最初那样单一锁法，<strong>JDK1.6</strong>之后，<strong>synchronized</strong> 里面包含了三种级别锁：<strong>偏向锁、轻量锁、重量锁</strong>。每种锁的所带来的效率完全不一样，可以说是天差地别。因此有必要了解一下<strong>synchronized</strong> 的原理。</p><h3 id="用法">用法</h3><p>简单几种用法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncExample</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyLock myLock = <span class="keyword">new</span> MyLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用法 1</span></span><br><span class="line"><span class="comment">     * 在方法上添加，锁住对象为 this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">one</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用法 2</span></span><br><span class="line"><span class="comment">     * 在方法内使用，锁住对象为 this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">second</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用法 3</span></span><br><span class="line"><span class="comment">     * 锁住某块代码，锁住自定义对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">third</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (myLock)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;third&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SyncExample syncExample = <span class="keyword">new</span> SyncExample();</span><br><span class="line">        syncExample.one();</span><br><span class="line">        syncExample.second();</span><br><span class="line">        syncExample.third();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>需要注意的是：如果是在方法上添加或锁住的 <strong>this</strong> <strong>或属性</strong>，那么锁住的依然是该属性或方法所属的实例化对象。</p><h3 id="对象头">对象头</h3><p>对象头是什么？为什么讲锁要去了解对象头呢？</p><h4 id="简介">简介</h4><p><strong>Java</strong> 对象头就是 <strong>Java</strong> 存储对象真正有效信息的的区域。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200520153255759.png" alt="image-20200520153255759"></p><p>上图为 <strong>Hotspot</strong> 的源码种对对象头的注释,整理一下得出下表</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525170634543.png" alt="image-20200525170634543"></p><p><strong>L locked</strong>（<strong>Lightweight Locked</strong>）,<strong>H Locked</strong>（<strong>Heavyweight Locked</strong>）</p><h4 id="Mark-Word">Mark_Word</h4><p><strong>Mark Word</strong> 用于存储对象自身的运行时数据，64位 <strong>JVM</strong> 为 <strong>64bits</strong>，<strong>8个字节</strong>：</p><ul><li><strong>thread</strong> ：偏向线程ID，<strong>54 bits</strong></li><li><strong>identity_hashcode</strong> ：哈希码（<strong>HashCode</strong>），<strong>31 bits</strong></li><li><strong>epoch</strong> ：偏向时间戳，<strong>2 bits</strong></li><li><strong>age</strong> ：GC分代年龄，<strong>4 bits</strong></li><li><strong>biased_lock</strong> ：偏向锁的标识位，<strong>1 bit</strong></li><li><strong>lock</strong> ： 线程持有的锁，<strong>2 bits</strong></li></ul><p>通过整理可以看出，<strong>Mark_Word</strong> 里面有三个 <strong>3bits</strong> 和锁紧密有关。这里可以解释为什么讲 <strong>synchronized</strong> 所产生的锁要理解对象头，<strong>因为 synchronized 关键字锁住的是对象，不是代码块，而体现就在对象头里面，所有很有必要了解一下对象头</strong>。</p><h4 id="对象的状态">对象的状态</h4><p>表格列出了<strong>5种</strong>对象状态，其实对象状态对象只有三种：</p><ul><li><strong>无锁状态</strong>（<strong>Normal</strong>）</li><li><strong>有锁状态</strong></li><li><strong>GC标记状态 （GC）</strong></li></ul><p>有锁状态又分为三种：</p><ul><li><strong>偏向锁（Biased）</strong></li><li><strong>轻量锁（Lightweight Locked）</strong></li><li><strong>重量锁（Heavyweight Locked）</strong></li></ul><p>总的来说一共有五种状态，但是 <strong>lock</strong> 只有 <strong>2bits</strong> 的二进制数，最多只能表示4种状态，所以这里多加了1bit <strong>biased_lock</strong>，表示偏向锁。</p><h3 id="分析JOL（Java-Object-Layout）">分析JOL（Java Object Layout）</h3><p><strong>Hotspot</strong>虚拟机中，对象在内存中的布局分为三块区域：<strong>对象头、实例数据和对齐填充</strong>。</p><h4 id="JOL工具包">JOL工具包</h4><p>如需要看到上述这些数据，需要借助一个工具包 <a href="http://openjdk.java.net/projects/code-tools/jol/"><strong>JOL（Java Object Layout）</strong></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JOL (Java Object Layout) is the tiny toolbox to analyze object layout schemes in JVMs. These tools are using Unsafe, JVMTI, and Serviceability Agent (SA) heavily to decoder the actual object layout, footprint, and references. This makes JOL much more accurate than other tools relying on heap dumps, specification assumptions, etc.</span><br></pre></td></tr></table></figure><p>一个借助 Java 多项技术，解析出 Java 对象在内存布局的工具包。</p><p>导入Maven包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jol/jol-core --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jol<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jol-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>打印一个对象信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.vm.VM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印当前 JVM 虚拟机信息</span></span><br><span class="line">        System.out.println(VM.current().details());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印实例化对象信息</span></span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Running 64-bit HotSpot VM.</span><br><span class="line"># Using compressed oop with 0-bit shift.</span><br><span class="line"># Using compressed klass with 3-bit shift.</span><br><span class="line"># Objects are 8 bytes aligned.</span><br><span class="line"># Field sizes by type: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span><br><span class="line"># Array element sizes: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span><br><span class="line"></span><br><span class="line">com.Playwi0.Third.One object internals:</span><br><span class="line">OFFSET SIZE   TYPE         DESCRIPTION                 VALUE</span><br><span class="line">  0   4   (object header)  01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">  4   4   (object header)  00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">  8   4   (object header)  43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)</span><br><span class="line">  12  4   (loss due to the next object alignment)</span><br><span class="line"></span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>分析</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Field sizes by type: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span><br><span class="line"># 分别对应[Oop(Object Original Pointer), boolean, byte, char, short, int, float, long, double]的大小</span><br><span class="line"></span><br><span class="line"># Array element sizes: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes] </span><br><span class="line"># 数组中元素的大小，分别对应的是[Oop(Object Original Pointer), boolean, byte, char, short, int, float, long, double]</span><br></pre></td></tr></table></figure><p>这部分主要是用来优化 <strong>Field</strong> 的排序，节省内存空间。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">com.Playwi0.Third.One object internals:</span><br><span class="line">OFFSET SIZE   TYPE         DESCRIPTION                 VALUE</span><br><span class="line">  0   4   (object header)  01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">  4   4   (object header)  00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">  8   4   (object header)  43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)</span><br><span class="line">  12  4   (loss due to the next object alignment)</span><br><span class="line"></span><br><span class="line">Instance size: 16 bytes</span><br></pre></td></tr></table></figure><p>通过这部分，可以确确了解到一个空对象在内存中占 <strong>16 bytes</strong>，对象头为 <strong>12 bytes</strong>，还有 <strong>4 bytes</strong> 是对齐字节，因为 JVM 上规定对象都是<strong>以8 bytes的粒度来对齐的</strong>，所以对象头占了 12 bytes，需要补齐 4bytes，一共 16 bytes。</p><h4 id="实例数据">实例数据</h4><p>往对象里面添加数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class One &#123;</span><br><span class="line"></span><br><span class="line">    private int i = 1;</span><br><span class="line">    </span><br><span class="line">    private boolean flag = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522143734127.png" alt="image-20200522143734127"></p><p>可以看到下面有两行打印出对象的实例数据，按照前面所说，<strong>int</strong> 类型数据大小对应 <strong>4 bytes</strong>， <strong>boolean</strong> 类型为 <strong>1bytes</strong> ，多出 <strong>5 bytes</strong>，加上对象头 <strong>12 bytes</strong>，总共 <strong>17 bytes</strong>，因为对象都是<strong>以8 bytes的粒度来对齐的</strong>，所以补了 **7 bytes **对齐数据，全部加起来一共 <strong>24 bytes</strong>。</p><h4 id="对象头-2">对象头</h4><p>知道了<strong>实例数据</strong>和<strong>对齐字节</strong>的意义，那么继续探究对象头。对齐字节存在的意义是弥补实例数据所带来差额，而对象数据大小并不会改变，只有<strong>12 bytes</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522151453017.png" alt="image-20200522151453017"></p><p>在<strong>Hotspot术语表</strong>对<strong>Object header</strong>解释：由两个 <strong>words</strong> 组成。除去前面已经解释过一个： <strong>Mark_Word</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522151727209.png" alt="image-20200522151727209"></p><p>还有一个 <strong>Klass_Word</strong></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522152048399.png" alt="image-20200522152048399"></p><p>该部分占 <strong>4 bytes</strong>（<strong>Mark_Word 占 8 bytes</strong>），并且该部分指向的是<strong>对象的元数据</strong>，就是JVM通过这个指针确定对象是哪个类的实例（猜测，依据是<strong>同一个类实例化出来的对象，该值一样</strong>）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class JOLExample &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        One one = new One();</span><br><span class="line">        One two = new One();</span><br><span class="line">        </span><br><span class="line">        // 打印实例化对象信息</span><br><span class="line">        System.out.println(&quot;Object one&quot;);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;Object two&quot;);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(two).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522152944863.png" alt="image-20200522152944863"></p><p>那么对象头的<strong>words</strong>结构是：</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522153330673.png" alt="image-20200522153330673"></p><p>验证</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印实例化对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before hashCode&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line">a</span><br><span class="line">        <span class="comment">// 打印对象16进制的hashCode</span></span><br><span class="line">        System.out.println(Integer.toHexString(one.hashCode()));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;after hashCode&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522154421896.png" alt="image-20200522154421896"></p><p>根据上面的表格，这是一个正常（<strong>Normal，无锁状态</strong>）的对象，其 <strong>HashCode</strong> 占 <strong>31bits</strong>，<strong>unused</strong> 占 <strong>25bits</strong>，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unusedHashCode</span><br><span class="line">00000000 00000000 00000000 0[1100100 10100010 10010100 10100110 00000001]</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522160918624.png" alt="image-20200522160918624"></p><p>确实是<strong>HashCode</strong>值，但是为什么是反过来的？</p><p>这是因为<a href="%5Bhttps://baike.baidu.com/item/%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F/6750542?fr=aladdin%5D(https://baike.baidu.com/item/%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F/6750542?fr=aladdin)">大小端模式</a>。PC端一般是<strong>小端模式</strong>，也就是<strong>指数据的高字节，保存在内存的低地址中，而数据的低字节，保存在内存的高地址中，这样的存储模式有点儿类似于把数据当作字符串顺序处理：地址由小向大增加，而数据从高位往低位放</strong>。</p><p>接下只剩下 <strong>1byte</strong> ，也就是 <strong>8 bits</strong>，但它是<strong>和锁有直接关系的部分</strong>，也就是和 <strong>synchronized</strong> 关键字最紧密联系的部分，最直观感受到 <strong>synchronized</strong> 关键字锁住对象所带来的变化。根据表格，结构如下</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522162155451.png" alt="image-20200522162155451"></p><p><strong>8 bits</strong> 中后 <strong>3 bits</strong> 直接表示五种对象状态，接下来探讨基本都是围绕这 <strong>3 bits</strong></p><h3 id="锁的原理">锁的原理</h3><p>到这里，你对对像头已经有了基本的了解，接下来，就是慢慢揭开锁的面纱。</p><table><thead><tr><th style="text-align:center">对象状态</th><th style="text-align:center">1 bit</th><th style="text-align:center">4 bits</th><th style="text-align:center">1 bit</th><th style="text-align:center">2 bit</th></tr></thead><tbody><tr><td style="text-align:center">无锁态</td><td style="text-align:center">unused</td><td style="text-align:center">分带年龄</td><td style="text-align:center">0</td><td style="text-align:center">01</td></tr><tr><td style="text-align:center">偏向锁</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">1</td><td style="text-align:center">01</td></tr><tr><td style="text-align:center">轻量级锁</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">00</td></tr><tr><td style="text-align:center">重量级锁</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">10</td></tr><tr><td style="text-align:center">GC 标记</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">11</td></tr></tbody></table><p>前面已经列出了对象的五种状态，由 <strong>3 bits</strong> 表示。上表是五种状态的具体表示。</p><h4 id="无锁态">无锁态</h4><p>前面已经打印过了，对象 <strong>one</strong> 并没有进行任何加锁操作，所以前面 <strong>8 bits</strong> 是 <strong>00000001</strong></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522203006233.png" alt="image-20200522203006233"></p><h4 id="偏向锁">偏向锁</h4><p>什么是偏向锁？</p><p><strong>偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁，降低获取锁的代价。</strong></p><p>在大多数情况下，锁不仅不存在多线程竞争，而且总是由同一个线程获得，为了让线程获得锁的代价更低从而提高性能，所以引入了偏向锁的概念。</p><p>JDK1.6之后 偏向锁默认开启偏向锁是锁状态中最乐观的一种锁：从始至终只有一个线程请求同一把锁。</p><h5 id="举例">举例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印锁前对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before lock&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给对象上锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (one)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对象已上锁信息</span></span><br><span class="line">            System.out.println(<span class="string">&quot;locking&quot;</span>);</span><br><span class="line">            System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 锁后对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after lock&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522204943506.png" alt="image-20200522204943506"></p><p>这里结果出乎，竟然不是偏向锁。难道前面所说的理论不对吗？</p><p>其实不是，<strong>这是因为偏向有延时</strong>，那为什么要有延时？</p><p><strong>JVM</strong> 启动时会进行一系列的复杂活动，比如装载配置，系统类初始化等等。在这个过程中会使用大量<strong>synchronized</strong> 关键字对对象加锁，且这些锁大多数都不是偏向锁。为了减少初始化时间，<strong>JVM 默认延时加载偏向锁</strong>。</p><p>这个延时的时间大概为4s左右，具体时间因机器而异。可以在运行时加入参数查看 <strong>JVM</strong> 默认参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522210112667.png" alt="image-20200522210112667"></p><p>当然也可以修改 <strong>JVM</strong> 参数，来取消延时加载偏向锁。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:BiasedLockingStartupDelay=0//毫秒</span><br></pre></td></tr></table></figure><p>重新打印输出</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522210624336.png" alt="image-20200522210624336"></p><p>可以看到，偏向锁确实是偏向锁，但为什么加锁前后改变的是后面 <strong>3 bytes</strong>，还有，如果我设置了加载偏向锁的延时为 0，那么无锁状态呢？</p><p>回看之前对象头的表格，可以知道，偏向除了这个 <strong>8 bits</strong>，还有 <strong>56 bits</strong>，分别表示 <strong>JavaThreadID（54 bits）和 epoch（2 bits）</strong></p><p><img src="https://gitee.com/playwi0/MyImage/raw/master/NoteImage/image-20200522211807481.png" alt="image-20200522211807481"></p><p>也就是说，在加锁之前，虽然也是显示偏向锁的状态，但是并不是真正的上了偏向锁，这个状态叫<strong>可偏向状态（相当于无锁）</strong>，是准备上偏向锁的阶段，所以后面的 <strong>7 bytes</strong> 全部是空值。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522212539258.png" alt="image-20200522212539258"></p><p>在使用 <strong>synchronized</strong> 关键字给对象上锁时，会检查该对象是否处于一个<strong>可偏向状态</strong>，如果是可偏向状态，则通过<strong>CAS（旧的内存值：可偏向状态，预期值：可偏向状态，新值：线程ID）</strong> 将原本空值修改为 <strong>ThreadID和epoch</strong>，这时候才是真正给对象上了锁。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522213600039.png" alt="image-20200522213600039"></p><p>但是线程不会主动撤销偏向锁，偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会撤销锁。所以即使在同步代码块执行完成之后，对象还是偏向锁状态。而这样，如果下次还是该线程，那么直接会获得锁，不需要重新进入加锁过程，提高性能。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200522213848366.png" alt="image-20200522213848366"></p><p>这里偏向锁的释放和撤销是两个概念：<strong>撤销是指在获取偏向锁的过程因为不满足条件导致要将锁对象改为非偏向锁状态；释放是指退出同步块时的过程。</strong></p><h4 id="轻量级锁">轻量级锁</h4><p>轻量级锁是指<strong>当锁是偏向锁或无锁（有延时）的时候，被另外的线程所访问，偏向锁或无锁（有延时）就会升级为轻量级锁</strong>。</p><h5 id="举例-2">举例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Third;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> One one = <span class="keyword">new</span> One();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印锁前对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 给对象上锁</span></span><br><span class="line">                <span class="keyword">synchronized</span> (one)&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 对象已上锁信息</span></span><br><span class="line">                        System.out.println(<span class="string">&quot;t1---locking&quot;</span>);</span><br><span class="line">                        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 给对象上锁</span></span><br><span class="line">                <span class="keyword">synchronized</span> (one)&#123;</span><br><span class="line">                    <span class="comment">// 对象已上锁信息</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;t2---locking&quot;</span>);</span><br><span class="line">                    System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//         锁后对象信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523182342410.png" alt="image-20200523182342410"></p><p><strong>分析：</strong></p><p>在<strong>加锁前（before）</strong>，因为已关闭延时，所以在加锁前是可偏向状态。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523203356138.png" alt="image-20200523203356138"></p><p>第一次是加锁，因为 <strong>t1</strong> 在 <strong>t2</strong> 启动之前用了 <strong>join</strong>，所以不存在多线程竞争，锁偏向 <strong>t1</strong> 线程。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523203831543.png" alt="image-20200523203831543"></p><p><strong>t2</strong> 启动要给对象加锁，可是对象已经是偏向锁了，又没达到重偏向条件（批量重偏向），并且持有偏向锁的线程已经死亡，所以膨胀为轻量级锁（有人说会重偏向t2，个人感觉不正确，后面会解释）。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523204742514.png" alt="image-20200523204742514"></p><p>最后所有子线程死亡，轻量级锁会主动释放，对象变为无锁状态。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200523205053804.png" alt="image-20200523205053804"></p><h4 id="重量级锁">重量级锁</h4><p>重量级锁是<strong>当锁是无锁（有延时）、偏向锁或轻量级锁的时候，多个线程同时竞争锁，当前锁就会升级重量锁，没有获取锁的线程就会进入阻塞等待唤醒。</strong></p><h5 id="举例-3">举例</h5><h6 id="无锁到重量级锁">无锁到重量级锁</h6><p>开启轻量级锁的延时</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">package com.Playwi0.Third;</span><br><span class="line"></span><br><span class="line">import org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line">public class JOLExample &#123;</span><br><span class="line"></span><br><span class="line">    private static final One one = new One();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 打印锁前对象信息</span><br><span class="line">        System.out.println(&quot;before\n&quot; + ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">        Thread t1 = new Thread(&quot;t1&quot;) &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                // 给对象上锁</span><br><span class="line">                synchronized (one)&#123;</span><br><span class="line"></span><br><span class="line">                    // 对象已上锁信息</span><br><span class="line">                    System.out.println(&quot;t1---locking\n&quot; +   </span><br><span class="line">                    ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t2 = new Thread(&quot;t2&quot;) &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                // 给对象上锁</span><br><span class="line">                synchronized (one)&#123;</span><br><span class="line">                    // 对象已上锁信息</span><br><span class="line">                    System.out.println(&quot;t2---locking\n&quot; +   </span><br><span class="line">                    ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        </span><br><span class="line">        // 锁后对象信息</span><br><span class="line">        System.out.println(&quot;after\n&quot; + ClassLayout.parseInstance(one).toPrintable());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524144747712.png" alt="image-20200524144747712"></p><h6 id="偏向锁到重量级锁">偏向锁到重量级锁</h6><p>关闭偏向锁的延时，代码同上</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524145123180.png" alt="image-20200524145123180"></p><h6 id="轻量级锁到重量级锁">轻量级锁到重量级锁</h6><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524150120514.png" alt="image-20200524150120514"></p><p><strong>分析</strong>：</p><p>无论是哪种锁，多个线程同时竞争这把锁时，都会升级为重量锁，并且重量锁会主动释放</p><h3 id="锁的膨胀">锁的膨胀</h3><p><strong>流程图</strong></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524155445490.png" alt="image-20200524155445490"></p><h4 id="无锁态的膨胀">无锁态的膨胀</h4><h5 id="无锁到偏向锁">无锁到偏向锁</h5><p>在关闭偏向锁延时时，无锁到可偏向状态只有在对象一开始未被加锁过的情况才会有。</p><p>可偏向状态下，<strong>epoch</strong> 字段是无效的(与锁对象对应的 <strong>klass_word</strong> 的 <strong>mark_prototype</strong> 的 <strong>epoch</strong> 值不匹配)，只有单个线程来拿锁，并且无竞争，<strong>JVM</strong> 会使用原子CAS指令（具体操不知），将可偏向状态偏向到当前线程ID。</p><h5 id="无锁到轻量锁">无锁到轻量锁</h5><p>如果不关闭偏向锁延时，<strong>JVM</strong> 默认一开始对象状态是无锁的，也不会有可偏向状态。</p><p>如果对象为无锁状态（001），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（<strong>Lock Record</strong>）的空间，用于存储锁对象目前的 <strong>Mark Word</strong> 的拷贝。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524164437982.png" alt="image-20200524164437982"></p><p>然后拷贝对象头中的 <strong>Mark Word</strong> 复制到锁记录中。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524165814016.png" alt="20200524165814016.png"></p><p>拷贝成功后，<strong>JVM</strong> 将使用 <strong>CAS</strong> 操作（具体未知）尝试将对象的 <strong>Mark Word</strong> 更新为指向 <strong>Lock Record</strong> 的指针，并将 <strong>Lock Record</strong> 里的<strong>owner</strong> 指针指向对象的 <strong>Mark Word</strong>。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524171050346.png" alt="image-20200524171050346"></p><p>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象 <strong>Mark Word</strong> 的锁标志位设置为**“000”**，表示此对象处于轻量级锁定状态。</p><p>如果更新操作失败了，虚拟机首先会检查对象的 <strong>Mark Word</strong> 是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行，否则说明多个线程竞争锁。</p><h5 id="无锁到重量级锁-2">无锁到重量级锁</h5><p>首先 <strong>JVM</strong> 会创建一个 <strong>Monitor</strong> （c++实现）</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ObjectMonitor</span>() &#123;</span><br><span class="line">    _header       = <span class="literal">NULL</span>;<span class="comment">//mark_word 对象头</span></span><br><span class="line">    _count        = <span class="number">0</span>;</span><br><span class="line">    _waiters      = <span class="number">0</span>,<span class="comment">//等待线程数</span></span><br><span class="line">    _recursions   = <span class="number">0</span>;<span class="comment">//重入次数</span></span><br><span class="line">    _object       = <span class="literal">NULL</span>;<span class="comment">//监视器锁寄生的对象。锁不是平白出现的，而是寄托存储于对象中。</span></span><br><span class="line">    _owner        = <span class="literal">NULL</span>;<span class="comment">//指向获得ObjectMonitor对象的线程或基础锁</span></span><br><span class="line">    _WaitSet      = <span class="literal">NULL</span>;<span class="comment">//处于wait状态的线程，会被加入到waitSet；</span></span><br><span class="line">    _WaitSetLock  = <span class="number">0</span>;</span><br><span class="line">    _Responsible  = <span class="literal">NULL</span>;</span><br><span class="line">    _succ         = <span class="literal">NULL</span>;</span><br><span class="line">    _cxq          = <span class="literal">NULL</span>;</span><br><span class="line">    FreeNext      = <span class="literal">NULL</span>;</span><br><span class="line">    _EntryList    = <span class="literal">NULL</span>;<span class="comment">//处于等待锁block状态的线程，会被加入到entryList；</span></span><br><span class="line">    _SpinFreq     = <span class="number">0</span>;</span><br><span class="line">    _SpinClock    = <span class="number">0</span>;</span><br><span class="line">    OwnerIsThread = <span class="number">0</span>;</span><br><span class="line">    _previous_owner_tid = <span class="number">0</span>;<span class="comment">//监视器前一个拥有者线程的ID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Monitor</strong> 的 <strong>_header</strong> 字段指向锁对象的 <strong>Mark_Word</strong>，<strong>_object</strong> 指向锁对象。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524203211910.png" alt="image-20200524203211910"></p><p>用 <strong>CAS</strong> 指令把 ** <strong>Monitor</strong> 指针替换到对象头的 <strong>Mark_Word</strong></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200524203552524.png" alt="image-20200524203552524"></p><h4 id="偏向锁的膨胀">偏向锁的膨胀</h4><h5 id="偏向锁到轻量级锁">偏向锁到轻量级锁</h5><p>如果当前锁为偏向锁，当有其他线程再次需要锁该对象的时候，<strong>JVM</strong> 会等待一个全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，判断该线程的状态（<strong>JVM</strong> 维护了一个集合存放所有存活的线程，通过遍历该集合判断某个线程是否存活）。</p><p>如果该线程已经<strong>不存活</strong>或<strong>活着但不处于同步代码块中</strong>（<strong>synchronized</strong> 锁住部分代码），则撤销偏向锁，设置对象头为无锁状态，然后膨胀到轻量锁（<strong>逻辑与上面无锁一样</strong>）。</p><p>如果线程仍然<strong>活着且处于同步与块代码中</strong>，<strong>竞争升级</strong>，恢复到无锁状态，偏向锁最终变为重量级锁（这个过程是先到轻量级锁，再到重量级锁，还是直接膨胀为重量级锁，目前未找到答案，膨胀过程与上面无锁一样）。</p><h5 id="HashCode">HashCode</h5><p>如果当前锁对象已经 <strong>HashCode</strong>，则不存在<strong>可偏向或偏向锁状态</strong>。这是因为 <strong>Mark_Word</strong> 有冲突。</p><p><img src="https://gitee.com/playwi0/MyImage/raw/master/NoteImage/image-20200525102339044.png" alt="image-20200525102339044"></p><p>如果对象处于可偏向状态进行 <strong>HashCode</strong>，会变为无锁不可偏向状态，下次加锁为轻量锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before hashCode\n&quot;</span> + </span><br><span class="line">                           ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;HashCode: &quot;</span> + fourth.hashCode());</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;after hashCode\n&quot;</span> + </span><br><span class="line">                           ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">        </span><br><span class="line">         Thread t1 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;after hashCode\n&quot;</span> + </span><br><span class="line">                           ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525111914047.png" alt="image-20200525111914047"></p><p>如果对象处于偏向锁状态且处于同步代码块的执行中 <strong>HashCode</strong>，则锁会膨胀为重量级锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before t1\n&quot;</span> + </span><br><span class="line">                           ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---before\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                    </span><br><span class="line">                    System.out.println(<span class="string">&quot;HashCode: &quot;</span> + fourth.hashCode() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    </span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---after\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果<img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525111355073.png" alt="image-20200525111355073"></p><h5 id="重偏向（不存在）">重偏向（不存在）</h5><p>重偏向是指当前线程释放偏向锁，下一个线程来拿锁，偏向锁会重新偏向。但这种情况是不存在，重偏向只会在<strong>批量重偏向</strong>（下面讲）才会出现。那这个名词怎么提出来的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t2---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525113119281.png" alt="image-20200525113119281"></p><p>这一看确实还是偏向锁，重新偏向了 <strong>t2</strong> ，但再仔细一看。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525113516828.png" alt="image-20200525113516828"></p><p>**ThreadID（系统分配还是 JVM 分配未知）**一样，在这里可以做个推测。t1 死亡之后，再次分配（<strong>是JVM还是系统分配，目前不清楚</strong>）给 t2 的 ID 和 t1 的一样，因此偏向锁以为是同一个线程，继续执行，不会膨胀。</p><p><strong>举个反例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOLExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;before\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t1---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 睡眠5秒，让 t2 执行时，t1 保持不死</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;t2---locking\n&quot;</span> + </span><br><span class="line">                                       ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 睡眠一秒，让 t1 执行完同步代码块，再启动 t2</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样写主要时保证 <strong>t2</strong> 执行的时候，<strong>t1</strong> 还活着，这样他俩的线程 ID 就不会一样。</p><p>结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525114901404.png" alt="image-20200525114901404"></p><p>结果很明显，<strong>线程ID</strong>不一样，符合上面描述的锁膨胀的过程，并不存在重偏向。</p><h5 id="批量重偏向">批量重偏向</h5><p>当一个线程创建<strong>大量对象</strong>被用来作为锁对象，之后某个线程又使用这些对象作为锁对象，那么在这期间就会大量的上锁和撤销锁的操作，这样做大大降低效率，违背了优化的初衷。</p><p>为了解决这个问题，JVM 每次在撤销偏向锁的时候，以class为单位，为每个class维护一个偏向锁撤销计数器，每次撤销偏向锁，该计数器 +1，当这个值达到重偏向阈值（默认20）时，可以运行时加入一下命令查看。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525143241957.png" alt="image-20200525143241957"></p><p>JVM就认为该 <strong>class</strong> 产生对象的偏向锁有问题，因此会进行批量重偏向。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RebiasThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayList&lt;Fourth&gt; fourths = <span class="keyword">new</span> ArrayList&lt;Fourth&gt;(<span class="number">70</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">t1</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Fourth fourth : fourths) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">18</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----19\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">19</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----20\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">20</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----21\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保持线程不死</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t1.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">t2</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Fourth fourth : fourths) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">synchronized</span> (fourth) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">18</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t2 locking----19\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">19</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t2 locking----20\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fourths.get(<span class="number">20</span>) == fourth) &#123;</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;t1 locking----21\n&quot;</span> +</span><br><span class="line">                                    ClassLayout.parseInstance(fourth).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            fourths.add(<span class="keyword">new</span> Fourth());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        t1();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 让 t1 for循环执行完</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">        t2();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>结果</strong></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525150356292.png" alt="image-20200525150356292"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525150459367.png" alt="image-20200525150459367"></p><p><strong>分析：</strong></p><p>t1 线程里的第19、20、21全部是偏向锁，符合预期。</p><p>t2 线程里第19个还是轻量锁，但第20，21已经开始批量重偏向，注意 t1 的第20、21锁对象的Thread ID和 t2 是不一样，证明他们已经重偏向了。</p><p>当到达开始批量重偏向阈值时，每个偏向锁对象的 <strong>Mark_Word</strong> 中的 <strong>epoch</strong> 字段（它的初始值是创建对象时<strong>class</strong> 中的 <strong>epoch</strong> 值），</p><p><img src="./NoteImg/image-20200525142559943.png" alt="image-20200525142559943"></p><p>每次发生批量重偏向时，就将该值+1，同时遍历JVM中所有线程的栈，找到该 class 产生的对象所有正处于加锁状态的偏向锁，将其 <strong>epoch</strong> 字段改为新值。下次获得锁时，发现当前对象的 <strong>epoch</strong> 值和 class 的 <strong>epoch</strong> 不相等，那就算当前已经偏向了其他线程，也不会执行撤销操作，而是直接通过CAS操作将其 <strong>Mark_Word</strong> 的 <strong>ThreadID</strong> 改成当前线程IID。</p><h5 id="批量撤销">批量撤销</h5><p>虽然有批量重偏向，但JVM不会一直重偏向下去，和前面批量重偏向机制一样，重偏向一次计数器+1，到达撤销阈值之后，</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525153132147.png" alt="image-20200525153132147"></p><p>JVM认为存在多线程竞争，会标记该class为不可偏向，开始批量撤销，膨胀。</p><h4 id="轻量级锁的膨胀">轻量级锁的膨胀</h4><h5 id="轻量级锁到重量级锁-2">轻量级锁到重量级锁</h5><p>膨胀到重量锁一般是因为<strong>多个线程同时竞争同一把锁</strong>，锁才会膨胀到重量级锁。</p><p>轻量级锁首先会释放锁，成为无锁状态，再膨胀为重量级锁，中间过程与上面的无锁到重量级锁类似。</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525155439945.png" alt="image-20200525155439945"></p><h3 id="性能对比">性能对比</h3><p>说那么多，是骡子是马，拿出来溜一溜就知道，<strong>show your code</strong></p><p>从0开始加到一个1个亿，看看三种不同级别锁，性能如何。（这里结果取决个人电脑，测个大概就行就行）</p><h4 id="偏向锁-2">偏向锁</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Fourth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Compared</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Fourth fourth = <span class="keyword">new</span> Fourth();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000l</span>; i++) &#123;</span><br><span class="line">            fourth.add();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Time: &quot;</span> + String.format(<span class="string">&quot;%sms&quot;</span>, end - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        run();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关闭延时，结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525161754746.png" alt="image-20200525161754746"></p><h4 id="轻量级锁-2">轻量级锁</h4><p>代码同上，开启延时，结果</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200525161719004.png" alt="image-20200525161719004"></p><p>轻量锁与偏向锁性能差距可以达到 <strong>10倍</strong> 左右，说明优化还是很有必要</p><h3 id="总结">总结</h3><p><strong>synchronized</strong> 关键字可是 <strong>sun</strong> 公司的亲儿子，所做的优化不仅仅是上面说的这么简单，作者水平有限，无法处处拿出证明，只能扯扯理论，仅仅代表作者自己的观点，不足之处还请指出。</p><h3 id="参考资料">参考资料</h3><ul><li><a href="http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.html"><strong>Hotspot术语表</strong></a></li><li><a href="%5Bhttp://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/94.html%5D(http://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/94.html)">死磕Synchronized底层实现–概论</a></li><li><a href="%5Bhttps://www.java520.cn/%e5%a4%9a%e7%ba%bf%e7%a8%8b/96.html%5D(https://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/96.html)">死磕Synchronized底层实现–偏向锁</a></li><li><a href="%5Bhttps://www.java520.cn/%e5%a4%9a%e7%ba%bf%e7%a8%8b/99.html%5D(https://www.java520.cn/%E5%A4%9A%E7%BA%BF%E7%A8%8B/99.html)">死磕Synchronized底层实现–轻量级锁</a></li><li><a href="https://blog.51cto.com/14440216/2427707">死磕Synchronized底层实现–重量级锁</a></li><li><a href="https://tech.meituan.com/2018/11/15/java-lock.html">不可不说的Java“锁”事</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> thread </tag>
            
            <tag> synchronized </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Thread In Java</title>
      <link href="/2020/05/18/JavaThread/"/>
      <url>/2020/05/18/JavaThread/</url>
      
        <content type="html"><![CDATA[<h3 id="前言">前言</h3><p>知道了Linux启动一个线程是使用函数 <strong>pthread_create</strong> ,那么它和 Java 的线程有什么联系呢？</p><h3 id="Thread-In-Java">Thread In Java</h3><h4 id="创建">创建</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createThread</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;I am a Java Thread&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        createThread();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Java创建一个线程主要有两种方式：</p><ul><li>实现 <strong>Runnable</strong> 接口，实现接口中的<strong>run方法</strong></li><li>继承 <strong>Thread</strong> 类，重写类中的<strong>run方法</strong></li></ul><p>可以看看到，两种方式，无论哪一种，都需要一个<strong>run方法</strong>，并且线程执行的主要逻辑全部都规定在run</p><p>方法实现，而且都调用了<strong>start</strong>去启动线程。</p><h4 id="start0">start0</h4><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200518165048135.png" alt="image-20200518165048135"></p><p><strong>Thread</strong> 中 <strong>start</strong> 方法调用的是 <strong>native</strong> 方法 <strong>start0</strong>。<strong>start</strong> 方法上面有一串黄色注释，拿来看看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">This method is not invoked for the main method thread or &quot;system&quot; group,threads created/set up by the VM</span><br><span class="line"></span><br><span class="line">主方法线程或“系统”组不会调用此方法,线程由JVM创建/设置。</span><br></pre></td></tr></table></figure><p>通过这句话，可以得知 <strong>start0</strong> 方法在 **Jvm（Hotspot）**中。通过 <strong>Jvm</strong> 来调度创建该线程。</p><p>在 <strong>JVM</strong> 找到该方法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;start0&quot;</span>,           <span class="string">&quot;()V&quot;</span>,        (<span class="keyword">void</span> *)&amp;JVM_StartThread&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;stop0&quot;</span>,            <span class="string">&quot;(&quot;</span> OBJ <span class="string">&quot;)V&quot;</span>, (<span class="keyword">void</span> *)&amp;JVM_StopThread&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;isAlive&quot;</span>,          <span class="string">&quot;()Z&quot;</span>,        (<span class="keyword">void</span> *)&amp;JVM_IsThreadAlive&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;suspend0&quot;</span>,         <span class="string">&quot;()V&quot;</span>,        (<span class="keyword">void</span> *)&amp;JVM_SuspendThread&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;resume0&quot;</span>,          <span class="string">&quot;()V&quot;</span>,        (<span class="keyword">void</span> *)&amp;JVM_ResumeThread&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setPriority0&quot;</span>,     <span class="string">&quot;(I)V&quot;</span>,       (<span class="keyword">void</span> *)&amp;JVM_SetThreadPriority&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;yield&quot;</span>,            <span class="string">&quot;()V&quot;</span>,        (<span class="keyword">void</span> *)&amp;JVM_Yield&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sleep&quot;</span>,            <span class="string">&quot;(J)V&quot;</span>,       (<span class="keyword">void</span> *)&amp;JVM_Sleep&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;currentThread&quot;</span>,    <span class="string">&quot;()&quot;</span> THD,     (<span class="keyword">void</span> *)&amp;JVM_CurrentThread&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;countStackFrames&quot;</span>, <span class="string">&quot;()I&quot;</span>,        (<span class="keyword">void</span> *)&amp;JVM_CountStackFrames&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;interrupt0&quot;</span>,       <span class="string">&quot;()V&quot;</span>,        (<span class="keyword">void</span> *)&amp;JVM_Interrupt&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;isInterrupted&quot;</span>,    <span class="string">&quot;(Z)Z&quot;</span>,       (<span class="keyword">void</span> *)&amp;JVM_IsInterrupted&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;holdsLock&quot;</span>,        <span class="string">&quot;(&quot;</span> OBJ <span class="string">&quot;)Z&quot;</span>, (<span class="keyword">void</span> *)&amp;JVM_HoldsLock&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getThreads&quot;</span>,        <span class="string">&quot;()[&quot;</span> THD,   (<span class="keyword">void</span> *)&amp;JVM_GetAllThreads&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;dumpThreads&quot;</span>,      <span class="string">&quot;([&quot;</span> THD <span class="string">&quot;)[[&quot;</span> STE, (<span class="keyword">void</span> *)&amp;JVM_DumpThreads&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>进入 <strong>JVM_StartThread</strong> 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">JVM_ENTRY(<span class="keyword">void</span>, JVM_StartThread(JNIEnv* env, jobject jthread))</span><br><span class="line">  JVMWrapper(<span class="string">&quot;JVM_StartThread&quot;</span>);</span><br><span class="line">  JavaThread *native_thread = NULL;</span><br><span class="line">  bool throw_illegal_thread_state = <span class="keyword">false</span>;</span><br><span class="line">  &#123;</span><br><span class="line">.....</span><br><span class="line">    native_thread = <span class="keyword">new</span> JavaThread(&amp;thread_entry, sz);</span><br><span class="line">.....</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>继续 <strong>JavaThread</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">JavaThread::<span class="built_in">JavaThread</span>(ThreadFunction entry_point, <span class="keyword">size_t</span> stack_sz) :</span><br><span class="line">  <span class="built_in">Thread</span>()</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_ALL_GCS</span></span><br><span class="line">  , _satb_mark_queue(&amp;_satb_mark_queue_set),</span><br><span class="line">  _dirty_card_queue(&amp;_dirty_card_queue_set)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// INCLUDE_ALL_GCS</span></span></span><br><span class="line">&#123;</span><br><span class="line">  .....</span><br><span class="line">  os::<span class="built_in">create_thread</span>(<span class="keyword">this</span>, thr_type, stack_sz);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还有继续 <strong>create_thread</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">os::create_thread</span><span class="params">(Thread* thread, ThreadType thr_type, <span class="keyword">size_t</span> stack_size)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(thread-&gt;<span class="built_in">osthread</span>() == <span class="literal">NULL</span>, <span class="string">&quot;caller responsible&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="built_in">pthread_create</span>(&amp;tid, &amp;attr, (<span class="keyword">void</span>* (*)(<span class="keyword">void</span>*)) java_start, thread);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>终于可以看到 <strong>pthread_create</strong> 函数，创建线程，执行的是 <strong>Java_start</strong> 方法。</p><p>既然Java底层创建线程是调用 <strong>pthread_creadte</strong> 函数来创建线程，再结合 Java 线程实现特点以及 <strong>pthread_creadte</strong> 函数的参数，不难推断出，<strong>JVM 中 Java_start 方法就是 Java中 Thread 类的 run 方法</strong>。</p><h3 id="手动实现">手动实现</h3><p>了解原来后，模仿一下J <strong>JVM</strong> 的实现</p><h4 id="JNI调用">JNI调用</h4><p><strong>JNI调用</strong>，使用这技术，实现 <strong>Java</strong> 中调用 <strong>native</strong> 方法</p><p><strong>MyThread.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 装载动态链接库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;MyThreadNative&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义 native 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MyThread myThread = <span class="keyword">new</span> MyThread();</span><br><span class="line">        myThread.start0();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac MyThread.java//编译成class</span><br><span class="line">Javah MyThread//编译成头文件</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200518202320142.png" alt="image-20200518202320142"></p><p><strong>MyThread.h</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class MyThread */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_MyThread</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_MyThread</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     MyThread</span></span><br><span class="line"><span class="comment"> * Method:    start0</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_MyThread_start0</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>可以看到 <strong>Java_MyThread_start0</strong> 就是我们调用的方法。</p><p><strong>MyThread.c</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span><span class="comment">//线程头文件</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MyThread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义接受线程id的变量</span></span><br><span class="line"><span class="keyword">pthread_t</span> pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义线程主体函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_entity</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">100</span>, i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;new thread: %d\n&quot;</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * env JVM虚拟机</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_MyThread_start0</span></span></span><br><span class="line"><span class="function"> <span class="params">(JNIEnv *env, jobject c1)</span></span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用pthread_create创建一个线程</span></span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, thread_entity, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">100</span>, i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;main thread: %d\n&quot;</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>把<strong>MyThread.c</strong> 编译成动态链接库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc ‐fPIC ‐I $JAVA_HOM/include -I $JAVA_HOM/include/linux ‐shared ‐o libMyThreadNative.so MyThread.c</span><br></pre></td></tr></table></figure><p>注意名字生成的so文件命名规则为 <strong><a href="http://libxx.so">libxx.so</a></strong> xx为再 java 代码中的装库名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    System.loadLibrary(<span class="string">&quot;MyThreadNative&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200518211127095.png" alt="image-20200518211127095"></p><p>运行测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=/home/ MyThread</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200518211353264.png" alt="image-20200518211353264"></p><p>成功运行，线程交错打印</p><h4 id="JNI反向调用">JNI反向调用</h4><p>虽然实现调用 <strong>native</strong> 方法，并使用C语言调用系统函数创建线程，但是线程主体是在C语言实现的，而Java是调用的 <strong>Thread</strong> 类的 <strong>run</strong> 方法。因此，为了反调用J <strong>run</strong> 方法，本文使用 <strong>JNI反向调用</strong> 技术（Java8 中并不是使用这一技术）</p><p>在 <strong>MyThread.c</strong> 修改调用 <strong>thread_entity</strong> 方法</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span><span class="comment">//线程头文件</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MyThread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">JavaVM *jvm = <span class="literal">NULL</span>;</span><br><span class="line">jobject c2 = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义接受线程id的变量</span></span><br><span class="line"><span class="keyword">pthread_t</span> pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义线程主体函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_entity</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    JNIEnv *env; </span><br><span class="line">    jclass cls;</span><br><span class="line">    jmethodID rid;</span><br><span class="line">   jint ret = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Attach主线程  </span></span><br><span class="line">    <span class="keyword">if</span>((*jvm)-&gt;AttachCurrentThread(jvm, &amp;env, <span class="literal">NULL</span>) != JNI_OK)  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;erorr\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取java类 </span></span><br><span class="line">    cls = (*env)-&gt;GetObjectClass(env,c2);</span><br><span class="line">    <span class="keyword">if</span>(cls==<span class="literal">NULL</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;find Class error!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取java的run方法</span></span><br><span class="line">    rid =(*env)-&gt;GetMethodID(env,cls,<span class="string">&quot;run&quot;</span>,<span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(rid==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;find constructor error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//回调方法</span></span><br><span class="line">    ret = (*env)-&gt;CallIntMethod(env,job,rid,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Detach主线程  </span></span><br><span class="line">    <span class="keyword">if</span>((*jvm)-&gt;DetachCurrentThread(jvm) != JNI_OK)  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;erorr\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//退出线程</span></span><br><span class="line">    pthread_exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * env JVM虚拟机</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_MyThread_start0</span></span></span><br><span class="line"><span class="function"> <span class="params">(JNIEnv *env, jobject c1)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过JavaVM来得到当前线程的JNIEnv指针. </span></span><br><span class="line">    (*env)-&gt;GetJavaVM(env,&amp;jvm);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将c1保持到全局变量中</span></span><br><span class="line">    c2 = (*env)-&gt;NewGlobalRef(env,c1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用pthread_create创建一个线程</span></span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, thread_entity, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc ‐fPIC ‐I $JAVA_HOM/include -I $JAVA_HOM/include/linux ‐shared ‐o libMyThreadNative.so MyThread.c</span><br></pre></td></tr></table></figure><p>执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=/home/ MyThread</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200519154032500.png" alt="image-20200519154032500"></p><p>可以看到主线程和子线程交替执行。</p><h3 id="总结">总结</h3><p>牛逼！！！自己动手实现Java多线程，可以简单了解 <strong>JVM</strong> 是是如何调度系统函数创建和运行一个线程。虽然<strong>JVM</strong> 可能并不是这样做的。</p><p>这里 <strong>MyThread.c</strong> 在调用 <strong>MyThead</strong> 类的 <strong>run</strong> 方法再去执行是否觉得有点像Java中的反射，这是不是 <strong>Java反射</strong> 在<strong>JVM</strong>上的实现机制呢？（我也不知道）</p><h3 id="参考文章">参考文章</h3><ul><li><a href="https://juejin.im/entry/593fce1c128fe1006a01f15e">从 Java 到 C++, 以 JVM 的角度看 Java 线程的创建与运行</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> thread </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pthread_create</title>
      <link href="/2020/05/17/pthread-create/"/>
      <url>/2020/05/17/pthread-create/</url>
      
        <content type="html"><![CDATA[<h3 id="简介">简介</h3><p><strong>pthread_create</strong>是<strong>UNIX</strong>操作系统创建<strong>线程</strong>的函数，</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200517164448219.png" alt="image-20200517164448219"></p><p>主要用来在系统种启动一个线程（实际上就是确定调用该线程函数的入口点）</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200517164654712.png" alt="image-20200517164654712"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">pthread_t</span> *thread, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span> *(*start_routine) (<span class="keyword">void</span> *), </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span> *arg</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>使用时需要在导入头文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br></pre></td></tr></table></figure><p>第一个参数 *<em>pthread_t <em>thread</em></em>：把成功创建线程的 <strong>id</strong> 赋给传入变量，通过这个传入的变量，可以拿到该线程的id</p><p>第二个参数 *<em>const pthread_attr_t <em>attr</em></em>：线程属性，初学可传入NULL，使用默认属性。</p><p>第三个参数 <strong>void *(*start_routine) (void *)</strong>：线程的启动后的主体函数，需要自己定义一个函数，然后传函数名即可。</p><p>第四个参数 *<em>void <em>arg</em></em> ：主体函数的参数 ，没有可直接传NULL</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200517164641971.png" alt="image-20200517164641971"></p><p>成功创建线程，则返回 0，若失败，则返回出错编号</p><h3 id="实例">实例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//引入头文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义接受线程id的变量</span></span><br><span class="line"><span class="keyword">pthread_t</span> pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义线程主体函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_entity</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;new thread: %d\n&quot;</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//调用pthread_create创建一个线程</span></span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, thread_entity, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;main thread: %d\n&quot;</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc thread.c -o thread -lpthread</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200517173757175.png" alt="image-20200517173757175"></p><p>运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./thread</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200517173838321.png" alt="image-20200517173838321"></p><p>可以看到主线程和新建线程交替打印。需要注意的是，在linux下主线程结束，如果不设置主线程阻塞，等待其他线程，则主线程启动的其他线程也会结束（<strong>其实是主线程return后，调用glibc库函数exit，exit做完清理工作之后调用_exit系统调用退出改进程，进程结束，会结束该进程的所有线程</strong>）</p><h3 id="总结">总结</h3><p>知道这个有什么用呢？</p><p>其实java 启动一个线程底层用的就是这个函数，java的线程和系统线程其实1：1，深入学习java线程离不开与系统层面线程结合。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> thread </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Set集合</title>
      <link href="/2020/04/11/Set%E9%9B%86%E5%90%88/"/>
      <url>/2020/04/11/Set%E9%9B%86%E5%90%88/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p>set集合具有可变性，无序性，不重复性，可迭代。底层基于Map集合实现。</p><h1>HashSet</h1><p>HashSet底层是HashMap，直接使用HashMap来实现。</p><h2 id="构造方法">构造方法</h2><h3 id="HashSet">HashSet()</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(125).png" alt="e5c74fa8d984e7b334450e93be229ef7.png"></p><h3 id="HashSet-int-initialCapacity">HashSet(int initialCapacity)</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(126).png" alt="24dbab11adf65979869014685046c39d.png"></p><h3 id="HashSet-int-initialCapacity-float-loadFactor">HashSet(int initialCapacity, float loadFactor)</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(127).png" alt="416a6ea9d7c03268dd02b89017c2e3d7.png"></p><h3 id="HashSet-Collection-extends-E-c">HashSet(Collection&lt;? extends E&gt; c)</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(128).png" alt="79a075fec92cd8b6b129b151efa81cda.png"></p><h3 id="HashSet-int-initialCapacity-float-loadFactor-boolean-dummy">HashSet(int initialCapacity, float loadFactor, boolean dummy)</h3><p>这个构造方法是专门为LinkedHashSet准备的。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(129).png" alt="8cf547b77abda32dabee8ea2f0a24d54.png"></p><h2 id="add-E-e">add(E e)</h2><p>直接调用HashMap的put方法，值做为key，value是一个空对象<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(130).png" alt="3a14ca82d9268479340b715d7ac02b3c.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(131).png" alt="7bf11f482838b63b942139d50a2a2815.png"></p><h2 id="其他">其他</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(132).png" alt="edc1c642e11f8903f0f57f3f369593f4.png"><br>没什么值得讲，方法很简单。</p><h1>TreeSet</h1><p>TreeSet底层用的是TreeMap。</p><h2 id="TreeSet-NavigableMap-E-Object-m">TreeSet(NavigableMap&lt;E,Object&gt; m)</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(133).png" alt="94b013f4196f0e09b22a90bb0f3d1b9d.png"></p><h2 id="TreeSet">TreeSet()</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(134).png" alt="39de7fe192fb5cc6fde6e69bf6e733ca.png"></p><h2 id="TreeSet-Comparator-super-E-comparator">TreeSet(Comparator&lt;? super E&gt; comparator)</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(135).png" alt="18e0bc0c2ea93d65ffd33c7234a0f0db.png"></p><h2 id="TreeSet-Collection-extends-E-c">TreeSet(Collection&lt;? extends E&gt; c)</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(136).png" alt="f5092f2bd2111ad675e7235b26d089a5.png"></p><h2 id="TreeSet-SortedSet-E-s">TreeSet(SortedSet<E> s)</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(137).png" alt="8abb387998298babdcfca38a23a361ca.png"></p><h2 id="add-E-e-2">add(E e)</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(138).png" alt="988d12a22f5477f1f81bc7ae02a36f42.png"></p><h2 id="其他-2">其他</h2><p>这里方法大多数是涛层壳。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(139).png" alt="d8d7d144ef3d2c40a59bcb1a12b74ca7.png"></p><h1>LinkedHashSet</h1><p>LinkedHashSet类似于LinkedHashMap，它继承HashSet，在HashSet上使用LinkedHashMap。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(140).png" alt="5b9938083754928a34aee50033781c86.png"></p><h2 id="构造方法-2">构造方法</h2><p>使用的是HashSet专门为其留的构造方法。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(141).png" alt="53f425cf37df212efa44f7512d6243e2.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(142).png" alt="84fd0ee55beef74e594d15ae76909083.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(143).png" alt="b26f34187d239f6b39a407695f6cb7ae.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(144).png" alt="9f817a6d01f6180e3cb97ad05ee44f1b.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(145).png" alt="5ceb11c38f24528bc6764329a9b413b5.png"><br>为什么在HashSet上使用LinkedHashMap，而不是LinkedHashSet直接继承？<br>我猜是因为设计的统一性吧，LinkedHashMap继承HashMap。LinkedHashSet则不能直接跳过HashSet吧。但是HashSet使用的是HashMap。所以。。。。。<br>不看源码我还真不知道。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> set集合 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ConcurrentHashMap</title>
      <link href="/2020/04/10/ConcurrentHashMap/"/>
      <url>/2020/04/10/ConcurrentHashMap/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p>ConcurrentHashMap底层和HashMap一样，散列表+红黑树。不过它与HashMap最大的区别就是使用CAS算法保证了线程的安全，可以在高并发的情况使用。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(110).png" alt="829bf766a2c56d96482a6fe4de2a7356.png"><br>虽然它和HashMap一样，但它并没有继承HashMap。重新在整个算法中加入CAS算法，保证线程安全<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(111).png" alt="64b5435c2e6abdae94dcd51b1b204f45.png"><br>Node也和HashMap没区别</p><h1>CAS算法</h1><p>CAS：<strong>Compare and Swap</strong>，比较替换，即先比较，再替换。<br>该算法有三个值，<strong>内存值V，旧的预期值A，要修改的值B</strong>。<br>只有当旧的预期值A和内存值相等时，才将内存值修改成B，否则什么都不做。</p><h1>构造方法</h1><h2 id="ConcurrentHashMap">ConcurrentHashMap()</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(112).png" alt="8cfc52fd07ddd03870cae06a0b5a7d75.png"></p><h2 id="ConcurrentHashMap-int-initialCapacity">ConcurrentHashMap(int initialCapacity)</h2><p>指定初始容量<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(113).png" alt="40fadb510dad18a54855ac39ec97045e.png"><br>在进入tableSizeFor（和HashMap的一样），按<strong>1.5x+1</strong>扩大一次，可能是因为高并发下，需要更大的容量。<br>这里的<strong>sizeCtl</strong>就是旧的预期值。</p><h2 id="ConcurrentHashMap-int-initialCapacity-float-loadFactor">ConcurrentHashMap(int initialCapacity, float loadFactor)</h2><p>指定容量。负载因子<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(114).png" alt="b8f11810154287e8e09dfaed056c5607.png"></p><h2 id="ConcurrentHashMap-int-initialCapacity-float-loadFactor-int-concurrencyLevel">ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel)</h2><p>指定容量。负载因子，估计并发线程数<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(115).png" alt="e19120baab049b4a10396d9755acd1df.png"><br>为了缓解高并发带来的压力，做了一些小优化。</p><h2 id="ConcurrentHashMap-Map-extends-K-extends-V-m">ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m)</h2><p>其他Map转为ConcurrentHashMap<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(116).png" alt="e2b5f7f344aa63ce50772c7a70b87450.png"></p><p>可以看到，除无参构造方法，旧的预期值都是容量大小。</p><h1>put(K key, V value)</h1><p>提交元素，进入putVal<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(117).png" alt="78f1fa83cfb5d50570b579e34f9b1943.png"></p><h1>putVal(K key, V value, boolean onlyIfAbsent)</h1><p>提交保存元素逻辑。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(118).png" alt="5fbc52db3f8e28b96b9e97d127c10c03.png"><br>可以见到ConcurrentHashMap不允许key和value为null。<br>进入spread方法计算key的hash值<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(119).png" alt="a1bc7e3843f8b7e8c500ca78bbadea60.png"><br>进入initTable方法初始化表。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(120).png" alt="339ea21df671073031f7a07d0da1026a.png"><br>新建节点时还是使用CAS算法，保证创建的数据的安全。<br>后面各种情况添加数据使用synchronized上锁<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(121).png" alt="d92cf6a32d0cca682255d12caed2f7d7.png"></p><h1>spread</h1><p>返回key的hash值<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(122).png" alt="955b74b3dfe43dbd0a148c1c532374d3.png"></p><h1>initTable</h1><p>初始化表。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(123).png" alt="8d994873ef0227c9bd7f3d00e03ead05.png"><br>这里主要看它如何保证合适化一次。<br>第一步判断防止被修改错乱数据，线程停止。<br>第二步判断，使用CAS算法。SIZECTL是sizeCtl的内存地址，在静态代码块已经初始好<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(124).png" alt="eea5a5574a9c4026c82775e950d062e4.png"><br>第一次是相等的，进入新建表。<br>进入之后再次确认当前表示空的，防止后面线程进入在此创建。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> concurrentHashMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinkedHashMap</title>
      <link href="/2020/04/09/LinkedHashMap/"/>
      <url>/2020/04/09/LinkedHashMap/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p>LinkedHashMap，HashMap前面加了个Linked，说明这个Map是有链表结构的。<br>结构示意图（盗的图）<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729162213825.png" alt="image-20200729162213825"><br>该Map在HashMap结构基础上增加了双向链表，以此保证元素的有序。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729162222137.png" alt="image-20200729162222137"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729162228880.png" alt="image-20200729162228880"><br>继承了HashMap的Node，增加了前后指针，改名为Entry。</p><h1>构造函数</h1><h2 id="LinkedHashMap">LinkedHashMap()</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(99).png" alt="885af45c9dbcc76347c4226134b1ec5a.png"><br>调用HashMap的构造方法，多了一个accessOrder参数，指定元素遍历排序，false为插入顺序，也是默认顺序，true为访问顺序。</p><h2 id="LinkedHashMap-int-initialCapacity">LinkedHashMap(int initialCapacity)</h2><p>指定容量<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(100).png" alt="707374dc0381e65334b11f20ee2c5158.png"></p><h2 id="LinkedHashMap-int-initialCapacity-float-loadFactor">LinkedHashMap(int initialCapacity, float loadFactor)</h2><p>指定容量和负载因子<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(101).png" alt="8376179d6e840c48bd0d2accc3e65fb2.png"></p><h2 id="LinkedHashMap-int-initialCapacity-float-loadFactor-boolean-accessOrder">LinkedHashMap(int initialCapacity, float loadFactor, boolean accessOrder)</h2><p>指定容量，负载因子和遍历顺序。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(102).png" alt="84cba7121ca9eb742ea125fb0bb5104e.png"></p><h2 id="LinkedHashMap-Map-extends-K-extends-V-m">LinkedHashMap(Map&lt;? extends K, ? extends V&gt; m)</h2><p>其他Map转为LinkedHashMap<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(103).png" alt="40ed5081ef8d68931e69f2aff6a74a9a.png"></p><h1>put</h1><p>看了半天并没有发现put方法踪影<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(104).png" alt="fd88a6450f500f89dc76c32c04fc80fc.png"><br>细想，继承HashMap，用的应该是HashMap的put方法吧，但是这样不和HaspMap结构一样，多出双向链表怎么实现？？？<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(105).png" alt="9276d0a39f2a954c6199008d69f7cfb1.png"><br>设计精妙就在这里，在调用HashMap的newNode方法创建节点时，LinkedHashMap重写了该方法。</p><h1>newNode</h1><p>重写了HashMap的newNode方法，改为建立一个Entry，并调用linkNodeLast方法，连接各个节点<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(106).png" alt="a8d9256f4b0e5bf205a54d9f100692c3.png"></p><h1>linkNodeLast</h1><p>连接新建的节点<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(107).png" alt="616c03057efe24e39c1c49d7e9eceb26.png"><br>新增加节点时，当前链表的尾部变成了该节点。<br>如果尾部都为空，那么说明该链表为空。新建的节点即为头部也为尾部。<br>如果不为空，那么新建节点的前驱节点为当前链表的尾结点，当前链表的尾结点的后驱节点为新建节点。</p><h1>get</h1><p>get重写了HashMap的get方法，多增加一个afterNodeAccess排序方法。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(108).png" alt="74ca88c0e95eecd5e5773ca6290393db.png"></p><h2 id="accessOrder-false">accessOrder=false</h2><p>遍历时链表默认插入顺序，即谁先put，谁排前。</p><h2 id="accessOrder-true">accessOrder=true</h2><p>重新排序链表，调用afterNodeAccess方法。</p><h1>afterNodeAccess</h1><p>访问顺序排序<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(109).png" alt="b911aa5d514e2280391cbce033886385.png"><br>当访问这个元素时（get），这个元素就会被放到链表的尾部，这样当前访问的元素永远比上一个元素顺序靠后，而未被访问过元素还是按插入顺序排序。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linkedHashMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TreeMap</title>
      <link href="/2020/04/09/TreeMap/"/>
      <url>/2020/04/09/TreeMap/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p>TreeMap在所有Map中出现的比较少，基本很少使用，但存在即合理。<br>TreeMap底层结构是红黑树，元素都是自动排序，但线程不安全。<br>节点属性<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(83).png" alt="994cd32d4f12fa161854358461f1e9f5.png"><br>key和value<br>左右孩子节点，父节点，颜色。</p><h1>构造方法</h1><h2 id="TreeMap">TreeMap()</h2><p>无惨构造方法。默认比较器为空，也就是采用自然数比较法则。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(84).png" alt="65b615cc477b9395f86e0ec57d839e94.png"></p><h2 id="TreeMap-Comparator-super-K-comparator">TreeMap(Comparator&lt;? super K&gt; comparator)</h2><p>指定比较器构造方法，自定义比较法则。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(85).png" alt="db6e7d3f21c8ecb29c41512a7e7c4411.png"></p><h2 id="TreeMap-Map-extends-K-extends-V-m">TreeMap(Map&lt;? extends K, ? extends V&gt; m)</h2><p>其他类型Map强转为TreeMap，默认为自然比较法则。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(86).png" alt="fe71acb29fe0f6e31e914f17b363b57e.png"></p><h2 id="TreeMap-SortedMap-K-extends-V-m">TreeMap(SortedMap&lt;K, ? extends V&gt; m)</h2><p>不太清楚<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(87).png" alt="110a5f693f4029d6bc9a886b9dd9d225.png"></p><h1>put(K key, V value)</h1><p>往TreeMap中提交数据<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(88).png" alt="638a66ba88be8d193ce8011c39e7b302.png"></p><h2 id="首次提交">首次提交</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(89).png" alt="c20bae924a796339e791637970928928.png"><br>首次提交，那么root是空的<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(90).png" alt="a42271eb41d5d3566856d5f57d9a7b67.png"><br>进入key的比较，默认规则（key不能为null，除非自定义比较器）。<br>新建节点，传入key，value，根节点没有父节点。</p><h2 id="非首次">非首次</h2><p><img src="data:image/png;base64,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XZJTu/ZiK76U1A2MA5tEG+uyC60Zr3fU8Ym6A/hazD20PP2jo+pvbT1dhV9r29/e+SLdf+1df0eXL/qrPbUj3H6iHd2uRKyPQjARR72b9HnHy48j7a45yC/Jxiplr8DYN1x55Jx/P8Ia7bFzIaoR8xdXPXEPzE+DDmHcwcnR9EM0LaOkGKkRQu9dub+xwquF4sQTIkLtPafXFWJvNf16Bx1o8/ZG+Le5+baD6m1zNV2EX5v7EcMCorr/YlhvZxcl+p2VhZBzKju7fYlWP+cIJtqIs78kQAIkQAIkQAIk4CfAOYK8FUiABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUAIVggg48u00CJEACJEACJEACFIK8B0iABEiABEiABEggQQlQCCbowLPbJEACJEACJEACJEAhyHuABEiABEiABEiABBKUwEknfa9Hq7velrytrjSKjF29fVF0haadTKCmd/9ObkFsqi84+kVsCmIpJEACJEACcUGAHsG4GEZ2ggRIgARIgARIgASiJ3BS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" alt="image.png"><br>如果有自定义比较器，在这里先调用自定义比较器进行进行比较排序。<br>按比较规则遍历树，直到子节点为空可添加（其实这里算法可以按照二叉查找树算法添加就可以），如果key相当就覆盖原来的值<br>没有自定义比较器，就是用默认的，规则同上<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729161600333.png" alt="image-20200729161600333"><br>最后往该位置插入新的节点<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729161608625.png" alt="image-20200729161608625"><br>进入fixAfterInsertion方法，检测并矫正符合红黑树规则</p><h1>fixAfterInsertion(Entry&lt;K,V&gt; x)</h1><p>这个方法修复红黑树，修复红黑树规则算法都这里面。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(93).png" alt="427f438e57cc8a5eff8ac596d84ddefe.png"><br>如果父节点为红色，且父节点为左孩子，叔叔节点为红色，就变颜色。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(94).png" alt="47d2a987bfba2905fee137eaf9f8ea37.png"><br>如果父节点为红色，且父节点为左孩子，叔叔节点为黑色，自己为右节点，就和父节点左旋。变换后，该节点变为以前父节点的父节点，以前父节点变为该节点左孩子。以前父节点变成该节点（参考点）。该节点的父节点和祖父节点变换颜色，父节点和祖父节点有旋。如果该节点为左节点，就就是左旋之后的情况。直接变颜色右旋。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(95).png" alt="c145056f38cca41214d1792640147c87.png"><br>下面情况是一样的<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(96).png" alt="c00cfb6b4789d7eb297bede62ac357f6.png"><br>最后一步，根节点一定是黑色<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(97).png" alt="6bab90f78b72355c02f0f73225d38cd6.png"></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> treeMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>红黑树</title>
      <link href="/2020/04/08/%E7%BA%A2%E9%BB%91%E6%A0%91/"/>
      <url>/2020/04/08/%E7%BA%A2%E9%BB%91%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h1>转换规则</h1><h2 id="1、转换颜色">1、转换颜色</h2><p>当前节点为红色（无论左右），父节点为红色，且叔叔节点（父节点的兄弟节点）为红色。<br>则父节点和叔叔节点转为黑色，祖父节点（父节点的父节点）转为红色。</p><h2 id="2、左旋">2、左旋</h2><p>当前节点为红色，且为右节点，父节点为红色，叔叔节点为黑色。<br>则当前节点和父节点左旋。</p><h2 id="3、右旋">3、右旋</h2><p>当前节点为红色，且为左节点，父节点为红色，叔叔节点为黑色。<br>则父节点和祖父节点交换颜色，并两点右旋。</p><h1>栗子</h1><p>默认红黑树<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(48).png" alt="b85656665528cb2aeed5bdbf74eb8214.png"><br>插入个6<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(49).png" alt="c0c55c378177f6350190ceacce7d5d6a.png"><br>满足情况1<br>动态<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/%E5%8F%98%E8%89%B2.gif" alt="94f3e930beaec71b1042a786d5452140.gif"><br>变色后<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(51).png" alt="b8b4fa115746fd58b4735ec62a33477a.png"><br>满足情况2<br>左旋动态</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/%E5%B7%A6%E6%97%8B.gif" alt="image-20200729154542839"></p><p>左旋之后<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(50).png" alt="3778b31f4435960bba640038aaf41d20.png"><br>满足情况3<br>右旋动态<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/%E5%8F%B3%E6%97%8B.gif" alt="image-20200729154542839"><br>完成，满足红黑树结构<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(52).png" alt="4450d5e884bc68fba4e8056c82ea02f3.png"></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 红黑树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HashMap</title>
      <link href="/2020/04/07/HashMap/"/>
      <url>/2020/04/07/HashMap/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p>HashMap在1.8之前是由数组+链表组成的散列表，在1.8之后（包括1.8）变成了数组+链表+红黑树。</p><h1>构造方法</h1><h2 id="HashMap">HashMap()</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(53).png" alt="d3df39eb629f7526d5a7691a82447a53.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(54).png" alt="7976e400905450530140c6fbf20aeb26.png"></p><p>无参构造方法指定负载因子，默认为0.75（最好不要修改），那么它的边界值是0.75X。</p><h2 id="HashMap-int-initialCapacity">HashMap(int initialCapacity)</h2><p>指定初始容量，会跳到另一个构造方法<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(55).png" alt="8185e8128fd84430746f39fef57ec502.png"></p><h2 id="HashMap-int-initialCapacity-float-loadFactor">HashMap(int initialCapacity, float loadFactor)</h2><p>这个构造方法不仅可以指定初始容量，还可以指定负载因子<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(56).png" alt="70627d4a22d0b591a3537107028b06ba.png"><br>指定容量不能小于0，不能超过最大值<strong>2^30</strong><br>负载因子不能小于等于0，不能不是数字。<br><strong>其实我们指定HashMap的初始容量并不是真正的初始容量，它默认的初始容量必须为2的n次幂，如果不是2的n次幂，它自动转换为比你指定的容量大的最小2的n次幂，这个转换方法就是tableSizeFor。</strong></p><h2 id="HashMap-Map-extends-K-extends-V-m">HashMap(Map&lt;? extends K, ? extends V&gt; m)</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(57).png" alt="08a6378b0c7690df9d0f3526823e1e74.png"><br>这个构造方法主要是将其他map转换为HashMap。</p><h1>tableSizeFor</h1><p>这个方法主要是返回比用户指定容量大或相等的最小2的n次幂。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(58).png" alt="f7c528e794029de3e04505b47f347301.png"><br>先给指定容量减1，这么做是<strong>防止用户给的就是2的n次幂。</strong><br>假设用户给8那么它计算出来就是16，用户给9那么计算就是16.<br>接下来就是计算过程，在这举个栗子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cap = 9</span><br><span class="line">n = 8</span><br><span class="line">n |= n &gt;&gt;&gt; 1</span><br><span class="line">先右移1位</span><br><span class="line">00000000 00000000 00000000 00000100 &gt;&gt;&gt; 1 = 00000000 00000000 00000000 00000010</span><br><span class="line">再或运算（有1为1）</span><br><span class="line">00000000 00000000 00000000 00000010</span><br><span class="line">00000000 00000000 00000000 00000100</span><br><span class="line">——————————————————</span><br><span class="line">00000000 00000000 00000000 00000110</span><br><span class="line"></span><br><span class="line">n |= n &gt;&gt;&gt; 2</span><br><span class="line">再右移2位</span><br><span class="line">00000000 00000000 00000000 00000110 &gt;&gt;&gt; 2 = 00000000 00000000 00000000 00000001</span><br><span class="line">再或运算</span><br><span class="line">00000000 00000000 00000000 00000110</span><br><span class="line">00000000 00000000 00000000 00000001</span><br><span class="line">——————————————————</span><br><span class="line">00000000 00000000 00000000 00000111</span><br><span class="line"></span><br><span class="line">n |= n &gt;&gt;&gt; 4;</span><br><span class="line">再右移4位</span><br><span class="line">00000000 00000000 00000000 00000111 &gt;&gt;&gt; 4 = 00000000 00000000 00000000 00000000</span><br><span class="line">再或运算</span><br><span class="line">00000000 00000000 00000000 00000111</span><br><span class="line">00000000 00000000 00000000 00000000</span><br><span class="line">——————————————————</span><br><span class="line">00000000 00000000 00000000 00000111</span><br><span class="line"></span><br><span class="line">n |= n &gt;&gt;&gt; 8;</span><br><span class="line">再右移8位</span><br><span class="line">00000000 00000000 00000000 00000111 &gt;&gt;&gt; 8 = 00000000 00000000 00000000 00000000</span><br><span class="line">再或运算</span><br><span class="line">00000000 00000000 00000000 00000111</span><br><span class="line">00000000 00000000 00000000 00000000</span><br><span class="line">——————————————————</span><br><span class="line">00000000 00000000 00000000 00000111</span><br><span class="line"></span><br><span class="line">n |= n &gt;&gt;&gt; 16;</span><br><span class="line">再右移16位</span><br><span class="line">00000000 00000000 00000000 00000111 &gt;&gt;&gt; 8 = 00000000 00000000 00000000 00000000</span><br><span class="line">再或运算</span><br><span class="line">00000000 00000000 00000000 00000111</span><br><span class="line">00000000 00000000 00000000 00000000</span><br><span class="line">——————————————————</span><br><span class="line">00000000 00000000 00000000 00000111</span><br><span class="line"></span><br><span class="line">最后</span><br><span class="line">n = 15</span><br></pre></td></tr></table></figure><p>其实规律不难发现，<strong>这样算的目的就是把1所在最高位后面数全部变为1</strong><br>给定9，减1为8，二进制<br>00000000 00000000 00000000 00000100<br>1后面全为1<br>00000000 00000000 00000000 00000111<br>即15<br>最后，判断得到的n是否越界<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(59).png" alt="2bcd490351779ae1ffcf27ab4709071e.png"><br>再 <strong>n + 1</strong><br>得到16，2的n次幂<br><strong>那么问题来了，为什么右移最大为16位？</strong><br>因为规定最大容量为<strong>2^30</strong>，二进制为<br>00100000 00000000 00000000 00000000<br>最高位第30位<br>根本不需要到32位</p><h1>put</h1><p>往Map提交数据（键值），这个方法只是层皮，真正是<strong>putVal</strong><br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(60).png" alt="1158d89464580132999da216b042f086.png"></p><h1>putVal</h1><p>真正提交数据保存的方法。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(61).png" alt="7b178471c5c16d1c49262757b0820b0a.png"><br>第一个值<strong>hash</strong>，是通过<strong>hash方法</strong>得到。<br>新建了四个变量，两个Node型tab，p，和两个int型n，i</p><h2 id="第一次put">第一次put</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(62).png" alt="06ce30ad4a0a3cc0f82232a200ee1581.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(63).png" alt="a9b515f3acc455bcbf3af0d9da91e5cd.png"><br>如果原来的的表是空的（table空或者长度为0）<br>进入<strong>resize方法新建表</strong>，再获得新建的长度。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(64).png" alt="e9c7eea544409c1a73b9a83f9997b683.png"><br>这里与运算，得到索引，第一次添加这里肯定为空，直接新建节点，保存hash值，key，value。赋值到这个索引，如果不为空则会接一个链表。</p><h2 id="非第一次put">非第一次put</h2><p>根据前面，非第一次计算出索引，判断这个位置是否存在元素。</p><h3 id="无元素">无元素</h3><p>没有被占用直接添加进去</p><h3 id="已被占用">已被占用</h3><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(65).png" alt="32dda4a1d85606bd59089f20a768b544.png"></p><h4 id="重复">重复</h4><p>如果是已被占用先判断是否和该位元素的hash和key一样，，重复就覆盖原来的Value，并返回原来的Value。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(66).png" alt="36314a60402c5bba4b7b094513d18a64.png"></p><h4 id="非重复">非重复</h4><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(67).png" alt="cdff8dc686faa9964a920d5fe0edcb4b.png"><br>先判断该占用节点下一个是否为空，为空直接添加，不为空继续判断是否重复。<br>这里关注一点，单链表长度大于等于8就要考虑是否要转为红黑树（还有一条件，表长要达到64）<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(68).png" alt="7b09b6c4bc6d143baf0e3aab3a65d6e5.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(69).png" alt="62e54936a84dbf2c1294410b9bae12c8.png"></p><h1>hash</h1><p>返回key的hash值，还不是真正的索引<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(70).png" alt="5e354b2b3db9f5dda0205e9ebc2d5334.png"><br><strong>这里key如果为null，那么hash就等于0，也就key为什么可以穿null的原因。</strong><br>先调用hahCode方法（native方法）获得一个值，，再将得到值向右移16位，前后异或。<br>返回到putVal方法中，进行与运算，得到真正的索引<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(71).png" alt="fac62240b5bcfc26cf43e3bfdfe0b962.png"><br><strong>其实经过（右移）&gt;&gt;&gt; ，再异或（^）,再与（&amp;），最后相当于key对n（Map长度）取余，之所以经过那么多运算，是因为这些运算在系统底层更快，直接取余很慢，效率问题。</strong></p><h1>resize</h1><p>这个重置表或者新建表<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(72).png" alt="24f535661a5ba7d82fe81c520e735e3e.png"><br>获取当前散列表，如果为空那么当前容量为0。<br>获取当前表的边界值，初始为0。<br>新的容量和新的边界值为0</p><h2 id="第一次创建">第一次创建</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(73).png" alt="7f0762c7d0b95d6dbbf9c74bfcfe96ee.png"><br>第一次创建，上半部分都没有进入<br>下半部分：<br>获得初始容量2^4,也就是16<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(74).png" alt="383d27ce7ce95383c8f08571ef7dc6dc.png"><br>边界值等于容量与负载因子的积，向下取整。<br>其实上面这部分代码就是为了解决容量和边界值的。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(75).png" alt="a8527b2bba24c58f72d32a2a0d515b93.png"><br>真正的创建表开始了。<br>先新建一个长度为初始容量16的Node数组<br>直接把新建的表赋值给table<br>第一次新建老表肯定为空，那么if不会走了，直接返回<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(76).png" alt="667a0dfe9bcd828258bf51bd042b8b1d.png"></p><h2 id="扩容">扩容</h2><p>非第一次进来，那么就是扩容了。<br>扩容有一难点，就是要rehash，重新计算索引，很麻烦，但jdk巧妙解决这一难点。<br>假设初始容量为16，有key的值为12，hash值12%16=12，那么原理就在12这个位置。扩容为32（比原来容量大的最小2的n次幂），rehash值为12%32=12，与原理没有变化。另有一key的值为25，hash值为25%16=9，rehash为25%32=25=9+16。差了扩容量（32-16=16）。<br>也就是说，如果key值比原来的容量小，那么rehash值还是原来的值，比原来的容量大，rehash就是原来hash值与增加容量的和。<br>具体看源码<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(77).png" alt="6b33d551759219a6f2762436c60c907f.png"><br>遍历数组。<br>取出当前位置节点判断是否为空，不为空就清空原来数组位置（清空给JVM自动回收），如果改位置只有一个数据就直接rehash添加到索引位置。<br>如果是链表<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(78).png" alt="2f0cd447efc367b38e75d7f88dadcc83.png"><br>do-while遍历，根据他的算法，这一步与运算得到的值大于0（索引值为 hash&amp;（oldCap-1）），说明key值比原来容量大，分到另一个表。遍历完后，在添加到新的索引位置。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(79).png" alt="463dc64822e80f39fdca7432cb5990f1.png"></p><h1>总结</h1><ul><li><p>hashMap什么时候扩容<br>HashMap中的数据元素超过临界值，不是数组中被使用的下标，就会扩容。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(80).png" alt="6b96c17dd9d7a0f8f935ce714929972e.png"><br>当链表的个数超过8个（hash碰撞超过8），并且数组长度小于64，就会扩容。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(81).png" alt="348cfd65576fad7fb2ba2c516a57e59a.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(82).png" alt="df5bf737a931b41566776fb0923eb8d6.png"></p></li><li><p>为什么是链表的临界值是8个<br>JDK是根据泊松分布来设计的。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hashMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vector</title>
      <link href="/2020/04/06/Vector/"/>
      <url>/2020/04/06/Vector/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p>Vector底层也是用数组实现的，那这样不是和linkedList一样了吗。确实，但是他两有一个本质区别，那就是Vector保证在多线程下读取数据，数据是安全的，也就是线程安全。</p><h1>如何保证线程安全</h1><p>Vector算法其实和LinkedList差不多，因为底层都是对象数组。能保证线程安全存在以下几点：</p><ul><li><p>绝多少<strong>public</strong>方法都加了<strong>synchronized</strong>，除了个别套层皮<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(41).png" alt="b0f60e0b43f387a068d6e107098714f1.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(42).png" alt="14fd44348bc4018fffb6c320ad18a316.png"></p></li></ul><h1>区别LinkedList</h1><p>虽然算法绝大部分一样，但Vector还是做了些修改</p><h2 id="构造函数">构造函数</h2><p>构造函数直接指定初始容量，还能指定扩容的容量<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(43).png" alt="1f12f65f47cfac415a6e2ce9a61bf069.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(44).png" alt="a377732321762e4859cccb86e21bac12.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(45).png" alt="ecdcbdfec87ede2542da06d992dd72b6.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(46).png" alt="8b8e7a690798970e4de5ff89630e9adf.png"></p><h2 id="扩容">扩容</h2><p>Vector默认扩大到原来的2倍，你也可以指定Vector扩容的大小<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(47).png" alt="5b9291f3318ae99ae8208fefe239d477.png"></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vector </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinkedList</title>
      <link href="/2020/04/05/LinkedList/"/>
      <url>/2020/04/05/LinkedList/</url>
      
        <content type="html"><![CDATA[<h1>简介</h1><p>LinkedList是一个双向链表，同样的<strong>线程不安全</strong></p><h1>Node</h1><p>内部类定义数据结构<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(35).png" alt="bdecd2c08616a2b8065a6b0be27bb885.png"></p><h1>add</h1><p>添加一个节点默认是从尾部添加<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(36).png" alt="981b3618c9791b5d2839d92ff71b79d5.png"><br>这里直接调用尾插方法<strong>linkLast</strong></p><h1>addFirst</h1><p>调用linkFirst</p><h1>addLast</h1><p>调用linkLast</p><h1>linkLast</h1><p>尾插法<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(37).png" alt="cf4aa2cc4b7764f3d4ce3d0f7ea53f25.png"><br>先取得最后一个节点<br>再新建一个节点，当前链表最后一个节点就是新建节点的前一个节点，插入元素，新建节点后节点为空。<br>当前链表的最后一个节点就是新建节点。</p><h2 id="第一次添加">第一次添加</h2><p>如果是第一次添加，那么当前链表的第一个节点就是新建节点</p><h2 id="非第一次">非第一次</h2><p>如果不是第一次添加，那么当前链表的最后一个节点的后驱节点就是新建节点</p><h1>linkFirst</h1><p>头插法<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(38).png" alt="ebe5a7959735ddfee653dbc17437b53d.png"><br>先取得第一个节点<br>然后新建一个节点，新建节点的后驱节点就是当前链表的第一个节点<br>标记当前链表的第一个节点是新建节点</p><h2 id="第一次添加-2">第一次添加</h2><p>如果是第一次添加，新建节点就是第一个节点</p><h2 id="非第一次-2">非第一次</h2><p>如果不是第一次添加，那么当前链表的第一个节点的前驱节点就是新建节点。</p><h1>remove</h1><p>删除一个元素<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(39).png" alt="2699c1706560cfd1267882221b88de96.png"><br>这个方法遍历链表，删除第一个相同的元素，后面其实存在一样的元素也不会删除</p><h1>unlink</h1><p>删除某个节点（链表任意位置），删除某个元素的具体方法。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(40).png" alt="0627a1f0ab99fca91600a483ceb3d2dc.png"><br>取出这个节点的数据，前驱节点，后驱节点。</p><h2 id="断掉前驱">断掉前驱</h2><p>先判断他是否为当前链表的第一个节点？<br>如果是，直接把该节点的后驱节点设置为当前链表第一个节点<br>如果不是，那么该节点的前驱节点的后驱节点改为该节点的后驱节点，同时断掉该节点的前驱节点。</p><h2 id="断掉后驱">断掉后驱</h2><p>再判断该节点是否为当前链表的最后一个节点（看他的后驱节点是否为空）<br>如果是，那么该节点的前驱节点就为当前链表的最后一个节点。<br>如果不是，那么该节点的后驱节点的前驱节点改为该节点的前驱结点，同时断掉该节点的后驱节点。</p><p>最后一步就是清空该节点数据</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linkedList </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ArrayList</title>
      <link href="/2020/04/04/ArrayList/"/>
      <url>/2020/04/04/ArrayList/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p>ArrayList其实就是一个对象类型数组，java内部进行了封装，是操作变得简单。<br><strong>线程不安全</strong></p><h1>构造方法</h1><h2 id="ArrayList">ArrayList()</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(22).png" alt="dbd6a8d7708d5b9bdb9b18c697117b96.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(23).png" alt="b25cd518e59aa3e4d6f19a7754744919.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(24).png" alt="55e285a973356858eb3bc82c51b62afe.png"><br>new的时候创建一个空的对象数组<br>？？？？<br>不是说好的创建默认容量为10的数组吗（有个版本直接创建容量为10的对象数组）</p><h2 id="ArrayList-int-initialCapacity">ArrayList(int initialCapacity)</h2><p>当然也可以创建指定容量的对象数组，相当于集合的容量<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(25).png" alt="2bc2b081f5955e9bbcf209c08994ed28.png"></p><h2 id="ArrayList-Collection-extends-E-c">ArrayList(Collection&lt;? extends E&gt; c)</h2><p>还有一个从集合创建ArrayList，相当于把其他集合<strong>转化为ArrayList</strong>。<br>步骤也很简单，调用toArray方法（集合转数组），把得到的数组复制一份给当前ArrayList的对象数组。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(26).png" alt="654b07e5fd9e465c28ea97d7996f8722.png"></p><h1>add</h1><p>在这可能有同学奇怪，初始化为空的数组怎么添加元素？？？<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(27).png" alt="deb043e538096d3859790bff49de8b7a.png"><br>先调用ensureCapacityInternal，防止内部元素数组溢出。<br>再向内部数组插入元素，size+1，完成添加。</p><h1>ensureCapacityInternal</h1><p>这个方法主要是防止内部元素数组溢出<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(28).png" alt="dbe0a5159a8b1c3058756ee65f49e08a.png"><br>首先调用 calculateCapacity</p><h1>ensureExplicitCapacity</h1><p>这个方法是防止内部元素数组溢出的具体代码<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(29).png" alt="9270c494eafd120ef9ee2f7a48c36622.png"><br>传入的是所需存储元素的个数。<br>如果所需存储元素的个数大于内部对象数组的个数，就调用grow方法</p><h1>calculateCapacity</h1><p>这个方法计算数组所需的容量（集合的容量）<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(30).png" alt="861bac8d49ea56adc908315fc8cfa089.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(31).png" alt="1ea4337105f6327ff71cdbe5f7987857.png"><br>如果集合内部对象数组为空，就返回10，也就是初始容量。<br>如果不为空就返回集合所需存储元素个数，不是内部对象数组容量大小。</p><h1>grow</h1><p>具体扩容集合内部对象数组的逻辑<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(32).png" alt="ce1685275792078f92b73ed31d2877e6.png"><br>先得到当前内部对象数组的大小，计算出扩容后的大小（当前内部对象数组的大小加上原来的一半，1.5X，向下取整）。<br>如果扩容容量还是小于集合所需储存元素个数，那么扩容容量就直接是集合所需储存元素个数。<br>同时确保集合所需储存元素个数不能超过整数型最大数（hugeCapacity方法）。<br>最后扩容。</p><h1>get</h1><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(33).png" alt="1ddc4435e198823e120d2868ad51fa6d.png"><br>先调用rangeCheck，检测所取得下标是否抽出元素个数<br>再返回对应元素</p><h1>rangeCheck</h1><p>这个方法检测传入整数是否超出元素个数<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(34).png" alt="4c106eab4a6b93086f6785a0ba159614.png"></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> arrayList </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Servlet原理</title>
      <link href="/2020/03/20/Servlet%E5%8E%9F%E7%90%86/"/>
      <url>/2020/03/20/Servlet%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p><strong>Servlet</strong>是每个学<strong>Javaweb</strong>同学必经历的一个坎，可以说，它在Javaweb中起到一个<strong>承上启下</strong>的作用，所以，搞清楚Servlet的本质很有必要，也是你学习各种web框架的基石。</p><h1>如何编写一个Servlet</h1><p>无论你是谷歌还度娘，几乎所有的教程首先让你做的是：新建一个类，继承<strong>HttpServlet</strong>类，重写doGet和doPost方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.ser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实除了doGet和doPost还有一堆do其他，可以进入HttpServlet类看看<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(13).png" alt="564fe2e424bfb48d8fb6ae7fc9564ae6.png"><br>为什么我们只重写这两个，因为这两个在web应用中最常用，那这些方法怎么来的？</p><h1>Servlet接口</h1><p>跟着<strong>HttpServlet</strong>，一直往上找父类<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(14).png" alt="a794f0c6cc2f85d1abedb3cb7665ef72.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(15).png" alt="20cee6f7449cbf233df1fbdc3158e6b9.png"><br>可以看到最顶层一个<strong>Servlet接口</strong><br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(16).png" alt="cc463310bd83fea26a59c80db43c18a5.png"><br>里面包含了五个方法</p><ul><li>init：Servlet的创建方法</li><li>getServletConfig：获得Servlet的配置</li><li>service：业务逻辑接口，包含两个<strong>Tomcat已经包装好的对象</strong>,ServletRequest和ServletResponse</li><li>getServletInfo：Servlet的信息</li><li>destroy：Servlet的销毁方法</li></ul><p>其中init，service，destroy是Servlet的生命周期，init和destory只会各执行一次，而service方法每有新的请求，就会执行一次。<br>如果我们要实现这个接口去写，那么service方法就要这样。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(17).png" alt="ba07954b1abccb867fcd0554e83ca49c.png"><br>但是这样很麻烦，有木有简单的写法？继续往下看</p><h1>GenericServlet抽象类</h1><p>这个抽象类实现Servlet接口、ServletConfig以及Serializable（序列化），但是它的service方法还是空的，如果我们继承它来写，还是很麻烦，过。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(18).png" alt="b7c1c0d9e9001172a44aec6d7a76ee10.png"></p><h1>HttpServlet</h1><p>HttpServlet继承了GenericServlet，直接转到service方法，先看有木有用。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(19).png" alt="57210106729e6e739dabe4abb4da8e32.png"><br>可以看到，HttpServlet的service方法以及实现了对请求的处理，并分别对没一个请求写了对应的方法</p><ul><li>Get-&gt;doGet</li><li>Post-&gt;doPost<br>…</li></ul><p>但奇怪的是，HttpServlet是一个抽象类，它却没有一个抽象方法，既然以及写好的了各种处理逻辑为什么不给实例化？（但凡是一个抽象类，要么有抽象方法，要么就是不让你实例化。）<br>可以看看它的do方法<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(20).png" alt="d478bada7b9525a0a23b6190deec1db0.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(21).png" alt="976a42a1453a65cd94ee8e5643f4324b.png"><br>无一列外，它的do方法，全都是返回405或400，而这就是让你重写的真正原因。<br>虽然我帮你处理好各种请求解析逻辑，但是我并不知道这个请求你真正的业务逻辑，所以就本身来说就是空逻辑</p><h1>参考文章</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/65588465">https://zhuanlan.zhihu.com/p/65588465</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> servlet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java Annotation</title>
      <link href="/2020/03/20/JavaAnnotation/"/>
      <url>/2020/03/20/JavaAnnotation/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p>注解，是一个很容易被人忽略的点。它出现在很多地方，可能你从来都没注意到它的存在，而它影响着没一个程序的运行。77<br>像这样<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image.png" alt="ff4dc7f5fcbbab6110c287c0f79c6123.png"><br>或是这样<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(1).png" alt="c557d60fb8ddf4fdad430289c42d89ff.png"><br>当我开始注意到它们的存在，但是我开始疑惑它们是怎么样工作的？</p><hr><h1>什么注解</h1><p>如果说注释是给程序员看的，那么注解就是给程序看的。用一个词来描述就是<strong>元数据</strong>，用来描述数据的数据。</p><h2 id="分类">分类</h2><p>注解可以分为三大类：自定义注解，JDK内置注解，第三方框架注解。</p><h2 id="作用">作用</h2><p>它是元数据，用来描述数据的数据。像JDK内置注解@Override，在方法前面加了，就表示该方法时重写方法，还有@Deprecated标识方法过期等。</p><hr><h1>注解的本质</h1><h2 id="注解的定义">注解的定义</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(2).png" alt="bd2fda48ecbf2e1e4d4e27bc700bef41.png"><br>有点类似接口，只不过是在interface前面加了个@符号。但事实是<strong>它本质就是一个接口</strong>。（可以用一个反编译查看编译的class文件）<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123607722.png" alt="image-20200729123607722"><br>（盗的图）</p><h2 id="注解属性">注解属性</h2><p>竟然是个接口，那就说可以往里面添加方法了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Test &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有趣的是，在使用的时候你竟然可以给方法赋值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test(value = &quot;Test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test(value = &quot;Test&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test(value = &quot;Test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talk</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这操作见过？<br>这种怪异的操作打破我们对以往学习的认知，其实这并不是方法，这只是注解的属性，可能是因为过于怪异，所以把注解归为单独的一类。<br>在赋值的时候，你可以指定默认值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Test &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;Test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这你在使用的时候不赋值就不会报错了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talk</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>元注解</h1><h2 id="Target">@Target</h2><p>上面可以看到注解既可以标注在类上，又可以标注在方法上，还能标注在属性上，那是不是注解可以随意标注呢？<br>很显然不是。<br>在定义注解时我们还需要标注注解使用范围，这就要用到@Target，它的作用就是标注注解的类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(value = ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Test &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;Test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123641504.png" alt="image-20200729123641504"><br>可以看到该元注解就只有一个属性，就是指定类型<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123656046.png" alt="image-20200729123656046"><br>限制在哪标记选择合适的类型。</p><h2 id="Retention">@Retention</h2><p>还有一个常用的元注解@Retention。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123722062.png" alt="image-20200729123722062"></p><p>它的作用就是标注注解的<strong>保留策略</strong>。（盗的图）<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123827446.png" alt="image-20200729123827446"><br>默认为<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123854043.png" alt="image-20200729123854043"><br>因为注解的主要解析方法就是反射，而反射只能读取内存中的字节码信息。</p><h2 id="完整注解">完整注解</h2><p>一个完整的注解大概是这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Test &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;Test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h1>注解的使用</h1><p>刚才已经标注了注解的类型（<strong>ElementType.METHOD</strong>），所以你只能在方法上使用，如果在别的地方使用就会报错<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123910005.png" alt="image-20200729123910005"></p><hr><h2 id="注解的解析">注解的解析</h2><p>注解无非就三个步骤：定义，使用，解析。解析是真正的精髓，是体现注解真正作用的一步。JDK并不会自动帮我们解析。<br>解析主要使用反射，简单实现一下Junit的@Test注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.MyTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.Service.Person;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.annotation.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Test annotation;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class personClass = Person.class;</span><br><span class="line"></span><br><span class="line">        Person person = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            person = (Person) personClass.newInstance();</span><br><span class="line"></span><br><span class="line">            Method[] methods = personClass.getMethods();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Method m : methods) &#123;</span><br><span class="line">                <span class="keyword">if</span> (m.isAnnotationPresent(Test.class))&#123;</span><br><span class="line">                    m.invoke(person);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        parTest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729123927210.png" alt="image-20200729123927210"></p><h1>参考文章</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/60941426">https://zhuanlan.zhihu.com/p/60941426</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 注解 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVC配置</title>
      <link href="/2020/03/18/SpringMVC%E9%85%8D%E7%BD%AE/"/>
      <url>/2020/03/18/SpringMVC%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1>一、导入相关jar包</h1><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h1>二、配置web.xml</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee </span></span></span><br><span class="line"><span class="string"><span class="tag">                                     http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--拦截器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring1<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--关联springMVC配置文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring1-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--拦截请求--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring1<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><h1>三、配置SpringMVC配置文件</h1><p>在<strong>resource</strong>目录下新建一个<strong>spring1-servlet.xml</strong>(【项目名]-servlet.xml)<br>依次配置<strong>处理映射器</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><strong>处理器适配器</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><strong>视图解析器</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span> <span class="attr">id</span>=<span class="string">&quot;InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--前缀--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--后缀--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当然也可以使用注解来实现，是用下面配置的来代替注入<strong>处理映射器</strong>和<strong>处理器适配器</strong>的<strong>bean</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>同时也可以配置注解扫描包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.Playwi0.controller&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>整个配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                                   http://www.springframework.org/schema/beans/spring-beans.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">                                   http://www.springframework.org/schema/mvc </span></span></span><br><span class="line"><span class="string"><span class="tag">                                   https://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                                   http://www.springframework.org/schema/context  </span></span></span><br><span class="line"><span class="string"><span class="tag">                                   https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--指定扫描注解包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.Playwi0.controller&quot;</span>/&gt;</span></span><br><span class="line">     </span><br><span class="line">    <span class="comment">&lt;!-- 让Spring MVC不处理静态资源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--注解注册处理映射器和处理器适配器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--处理映射器--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;bean class=&quot;org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping&quot;/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--处理器适配器--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;bean class=&quot;org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter&quot;/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span> <span class="attr">id</span>=<span class="string">&quot;InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--前缀--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--后缀--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springMVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>整合SSM</title>
      <link href="/2020/03/17/%E6%95%B4%E5%90%88SSM/"/>
      <url>/2020/03/17/%E6%95%B4%E5%90%88SSM/</url>
      
        <content type="html"><![CDATA[<h1>一、准备阶段</h1><h2 id="1、创建新项目">1、创建新项目</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(6).png" alt="87518e443f4052ebbf13b1c400a25c46.png"></p><h2 id="2、导包">2、导包</h2><p><strong>pom.xml</strong></p><h2 id="code￼0"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SSM<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--数据库驱动--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--数据库连接池--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Servlet - JSP --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Spring--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Maven资源过滤--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></h2><h1>二、MyBatis层</h1><h2 id="1、新建数据库配置文件">1、新建数据库配置文件</h2><p><strong>database.properties</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdbc.driver=com.mysql.jdbc.Driver</span><br><span class="line">jdbc.url=jdbc:mysql://localhost:3306/mybatis?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf8</span><br><span class="line">jdbc.username=root</span><br><span class="line">jdbc.password=123456</span><br></pre></td></tr></table></figure><h2 id="2、新建MyBatis配置文件">2、新建MyBatis配置文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3、新建mapper和pojo包">3、新建mapper和pojo包</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(7).png" alt="8b0c3871df46c13d3005f914a98bb37a.png"></p><h2 id="4、编写数据库对应类">4、编写数据库对应类</h2><p><img src="data:image/png;base64,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" alt="image.png"><br><strong>Users</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Users</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Users</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Users</span><span class="params">(<span class="keyword">int</span> id, String name, String pwd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.pwd = pwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPwd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPwd</span><span class="params">(String pwd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pwd = pwd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Users&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, pwd=&#x27;&quot;</span> + pwd + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5、编写mapper">5、编写mapper</h2><p><strong>UsersMapper</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.pojo.Users;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UsersMapper</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function">List&lt;Users&gt; <span class="title">selectUser</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>UsersMapper.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.Playwi0.mapper.UsersMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectUser&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.Playwi0.pojo.Users&quot;</span>&gt;</span></span><br><span class="line">        select * from user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="6、注册mapper-xml">6、注册mapper.xml</h2><p><strong>mybatis.xml</strong></p><h2 id="code￼6"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.Playwi0.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;com/Playwi0/mapper/UsersMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></h2><h1>三、Spring层</h1><h2 id="1、编写spring-mybatis-xml">1、编写spring-mybatis.xml</h2><p><strong>spring-mybatis.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">&quot;http://www.springframework.org/schema/util&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/util</span></span></span><br><span class="line"><span class="string"><span class="tag">                           https://www.springframework.org/schema/util/spring-util.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--关联为数据库配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:database.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置数据库连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--SqlSessionFactory--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis.xml&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;property name=&quot;mapperLocations&quot; value=&quot;classpath:com/Playwi0/mapper/*.xml&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--sqlSessionTemplate--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;bean id=&quot;sqlSessionTemplate&quot; class=&quot;org.mybatis.spring.SqlSessionTemplate&quot;&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;constructor-arg index=&quot;0&quot; ref=&quot;sqlSessionFactoryBean&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;/bean&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置扫描Mapper接口包，动态实现Mapper接口注入到spring容器中 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.Playwi0.mapper&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2、编写service接口">2、编写service接口</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(8).png" alt="72861a5844e66834fd6f4d22c075ca37.png"></p><p><strong>UsersService</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package com.Playwi0.service;</span><br><span class="line"></span><br><span class="line">import com.Playwi0.pojo.Users;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface UsersService &#123;</span><br><span class="line"></span><br><span class="line">    List<span class="tag">&lt;<span class="name">Users</span>&gt;</span> selectUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、编写serviceImpl类">3、编写serviceImpl类</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(9).png" alt="df2262940bcd2d2d9dcda52bd84014b9.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.serviceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.mapper.UsersMapper;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.pojo.Users;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.service.UsersService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersServiceIpmpl</span> <span class="keyword">implements</span> <span class="title">UsersService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UsersMapper usersMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UsersServiceIpmpl</span><span class="params">(UsersMapper usersMapper)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.usersMapper = usersMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Users&gt; <span class="title">selectUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> usersMapper.selectUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="4、注入serviceimpl类">4、注入serviceimpl类</h2><p><strong>spring-service.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--扫描serviceImpl包下的bean--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.Playwi0.serviceImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;usersServiceIpml&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.serviceImpl.UsersServiceIpml&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;usersMapper&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;usersMapper&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="5、配置applicationContext-xml">5、配置applicationContext.xml</h2><p><strong>applicationContext.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:spring-mybatis.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:spring-service.xml&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h1>三、SpringMVC层</h1><h2 id="1、添加web支持">1、添加web支持</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(10).png" alt="1111e3b35b29ba7105c654658da1cb15.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(11).png" alt="32773aa72e6d47338737c183c24907a8.png"></p><h2 id="2、编写web-xml">2、编写web.xml</h2><p><strong>web.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee </span></span></span><br><span class="line"><span class="string"><span class="tag">         http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--过滤器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--encodingFilter--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span></span><br><span class="line">            org.springframework.web.filter.CharacterEncodingFilter</span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Session过期时间--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>15<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3、新建controller包">3、新建controller包</h2><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(12).png" alt="0e20a2f69a61f3739d4743ac7f3a3c8f.png"></p><h2 id="4、编写springMVC-xml">4、编写springMVC.xml</h2><p><strong>springMVC.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="string"><span class="tag">    https://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置mvc注解驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--静态资源默认servlet配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置jsp 显示ViewResolver视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;viewClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.springframework.web.servlet.view.JstlView&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 扫描web相关的bean --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.Playwi0.controller&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="5、导入配置到applicationContext-xml">5、导入配置到applicationContext.xml</h2><p><strong>applicationContext.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;spring-mybatis.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;spring-service.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;springMVC.xml&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="6、编写UsersController类">6、编写UsersController类</h2><p><strong>UsersController</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.pojo.Users;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.serviceImpl.UsersServiceIpml;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;usersServiceIpml&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> UsersServiceIpml usersServiceIpml;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/allUsers&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">allUsers</span><span class="params">(Model model)</span></span>&#123;</span><br><span class="line">        List&lt;Users&gt; users = usersServiceIpml.selectUser();</span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>,users);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;users&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
            <tag> SSM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring的使用</title>
      <link href="/2019/12/22/Spring%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2019/12/22/Spring%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1>前言</h1><p>没办法，spring是java必过的一道坎。先看看spring怎么用</p><h1>HelloWord</h1><p>还是没办法，HelloWord是编程的开始</p><h2 id="1、导入spring所需的包">1、导入spring所需的包</h2><p><strong>spring-beans</strong> 和 <strong>spring-context</strong> 必需的包，是Spring IOC容器的基础。<br><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.Playwi0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springLearning<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-beans --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>有这两个包就可以实现Spring注入功能</p><h2 id="2、编写一个Bean">2、编写一个Bean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello Word&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个Persom Bean，基本的get和set方法，还有一些代表person行为的方法</p><h2 id="3、配置Spring-xml">3、配置Spring-xml</h2><p>默认xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加自己的写的bean到配置文件中(HelloWord.xml)。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;A&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><bean> 标签表示要添加的bean，<strong>属性id</strong>表示bean的名称，相当于变量名，不可重复，<strong>属性class</strong>指定这个的类文件<br>同样的，可以配置多个</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--闭合方式一--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;B&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--闭合方式二--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;B&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="4、使用Spring容器获得bean">4、使用Spring容器获得bean</h2><p>I、根据配置文件新建一个容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;HelloWord.xml&quot;</span>);</span><br></pre></td></tr></table></figure><p>II、根据id，从容器中获取一个bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;HelloWord.xml&quot;</span>);</span><br><span class="line">Person a = (Person) context.getBean(<span class="string">&quot;A&quot;</span>);</span><br></pre></td></tr></table></figure><p>III、获取到自己想要的bean就可以使用这个bean了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.first.Person;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;HelloWord.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Person a = (Person) context.getBean(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">        a.say();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IV、结果<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145139579.png" alt="image-20200729145139579"><br>在这个过程中，我们并没使用new去实例化一个对象，而是直接使用Spring容器去获取一个bean。这就相当于使用Spring容器去管理我们编写的类，对象实例化的过程交给Spring，而我们只需要获取相应的bean就可以，减去开发中繁琐使用new，使代码看起来更加简洁。当然，Spring的好处当然不止于此。</p><h1>创建对象方式</h1><h2 id="1、无参构造函数创建">1、无参构造函数创建</h2><p>先举个例子<br>再键一个People bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">People</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;People is comming&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I am People&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>除了一些方法外，同时也为People类添加了一个无参构造函数<br>配置到xml中</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--闭合方式一--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;A&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--闭合方式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;B&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>新建一个容器,不获取任何的bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.first.Person;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;HelloWord.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Person a = (Person) context.getBean(&quot;A&quot;);</span></span><br><span class="line"><span class="comment">//        a.say();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145155704.png" alt="image-20200729145155704"><br>可以看到，People的无参构造函数被被执行。也就是说，<strong>默认情况下</strong>，Spring是通过无参构造函数去实例化一个对象，同时也表明，如果你的类中没有无参构造函数，Spring就无法实例化bean，会报错<br>修改一下People类的构造函数为有参构造函数，并且只有一个有参构造函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">People</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;People is comming&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    。。。。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>报错</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(4).png" alt="fd7aea45b81fc0e248a6417ba12360fa.png"></p><p>没有默认的构造器<br>我就是要通过有参构造函数创建怎么办？Spring当然也有了</p><h2 id="2、有参构造函数创建">2、有参构造函数创建</h2><p>要想通过Spring实例化bean，那么就要告诉Spring有参构造函数时什么？<br>怎么说？配置文件啊</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--闭合方式一--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;A&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--闭合方式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;B&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;people&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在bean中添加<constructor-arg>标签，属性name为形参名，属性value为对应形参的值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">People</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;name is&quot;</span> + name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>实例化<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145208472.png" alt="image-20200729145208472"><br>成功实例化<br>上面的配置方式是按形参名，Spring还提供多种配置方式<br>配置多个</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>根据形参下标位置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;people&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>根据形参类型</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value</span>=<span class="string">&quot;people&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h1>依赖注入</h1><ul><li>依赖注入（Dependency Injection,DI）。</li><li>依赖 : 指Bean对象的创建依赖于容器 . Bean对象的依赖资源。</li><li>注入 : 指Bean对象所依赖的资源 , 由容器来设置和装配。</li></ul><h2 id="构造器注入">构造器注入</h2><p>上面创建方式有参构造器就是一种</p><h2 id="set注入">set注入</h2><p>很显然，想要set注入就要有set方法。<br>测试类People</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.ws.wsdl.writer.document.http.Address;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Person person;</span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line">    <span class="keyword">private</span> String[] s;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; map;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; set;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">People</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;name is&quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">getPerson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPerson</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.person = person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Properties <span class="title">getProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getS() &#123;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setS</span><span class="params">(String[] s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.s = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setList</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMap</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSet</span><span class="params">(Set&lt;String&gt; set)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.set = set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I am People&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1、基本类型<br>给People中的name和age赋值</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Jack&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2、bean注入<br>使用<strong>属性ref引用</strong>配置的bean，注意是引用</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;A&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--bean注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;person&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;A&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>还有一种方式可以完成这种注入，利用注解<br>需要引入约束</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span> <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag"></span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/context/spring-context.xsd&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br></pre></td></tr></table></figure><p>同时需开启注解支持</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>修改一下测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDogName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(dog.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">&quot;dog&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在配置文件配置两个类</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Dog&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;A&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为Person类的dog属性增加一个注解@Autowired</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDogName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(dog.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个注解会根据属性类型，在配置文件查到对应的bean<br>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.Playwi0.first.Person;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;HelloWord.xml&quot;</span>);</span><br><span class="line">        Person a = (Person) context.getBean(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        a.getDogName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145414110.png" alt="image-20200729145414110"><br>如果这个属性为空需要设置注解属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired(required = false)</span></span><br><span class="line"><span class="keyword">private</span> Dog dog;</span><br></pre></td></tr></table></figure><p>false可为空，true不可为空，默认为true<br>同时也可以在@Autowired下增加一个注解@Qualifier，指定bean的id，不过不能单独使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired(required = false)</span></span><br><span class="line"><span class="meta">@Qualifier(value = &quot;dog&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Dog dog;</span><br></pre></td></tr></table></figure><p>还有一个注解，结合了上面两个注解的特点@Resource<br>可以单独使用，可以以指定id<br>如果指定id，则按id去寻找，如果找不到，则按类型去寻找，两个都不行就报错</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource(name = &quot;dog&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Dog dog;</span><br></pre></td></tr></table></figure><p>2、数组注入<br>使用<array>标签包含<value>标签，在<value>标签写入值</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--数组注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;s&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>a<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>b<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3、List注入<br>和数组有点类似，只是<array>标签变<list></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--List注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>你<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>我<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>他<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4、Map注入<br>注意key和value类型</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Map注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;我&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;你&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;他&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>5、set注入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--set注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;set&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>a<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>b<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>6、Properties注入<br>这里需和Map区别开</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Properties注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;姓名&quot;</span>&gt;</span>Playwi0<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;性别&quot;</span>&gt;</span>男<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>7、Null注入<br>给某个属性赋空值</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;C&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Null注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面列举的几种注入大同小异，配置起来并没那么难，注意一些细节便可</p><h2 id="命名空间注入">命名空间注入</h2><p>Spring提供了两个命名空间，P和C标签</p><ul><li>p(property)</li><li>c(constructor-arg)</li></ul><p>为什么这么说，使用就知道<br>使用这两个需要引入约束文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--默认配置文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> </span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span>       </span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>            </span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--p和c--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:c</span>=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span></span></span><br><span class="line"><span class="tag">       </span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;D&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Dog&quot;</span> <span class="attr">p:name</span>=<span class="string">&quot;p注入&quot;</span> <span class="attr">c:name</span>=<span class="string">&quot;c注入&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>命名标签加上属性名，再写入属性值，即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.Playwi0.first.Dog;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.first.People;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;HelloWord.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Dog dog = (Dog) context.getBean(<span class="string">&quot;D&quot;</span>);</span><br><span class="line">        System.out.println(dog.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145436394.png" alt="image-20200729145436394"></p><h1>Bean装配</h1><p>顾名思义就是给Spring容器配置类信息，让Spring来实例化对象</p><h2 id="xml配置">xml配置</h2><p>这种方式上面也使用过，就是直接在xml配置文件中配置bean。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">&quot;http://www.springframework.org/schema/c&quot;</span> <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--闭合方式一--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;A&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--闭合方式二--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;B&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.first.Person&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="注解配置">注解配置</h2><p>在Spring4之后，如果想要使用注解形式注入bean，需要引入Aop包<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145501464.png" alt="image-20200729145501464"><br>Maven</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> https://mvnrepository.com/artifact/org.springframework/spring-aop</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>虽说是注解，但是配置文件才是真正的主宰。使用这种方式，须在配置文件中添加约束</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--约束--&gt;</span></span><br><span class="line">xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">xsi:schemaLocation=&quot;http://www.springframework.org/schema/context</span><br><span class="line">http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--完整配置--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">         http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>同时还需配置，在哪个包下面使用了注解，让Spring根据此扫描</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans                                  </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.Playwi0.second&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建个测试类Dog</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.second;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;eat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>增加注解@Component(“id”)在相应的类上，这相当于配置文件中的</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;id&quot;</span> <span class="attr">class</span>=<span class="string">&quot;xxx.xxx.xxx.xxx&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.second;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(&quot;dog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;eat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> second;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.second.Dog;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;first.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Dog dog = (Dog) context.getBean(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line"></span><br><span class="line">        dog.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145534166.png" alt="image-20200729145534166"></p><h2 id="Java类配置">Java类配置</h2><p>使用java代码来配置bean，这种方式好处就是可以抛弃xml配置文件，完全由java类控制。<br>新建一个包名为config并且在包下新建一个MyConfig类<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145547648.png" alt="image-20200729145547648"><br>编写该类，首先给类增加一个注解@Configuration，表示其为配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>填加一个返回bean的方法，同时为该方法增加一个注解@Bean，表示配置一个bean，而bean的id就是方法名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.Config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.second.Dog;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">dog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dog();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实例化Spring容器的相应的类也需要做出改变</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> second;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.Config.MyConfig;</span><br><span class="line"><span class="keyword">import</span> com.Playwi0.second.Dog;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(MyConfig.class);</span><br><span class="line">        Dog dog = (Dog) context.getBean(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line">        dog.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145606201.png" alt="image-20200729145606201"></p><h1>AOP</h1><p>需要导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-aspects --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试类People</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I can eat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I can run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talk</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I can talk&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="内置接口">内置接口</h2><p>Spring内置提供API来实现<br>前置接口：<strong>MethodBeforeAdvice</strong><br>日志类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.MethodBeforeAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Log</span> <span class="keyword">implements</span> <span class="title">MethodBeforeAdvice</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * method:方法名</span></span><br><span class="line"><span class="comment">    * objects:方法运行的参数</span></span><br><span class="line"><span class="comment">    * o:目标对象</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method method, Object[] objects, Object o)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(o.getClass().getName() + <span class="string">&quot;运行了&quot;</span> + method.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后置接口：<strong>AfterReturningAdvice</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.AfterReturningAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterLog</span> <span class="keyword">implements</span> <span class="title">AfterReturningAdvice</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * o:返回值对象</span></span><br><span class="line"><span class="comment">     * method:方法名</span></span><br><span class="line"><span class="comment">     * objects:方法运行的参数</span></span><br><span class="line"><span class="comment">     * o1:目标对象</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(Object o, Method method, Object[] objects, Object o1)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(o1.getClass().getName() + <span class="string">&quot;的&quot;</span> + method.getName() + <span class="string">&quot;成功执行了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>环绕接口:   <strong>MethodInterceptor</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInvocation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">All</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation methodInvocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  前置逻辑</span></span><br><span class="line">        System.out.println(<span class="string">&quot;环绕前&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行对应方法</span></span><br><span class="line">        Object obj = methodInvocation.proceed();</span><br><span class="line">        <span class="comment">//  后置逻辑</span></span><br><span class="line">        System.out.println(<span class="string">&quot;环绕后&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xml配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置好对应的bean--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;people&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.People&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;log&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.Log&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;after&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.AfterLog&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;all&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.All&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--在config标签里面写入配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--pointcut标签expression属性配置需要代理的方法，为该方法配置一个id--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;p&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.Playwi0.forth.People.*(..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--advisor标签advice-ref属性代理的bean id，pointcut-ref配置代理的方法--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;log&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;p&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;p&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;all&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;p&quot;</span>/&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.forth.People;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;forth.xml&quot;</span>);</span><br><span class="line">        People people = (People) context.getBean(<span class="string">&quot;people&quot;</span>);</span><br><span class="line">        people.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729145627294.png" alt="image-20200729145627294"></p><h2 id="方式二">方式二</h2><p>无需接口，直接使用配置文件来完成相对的操作<br>编写一个前置和后置方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Replace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xml配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置好对应的bean--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;people&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.People&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;replace&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.Replace&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--在config标签里面写入配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--aspect标签ref属性配置前置或后置方法所在类的bean id--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;replace&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--pointcut标签expression属性配置需要代理的方法，为该方法配置一个id--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;p&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.Playwi0.forth.People.*(..))&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--before表示前置，method属性是前面配置ref中的方法--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;before&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;p&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;p&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.forth.People;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;forth.xml&quot;</span>);</span><br><span class="line">        People people = (People) context.getBean(<span class="string">&quot;people&quot;</span>);</span><br><span class="line">        people.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/png;base64,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" alt="image.png"></p><h2 id="注解方式">注解方式</h2><p>注解与第二种方式大同小异，不过是使用了注解的方式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Playwi0.forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@Aspect配置通知所在类</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Replace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Before注解标识前置通知，execution写入表达式，在那个方法写入前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.Playwi0.forth.People.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@After注解标识后置置通知，execution写入表达式，在那个方法写入后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.Playwi0.forth.People.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Around注解标识环绕通知，execution写入表达式，在那个方法写入环绕通知</span></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.Playwi0.forth.People.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint jp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">//  前置逻辑</span></span><br><span class="line">        System.out.println(<span class="string">&quot;环绕前&quot;</span>);</span><br><span class="line">        <span class="comment">//  要执行的方法</span></span><br><span class="line">        Object obj = jp.proceed();</span><br><span class="line">        <span class="comment">// 后置逻辑</span></span><br><span class="line">        System.out.println(<span class="string">&quot;环绕后&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xml配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--开启aop注解支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置好对应的bean--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;people&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.People&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;replace&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.Playwi0.forth.Replace&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> forth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.Playwi0.forth.People;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;forth.xml&quot;</span>);</span><br><span class="line">        People people = (People) context.getBean(<span class="string">&quot;people&quot;</span>);</span><br><span class="line">        people.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/Image(5).png" alt="f34ecff83ec7e3cb737a7d6763801650.png"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/download.png" alt="0c3ae3fabfaf8481371545f43b1ea24e.png"></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java之RMI</title>
      <link href="/2019/11/17/Java%E4%B9%8BRMI/"/>
      <url>/2019/11/17/Java%E4%B9%8BRMI/</url>
      
        <content type="html"><![CDATA[<h1>一、前言</h1><p><strong>RMI</strong>:远程方法调用（Remote Method Invocation）,在某个Java虚拟机（JVM）上调用另一个Java虚拟机中的对象或方法的一种<strong>协议</strong>。多数用于两台或多台计算机之间的调用（一台计算机访问另一台或多台上的对象和方法）。主要运用于<strong>Java网络分布式应用</strong>，是Java网络分布式应用的核心解决方案之一。</p><h1>二、工作流程</h1><p>RMI有点类似于Web应用程序，客户端发起HTTP请求，服务端响应对应的HTML代码，而RMI则是任意对象之间的传递。在这两者之间都离不开两个概念<strong>服务端</strong>和<strong>客户端</strong>，不同的是，服务端与客户端在RMI中随时有可能被颠倒，角色互换。</p><p>1、当client需要调用远程方法时，会调用代理对象存根（stub，网上有非常多的叫法，存根是《java核心技术卷II》中文版的叫法），存根根据你输入的<strong>rmi://remotehost:1099</strong>让client使用<strong>TCP协议</strong>连接到server的<strong>RMIRegistry</strong>，这样client就拿到远程stub对象，而server会在虚拟机中加载对应的stub对象<br>2、client从server中的<strong>RMIRegistry</strong>拿到<strong>stub对象</strong>之后，想要加载其中的方法，存根（stub）根据相应的信息连接远程server的骨架（skeletons，网上也有很多不同的命名），骨架把信息发给server，server根据相应的信息执行相应的方法，得到结果返回给骨架，骨架返回给存根，存根返回给client。<br>3、client拿到的是想要执行方法的结果，并没在client本机上执行了方法。<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729125552495.png" alt="image-20200729125552495"></p><h1>三、代码实现</h1><p>1、先在Server端定义一个远程接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="comment">/** 接口必须继承Remote</span></span><br><span class="line"><span class="comment">* 接口中的对象必须是可序列化，传输的时候是传输序列化的数据</span></span><br><span class="line"><span class="comment">* 远程对象需要实现类似接口</span></span><br><span class="line"><span class="comment">* 只有远程接口定义方法才可以被远程调用</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RemoteInterface</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义的方法必须抛出RemoteException</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、实现远程接口的类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 远程类</span></span><br><span class="line"><span class="comment">* 必须继承UnicastRemoteObject，里面包含了stub与skeleton的通信</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteObject</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">RemoteInterface</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//必须定义一个无参构造函数，抛出RemoteException异常    </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RemoteObject</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//实现接口中的方法    </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> a+b;    </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、服务端启动代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//实例化远程对象</span></span><br><span class="line">            RemoteObject remoteObject = <span class="keyword">new</span> RemoteObject();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//开启注册服务</span></span><br><span class="line">            LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">            <span class="comment">//获取注册对象</span></span><br><span class="line">            Registry registry = LocateRegistry.getRegistry();</span><br><span class="line">            <span class="comment">//注册远程对象</span></span><br><span class="line">            registry.bind(<span class="string">&quot;RemoteObject&quot;</span>,remoteObject);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//工具类 java.rmi.Naming可以简单实现上面操作</span></span><br><span class="line">            <span class="comment">//Naming.rebind(&quot;rmi://localhost:1099/RemoteObject&quot;,remoteObject);</span></span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;Server is running&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AlreadyBoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、在客户端获取stub对象，并执行相应方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取远程stub对象</span></span><br><span class="line">            Registry lh = LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">            RemoteObject remoteObject = (RemoteObject)lh.lookup(<span class="string">&quot;RemoteObject&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用java.rmi.Naming方便操作</span></span><br><span class="line"><span class="comment">//            RemoteObject remoteObject = (RemoteObject) Naming.lookup(&quot;rmi://127.0.0.1:10990/RemoteObject&quot;);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用远程对象的方法</span></span><br><span class="line">            <span class="keyword">double</span> add = remoteObject.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="comment">//打印结果</span></span><br><span class="line">            System.out.println(add);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotBoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RMI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>静动态代理</title>
      <link href="/2019/11/10/%E9%9D%99%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
      <url>/2019/11/10/%E9%9D%99%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1>一、前言</h1><p>Java代理有点类似于Python的装饰器，但是两者的实现方式有很大的区别。<br>Java用一个对象去代理另一个对象的执行，表面上执行的对象叫代理对象。而真正执行的原始对象被另一个对象代理执行，这样能够使原始对象更专注于业务的逻辑，而减少过多不必要的代码，减少代码的耦合性。</p><h1>二、静态代理</h1><p>顾名思义，静态代理的代理对象和原始对象都是确定的，编译后就已经无法再做出改变。<br>用代码来加深理解<br>1、代理类和原始类需要实现同一接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 定义一个动物接口</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//动物吃方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、创建某个动物类实现<strong>Animal接口</strong>，并重写方法（主要业务逻辑）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">implements</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重写eat方法，写上主要逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I can eat something&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、创建一个代理类实现<strong>Animal接口</strong>，将其他对象相同或经常改动的逻辑写在里面。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DogProxy</span> <span class="keyword">implements</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定代理对象</span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化获得原始对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DogProxy</span><span class="params">(Dog dog)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dog = dog;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//表面上代理对象执行方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        beforEat();</span><br><span class="line">        dog.eat();</span><br><span class="line">        afterEat();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//吃前的逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforEat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;wash hand&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//吃后的逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterEat</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;wipe mouth&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、运行测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个Dog对象</span></span><br><span class="line">        Dog dog = <span class="keyword">new</span> Dog();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//实例化一个代理对象</span></span><br><span class="line">        DogProxy dogProxy = <span class="keyword">new</span> DogProxy(dog);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//运行代理方法</span></span><br><span class="line">        dogProxy.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5、结果<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124740711.png" alt="image-20200729124740711"><br>这样原始类只要专注于业务逻辑的实现，而同一个类不同对象其他过多相同提示，由代理对象来完成。<br>但是问题来了<br>我要新建一个Cat类或是Ant类等等，那该怎么做？<br>1、Cat类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Cat逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I am cat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、CatProxy类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatProxy</span> <span class="keyword">implements</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定代理对象</span></span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化获得原始对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DogProxy</span><span class="params">(Cat cat)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cat = cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//表面上代理对象执行方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        beforEat();</span><br><span class="line">        cat.eat();</span><br><span class="line">        afterEat();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//吃前的逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforEat</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;wash hand&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//吃后的逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterEat</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;wipe mouth&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个Dog对象</span></span><br><span class="line">        Dog dog = <span class="keyword">new</span> Dog();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个Dog代理对象</span></span><br><span class="line">        DogProxy dogProxy = <span class="keyword">new</span> DogProxy(dog);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//运行代理方法</span></span><br><span class="line">        dogProxy.eat();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个Cat对象</span></span><br><span class="line">        Cat cat = <span class="keyword">new</span> Cat();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个Cat代理对象</span></span><br><span class="line">        CatProxy catProxy = <span class="keyword">new</span> CatProxy(cat);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//运行代理方法</span></span><br><span class="line">        catProxy.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、结果<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124806843.png" alt="image-20200729124806843"><br>同时Animal但是却是相当于重写整个代理。<br>主要因为在静态代理对象中，<strong>写死了代理某一个对象</strong><br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124822631.png" alt="image-20200729124822631"><br>这样每次代理同一个类不同对象时，都要新建一个代理对象。如果原始对象太多，代理对象也会同样增多，维护不断更高。<br>那有什么办法可以解决这个缺点呢？<br>有，<strong>动态代理</strong></p><h1>三、动态代理</h1><p>顾名思义，动态代理就是动态的，对象是动态的，也就是可以对任意对象的方法进行代理，对象可以是任意，所以是动态的。<br>代码举例<br>同样需要定义好接口，直接使用上面的Dog来实现<br>1、先是代理对象，必须实现 InvocationHandler</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得对象</span></span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyHandler</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//代理方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object o, Method method, Object[] objects)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        befor();</span><br><span class="line">        method.invoke(object,objects);</span><br><span class="line">        after();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行前逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">befor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Befor running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行后逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;After running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个被代理对象</span></span><br><span class="line">        Dog dog = <span class="keyword">new</span> Dog();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获得类加载器</span></span><br><span class="line">        ClassLoader classLoader = dog.getClass().getClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获得所有接口</span></span><br><span class="line">        Class&lt;?&gt;[] interfaces = dog.getClass().getInterfaces();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化代理类，传入被代理对象</span></span><br><span class="line">        InvocationHandler proxyHandler = <span class="keyword">new</span> ProxyHandler(dog);</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//返回代理对象</span></span><br><span class="line">        Animal a = (Animal)Proxy.newProxyInstance(classLoader, interfaces, proxyHandler);</span><br><span class="line"></span><br><span class="line">        a.eat();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、结果<br><img src="data:image/png;base64,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" alt="image.png"><br>无论是传入Cat还是传入Dog，只要他实现了Animal接口，就能代理接口中的方法。<br>怎么做到的？</p><h1>四、动态代理原理</h1><p>从上面测试代码不难看出，关键代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Animal a = (Animal)Proxy.newProxyInstance(classLoader,interfaces,proxyHandler);</span><br></pre></td></tr></table></figure><p>跟进静态方法<strong>newPrxoyInstance</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         Class&lt;?&gt;[] interfaces,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         InvocationHandler h)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       Objects.requireNonNull(h);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</span><br><span class="line">       <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</span><br><span class="line">       <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">           checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Look up or generate the designated proxy class.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Invoke its constructor with the designated invocation handler.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">               checkNewProxyPermission(Reflection.getCallerClass(), cl);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line">           <span class="keyword">final</span> InvocationHandler ih = h;</span><br><span class="line">           <span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">               AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                   <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       cons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br></pre></td></tr></table></figure><p>仔细观察，重要的三句代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//获取代理对象class</span></span><br><span class="line"> Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//获取代理对象构造器</span></span><br><span class="line"> <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//返回代理对象实例</span></span><br><span class="line"> <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br></pre></td></tr></table></figure><p>代理对象不是上面的<strong>ProxyHandler</strong>？？？，其实不然，在他之上还有一层代理对象。而这个代理类怎么来的，就是这句代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br></pre></td></tr></table></figure><p>通过目标类的loader和interface获得需要代理的方法，新建一个带有构造方法的$Proxy0类。<br>在main函数中加入一句</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.getProperties().put(<span class="string">&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure><p>保存生成的class文件，就可以得到$Proxy0的class文件，在IDEA可以直接看到反编译后的代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.sun.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;equals&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>));</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;Animal&quot;</span>).getMethod(<span class="string">&quot;eat&quot;</span>);</span><br><span class="line">            m2 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;toString&quot;</span>);</span><br><span class="line">            m0 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这句获得相对应的构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br></pre></td></tr></table></figure><p>实例化时再传入<strong>InvocationHandler</strong>对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br></pre></td></tr></table></figure><p>再调用<strong>父类Proxy</strong>的构造方法<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124631577.png" alt="image-20200729124631577"><br>当我们调用<strong>eat</strong>方法时，其实调用的是，代理对象的eat</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">           <span class="keyword">throw</span> var2;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>eat方法里面调用的是<strong>InvocationHandler</strong>第二层代理对象的<strong>invoke</strong>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object o, Method method, Object[] objects)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    befor();</span><br><span class="line">    method.invoke(object,objects);</span><br><span class="line">    after();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里面，传入的method</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method = m3 = Class.forName(<span class="string">&quot;Animal&quot;</span>).getMethod(<span class="string">&quot;eat&quot;</span>);</span><br></pre></td></tr></table></figure><p>method.invoke(<strong>object</strong>,objects)中的object是</p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124903324.png" alt="image-20200729124903324"></p><p><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124919568.png" alt="image-20200729124919568"><br>其实就是传入的目标对象。</p><h1>五、总结</h1><p>整个流程下来，可以发现动态代理底层用的其实就是放射。<br>盗来一张图<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124937278.png" alt="image-20200729124937278"><br>但是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Animal a = (Animal)Proxy.newProxyInstance(classLoader, interfaces, proxyHandler);</span><br></pre></td></tr></table></figure><p>这里强制转的是接口中的一个，如果我实现多个接口，也就不能交叉使用了，这个也就是动态代理的不足之处<br><img src="https://gitee.com/Playwi0/MyImage/raw/master/NoteImage/image-20200729124954689.png" alt="image-20200729124954689"></p><h1>六、参考文章</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/62660956">https://zhuanlan.zhihu.com/p/62660956</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 动态代理 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
